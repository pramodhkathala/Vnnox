<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{--bg:#eef2f7;--card:#fff;--ink:#111827;--brand:#0d47a1;--accent:#b71c1c;--muted:#f8fafc;--ok:#1b5e20}
    html,body{height:100%}body{font-family:Inter,ui-sans-serif,system-ui; margin:0; padding:32px; background:var(--bg); color:var(--ink); font-size:14px}
    .main-wrapper{max-width:1200px;margin:auto}
    h2{color:var(--brand);text-align:center;margin-bottom:18px;font-weight:700}
    .input-panel{background:var(--card);padding:22px;border-radius:12px;border:1px solid #e5e7eb;box-shadow:0 8px 30px rgba(2,6,23,.06)}
    .input-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px 20px}
    label{display:block;margin-bottom:6px;font-weight:600;color:#475569}
    select,input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #dcdcdc;background:#fff;box-sizing:border-box}
    .btn{background:var(--brand);color:#fff;padding:12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .visualization{background:var(--card);padding:22px;border-radius:12px;margin-top:20px;border:1px solid #e5e7eb;display:none}
    .visualization.visible{display:block}
    .output-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .details-box{padding:14px;border-radius:10px;background:linear-gradient(180deg,#fbfdff,#f7f9fc);border:1px solid #e5e7eb}
    .vis-details{display:grid;gap:8px}
    .vis-details span{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dotted #e5e7eb}
    .vis-details strong{font-weight:700;color:#111827}
    .debug-box{background:#fff8e1;border:1px solid #ffecb3;padding:10px;border-radius:8px;font-size:13px;color:#7a4100}
    pre.debug{background:#fff;margin:6px 0;padding:10px;border-radius:6px;border:1px dashed #f0f0f0;overflow:auto;font-size:13px}
    footer{text-align:center;margin-top:12px;color:#9aa9c6;font-size:12px}
    @media(max-width:900px){.input-grid,.output-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="input-panel" id="formContainer">
      <h2>PeopleLink LED Video Wall Configuration — V16.1</h2>
      <div class="input-grid">
        <div>
          <label for="productModel">LED Model / Pixel Pitch</label>
          <select id="productModel">
            <option value="">Select LED Model</option>
            <optgroup label="COB Models (16:9 Cabinet - 600x337.5mm)">
              <option value="cob_09">0.9375mm</option>
              <option value="cob_125">1.25mm</option>
              <option value="cob_15">1.5625mm</option>
            </optgroup>
            <optgroup label="SMD Indoor Models (4:3 Cabinet - 640x480mm)">
              <option value="indoor_186">1.86mm</option>
              <option value="indoor_20">2.0mm</option>
              <option value="indoor_25">2.5mm</option>
            </optgroup>
            <optgroup label="SMD Outdoor Models (1:1 Cabinet - 960x960mm)">
              <option value="outdoor_40">4.0mm</option>
              <option value="outdoor_667">6.67mm</option>
              <option value="outdoor_80">8.0mm</option>
              <option value="outdoor_100">10.0mm</option>
            </optgroup>
          </select>
        </div>

        <div>
          <label for="unit">Unit</label>
          <select id="unit" onchange="toggleMeasurementFields()">
            <option value="">Select unit</option>
            <option value="meters">Meters (m)</option>
            <option value="feet">Feet (ft)</option>
            <option value="inches">Inches (diagonal)</option>
          </select>
        </div>

        <div id="widthGroup">
          <label id="widthLabel" for="width">Desired Width (m)</label>
          <input id="width" type="number" min="0.1" step="0.01" placeholder="Width" />
        </div>
        <div id="heightGroup">
          <label id="heightLabel" for="height">Desired Height (m)</label>
          <input id="height" type="number" min="0.1" step="0.01" placeholder="Height" />
        </div>

        <div id="diagonalGroup" style="display:none">
          <label id="diagonalLabel" for="diagonal">Diagonal (inches)</label>
          <input id="diagonal" type="number" min="10" step="1" placeholder="Diagonal inches" />
        </div>

        <div>
          <label for="aspectRatio">Target Aspect Ratio (optional)</label>
          <select id="aspectRatio">
            <option value="">Auto</option>
            <option value="16:9">16:9</option>
            <option value="4:3">4:3</option>
            <option value="1:1">1:1</option>
          </select>
        </div>

        <div style="align-self:end">
          <button class="btn" id="submitButton" onclick="showVisualization()">Calculate & Visualize</button>
        </div>
      </div>
    </div>

    <div class="visualization" id="visualization">
      <div class="output-grid">
        <div class="details-box">
          <h3>LED Wall Specifications</h3>
          <div class="vis-details">
            <span><strong>Pixel Pitch</strong><small id="pixelPitchDisplay">--</small></span>
            <span><strong>Final Dimensions (W x H)</strong><small id="finalDimensions">--</small></span>
            <span><strong>Resolution (W x H)</strong><small id="resolution">--</small></span>
            <span><strong>Total Cabinets</strong><small id="numCabinets">--</small></span>
            <span><strong>Total Pixels</strong><small id="totalPixels">--</small></span>
            <span><strong>Viewing Distance (min/comfort/ideal)</strong><small id="viewingDistance">--</small></span>
            <span><strong>Cabinet Size (W x H)</strong><small id="cabinetSize">--</small></span>
            <span><strong>Cabinet Pixels (W x H)</strong><small id="cabinetPixels">--</small></span>
          </div>

          <div style="margin-top:12px">
            <div class="debug-box"><strong>Port Calculation (debug)</strong>
              <pre class="debug" id="portCalcDebug">--</pre>
            </div>
          </div>
        </div>

        <div class="details-box">
          <h3>Control System & Connections</h3>
          <div class="vis-details" id="controlSystemDetails">--</div>
        </div>
      </div>

      <div style="margin-top:14px" class="details-box">
        <h3>Visual Layout</h3>
        <div style="height:280px; background:linear-gradient(135deg,#e3f2fd,#bbdefb); border-radius:8px; border:3px solid #b71c1c; position:relative" id="visGrid">
          <div id="cabinetOverlay" style="position:absolute;inset:0;display:grid"></div>
          <div style="position:absolute;left:12px;top:8px;font-weight:700;color:#b71c1c" id="visLabels">--</div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; align-items:center">
        <button class="btn" onclick="proceedToDownloadPdf()">Download PDF Summary</button>
        <button class="btn" style="background:#6b7280" onclick="hideVisualization()">Modify</button>
      </div>
    </div>

    <div id="controllerModal" style="display:none"></div>
  </div>

  <footer>© 2025 PeopleLink Unified Communications Pvt. Ltd.</footer>

  <script>
    // Constants
    const MM_PER_METER = 1000;
    const MM_PER_INCH = 25.4;
    const MM_PER_FOOT = MM_PER_INCH*12;
    const METER_TO_FEET = 3.28084;

    // <-- IMPORTANT: base pixels-per-port for calculation (explicit 650,000) -->
    const PIXELS_PER_PORT_BASE = 650000;

    // Products (same as your established ones)
    const LED_PRODUCTS = {
      cob_09:   { name:"PeopleLink COB (0.9375mm)", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300 },
      cob_125:  { name:"PeopleLink COB (1.25mm)", pitch_mm:1.25, cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300 },
      cob_15:   { name:"PeopleLink COB (1.5625mm)", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300 },
      indoor_186:{ name:"PeopleLink SMD Indoor (1.86mm)", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560 },
      indoor_20:{ name:"PeopleLink SMD Indoor (2.0mm)", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560 },
      indoor_25:{ name:"PeopleLink SMD Indoor (2.5mm)", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560 },
      outdoor_40:{ name:"PeopleLink SMD Outdoor (4.0mm)", pitch_mm:4.0, cabW_mm:960, cabH_mm:960, cabPixW:240, cabPixH:240, modulesPerCab:18, weight_kg:8.28, maxPower_W_m2:937.5 },
      outdoor_667:{ name:"PeopleLink SMD Outdoor (6.67mm)", pitch_mm:6.67, cabW_mm:960, cabH_mm:960, cabPixW:144, cabPixH:144, modulesPerCab:18, weight_kg:8.28, maxPower_W_m2:937.5 },
      outdoor_80:{ name:"PeopleLink SMD Outdoor (8.0mm)", pitch_mm:8.0, cabW_mm:960, cabH_mm:960, cabPixW:120, cabPixH:120, modulesPerCab:18, weight_kg:8.28, maxPower_W_m2:937.5 },
      outdoor_100:{ name:"PeopleLink SMD Outdoor (10.0mm)", pitch_mm:10.0, cabW_mm:960, cabH_mm:960, cabPixW:96, cabPixH:96, modulesPerCab:18, weight_kg:8.28, maxPower_W_m2:937.5 }
    };

    // Controller models simplified (keeps previous logic)
    const CONTROLLER_MODELS = [
      { name:"TB40", type:"Multimedia Player", ports:2, maxPixels:1300000, maxW:10240, maxH:8192 },
      { name:"TB60", type:"Multimedia Player", ports:4, maxPixels:2300000, maxW:4096, maxH:4096 },
      { name:"VX400 Pro / DSP400 Pro", type:"All-in-One Processor", ports:4, maxPixels:2600000, maxW:10240, maxH:8192 },
      { name:"VX600 Pro / DSP600 Pro", type:"All-in-One Processor", ports:6, maxPixels:3900000, maxW:10240, maxH:8192 },
      { name:"H2 (2U)", type:"Modular Splicer", ports:20, maxPixels:26000000, maxW:16384, maxH:8192, slots:8 },
      { name:"H5 (5U)", type:"Modular Splicer", ports:20, maxPixels:39000000, maxW:16384, maxH:8192, slots:16 }
    ];

    // Helpers
    function gcd(a,b){return b===0?a:gcd(b,a%b)}
    function format(n, d=1){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}); }
    let finalCalculationData = {};

    function toggleMeasurementFields(){
      const unit = document.getElementById('unit').value;
      const diag = unit==='inches';
      document.getElementById('widthGroup').style.display = diag ? 'none' : 'block';
      document.getElementById('heightGroup').style.display = diag ? 'none' : 'block';
      document.getElementById('diagonalGroup').style.display = diag ? 'block' : 'none';
    }

    function getSuggestedControllerModel(totalPixels, finalResW, finalResH, minPortsRequired, inputCardQty=2, outputCardPorts=20){
      // simplified: prefer non-modular if it covers ports+pixels, else choose smallest modular with slots
      const nonMods = CONTROLLER_MODELS.filter(c=>c.type!=='Modular Splicer');
      let pick = nonMods.find(c=>c.maxPixels>=totalPixels && c.ports>=minPortsRequired && c.maxW>=finalResW && c.maxH>=finalResH);
      if (pick) return pick;
      const mods = CONTROLLER_MODELS.filter(c=>c.type==='Modular Splicer').sort((a,b)=>a.maxPixels-b.maxPixels);
      const requiredOutputCards = Math.max(1, Math.ceil(minPortsRequired / outputCardPorts));
      const totalSlotsNeeded = requiredOutputCards + inputCardQty;
      pick = mods.find(m=>m.maxPixels>=totalPixels && (m.slots||0) >= totalSlotsNeeded && m.maxW>=finalResW && m.maxH>=finalResH);
      return pick || CONTROLLER_MODELS[CONTROLLER_MODELS.length-1];
    }

    function calculateLEDWall(){
      const productKey = document.getElementById('productModel').value;
      const unit = document.getElementById('unit').value;
      const width = parseFloat(document.getElementById('width').value);
      const height = parseFloat(document.getElementById('height').value);
      const diagonal = parseFloat(document.getElementById('diagonal').value);
      const aspect = document.getElementById('aspectRatio').value;

      if (!productKey || !unit || (unit!=='inches' && !width && !height) || (unit==='inches' && !diagonal)){
        alert('Select model, unit and enter valid dimensions'); return null;
      }

      const details = LED_PRODUCTS[productKey];
      // compute desired dimensions in mm
      let desiredW_mm, desiredH_mm;
      if (unit==='inches'){
        const ratio = aspect || '16:9'; const [rw,rh]=ratio.split(':').map(Number);
        const diagRatio = Math.sqrt(rw*rw + rh*rh); const factor = diagonal / diagRatio;
        desiredW_mm = rw * factor * MM_PER_INCH; desiredH_mm = rh * factor * MM_PER_INCH;
      } else {
        const unit_factor = unit==='meters' ? MM_PER_METER : MM_PER_FOOT;
        if (aspect){
          const [rw,rh]=aspect.split(':').map(Number);
          if (width){ desiredW_mm = width * unit_factor; desiredH_mm = (width / rw) * rh * unit_factor; }
          else { desiredH_mm = height * unit_factor; desiredW_mm = (height / rh) * rw * unit_factor; }
        } else {
          desiredW_mm = (width || (height * (details.cabW_mm/details.cabH_mm))) * unit_factor;
          desiredH_mm = (height || (width * (details.cabH_mm/details.cabW_mm))) * unit_factor;
        }
      }

      // snap to cabinets
      let numCabW = Math.max(1, Math.round(desiredW_mm / details.cabW_mm));
      let numCabH = Math.max(1, Math.round(desiredH_mm / details.cabH_mm));
      const totalCabinets = numCabW * numCabH;
      const finalW_mm = numCabW * details.cabW_mm;
      const finalH_mm = numCabH * details.cabH_mm;
      const finalResW = numCabW * details.cabPixW;
      const finalResH = numCabH * details.cabPixH;
      const totalPixels = finalResW * finalResH;

      // viewing distance per your rule: m ≈ pixel pitch (mm)
      const minView_m = details.pitch_mm;
      const comfortView_m = details.pitch_mm * 1.5;
      const idealView_m = details.pitch_mm * 2.0;

      // PORT CALCULATION (CONSERVATIVE)
      // 1) bandwidth-based
      const portsByBandwidth = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_BASE));
      // 2) cabinet-aware: how many whole cabinets per port (floor)
      const cabinetPixels = details.cabPixW * details.cabPixH;
      const maxCabinetsPerPort = Math.max(1, Math.floor(PIXELS_PER_PORT_BASE / cabinetPixels));
      const portsByCabinets = Math.max(1, Math.ceil(totalCabinets / maxCabinetsPerPort));
      // 3) topology: one run per column minimum
      const portsByColumns = numCabW;
      // Final long runs
      const requiredLongPorts = Math.max(portsByBandwidth, portsByCabinets, portsByColumns);
      const requiredShortEthernet = Math.max(0, totalCabinets - requiredLongPorts);

      // controller suggestion
      const suggested = getSuggestedControllerModel(totalPixels, finalResW, finalResH, requiredLongPorts);
      // required send cards assuming 20-ports
      const outputCardPorts = 20;
      const requiredSendCards = Math.max(1, Math.ceil(requiredLongPorts / outputCardPorts));

      finalCalculationData = {
        productName: details.name,
        pixelPitch_mm: details.pitch_mm,
        cabinetW_mm: details.cabW_mm, cabinetH_mm: details.cabH_mm,
        cabPixW: details.cabPixW, cabPixH: details.cabPixH,
        numCabW, numCabH, totalCabinets,
        finalW_mm, finalH_mm, finalResW, finalResH, totalPixels,
        minView_m, comfortView_m, idealView_m,
        portsByBandwidth, cabinetPixels, maxCabinetsPerPort, portsByCabinets, portsByColumns,
        requiredLongPorts, requiredShortEthernet, requiredSendCards,
        controllerName: suggested.name, controllerType: suggested.type
      };
      return finalCalculationData;
    }

    function showVisualization(){
      const data = calculateLEDWall(); if(!data) return;
      document.getElementById('visualization').classList.add('visible');
      document.getElementById('pixelPitchDisplay').textContent = data.pixelPitch_mm + ' mm';
      const finalW_m = (data.finalW_mm/1000).toFixed(2), finalH_m=(data.finalH_mm/1000).toFixed(2);
      document.getElementById('finalDimensions').textContent = finalW_m + ' m × ' + finalH_m + ' m';
      document.getElementById('resolution').textContent = data.finalResW + ' × ' + data.finalResH;
      document.getElementById('numCabinets').textContent = data.totalCabinets + ' (' + data.numCabW + ' × ' + data.numCabH + ')';
      document.getElementById('totalPixels').textContent = data.totalPixels.toLocaleString();
      document.getElementById('viewingDistance').textContent = data.minView_m + 'm / ' + data.comfortView_m.toFixed(2) + 'm / ' + data.idealView_m.toFixed(2) + 'm';
      document.getElementById('cabinetSize').textContent = data.cabinetW_mm + 'mm × ' + data.cabinetH_mm + 'mm';
      document.getElementById('cabinetPixels').textContent = data.cabPixW + ' × ' + data.cabPixH;

      // control system
      const controlDiv = document.getElementById('controlSystemDetails');
      controlDiv.innerHTML = '<div><strong>Controller:</strong> ' + data.controllerName + ' (' + data.controllerType + ')</div>'
        + '<div><strong>Long Runs Required:</strong> ' + data.requiredLongPorts + '</div>'
        + '<div><strong>Send Cards:</strong> ' + data.requiredSendCards + ' × H_20xRJ45</div>';

      // debug block
      const debugLines = [
        'PIXELS_PER_PORT_BASE = ' + PIXELS_PER_PORT_BASE,
        'Cabinet pixels = ' + data.cabinetPixels + ' px (W × H => ' + data.cabPixW + ' × ' + data.cabPixH + ')',
        'maxCabinetsPerPort = floor(PIXELS_PER_PORT_BASE / cabinetPixels) = ' + data.maxCabinetsPerPort,
        'portsByCabinets = ceil(totalCabinets / maxCabinetsPerPort) = ' + data.portsByCabinets,
        'portsByBandwidth = ceil(totalPixels / PIXELS_PER_PORT_BASE) = ' + data.portsByBandwidth,
        'portsByColumns = number of columns = ' + data.portsByColumns,
        'Final required long runs = max(portsByBandwidth, portsByCabinets, portsByColumns) = ' + data.requiredLongPorts
      ];
      document.getElementById('portCalcDebug').textContent = debugLines.join('\n');

      // simple visual cabinet grid
      const overlay = document.getElementById('cabinetOverlay');
      overlay.innerHTML = '';
      overlay.style.gridTemplateColumns = 'repeat(' + data.numCabW + ', 1fr)';
      overlay.style.gridTemplateRows = 'repeat(' + data.numCabH + ', 1fr)';
      for(let r=0;r<data.numCabH;r++){
        for(let c=0;c<data.numCabW;c++){
          const d = document.createElement('div'); d.style.border='1px dashed rgba(0,0,0,0.12)'; overlay.appendChild(d);
        }
      }
      document.getElementById('visLabels').textContent = data.numCabW + ' × ' + data.numCabH + ' cabinets';
    }

    function hideVisualization(){
      document.getElementById('visualization').classList.remove('visible');
    }

    function proceedToDownloadPdf(){
      alert('PDF export uses same numbers — debug is visible on screen. (PDF export can be added as required).');
    }

    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById('unit').value = 'meters';
    });
  </script>
</body>
</html>
