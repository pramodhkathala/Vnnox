<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --brand:#0D47A1;
      --accent:#B71C1C;
      --muted:#6b7280;
      --bg:#eef1f8;
    }

    /* compact front page / tightened styles */
    html,body{height:100%}
    body{
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0;
      padding:24px;
      background:var(--bg);
      color:#1c2738;
      font-size:13px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .main-wrapper{
      max-width:1100px;
      margin:0 auto;
    }

    h2{
      text-align:center;
      color:var(--brand);
      margin:0 0 18px 0;
      font-weight:700;
      font-size:1.25rem;
    }

    .input-panel{
      background:#fff;
      padding:18px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(12,34,64,0.06);
      transition:all .35s ease;
    }
    .input-panel.minimized{height:96px;padding:10px 12px;overflow:hidden;background:#fbfdff}

    .input-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px 16px}
    .input-group{margin-top:0}
    label{display:block;margin-bottom:6px;font-weight:600;color:#444;font-size:12px}
    select,input[type="number"],input[type="text"]{
      width:100%;padding:8px 10px;font-size:13px;border:1px solid #e6e9ef;border-radius:6px;box-sizing:border-box;
    }
    select:focus,input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 4px rgba(13,71,161,0.06)}

    /* smaller primary button */
    .submit-btn{margin-top:12px;grid-column:1/-1;background:var(--brand);color:#fff;padding:10px;border-radius:8px;border:0;font-weight:700;font-size:14px;cursor:pointer}
    .submit-btn:hover{background:#1257a8}

    .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--brand);color:#fff;font-weight:700;cursor:pointer;font-size:13px}
    .btn.gray{background:#6c757d}

    .error-message{color:var(--accent);background:#fff0f0;border:1px solid var(--accent);padding:8px;border-radius:6px;text-align:center;font-weight:600;margin-top:10px}

    /* visualization container */
    .visualization{background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(12,34,64,0.06);margin-top:18px;transition:all .35s;opacity:0;max-height:0;overflow:hidden}
    .visualization.visible{opacity:1;max-height:2200px; padding-bottom:22px}
    .output-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}

    .details-box{background:#fbfdff;border:1px solid #eef2f8;padding:12px;border-radius:8px}
    .details-box h4{margin:0 0 8px 0;color:var(--brand);font-size:14px}

    .vis-details{display:grid;gap:8px;font-size:13px}
    .vis-details span{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px dashed #eef2f8}
    .vis-details strong{font-weight:600;color:#222}
    .vis-details small{color:var(--muted);font-weight:600}

    /* responsive, scaling preview area */
    .vis-area{
      position:relative;
      margin:14px auto 0;
      width:100%;
      max-width:880px;   /* preview won't exceed this */
      border-radius:8px;
      background:linear-gradient(135deg,#eaf4ff,#dbeeff);
      border:3px solid #d7eaff;
      box-sizing:border-box;
      overflow:hidden;
      display:block;
    }

    /* cabinet overlay absolutely fills preview and is a CSS grid */
    #cabinetOverlay{
      position:absolute;inset:6px; /* small inset for padding */
      display:grid;grid-gap:0;align-items:stretch;justify-items:stretch;
      box-sizing:border-box;z-index:5;
    }
    #cabinetOverlay>div{border:1px dashed rgba(13,71,161,0.28);box-sizing:border-box;width:100%;height:100%;min-width:4px;min-height:4px}

    .dimension-label{position:absolute;color:var(--accent);background:rgba(255,255,255,0.96);padding:4px 6px;font-weight:700;border-radius:4px;z-index:10;box-shadow:0 1px 4px rgba(0,0,0,0.06);font-size:12px}
    .dim-top{top:8px;left:50%;transform:translateX(-50%)}
    .dim-right{top:50%;right:8px;transform:translateY(-50%) rotate(90deg);transform-origin:center}

    footer{text-align:center;font-size:11px;color:var(--muted);margin-top:12px}

    /* modal (unchanged) */
    .modal{position:fixed;z-index:1100;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.35);display:none}
    .modal-content{width:90%;max-width:720px;margin:5% auto;background:#fff;padding:16px;border-radius:10px}

    /* mobile adjustments */
    @media (max-width:900px){
      .input-grid{grid-template-columns:1fr}
      .output-grid{grid-template-columns:1fr}
      .vis-area{max-width:100%}
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="input-panel" id="formContainer">
      <h2>LED Video Wall Configuration Calculator</h2>

      <div id="enteredValuesDisplay" style="display:none;text-align:center;margin-bottom:8px;font-size:13px">
        <span id="enteredSummaryText"></span><br>
        Aspect Ratio: <strong><span id="aspectRatioValue">--</span></strong>
      </div>

      <div id="errorMessage" class="error-message" style="display:none" role="alert" aria-live="assertive"></div>

      <div class="input-grid" role="form" aria-label="LED configuration form">
        <div class="input-group">
          <label for="productModel">LED Model / Pixel Pitch</label>
          <select id="productModel" aria-label="Select LED Model">
            <option value="">Select LED Model</option>
            <optgroup label="COB Models (16:9 Cabinet - 600x337.5mm)">
              <option value="cob_09">0.9375 mm (COB)</option>
              <option value="cob_125">1.25 mm (COB)</option>
              <option value="cob_15">1.5625 mm (COB)</option>
            </optgroup>
            <optgroup label="SMD Indoor Models (4:3 Cabinet - 640x480mm)">
              <option value="indoor_186">1.86 mm (Indoor)</option>
              <option value="indoor_20">2.0 mm (Indoor)</option>
              <option value="indoor_25">2.5 mm (Indoor)</option>
            </optgroup>
            <optgroup label="SMD Outdoor Models (1:1 Cabinet - 960x960mm)">
              <option value="outdoor_40">4.0 mm (Outdoor)</option>
              <option value="outdoor_667">6.67 mm (Outdoor)</option>
              <option value="outdoor_80">8.0 mm (Outdoor)</option>
              <option value="outdoor_100">10.0 mm (Outdoor)</option>
            </optgroup>
          </select>
        </div>

        <div class="input-group">
          <label for="unit">Unit of Measurement</label>
          <select id="unit" onchange="toggleMeasurementFields()">
            <option value="">Select unit</option>
            <option value="meters">Meters (m)</option>
            <option value="feet">Feet (ft)</option>
            <option value="inches">Inches (in) - Diagonal</option>
          </select>
        </div>

        <div class="input-group" id="widthGroup">
          <label for="width" id="widthLabel">Desired Width (m)</label>
          <input id="width" type="number" step="0.01" min="0.1" placeholder="e.g., 3.5" />
        </div>

        <div class="input-group" id="heightGroup">
          <label for="height" id="heightLabel">Desired Height (m)</label>
          <input id="height" type="number" step="0.01" min="0.1" placeholder="e.g., 2.0" />
        </div>

        <div class="input-group" id="diagonalGroup" style="display:none">
          <label for="diagonal" id="diagonalLabel">Desired Diagonal (inches)</label>
          <input id="diagonal" type="number" min="10" step="1" placeholder="e.g., 110" />
        </div>

        <div class="input-group">
          <label for="aspectRatio" id="aspectRatioLabel">Target Aspect Ratio (Optional)</label>
          <select id="aspectRatio">
            <option value="">(Optional)</option>
            <option value="16:9">16:9</option>
            <option value="16:10">16:10</option>
            <option value="4:3">4:3</option>
            <option value="2:1">2:1</option>
            <option value="21:9">21:9</option>
            <option value="1:1">1:1</option>
          </select>
        </div>

        <button id="submitButton" class="submit-btn" onclick="showVisualization()" aria-controls="visualization">Calculate & Visualize System</button>
      </div>
    </div>

    <!-- Visualization & Outputs -->
    <div class="visualization" id="visualization" aria-hidden="true">
      <div class="output-grid" aria-live="polite">
        <div class="details-box">
          <h4>LED Wall Specifications</h4>
          <div class="vis-details" id="wallSpecs">
            <span><strong>Pixel Pitch</strong><small id="pixelPitchDisplay">--</small></span>
            <span><strong>Final Dimensions (WxH)</strong><small id="finalDimensions">--</small></span>
            <span><strong>Final Resolution (WxH)</strong><small id="resolution">--</small></span>
            <span><strong>Total Cabinets</strong><small id="numCabinets">--</small></span>
            <span><strong>Total Modules</strong><small id="totalModules">--</small></span>
            <span><strong>Final Diagonal</strong><small id="finalDiagonal">--</small></span>
            <span><strong>Final Area</strong><small id="finalArea">--</small></span>
            <span><strong>Total Pixels</strong><small id="totalPixels">--</small></span>
          </div>
        </div>

        <div class="details-box">
          <h4>Control System & Connections <button class="edit-btn" onclick="openControllerModal()" aria-haspopup="dialog" style="margin-left:8px;background:none;border:0;color:var(--brand);font-weight:700;cursor:pointer">Edit</button></h4>
          <div class="vis-details" id="controlSystemDetails"></div>
        </div>
      </div>

      <h3 style="margin:12px 0 8px 0;color:var(--brand);font-size:14px">Physical Wall Visualization</h3>

      <!-- Responsive preview: width = available container width (capped), height computed from aspect ratio -->
      <div class="vis-area" id="visArea" role="img" aria-label="LED preview area">
        <div id="cabinetOverlay" aria-hidden="true"></div>
        <div class="dimension-label dim-top" id="dimTop">-- W --</div>
        <div class="dimension-label dim-right" id="dimRight">-- H --</div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px;justify-content:center">
        <button class="btn" id="downloadPdf" onclick="proceedToDownloadPdf()">Download PDF Technical Summary ðŸ“„</button>
        <button class="btn gray" onclick="hideVisualization()">Modify Configuration</button>
      </div>
    </div>

    <footer>Â© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala</footer>
  </div>

  <!-- Controller Modal -->
  <div id="controllerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="controllerModalTitle">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3 id="controllerModalTitle" style="margin:0;color:var(--brand)">Edit Control System Components</h3>
        <button onclick="closeControllerModal()" style="background:none;border:0;font-size:22px;cursor:pointer">&times;</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="grid-column:1 / -1">
          <label for="modalControllerModel">Controller/Processor Model</label>
          <select id="modalControllerModel"></select>
        </div>

        <div>
          <label for="modalOutputCardModel">Output Card Model</label>
          <select id="modalOutputCardModel" onchange="updatePortsFromOutputCard()"></select>
        </div>

        <div>
          <label for="modalMaxPortsPerCard">Max Ports per Output Card</label>
          <input id="modalMaxPortsPerCard" type="number" readonly />
        </div>

        <div>
          <label for="modalInputCardModel">Input Card Model</label>
          <select id="modalInputCardModel"></select>
        </div>

        <div>
          <label for="modalInputCardQty">Input Card Qty</label>
          <input id="modalInputCardQty" type="number" min="1" step="1" />
        </div>
      </div>

      <div style="margin-top:12px;background:#fff8e1;border-left:4px solid #ffeb3b;padding:10px;border-radius:6px;font-size:13px">
        <strong>Note:</strong> Default input card qty is 2. Change as per site requirement.
      </div>

      <div style="text-align:right;margin-top:12px">
        <button class="submit-btn" onclick="applyModalChanges()" style="padding:8px 12px;font-size:13px">Apply & Recalculate</button>
      </div>
    </div>
  </div>

  <script>
    // Constants
    const MM_PER_METER = 1000;
    const MM_PER_INCH = 25.4;
    const MM_PER_FOOT = MM_PER_INCH * 12;
    const METER_TO_FEET = 3.28084;
    const PIXELS_PER_PORT_DEFAULT = 650000; // fallback for SMD models

    // Buffers
    const CONTROLLER_PORT_BUFFER = 1.2; // 20% extra ports

    // LED list (kept same)
    const LED_PRODUCTS = {
      'cob_09': { name: "PeopleLink COB (0.9375mm)", pitch_mm: 0.9375, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 640, cabPixH: 360, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-1000", maxPower_W_m2: 300 },
      'cob_125': { name: "PeopleLink COB (1.25mm)", pitch_mm: 1.25, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 480, cabPixH: 270, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-800", maxPower_W_m2: 300 },
      'cob_15': { name: "PeopleLink COB (1.5625mm)", pitch_mm: 1.5625, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 384, cabPixH: 216, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-800", maxPower_W_m2: 300 },
      'indoor_186': { name: "PeopleLink SMD Indoor (1.86mm)", pitch_mm: 1.86, cabW_mm: 640, cabH_mm: 480, cabPixW: 344, cabPixH: 258, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 },
      'indoor_20': { name: "PeopleLink SMD Indoor (2.0mm)", pitch_mm: 2.0, cabW_mm: 640, cabH_mm: 480, cabPixW: 320, cabPixH: 240, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 },
      'indoor_25': { name: "PeopleLink SMD Indoor (2.5mm)", pitch_mm: 2.5, cabW_mm: 640, cabH_mm: 480, cabPixW: 256, cabPixH: 192, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 },
      'outdoor_40': { name: "PeopleLink SMD Outdoor (4.0mm)", pitch_mm: 4.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 240, cabPixH: 240, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 },
      'outdoor_667': { name: "PeopleLink SMD Outdoor (6.67mm)", pitch_mm: 6.67, cabW_mm: 960, cabH_mm: 960, cabPixW: 144, cabPixH: 144, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 },
      'outdoor_80': { name: "PeopleLink SMD Outdoor (8.0mm)", pitch_mm: 8.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 120, cabPixH: 120, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 },
      'outdoor_100': { name: "PeopleLink SMD Outdoor (10.0mm)", pitch_mm: 10.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 96, cabPixH: 96, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 }
    };

    // controller model list (kept simple for selection)
    const CONTROLLER_MODELS = [
      { name: "TB40", type: "Multimedia Player", ports: 2, maxPixels: 1300000 },
      { name: "TB60", type: "Multimedia Player", ports: 4, maxPixels: 2300000 },
      { name: "VX400 Pro", type: "All-in-One", ports: 4, maxPixels: 2600000 },
      { name: "VX600 Pro", type: "All-in-One", ports: 6, maxPixels: 3900000 },
      { name: "VX1000 Pro", type: "All-in-One", ports: 10, maxPixels: 6500000 },
      { name: "4K Prime", type: "All-in-One", ports: 16, maxPixels: 10400000 },
      { name: "H5 (5U)", type: "Modular Splicer", ports: 20, maxPixels: 39000000 }
    ];

    // H-series defaults (kept)
    const H_SERIES_DEFAULTS = {
      SPLICER_NAME: "H-Series Modular Splicer Frame",
      INPUT_CARD_OPTIONS: [
        { model: "H_1xHDMI2.0 input card (4K)", display: "1x 4K HDMI (Single Input)", qty: 1 },
        { model: "H_2xHDMI2.0 input card (4K)", display: "2x 4K HDMI (Dual Input)", qty: 1 },
        { model: "H_4xHDMI input card (1080P)", display: "4x FHD HDMI (Quad Input)", qty: 1 }
      ],
      DEFAULT_INPUT_CARD_MODEL: "H_1xHDMI2.0 input card (4K)",
      DEFAULT_INPUT_CARD_QTY: 2,
      OUTPUT_CARD_20_PORTS: 20,
      OUTPUT_CARD_20_MODEL: "H_20xRJ45 Sending Card",
      OUTPUT_CARD_16_PORTS: 16,
      OUTPUT_CARD_16_MODEL: "H_16xRJ45 Sending Card"
    };

    // global store
    let finalCalculationData = {};
    let contactInfo = { email: '', phone: '' };

    function formatNumber(n,d=1){return n.toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d});}
    function formatLargeNumber(n){if(n>=1e6)return(n/1e6).toFixed(2)+"M";if(n>=1e3)return(n/1e3).toFixed(1)+"K";return n.toLocaleString();}
    function gcd(a,b){return b===0?a:gcd(b,a%b);}

    function toggleMeasurementFields(){
      const unit = document.getElementById('unit').value;
      const isDiagonal = (unit === 'inches');
      const isFeet = (unit === 'feet');
      let unitText = ' (m)';
      if (isFeet) unitText = ' (ft)';
      if (isDiagonal) unitText = ' (in)';

      document.getElementById('widthLabel').textContent = `Desired Width${unitText}`;
      document.getElementById('heightLabel').textContent = `Desired Height${unitText}`;

      document.getElementById('widthGroup').style.display = isDiagonal ? 'none' : 'block';
      document.getElementById('heightGroup').style.display = isDiagonal ? 'none' : 'block';
      document.getElementById('diagonalGroup').style.display = isDiagonal ? 'block' : 'none';

      document.getElementById('errorMessage').style.display = 'none';
    }

    function populateModalControllers(){
      const s = document.getElementById('modalControllerModel'); s.innerHTML='';
      CONTROLLER_MODELS.forEach(c=>{const o=document.createElement('option');o.value=c.name;o.textContent=`${c.name} (${c.type})`;s.appendChild(o)});
    }
    function populateModalOutputCards(){
      const s=document.getElementById('modalOutputCardModel');s.innerHTML='';
      const cards=[{model:H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL,ports:H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS},{model:H_SERIES_DEFAULTS.OUTPUT_CARD_16_MODEL,ports:H_SERIES_DEFAULTS.OUTPUT_CARD_16_PORTS}];
      cards.forEach(card=>{const o=document.createElement('option');o.value=`${card.model}|${card.ports}`;o.textContent=`${card.model} (${card.ports} ports)`;s.appendChild(o)});
    }
    function populateModalInputCards(){const s=document.getElementById('modalInputCardModel');s.innerHTML='';H_SERIES_DEFAULTS.INPUT_CARD_OPTIONS.forEach(opt=>{const o=document.createElement('option');o.value=`${opt.model}|${opt.qty}`;o.textContent=opt.display;s.appendChild(o)})}
    function updatePortsFromOutputCard(){const v=document.getElementById('modalOutputCardModel').value.split('|');document.getElementById('modalMaxPortsPerCard').value=v[1]||''}

    function openControllerModal(){
      populateModalControllers();populateModalOutputCards();populateModalInputCards();
      // prefill from finalCalculationData if present
      const suggested = finalCalculationData.controllerOverrideName || finalCalculationData.controllerName || '';
      if(suggested) { const sel=document.getElementById('modalControllerModel'); if(Array.from(sel.options).some(o=>o.value===suggested)) sel.value=suggested; }
      document.getElementById('modalSplicerSolution')?.value && (document.getElementById('modalSplicerSolution').value = finalCalculationData.splicerSolution || H_SERIES_DEFAULTS.SPLICER_NAME);
      document.getElementById('controllerModal').style.display='block';
    }
    function closeControllerModal(){document.getElementById('controllerModal').style.display='none'}
    function applyModalChanges(){
      finalCalculationData.controllerOverrideName = document.getElementById('modalControllerModel').value;
      const [model,ports] = (document.getElementById('modalOutputCardModel').value||'').split('|');
      finalCalculationData.outputCardModel = model;
      finalCalculationData.outputCardPorts = ports ? parseInt(ports) : H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS;
      const inSel=document.getElementById('modalInputCardModel').value.split('|')[0];
      finalCalculationData.inputCardModel = inSel || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL;
      finalCalculationData.inputCardQty = parseInt(document.getElementById('modalInputCardQty').value) || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;
      closeControllerModal();
      showVisualization();
    }

    function getSuggestedControllerModel(totalPixels, finalResW, finalResH, productKey){
      // Basic suggestion based on pixel count (kept simple)
      return CONTROLLER_MODELS.find(c=>c.maxPixels && c.maxPixels >= totalPixels) || CONTROLLER_MODELS[CONTROLLER_MODELS.length-1];
    }

    function calculateLEDWall(){
      const productKey = document.getElementById('productModel').value;
      const unit = document.getElementById('unit').value;
      const widthInput = parseFloat(document.getElementById('width').value || 0);
      const heightInput = parseFloat(document.getElementById('height').value || 0);
      const diagonalInput = parseFloat(document.getElementById('diagonal').value || 0);
      const aspectRatioKey = document.getElementById('aspectRatio').value;

      const err = document.getElementById('errorMessage');
      err.style.display='none';

      if(!productKey || !unit || ((unit!=='inches' && !widthInput && !heightInput) || (unit==='inches' && !diagonalInput))){
        err.textContent = 'ERROR: select model, unit and enter valid dimension(s).';
        err.style.display='block';
        return null;
      }

      const details = LED_PRODUCTS[productKey];
      const cabinetW_mm = details.cabW_mm;
      const cabinetH_mm = details.cabH_mm;

      let desiredW_mm=0, desiredH_mm=0;
      if(unit === 'inches'){
        const ratioToUse = aspectRatioKey || '16:9';
        const [rw,rh] = ratioToUse.split(':').map(Number);
        const diagFactor = diagonalInput / Math.sqrt(rw*rw + rh*rh);
        desiredW_mm = rw * diagFactor * MM_PER_INCH;
        desiredH_mm = rh * diagFactor * MM_PER_INCH;
      } else {
        const unitFactor = (unit==='meters') ? MM_PER_METER : MM_PER_FOOT;
        if(aspectRatioKey){
          const [rw,rh] = aspectRatioKey.split(':').map(Number);
          if(widthInput>0){ desiredW_mm = widthInput * unitFactor; desiredH_mm = (widthInput/rw)*rh*unitFactor; }
          else { desiredH_mm = heightInput * unitFactor; desiredW_mm = (heightInput/rh)*rw*unitFactor; }
        } else {
          desiredW_mm = (widthInput>0 ? widthInput : (heightInput*(cabinetW_mm/cabinetH_mm))) * unitFactor;
          desiredH_mm = (heightInput>0 ? heightInput : (widthInput*(cabinetH_mm/cabinetW_mm))) * unitFactor;
        }
      }

      // cabinet counts
      const numCabW = Math.max(1, Math.round(desiredW_mm / cabinetW_mm));
      const numCabH = Math.max(1, Math.round(desiredH_mm / cabinetH_mm));
      const totalCabinets = numCabW * numCabH;
      const totalModules = totalCabinets * details.modulesPerCab;
      const finalW_mm = numCabW * cabinetW_mm;
      const finalH_mm = numCabH * cabinetH_mm;
      const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);

      const finalResW = numCabW * details.cabPixW;
      const finalResH = numCabH * details.cabPixH;
      const totalPixels = finalResW * finalResH;
      const ratioG = gcd(finalResW, finalResH);
      const aspectRatioText = `${finalResW/ratioG}:${finalResH/ratioG}`;
      const finalDiagonal_in = Math.sqrt(finalW_mm*finalW_mm + finalH_mm*finalH_mm) / MM_PER_INCH;

      // power & weight
      const actualPower_W_unbuffered = finalArea_m2 * details.maxPower_W_m2;
      const actualCurrent_A = actualPower_W_unbuffered / 220;
      const actualCabinetWeight_unbuffered = details.weight_kg * totalCabinets;

      // Determine long ethernet ports based on model rules provided
      let requiredLongPortsRaw = 1;
      if(productKey.startsWith('cob_')){
        // COB rules: per user instruction
        const map = { 'cob_09': 2, 'cob_125': 5, 'cob_15': 7 };
        const perCable = map[productKey] || 2;
        requiredLongPortsRaw = Math.max(1, Math.ceil(totalCabinets / perCable));
      } else {
        // SMD indoor/outdoor: fallback to pixels-per-port method
        requiredLongPortsRaw = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_DEFAULT));
      }

      // add 20% buffer ports for controller (as requested)
      const requiredPortsWithBuffer = Math.max(1, Math.ceil(requiredLongPortsRaw * CONTROLLER_PORT_BUFFER));

      // required sending cards etc â€” keep conservative mapping to output card ports or defaults
      const outputCardPorts = finalCalculationData.outputCardPorts || H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS;
      const requiredSendCards = Math.max(1, Math.ceil(requiredPortsWithBuffer / outputCardPorts));

      const suggestedController = getSuggestedControllerModel(totalPixels, finalResW, finalResH, productKey);

      finalCalculationData = {
        ...finalCalculationData,
        productName: details.name,
        pixelPitch_mm: details.pitch_mm,
        cabinetW_mm, cabinetH_mm,
        cabPixW: details.cabPixW, cabPixH: details.cabPixH,
        numCabW, numCabH, totalCabinets, totalModules,
        finalW_mm, finalH_mm, finalArea_m2,
        finalResW, finalResH, totalPixels,
        aspectRatioText, finalDiagonal_in,
        actualPower_W_unbuffered, actualCurrent_A, actualCabinetWeight_unbuffered,
        requiredLongPortsRaw, requiredPortsWithBuffer, requiredSendCards,
        outputCardPorts: outputCardPorts,
        controllerName: finalCalculationData.controllerOverrideName || suggestedController.name,
        controllerType: suggestedController.type || 'Processor/Controller',
        inputCardModel: finalCalculationData.inputCardModel || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL,
        inputCardQty: finalCalculationData.inputCardQty || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY,
        splicerSolution: finalCalculationData.splicerSolution || (suggestedController.type && suggestedController.type.includes('Splicer') ? H_SERIES_DEFAULTS.SPLICER_NAME : 'N/A')
      };

      return finalCalculationData;
    }

    function calculateDimensions(data){
      return {
        finalW_M: data.finalW_mm / MM_PER_METER,
        finalH_M: data.finalH_mm / MM_PER_METER,
        finalW_FT: data.finalW_mm / MM_PER_FOOT,
        finalH_FT: data.finalH_mm / MM_PER_FOOT
      };
    }

    function showVisualization(){
      const data = calculateLEDWall();
      if(!data) return;

      const dims = calculateDimensions(data);

      // update header/summary
      document.getElementById('enteredSummaryText').textContent = `Cabinet Matrix: ${data.numCabW} x ${data.numCabH} (${data.totalCabinets} cabinets)`;
      document.getElementById('aspectRatioValue').textContent = data.aspectRatioText;
      document.getElementById('enteredValuesDisplay').style.display = 'block';

      // UI changes
      document.getElementById('formContainer').classList.add('minimized');
      document.getElementById('visualization').classList.add('visible');
      document.getElementById('visualization').setAttribute('aria-hidden', 'false');
      document.getElementById('submitButton').style.display = 'none';

      // fill spec fields
      document.getElementById('pixelPitchDisplay').textContent = `${data.pixelPitch_mm} mm`;
      document.getElementById('finalDimensions').textContent = `(${dims.finalW_FT.toFixed(2)}ft x ${dims.finalH_FT.toFixed(2)}ft) - ${dims.finalW_M.toFixed(2)}m x ${dims.finalH_M.toFixed(2)}m`;
      document.getElementById('resolution').textContent = `${data.finalResW} x ${data.finalResH}`;
      document.getElementById('numCabinets').textContent = `${data.totalCabinets} (${data.numCabW} x ${data.numCabH})`;
      document.getElementById('totalModules').textContent = `${data.totalModules}`;
      document.getElementById('finalDiagonal').textContent = `${data.finalDiagonal_in.toFixed(1)} in`;
      document.getElementById('finalArea').textContent = `${data.finalArea_m2.toFixed(2)} mÂ²`;
      document.getElementById('totalPixels').textContent = `${formatLargeNumber(data.totalPixels)}`;

      // control system details
      const cdiv = document.getElementById('controlSystemDetails');
      cdiv.innerHTML = `
        <span><strong>Controller</strong><small>${data.controllerName} (${data.controllerType})</small></span>
        <span><strong>Long Ethernet Runs (raw)</strong><small>${data.requiredLongPortsRaw}</small></span>
        <span><strong>Controller Ports (with 20% buffer)</strong><small>${data.requiredPortsWithBuffer}</small></span>
        <span><strong>Sending Cards (estimated)</strong><small>${data.requiredSendCards} x ${data.outputCardPorts}ports</small></span>
        <span><strong>Input Cards</strong><small>${data.inputCardQty} x ${data.inputCardModel}</small></span>
      `;

      // Responsive preview sizing: compute width available within main wrapper
      const visArea = document.getElementById('visArea');
      const wrapper = document.querySelector('.main-wrapper');
      const maxPreviewWidth = 880;
      const gutter = 24;
      const available = Math.min(maxPreviewWidth, wrapper.clientWidth - gutter);
      const aspectRatio = Math.max(0.1, data.finalW_mm / data.finalH_mm); // prevent divide by 0
      // choose width = available, height = width / aspectRatio; constrain height to reasonable range
      let areaWidth = Math.max(220, Math.min(available, maxPreviewWidth));
      let areaHeight = Math.max(120, Math.min(720, Math.round(areaWidth / aspectRatio)));

      visArea.style.width = areaWidth + 'px';
      visArea.style.height = areaHeight + 'px';

      document.getElementById('dimTop').textContent = `${dims.finalW_M.toFixed(2)} m (W)`;
      document.getElementById('dimRight').textContent = `${dims.finalH_M.toFixed(2)} m (H)`;

      // render cabinet overlay grid inside the visArea (absolute fill)
      const overlay = document.getElementById('cabinetOverlay');
      overlay.innerHTML = '';

      // set CSS grid template based on cabinet counts
      overlay.style.gridTemplateColumns = `repeat(${data.numCabW}, 1fr)`;
      overlay.style.gridTemplateRows = `repeat(${data.numCabH}, 1fr)`;

      const totalCells = data.numCabW * data.numCabH;
      const maxCellsForRender = 240;
      if(totalCells > maxCellsForRender){
        const hint = document.createElement('div');
        hint.style.display='flex';
        hint.style.alignItems='center';
        hint.style.justifyContent='center';
        hint.style.fontSize='13px';
        hint.style.color='#1c2738';
        hint.textContent = `${data.numCabW} x ${data.numCabH} cabinets â€” preview simplified`;
        overlay.appendChild(hint);
      } else {
        for(let r=0;r<data.numCabH;r++){
          for(let c=0;c<data.numCabW;c++){
            const d = document.createElement('div');
            overlay.appendChild(d);
          }
        }
      }

      // show pdf button
      const dl = document.getElementById('downloadPdf');
      if(dl) dl.style.display = 'inline-block';
    }

    function hideVisualization(){
      document.getElementById('formContainer').classList.remove('minimized');
      document.getElementById('visualization').classList.remove('visible');
      document.getElementById('visualization').setAttribute('aria-hidden', 'true');
      document.getElementById('submitButton').style.display = 'block';
      document.getElementById('enteredValuesDisplay').style.display = 'none';
      const dl = document.getElementById('downloadPdf'); if(dl) dl.style.display='none';
    }

    function proceedToDownloadPdf(){
      const data = finalCalculationData;
      if(!data || !data.finalResW){
        document.getElementById('errorMessage').textContent = 'ERROR: calculate configuration first.';
        document.getElementById('errorMessage').style.display='block';
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p','mm','a4');
      const margin = 14;
      let y = 10;
      const pageW = doc.internal.pageSize.getWidth();

      doc.setFontSize(16); doc.setTextColor(13,71,161);
      doc.text('PeopleLink LED Video Wall Technical Summary', pageW/2, y, {align:'center'});
      y += 8;
      doc.setFontSize(8);
      doc.setTextColor(60,60,60);
      doc.text(`Generated: ${new Date().toLocaleDateString()} | Model: ${data.productName}`, pageW/2, y, {align:'center'});
      y += 8;

      // Wall basic table
      doc.setFontSize(11); doc.setTextColor(183,28,28);
      doc.text('1. Wall Performance & Dimensions', margin, y); y+=6;
      const dims = calculateDimensions(data);

      const performance = [
        ['Actual Final Dimensions (WxH):', `(${dims.finalW_FT.toFixed(2)}ft x ${dims.finalH_FT.toFixed(2)}ft) - ${dims.finalW_M.toFixed(2)}m x ${dims.finalH_M.toFixed(2)}m`],
        ['Resolution (WxH):', `${data.finalResW} x ${data.finalResH}`],
        ['Aspect Ratio:', data.aspectRatioText],
        ['Final Diagonal:', `${data.finalDiagonal_in.toFixed(1)} in`],
        ['Total Pixels / Area:', `${formatLargeNumber(data.totalPixels)} / ${data.finalArea_m2.toFixed(2)} mÂ²`]
      ];

      doc.autoTable({
        startY: y+2,
        body: performance,
        margin:{left:margin,right:margin},
        styles:{fontSize:8},
        columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}}
      });
      y = doc.lastAutoTable.finalY + 6;

      // Controller & ports
      doc.setFontSize(11); doc.setTextColor(13,71,161);
      doc.text('2. Control & Connections', margin, y); y+=6;

      const controllerTable = [
        ['Controller Model:', `${data.controllerName} (${data.controllerType})`],
        ['Long Ethernet Runs (raw):', `${data.requiredLongPortsRaw}`],
        ['Controller Ports (with 20% buffer):', `${data.requiredPortsWithBuffer}`],
        ['Sending Cards (estimated):', `${data.requiredSendCards} x ${data.outputCardPorts} ports`]
      ];

      doc.autoTable({
        startY:y+2,
        body:controllerTable,
        margin:{left:margin,right:margin},
        styles:{fontSize:8},
        columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}}
      });
      y = doc.lastAutoTable.finalY + 8;

      // BOQ: brief
      doc.setFontSize(11); doc.setTextColor(13,71,161);
      doc.text('3. Bill of Quantities (Summary)', margin, y); y+=6;

      const boq = [
        ['Item','Model/Description','Qty','Unit'],
        ['LED Cabinets', data.productName, data.totalCabinets, 'PCS'],
        ['Controller', data.controllerName, 1, 'PCS'],
        ['Receiving Cards', 'Embedded in cabinet', data.totalCabinets, 'PCS'],
        ['Long Ethernet Runs','Controller to wall', data.requiredPortsWithBuffer || data.requiredPortsWithBuffer, 'PCS']
      ];

      doc.autoTable({
        startY:y+2,
        head:[boq[0]],
        body:boq.slice(1),
        margin:{left:margin,right:margin},
        styles:{fontSize:8},
        headStyles:{fillColor:[13,71,161]}
      });

      // footer small
      doc.setFontSize(8);
      doc.setTextColor(120,120,120);
      doc.text('Â© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala', pageW/2, doc.internal.pageSize.getHeight()-10, {align:'center'});

      doc.save(`PeopleLink_LED_Config_${data.finalResW}x${data.finalResH}_BOQ.pdf`);
    }

    // initial setup
    document.addEventListener('DOMContentLoaded',()=>{
      toggleMeasurementFields();
      populateModalControllers();
      populateModalOutputCards();
      populateModalInputCards();
      // hide download by default
      document.getElementById('downloadPdf').style.display='none';
      window.onclick = function(e){ const m=document.getElementById('controllerModal'); if(e.target==m) m.style.display='none' };
      // small UX: recalc when window resizes to keep preview responsive
      window.addEventListener('resize', ()=>{ if(document.getElementById('visualization').classList.contains('visible')) showVisualization(); });
    });

  </script>
</body>
</html>
