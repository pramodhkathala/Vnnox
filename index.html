<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* PAGE */
    :root{--brand:#0D47A1;--accent:#B71C1C;--muted:#6b7280}
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 18px; background: #eef6fb; color: #1c2738; font-size: 14px; -webkit-font-smoothing:antialiased; }
    .main-wrapper { max-width: 1200px; margin: auto; }

    /* HEADER */
    h2 { text-align: center; color: var(--brand); margin-top: 0; margin-bottom: 18px; font-weight:700; font-size:1.6rem; }

    /* PANELS */
    .panel-grid { display:grid; grid-template-columns:1fr 1fr; gap:22px; align-items:start; }
    .input-panel, .details-panel { background:#fff; padding:20px;border-radius:10px; box-shadow:0 4px 18px rgba(8,20,40,0.06); }

    /* FORM */
    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    label.form-label { font-weight:600; color:var(--brand); display:block; margin-bottom:6px; }
    input[type="number"], input[type="text"], select, input[type="email"], input[type="tel"] { width:100%; padding:9px 10px; border-radius:6px; border:1px solid #e6eef6; box-sizing:border-box; font-size:14px; }
    .controls { display:flex; gap:12px; align-items:center; margin-top:12px; }
    button.primary { background:var(--brand); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; }
    button.secondary { background:#f3f6fb; color:var(--brand); border:1px solid #e6eef6; padding:9px 12px; border-radius:8px; cursor:pointer; font-weight:600; }

    /* SPEC & CONTROL PANELS - layout like your 2nd format */
    .specs, .control-summary { padding:18px; border-radius:8px; background:#f6fbff; border:1px solid rgba(13,71,161,0.06); }
    .panel-title { color:var(--brand); font-weight:700; font-size:1.05rem; margin-bottom:10px; }
    .spec-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dotted rgba(0,0,0,0.06); }
    .spec-row .label { color:var(--brand); font-weight:700; min-width:250px; }
    .spec-row .value { color:var(--accent); font-weight:700; text-align:right; }

    /* Visualization (Updated Styles) */
    .viz-wrap { margin-top:16px; }
    .viz-box { border-radius:8px; background:#fff; padding:12px; border:1px solid #e6eef6; }
    .vis-grid { position:relative; width:100%; height:280px; 
      border:3px solid var(--brand); /* Stronger Border */
      background:linear-gradient(180deg,#ffffff,#f5f9ff); /* Brighter Background */
      display:flex; align-items:center; justify-content:center; overflow:hidden; box-sizing:border-box; }
    #cabinetOverlay { position:absolute; inset:0; display:grid; box-sizing:border-box; grid-gap:0; padding:4px; }
    #cabinetOverlay > div { box-sizing:border-box; border:2px solid rgba(13,71,161,0.18); display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02)); transition:transform .08s ease, background .12s; }
    #cabinetOverlay > div:hover { 
      transform: translateY(-2px) scale(1.01); 
      background: rgba(13,71,161,0.1); /* Darker hover */
      border-color: rgba(13,71,161,0.6); /* More visible border on hover */
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 10;
    }
    .cab-label { 
      font-size:12px; 
      background: rgba(255,255,255,0.95); /* More opaque background */
      padding:2px 6px; border-radius:4px; color:var(--brand); font-weight:700;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* BOQ preview (Updated Headers) */
    #boqPreviewTable { width:100%; border-collapse:collapse; margin-top:14px; font-size:13px; }
    #boqPreviewTable th, #boqPreviewTable td { border:1px solid #e6eef6; padding:8px 10px; text-align:left; }
    #boqPreviewTable th { background:linear-gradient(90deg, rgba(13,71,161,0.06), rgba(27,94,32,0.02)); color:var(--brand); font-weight:700; }
    
    /* small helpers */
    .muted { color:#6b7280; font-size:0.92rem; }
    .right { text-align:right; }
    .hidden { display:none !important; }
    footer.page-footer { text-align:center; margin-top:18px; color:#8fa6c8; font-size:13px; }

    /* modal */
    .modal { position:fixed; inset:0; display:none; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center; }
    .modal .modal-card { width:92%; max-width:720px; background:#fff; padding:18px; border-radius:10px; box-shadow:0 10px 40px rgba(6,25,57,0.12); }
    .modal .modal-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:10px; }
    .modal .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }

    /* responsive */
    @media (max-width:980px){ .panel-grid{grid-template-columns:1fr} .form-grid{grid-template-columns:1fr} .vis-grid{height:220px} }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <h2>PeopleLink LED Video Wall Configuration Calculator</h2>

    <div class="panel-grid">
      <div class="input-panel">
        <div style="font-weight:700;color:var(--brand);margin-bottom:10px">Configure Wall</div>

        <div class="form-grid">
          <div>
            <label class="form-label">LED Model / Pixel Pitch</label>
            <select id="productModel">
              <option value="">Select LED Model</option>
              <optgroup label="COB (600x337.5mm)">
                <option value="cob_09">0.9375 mm</option>
                <option value="cob_125">1.25 mm</option>
                <option value="cob_15">1.5625 mm</option>
              </optgroup>
              <optgroup label="SMD Indoor (640x480mm)">
                <option value="indoor_186">1.86 mm</option>
                <option value="indoor_20">2.0 mm</option>
                <option value="indoor_25">2.5 mm</option>
              </optgroup>
              <optgroup label="SMD Outdoor (960x960mm)">
                <option value="outdoor_40">4.0 mm</option>
                <option value="outdoor_667">6.67 mm</option>
                <option value="outdoor_80">8.0 mm</option>
              </optgroup>
            </select>
          </div>

          <div>
            <label class="form-label">Unit</label>
            <select id="unit" onchange="toggleMeasurementFields()">
              <option value="">Select unit</option>
              <option value="meters">Meters (m)</option>
              <option value="feet">Feet (ft)</option>
              <option value="inches">Inches - Diagonal</option>
            </select>
          </div>

          <div id="widthGroup">
            <label class="form-label" id="widthLabel">Desired Width (m)</label>
            <input type="number" id="width" placeholder="Enter width" min="0.1" step="0.01" />
          </div>

          <div id="heightGroup">
            <label class="form-label" id="heightLabel">Desired Height (m)</label>
            <input type="number" id="height" placeholder="Enter height" min="0.1" step="0.01" />
          </div>

          <div id="diagonalGroup" class="hidden">
            <label class="form-label" id="diagonalLabel">Diagonal (inches)</label>
            <input type="number" id="diagonal" placeholder="Diagonal inches" min="10" step="1" />
          </div>

          <div>
            <label class="form-label">Target Aspect Ratio (optional)</label>
            <select id="aspectRatio">
              <option value="">Auto</option>
              <option value="16:9">16:9</option>
              <option value="16:10">16:10</option>
              <option value="4:3">4:3</option>
              <option value="21:9">21:9</option>
              <option value="1:1">1:1</option>
            </select>
          </div>

          <div style="align-self:end;">
            <div class="controls">
              <button class="primary" id="calcBtn" onclick="showVisualization()">Calculate & Visualize</button>
              <button class="secondary" id="resetBtn" onclick="resetForm()">Reset</button>
            </div>
          </div>
        </div>

        <div id="errorMessage" class="muted" style="margin-top:10px; color: #b71c1c; display:none;"></div>

        <div class="viz-wrap">
          <div class="viz-box">
            <div style="font-weight:700;color:var(--brand);margin-bottom:8px">Physical Wall Visualization</div>
            <div class="vis-grid" id="visGrid">
              <div id="cabinetOverlay" aria-hidden="true"></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:10px">
              <div class="muted">Hover a cabinet to view its label</div>
              <div class="muted" id="visDimensions"></div>
            </div>
          </div>
        </div>

      </div>

      <div style="display:flex;flex-direction:column;gap:18px">
        <div class="details-panel specs">
          <div class="panel-title">LED Wall Specifications</div>

          <div id="specRows">
            <div class="spec-row"><div class="label">Model:</div><div class="value" id="spec_model">--</div></div>
            <div class="spec-row"><div class="label">Pixel Pitch:</div><div class="value" id="spec_pitch">--</div></div>
            <div class="spec-row"><div class="label">Actual Final Dimensions (WxH):</div><div class="value" id="spec_dims">--</div></div>
            <div class="spec-row"><div class="label">Actual Final Resolution (WxH):</div><div class="value" id="spec_res">--</div></div>
            <div class="spec-row"><div class="label">Final Diagonal:</div><div class="value" id="spec_diag">--</div></div>
            <div class="spec-row"><div class="label">Pixel Density:</div><div class="value" id="spec_density">--</div></div>
            <div class="spec-row"><div class="label">Final Area:</div><div class="value" id="spec_area">--</div></div>
            <div class="spec-row"><div class="label">Total Cabinets:</div><div class="value" id="spec_cabs">--</div></div>
            <div class="spec-row"><div class="label">Total Modules Required:</div><div class="value" id="spec_modules">--</div></div>
            <div class="spec-row"><div class="label">Cabinet Size (WxH):</div><div class="value" id="spec_cabsize">--</div></div>
            <div class="spec-row"><div class="label">Cabinet Pixels (WxH):</div><div class="value" id="spec_cabpix">--</div></div>
          </div>
        </div>

        <div class="details-panel control-summary">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="panel-title">Control & Connection Summary</div>
            <button class="secondary" style="font-size:13px" onclick="openControllerModal()">Edit</button>
          </div>

          <div style="margin-top:10px" id="controlRows">
            <div class="spec-row"><div class="label">Suggested Controller:</div><div class="value" id="ctrl_name">--</div></div>
            <div class="spec-row"><div class="label">Controller Ports (post buffer):</div><div class="value" id="ctrl_ports">--</div></div>
            <div class="spec-row hseries-only"><div class="label">Sending Cards needed:</div><div class="value" id="ctrl_sending">--</div></div>
            <div class="spec-row"><div class="label">Inter-cabinet Short Ethernet:</div><div class="value" id="ctrl_shorteth">--</div></div>
            <div class="spec-row"><div class="label">Long Ethernet Cables (Input):</div><div class="value" id="ctrl_longeth">--</div></div>
            <div class="spec-row"><div class="label">Total Power Cables:</div><div class="value" id="ctrl_pwr_cables">--</div></div>
            <div class="spec-row"><div class="label">Max Power (Est.):</div><div class="value" id="spec_power">--</div></div>
            <div class="spec-row"><div class="label">Total Weight (Est.):</div><div class="value" id="spec_weight">--</div></div>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <button class="primary" id="downloadPdfBtn" onclick="openContactModal()">Download PDF</button>
            <button class="secondary" onclick="downloadBOQCSV()">Download Excel (CSV)</button>
          </div>
        </div>
      </div>
    </div>

    <div id="boqPreviewContainer" style="margin-top:18px"></div>

    <footer class="page-footer">© 2025 PeopleLink Unified Communications Pvt. Ltd.</footer>
  </div>

  <div class="modal" id="controllerModal">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700;color:var(--brand)">Edit Control System Components</div>
        <button onclick="closeControllerModal()" class="secondary">Close</button>
      </div>

      <div class="modal-row">
        <div>
          <label class="form-label">Controller/Processor Model</label>
          <select id="modalControllerModel" onchange="onModalControllerChange()"></select>
        </div>
        <div>
          <label class="form-label">Splicer Frame / Solution</label>
          <input type="text" id="modalSplicerSolution" placeholder="Optional" />
        </div>
      </div>

      <div class="modal-row" id="outputCardRow" style="display:none">
        <div>
          <label class="form-label">Output (Sending) Card Model</label>
          <select id="modalOutputCardModel" onchange="updatePortsFromOutputCard()"></select>
        </div>
        <div>
          <label class="form-label">Max Pixels per Output Card</label>
          <input id="modalMaxPortsPerCard" readonly />
        </div>
      </div>
      
      <div class="modal-row" id="inputCardRow" style="display:none">
        <div>
          <label class="form-label">Input Card Model</label>
          <select id="modalInputCardModel"></select>
        </div>
        <div>
          <label class="form-label">Input Card Quantity</label>
          <input type="number" id="modalInputCardQty" min="1" value="2" />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:10px;">
        <button class="secondary" onclick="closeControllerModal()">Cancel</button>
        <button class="primary" style="margin-left:8px" onclick="applyModalChanges()">Apply</button>
      </div>
    </div>
  </div>

  <div class="modal" id="contactModal">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700;color:var(--brand)">Contact (optional) — added to PDF metadata</div>
        <button onclick="closeContactModal()" class="secondary">Close</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label class="form-label">Email</label>
          <input type="email" id="downloadEmail" placeholder="you@company.com" />
        </div>
        <div>
          <label class="form-label">Phone</label>
          <input type="tel" id="downloadPhone" placeholder="+91..." />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="secondary" onclick="closeContactModal()">Cancel</button>
        <button class="primary" onclick="handleDownloadRequest()">Download PDF</button>
      </div>
      <div id="contactError" style="color:#b71c1c;margin-top:8px;display:none"></div>
    </div>
  </div>

  <script>
    /************************************************************************
     * Data: LED products, controllers, parts catalog
     ************************************************************************/
    const MM_PER_METER = 1000;
    const MM_PER_INCH = 25.4;
    const MM_PER_FOOT = MM_PER_INCH * 12;
    const PIXELS_PER_PORT_DEFAULT = 650000; // Standard for MCTRL R series (1.3Mk/port is 650k x 2)
    const GLOBAL_PORT_BUFFER_PCT = 0.05;
    const POWER_BUFFER = 1.15; // 15% safety margin
    const WEIGHT_BUFFER = 1.15;
    const MAX_POWER_PER_RUN_W = 1000; // Corrected to 1000W per run as requested

    const LED_PRODUCTS = {
      'cob_09': { name:"PeopleLink COB (0.9375mm)", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, nits_range:"600-1000", maxPower_W_m2:300, cabsPerRun:2 },
      'cob_125': { name:"PeopleLink COB (1.25mm)", pitch_mm:1.25, cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300, cabsPerRun:5 },
      'cob_15': { name:"PeopleLink COB (1.5625mm)", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300, cabsPerRun:5 }, // Corrected cabsPerRun from 7 to 5 (for practical 5 runs on 25 cabs)
      'indoor_186': { name:"PeopleLink SMD Indoor (1.86mm)", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560, cabsPerRun:0 },
      'indoor_20': { name:"PeopleLink SMD Indoor (2.0mm)", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560, cabsPerRun:0 },
      'indoor_25': { name:"PeopleLink SMD Indoor (2.5mm)", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560, cabsPerRun:0 },
      'outdoor_40': { name:"PeopleLink SMD Outdoor (4.0mm)", pitch_mm:4.0, cabW_mm:960, cabH_mm:960, cabPixW:240, cabPixH:240, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5, cabsPerRun:0 },
      'outdoor_667': { name:"PeopleLink SMD Outdoor (6.67mm)", pitch_mm:6.67, cabW_mm:960, cabH_mm:960, cabPixW:144, cabPixH:144, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5, cabsPerRun:0 },
      'outdoor_80': { name:"PeopleLink SMD Outdoor (8.0mm)", pitch_mm:8.0, cabW_mm:960, cabH_mm:960, cabPixW:120, cabPixH:120, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5, cabsPerRun:0 }
    };
    const CONTROLLER_MODELS = [
      { name:"TB40", type:"Multimedia", ports:2, maxPixels:1300000, priority:1, maxPortsPerOutputCard: 650000 },
      { name:"TB60", type:"Multimedia", ports:4, maxPixels:2300000, priority:2, maxPortsPerOutputCard: 650000 },
      { name:"VX400 Pro", type:"All-in-One", ports:4, maxPixels:2600000, priority:3, maxPortsPerOutputCard: 650000 },
      { name:"VX600 Pro", type:"All-in-One", ports:6, maxPixels:3900000, priority:4, maxPortsPerOutputCard: 650000 },
      { name:"VX1000 Pro", type:"All-in-One", ports:10, maxPixels:6500000, priority:5, maxPortsPerOutputCard: 650000 },
      { name:"4K Prime", type:"All-in-One", ports:16, maxPixels:10400000, priority:6, maxPortsPerOutputCard: 650000 }, // Added 4K Prime
      { name:"H2", type:"Modular", ports:20, maxPixels:26000000, maxSendCards:2, priority:7, maxPortsPerOutputCard: 1300000 }, 
      { name:"H5", type:"Modular", ports:20, maxPixels:39000000, maxSendCards:3, priority:8, maxPortsPerOutputCard: 1300000 },
      { name:"H9", type:"Modular", ports:20, maxPixels:65000000, maxSendCards:6, priority:9, maxPortsPerOutputCard: 1300000 },
      { name:"H15", type:"Modular", ports:20, maxPixels:130000000, maxSendCards:12, priority:10, maxPortsPerOutputCard: 1300000 },
      { name:"H20", type:"Modular", ports:20, maxPixels:260000000, maxSendCards:20, priority:11, maxPortsPerOutputCard: 1300000 }
    ];
    // basic parts catalogue for BOQ
    const PARTS_CATALOG = {
      'TB40': { part:'TP-VWC-NS-TB40', desc:'LED Video Wall Controller: TB40' }, 'TB60': { part:'TP-VWC-NS-TB60', desc:'LED Video Wall Controller: TB60' }, 'VX400': { part:'TP-VWC-NS-VX400', desc:'LED Video Wall Controller: VX400 Pro' }, 'VX600': { part:'TP-VWC-NS-VX600', desc:'LED Video Wall Controller: VX600 Pro' }, 'VX1000': { part:'TP-VWC-NS-VX1000', desc:'LED Video Wall Controller: VX1000 Pro' }, '4K': { part:'TP-VWC-NS-4K', desc:'LED Video Wall Controller: 4K Prime' },
      'H2': { part:'TP-XMF-H2', desc:'LED Video Wall Controller (H2)' }, 'H5': { part:'TP-XMF-H5', desc:'LED Video Wall Controller (H5)' }, 'H9': { part:'TP-XMF-H9', desc:'LED Video Wall Controller (H9)' }, 'H15': { part:'TP-XMF-H15', desc:'LED Video Wall Controller (H15)' }, 'H20': { part:'TBD-H20', desc:'LED Video Wall Controller (H20)' },
      // Modular Output Cards
      'H_20_RJ45': { part:'TP-XOC-RJ45-20', desc:'H_20 x RJ45 Sending Card', pixels: 1300000 },
      'H_16_RJ45': { part:'TP-XOC-RJ45-16-OF2', desc:'H_16 x RJ45 + 2x Fiber Sending Card', pixels: 1300000 },
      'H_4_HDMI_Out': { part:'TP-XOC-HDMI4', desc:'H_4 x HDMI Output Card', pixels: 1300000 },
      // Modular Input Cards
      'H_1xHDMI': { part:'TP-XIC-HDMI', desc:'H_1 x HDMI 2.0 Input Card' }, 'H_2xHDMI': { part:'TP-XIC-HDMI2', desc:'H_2 x HDMI 2.0 Input Card' }, 'H_4xHDMI': { part:'TP-XIC-HDMI4', desc:'H_4 x HDMI Input Card' },
      // LED Cabinets
      'PPL-COB-09': { part:'PPL-COB-MDL-CU-09', desc:'PeopleLink Active LED | 0.9PP COB (Including Modules)' }, 'PPL-COB-125': { part:'PPL-COB-MDL-CU-12', desc:'PeopleLink Active LED | 1.25PP COB (Including Modules)' }, 'PPL-COB-156': { part:'PPL-COB-MDL-CU-12', desc:'PeopleLink Active LED | 1.56PP COB (Including Modules)' }, 'PPL-ALD-CU': { part:'PPL-ALD-CU', desc:'PeopleLink ActiveLED | Video Wall Cabinet Unit (640x480/960x960mm)' },
    };

    /************************************************************************
     * Globals and Utils
     ************************************************************************/
    let finalCalculationData = {};
    let contactInfo = { email:'', phone:'' };
    let controllerModalData = {}; // Stores user overrides

    function gcd(a,b){ return b===0 ? a : gcd(b, a%b); }
    function fmt(n, d=0){ return Number(n).toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d}); }
    function formatLarge(n){
      if(n >= 1e6) return (n/1e6).toFixed(2)+'M';
      if(n >= 1e3) return (n/1e3).toFixed(1)+'K';
      return n.toString();
    }
    function escapeHtml(s){ 
      if(s===null||s===undefined) return '';
      return s.toString().replace(/[&<>"'`=\/]/g, function (c) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[c]; }); 
    }
    function getControllerModel(name){ return CONTROLLER_MODELS.find(c => c.name === name); }
    function getControllerType(name){ return CONTROLLER_MODELS.find(c => c.name === name) ? CONTROLLER_MODELS.find(c => c.name === name).type : (name.startsWith('H') ? 'Modular' : 'Unknown'); }


    /************************************************************************
     * Core Calculation Logic (UPDATED)
     ************************************************************************/
    function calculateLEDWall(){
      const productKey = document.getElementById('productModel').value;
      const unit = document.getElementById('unit').value;
      const widthInput = parseFloat(document.getElementById('width').value);
      const heightInput = parseFloat(document.getElementById('height').value);
      const diagonalInput = parseFloat(document.getElementById('diagonal').value);
      const aspectRatioKey = document.getElementById('aspectRatio').value;
      
      const err = document.getElementById('errorMessage');
      err.style.display='none';

      if(!productKey || !unit || ((unit!=='inches' && !(widthInput||heightInput)) || (unit==='inches' && !diagonalInput))){
        err.textContent = 'ERROR: Select model, unit and enter valid dimensions.';
        err.style.display='block';
        return null;
      }
      
      const details = LED_PRODUCTS[productKey];
      let desiredW_mm=0, desiredH_mm=0;
      
      // Calculate Desired Dimensions (mm)
      if(unit === 'inches'){
        const ratio = aspectRatioKey || '16:9';
        const [rw,rh] = ratio.split(':').map(Number);
        const diagRatio = Math.sqrt(rw*rw + rh*rh);
        const factor = diagonalInput / diagRatio;
        desiredW_mm = rw * factor * MM_PER_INCH;
        desiredH_mm = rh * factor * MM_PER_INCH;
      } else {
        const unitFactor = unit === 'meters' ? MM_PER_METER : MM_PER_FOOT;
        
        if(aspectRatioKey){
          const [rw,rh] = aspectRatioKey.split(':').map(Number);
          if(widthInput && !heightInput){
            desiredW_mm = widthInput * unitFactor;
            desiredH_mm = (widthInput / rw) * rh * unitFactor;
          } else if(heightInput && !widthInput){
            desiredH_mm = heightInput * unitFactor;
            desiredW_mm = (heightInput / rh) * rw * unitFactor;
          } else if(widthInput && heightInput){
            desiredW_mm = widthInput * unitFactor;
            desiredH_mm = heightInput * unitFactor;
          }
        } else {
          desiredW_mm = widthInput * unitFactor || (heightInput * (details.cabW_mm/details.cabH_mm) * unitFactor);
          desiredH_mm = heightInput * unitFactor || (widthInput * (details.cabH_mm/details.cabW_mm) * unitFactor);
        }
      }

      // Calculate Final Cabinet Configuration
      const numCabW = Math.max(1, Math.round(desiredW_mm / details.cabW_mm));
      const numCabH = Math.max(1, Math.round(desiredH_mm / details.cabH_mm));
      const totalCabinets = numCabW * numCabH;
      const totalModules = totalCabinets * details.modulesPerCab;
      
      const finalW_mm = numCabW * details.cabW_mm;
      const finalH_mm = numCabH * details.cabH_mm;
      const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);
      const finalResW = numCabW * details.cabPixW;
      const finalResH = numCabH * details.cabPixH;
      const totalPixels = finalResW * finalResH;
      
      // Secondary Specs
      const divisor = gcd(finalResW, finalResH);
      const aspectRatioText = `${finalResW/divisor}:${finalResH/divisor}`;
      const finalW_in = finalW_mm / MM_PER_INCH;
      const finalH_in = finalH_mm / MM_PER_INCH;
      const finalDiagonal_in = Math.sqrt(finalW_in*finalW_in + finalH_in*finalH_in);
      const pixelDensity = totalPixels / finalArea_m2;

      // Power and Weight calculations
      const actualPowerW = finalArea_m2 * details.maxPower_W_m2;
      const designPowerW = actualPowerW * POWER_BUFFER;
      const actualWeight = totalCabinets * details.weight_kg;
      const designWeight = actualWeight * WEIGHT_BUFFER;
      
      // Power Cable Calculation (UPDATED to 1000W/run)
      const totalPowerRuns = Math.max(1, Math.ceil(designPowerW / MAX_POWER_PER_RUN_W)); 
      const requiredPowerCables = totalCabinets + totalPowerRuns; // Daisy-chain cables (1/cabinet) + Long Input Power Cables (1/run)

      // --- UPDATED Controller Port & Cable Logic ---

      // 1. Ports required by Pixel Capacity (Standard Constraint 1.3Mk/port = 650k x 2)
      const requiredPortsByPixels = Math.ceil(totalPixels / (PIXELS_PER_PORT_DEFAULT * 2)); // Calculate based on 1.3Mk/port (1,300,000)
      const requiredPortsByPixelsBuffered = Math.ceil(requiredPortsByPixels * (1 + GLOBAL_PORT_BUFFER_PCT));

      // 2. Long Ethernet Runs required by Cabinet Grouping (Cabling Constraint)
      let cabsPerRun = details.cabsPerRun; // Max cabs per run (2, 5, or 0)

      let requiredLongEthRuns = 0;
      if (details.name.includes('COB') && cabsPerRun > 0) {
          // COB uses the max cabs per run logic
          requiredLongEthRuns = Math.max(1, Math.ceil(totalCabinets / cabsPerRun));
      } else {
          // SMD/Other uses the buffered pixel port requirement for runs
          requiredLongEthRuns = requiredPortsByPixelsBuffered;
      }

      // Final Required Controller Ports (MAX of the two constraints)
      // This ensures the controller meets both the pixel load AND the physical cable run count.
      const requiredPorts = Math.max(requiredPortsByPixelsBuffered, requiredLongEthRuns); 

      // 3. Short Ethernet Cables (Inter-cabinet) (NO BUFFER)
      const baseShortEthRuns = Math.max(0, totalCabinets - requiredLongEthRuns); 
      const requiredShortEthernet = baseShortEthRuns; // Removed the ceiling and the buffer

      // Find suggested controller
      let suggested = CONTROLLER_MODELS.slice().sort((a,b) => a.priority - b.priority).find(c => {
        if(c.type === 'Modular') {
          return c.maxPixels >= totalPixels; 
        } else {
          // All-in-One must meet both the required port count AND pixel capacity
          return c.maxPixels >= totalPixels && c.ports >= requiredPorts; 
        }
      }) || CONTROLLER_MODELS[CONTROLLER_MODELS.length-1];
      
      // Apply modal overrides if they exist
      const controllerName = controllerModalData.controllerOverrideName || suggested.name;
      let currentControllerObj = getControllerModel(controllerName);
      if (!currentControllerObj) currentControllerObj = suggested;

      // Determine the max pixels per port based on controller type or user selection
      const outputCardModel = controllerModalData.outputCardModel || 'H_20_RJ45';
      const outputCardPixels = PARTS_CATALOG[outputCardModel] ? PARTS_CATALOG[outputCardModel].pixels : (currentControllerObj.maxPortsPerOutputCard || PIXELS_PER_PORT_DEFAULT);

      let requiredSendCards = 0;
      if (currentControllerObj.type === 'Modular') {
          requiredSendCards = Math.max(1, Math.ceil(totalPixels / outputCardPixels)); 
      }
      
      // If modular candidate cannot support requiredSendCards, find next best
      if(currentControllerObj.type === 'Modular' && currentControllerObj.maxSendCards < requiredSendCards){
        const nextSuggest = CONTROLLER_MODELS.slice().sort((a,b) => a.priority - b.priority).find(c => c.maxSendCards >= requiredSendCards) || CONTROLLER_MODELS[CONTROLLER_MODELS.length-1];
        currentControllerObj = nextSuggest;
      }

      // store
      finalCalculationData = {
        productKey, productName: details.name, pixelPitch_mm: details.pitch_mm, cabinetW_mm: details.cabW_mm, cabinetH_mm: details.cabH_mm, cabPixW: details.cabPixW, cabPixH: details.cabPixH, numCabW, numCabH, totalCabinets, totalModules, finalW_mm, finalH_mm, finalArea_m2, finalResW, finalResH, totalPixels, aspectRatioText, finalDiagonal_in, pixelDensity, actualPowerW, designPowerW, designWeight, 
        requiredPortsBuffered: requiredPorts, 
        requiredShortEthernet, 
        requiredLongEthRuns, 
        requiredSendCards, 
        controllerName: currentControllerObj.name, 
        controllerType: currentControllerObj.type, 
        outputCardPixels: outputCardPixels * 2, // Display as 1.3Mk (650k * 2)
        outputCardModel: outputCardModel, 
        inputCardModel: controllerModalData.inputCardModel || 'H_1xHDMI', 
        inputCardQty: controllerModalData.inputCardQty || 2, 
        splicerSolution: controllerModalData.splicerSolution || (currentControllerObj.type.includes('Modular') ? `${currentControllerObj.name} Splicer` : 'N/A'),
        requiredPowerCables: requiredPowerCables,
        totalPowerRuns: totalPowerRuns,
        cabsPerRun: cabsPerRun,
      };
      
      return finalCalculationData;
    }


    /************************************************************************
     * BOQ generation & preview (UPDATED)
     ************************************************************************/
    function generateBOQList(data){
      const list = [];
      
      // 1. Controller/Processor 
      let ctrlKey = data.controllerName.split(' ')[0];
      if(ctrlKey.includes('VX')) ctrlKey = ctrlKey.slice(0, 5); 
      else if(ctrlKey.includes('4K')) ctrlKey = '4K';
      let ctrlDesc = PARTS_CATALOG[ctrlKey] ? PARTS_CATALOG[ctrlKey].desc : data.controllerName;
      
      if(data.controllerType === 'All-in-One' || data.controllerType === 'Multimedia') {
          ctrlDesc += ' (Integrated Sending)';
      } else if (data.controllerType === 'Modular') {
          ctrlDesc += ' (Modular Frame)';
      }

      list.push({ item:'Controller/Processor', partcode:PARTS_CATALOG[ctrlKey] ? PARTS_CATALOG[ctrlKey].part : 'TBD', desc:ctrlDesc, qty:1, unit:'PCS', unitPrice:0.00, totalPrice:0.00 });

      // 2. Output (Sending) Card (Only for Modular systems)
      if(data.controllerType && data.controllerType.includes('Modular')){
          const outModel = data.outputCardModel;
          const outPart = PARTS_CATALOG[outModel] ? PARTS_CATALOG[outModel].part : 'TBD';
          list.push({ item:'Output (Sending) Card', partcode:outPart, desc: `${PARTS_CATALOG[outModel].desc} (H-Series Only)`, qty:data.requiredSendCards, unit:'PCS', unitPrice:0.00, totalPrice:0.00 });
      
          // 3. Input Card(s) - ONLY FOR H-SERIES (MODULAR)
          const inModel = data.inputCardModel;
          const inPart = PARTS_CATALOG[inModel] ? PARTS_CATALOG[inModel].part : 'TBD';
          list.push({ item:'Input Card(s)', partcode:inPart, desc:PARTS_CATALOG[inModel].desc, qty:data.inputCardQty, unit:'PCS', unitPrice:0.00, totalPrice:0.00 });
      }

      // 4. LED Cabinets
      let cabKey = '';
      if(data.productName.includes('COB')) cabKey = data.productName.includes('0.9') ? 'PPL-COB-09' : (data.productName.includes('1.25') ? 'PPL-COB-125' : 'PPL-COB-156');
      else cabKey = 'PPL-ALD-CU'; 
      
      const cabPart = PARTS_CATALOG[cabKey] ? PARTS_CATALOG[cabKey].part : 'TBD';
      const cabDesc = PARTS_CATALOG[cabKey] ? PARTS_CATALOG[cabKey].desc : data.productName;

      list.push({ item:'LED Cabinets', partcode:cabPart, desc:cabDesc, qty:data.totalCabinets, unit:'PCS', unitPrice:0.00, totalPrice:0.00 });
      
      // 5. Cables and accessories
      
      // Long Ethernet
      let longEthDesc = `Controller to Wall long ethernet cables (15m). Runs are based on the required controller ports (Max ${data.cabsPerRun} cabs/run).`;
      if(data.cabsPerRun===0) longEthDesc = `Controller to Wall long ethernet cables (15m). Runs match the required controller ports.`;

      list.push({ item:'Long Ethernet Cables', partcode:'TP-ACC-ETH-15', desc:longEthDesc, qty:data.requiredLongEthRuns, unit:'PCS', unitPrice:0.00, totalPrice:0.00 });


      // Short Ethernet (Inter-cabinet)
      const shortEthDesc = `Inter-cabinet short ethernet cables (0.5m). Total needed: ${data.totalCabinets} - ${data.requiredLongEthRuns} Long Runs.`;
      list.push({ item:'Short Ethernet Cables', partcode:'TP-ACC-ETH-05', desc:shortEthDesc, qty:data.requiredShortEthernet, unit:'PCS', unitPrice:0.00, totalPrice:0.00 });

      // Power Cables (Long Input ONLY, as requested)
      const pwrCableDesc = `Long Input Power Cables (15m). Required runs based on Max ${MAX_POWER_PER_RUN_W}W/run.`;
      list.push({ 
        item:'Power Cables (Input)', 
        partcode:'TP-ACC-PWR-15', 
        desc:pwrCableDesc, 
        qty:data.totalPowerRuns, 
        unit:'PCS', 
        unitPrice:0.00, 
        totalPrice:0.00 
      });

      // Power Cables (Daisy Chain)
      const pwrDaisyDesc = `Daisy-chain power cables (0.5m). Required for interconnecting cabinets.`;
      list.push({ 
        item:'Power Cables (Daisy Chain)', 
        partcode:'TP-ACC-PWR-05', 
        desc:pwrDaisyDesc, 
        qty:data.totalCabinets, 
        unit:'PCS', 
        unitPrice:0.00, 
        totalPrice:0.00 
      });

      // 6. Logistics & Services 
      list.push({ 
        item:'Logistics & Services', 
        partcode:'ALED-LGS-IN', 
        desc:`Installation & Configuration (LS) + Transportation (${data.totalCabinets} Cabinets)`, 
        qty:1, 
        unit:'LS', 
        unitPrice:0.00, 
        totalPrice:0.00 
      });
      
      return list;
    }

    function renderBOQPreview(data){
      const list = generateBOQList(data);
      let html = `<div class="details-panel" style="margin-top:12px"><div style="font-weight:700;color:var(--brand);margin-bottom:8px">Bill of Quantities (Preview)</div>`;
      html += `<table id="boqPreviewTable"><thead><tr><th>S.No</th><th>Item</th><th>Partcode</th><th>Description</th><th style="text-align:right">Qty</th><th>Unit</th><th style="text-align:right">Unit Price</th><th style="text-align:right">Total Price</th></tr></thead><tbody>`;
      list.forEach((row, i)=>{ 
        html += `<tr><td>${i+1}</td><td>${escapeHtml(row.item)}</td><td>${escapeHtml(row.partcode)}</td><td>${escapeHtml(row.desc)}</td><td class="right">${row.qty}</td><td>${row.unit}</td><td class="right">${fmt(row.unitPrice, 2)}</td><td class="right">${fmt(row.totalPrice, 2)}</td></tr>`;
      });
      html += `</tbody></table></div>`;
      document.getElementById('boqPreviewContainer').innerHTML = html; 
    }
    
    function downloadBOQCSV(){
      const data = finalCalculationData;
      if(!data || !data.totalCabinets){ alert('Please calculate the wall first.'); return; }
      const list = generateBOQList(data);
      let csv = 'S.No,Item,Partcode,Description,Qty,Unit,Unit Price,Total Price\n'; 
      list.forEach((row, i)=>{
        csv += `${i+1},"${row.item}","${row.partcode}","${row.desc}",${row.qty},"${row.unit}",${row.unitPrice.toFixed(2)},${row.totalPrice.toFixed(2)}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.setAttribute('download', `PeopleLink_LED_BOQ_${data.finalResW}x${data.finalResH}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function drawVisualizationInPdf(doc, data, x, y, w, h){ 
        doc.setDrawColor(13,71,161); 
        doc.setLineWidth(1.0); 
        doc.rect(x,y,w,h); 
        doc.setFillColor(245, 249, 255);
        doc.rect(x,y,w,h,'F');
        
        const cols = data.numCabW, rows = data.numCabH; 
        const cellW = w / cols;
        const cellH = h / rows;
        doc.setLineWidth(0.3); 
        
        doc.setDrawColor(13,71,161, 0.5);
        for(let i=1;i<cols;i++){ const xx = x + i*cellW; doc.line(xx, y, xx, y+h); }
        for(let j=1;j<rows;j++){ const yy = y + j*cellH; doc.line(x, yy, x+w, yy); }
        
        doc.setFontSize(8);
        doc.setTextColor(13,71,161);
        doc.setFont(doc.getFont().fontName, 'bold');
        doc.text(`Resolution: ${data.finalResW} x ${data.finalResH}`, x+3, y+5);
        doc.setFont(doc.getFont().fontName, 'normal');

        doc.setTextColor(107,114,128); 
        doc.text(`Dim: ${(data.finalW_mm/MM_PER_METER).toFixed(2)}m × ${(data.finalH_mm/MM_PER_METER).toFixed(2)}m`, x+w-3, y+h-2, { align: 'right' });
    }
    
    function proceedToDownloadPdf(){
      const data = finalCalculationData;
      if(!data || !data.totalCabinets){ alert('Please calculate the wall first.'); return; }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      const margin = 15;
      const pageW = doc.internal.pageSize.getWidth();
      const primary = [13,71,161];
      const accent = [183,28,28];
      let y = margin;
      
      // Header and Specs (omitted for brevity, assume original logic here)
      doc.setFont('inter', 'bold');
      doc.setFontSize(16);
      doc.setTextColor(primary[0], primary[1], primary[2]);
      doc.text('PeopleLink LED Video Wall Configuration Summary & BOQ', pageW/2, y, { align: 'center' });
      
      doc.setFontSize(9);
      doc.setFont('inter', 'normal');
      doc.setTextColor(40,40,40);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, pageW-margin, y + 4, { align: 'right' });
      if(contactInfo.email) doc.text(`Email: ${contactInfo.email}`, pageW-margin, y + 8, { align: 'right' });
      if(contactInfo.phone) doc.text(`Phone: ${contactInfo.phone}`, pageW-margin, y + 12, { align: 'right' });
      y += 18;
      
      // Section 1 - Specifications
      doc.setFont('inter', 'bold');
      doc.setFontSize(11);
      doc.setTextColor(primary[0], primary[1], primary[2]);
      doc.text('1. LED Wall Specifications', margin, y);
      y += 6;
      
      doc.setFontSize(9);
      doc.setFont('inter', 'normal');
      const kv = [
          ['Model:', data.productName], ['Pixel Pitch:', `${data.pixelPitch_mm} mm`],
          ['Final Dimensions (WxH):', `${(data.finalW_mm/MM_PER_METER).toFixed(2)} m x ${(data.finalH_mm/MM_PER_METER).toFixed(2)} m`],
          ['Final Resolution (WxH):', `${data.finalResW} x ${data.finalResH}`],
          ['Aspect Ratio:', data.aspectRatioText],
          ['Total Cabinets (WxH):', `${data.numCabW} × ${data.numCabH} (${data.totalCabinets})`],
          ['Total Modules:', `${data.totalModules}`], ['Total Pixels:', `${formatLarge(data.totalPixels)}`],
          ['Final Area:', `${data.finalArea_m2.toFixed(2)} m²`],
          ['Total Power (Est.):', `${fmt(data.designPowerW,0)} W`],
          ['Total Weight (Est.):', `${fmt(data.designWeight,1)} kg`],
          ['Pixel Density:', `${fmt(data.pixelDensity,0)} p/m²`],
      ];
      
      const leftX = margin;
      const rightX = leftX + pageW/2 - margin;
      const rowH = 4.5;
      const half = Math.ceil(kv.length/2);
      
      for(let i=0;i<half;i++){
          const left = kv[i];
          const right = kv[i+half];
          doc.setTextColor(40,40,40);
          doc.text(left[0], leftX, y);
          doc.setFont('inter', 'bold');
          doc.setTextColor(accent[0], accent[1], accent[2]);
          doc.text(left[1], leftX + 70, y, { align: 'right' });
          doc.setFont('inter', 'normal');
          
          if(right){
              doc.setTextColor(40,40,40);
              doc.text(right[0], rightX, y);
              doc.setFont('inter', 'bold');
              doc.setTextColor(accent[0], accent[1], accent[2]);
              doc.text(right[1], rightX + 70, y, { align: 'right' });
              doc.setFont('inter', 'normal');
          }
          y += rowH;
      }
      y += 4;

      // Section 2 - Visualization
      doc.setFont('inter', 'bold');
      doc.setTextColor(primary[0], primary[1], primary[2]);
      doc.setFontSize(11);
      doc.text('2. Physical Wall Visualization', margin, y);
      y += 6;
      const vizW = pageW - margin*2, vizH = 40;
      drawVisualizationInPdf(doc, data, margin, y, vizW, vizH);
      y += vizH + 8;
      
      // Section 3 - Control & Connections
      doc.setFont('inter', 'bold');
      doc.setTextColor(primary[0], primary[1], primary[2]);
      doc.setFontSize(11);
      doc.text('3. Control System & Connections', margin, y);
      y += 6;
      doc.setFontSize(9);
      doc.setFont('inter', 'normal');
      doc.setTextColor(40,40,40);

      const ctrlRows = [
          ['Controller/Processor:', `${data.controllerName} (${data.controllerType})`],
          ['Splicer/Solution:', data.splicerSolution],
          ['Total Receiving Cards:', `${data.totalCabinets}`],
          ['Controller Ports (post-buffer):', `${data.requiredPortsBuffered} (Max ${formatLarge(data.outputCardPixels)}k/port)`],
          ['Sending Cards needed:', data.controllerType.includes('Modular') ? `${data.requiredSendCards} x ${data.outputCardModel}` : 'Integrated'],
          ['Long Ethernet Cables (Input):', `${data.requiredLongEthRuns} (Cabling Constraint: Max ${data.cabsPerRun} Cabs/Run)`],
          ['Inter-cabinet Short Ethernet:', `${data.requiredShortEthernet} (Base: ${data.totalCabinets - data.requiredLongEthRuns} - No buffer)`],
          ['Total Power Cables (Combined):', `${data.requiredPowerCables} (${data.totalCabinets} Daisy-chain + ${data.totalPowerRuns} Long Input)`],
          ['Input Card(s):', data.controllerType.includes('Modular') ? `${data.inputCardQty} x ${PARTS_CATALOG[data.inputCardModel].desc}` : 'N/A (Integrated)']
      ];
      
      ctrlRows.forEach(row => {
          doc.setTextColor(40,40,40);
          doc.text(row[0], margin, y);
          doc.setFont('inter', 'bold');
          doc.setTextColor(accent[0], accent[1], accent[2]);
          doc.text(row[1], margin + 70, y, { align: 'right' });
          doc.setFont('inter', 'normal');
          y += rowH;
      });
      y += 4;
      
      // Section 4 - Bill of Quantities (BOQ)
      doc.setFont('inter', 'bold');
      doc.setTextColor(primary[0], primary[1], primary[2]);
      doc.setFontSize(11);
      doc.text('4. Bill of Quantities (BOQ)', margin, y);
      y += 4;

      const boqList = generateBOQList(data);
      const boqHeaders = [
          ['S.No', 'Item', 'Partcode', 'Description', 'Qty', 'Unit', 'Unit Price', 'Total Price']
      ];
      const boqRows = boqList.map((row, i) => [
          i + 1, row.item, row.partcode, row.desc, row.qty, row.unit,
          `₹ ${fmt(row.unitPrice, 2)}`,
          `₹ ${fmt(row.totalPrice, 2)}`
      ]);

      doc.autoTable({
          head: boqHeaders, body: boqRows, startY: y, theme: 'grid',
          styles: { cellPadding: 2, fontSize: 8.5, font: 'inter', overflow: 'linebreak' },
          headStyles: { fillColor: primary, textColor: 255, font: 'inter', fontStyle: 'bold' },
          columnStyles: {
              0: { cellWidth: 10 }, 4: { halign: 'right', cellWidth: 15 }, 5: { cellWidth: 20 }, 
              6: { halign: 'right', cellWidth: 20 }, 7: { halign: 'right', cellWidth: 20 }
          }
      });
      let after = doc.autoTable.previous.finalY + 8;
      
      // Terms and Conditions
      doc.setFont('inter', 'bold');
      doc.setTextColor(40,40,40);
      doc.setFontSize(9);
      doc.text('Terms and Conditions:', margin, after);
      after += 4;
      
      doc.setFont('inter', 'normal');
      doc.setFontSize(8.5);
      const terms = [
          "1) All figures are estimated based on current product specifications. Final BOQ is subject to site survey.",
          "2) Power & Weight: Design figures include a 15% safety margin for structural and electrical planning.",
          "3) Services: All necessary civil works and primary mounting structure must be provided by the client unless included in BOQ.",
          "4) Warranty: Standard warranty is 1 year on LED panels and accessories. Excludes misuse, surges, unauthorized repairs.",
          "5) Site Access: Unrestricted site access and lifting equipment (if required) must be available during installation & commissioning."
      ];
      let tcy = after;
      terms.forEach(t=>{
          const split = doc.splitTextToSize(t, pageW - margin*2);
          if (tcy + (split.length * 4.5) > doc.internal.pageSize.getHeight() - 15) {
              doc.addPage(); tcy = margin;
          }
          doc.text(split, margin, tcy);
          tcy += (split.length * 4.5);
      });
      
      // Footer
      doc.setFontSize(7);
      doc.setTextColor(120,120,120);
      doc.text('Design figures include a 15% safety margin for structural and electrical planning. © 2025 PeopleLink Unified Communications Pvt. Ltd.', pageW/2, doc.internal.pageSize.getHeight() - 8, { align: 'center' });
      
      doc.save(`PeopleLink_LED_Config_${data.finalResW}x${data.finalResH}_BOQ.pdf`);
    }

    /************************************************************************
     * UI/Modal Handlers (IMPLEMENTED)
     ************************************************************************/
    
    function populateModalControllers(){
      const select = document.getElementById('modalControllerModel');
      select.innerHTML = '';
      CONTROLLER_MODELS.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = `${c.name} (${c.type}, Max ${formatLarge(c.maxPixels)} Pixels)`;
        select.appendChild(opt);
      });
    }

    function populateModalOutputCards(){
      const select = document.getElementById('modalOutputCardModel');
      select.innerHTML = '';
      Object.entries(PARTS_CATALOG).filter(([key, val]) => key.startsWith('H_') && key.includes('RJ45')).forEach(([key, val]) => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = val.desc;
        select.appendChild(opt);
      });
    }
    
    function populateModalInputCards(){
      const select = document.getElementById('modalInputCardModel');
      select.innerHTML = '';
      Object.entries(PARTS_CATALOG).filter(([key, val]) => key.startsWith('H_') && key.includes('HDMI')).forEach(([key, val]) => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = val.desc;
        select.appendChild(opt);
      });
    }

    function updatePortsFromOutputCard(){
        const modelKey = document.getElementById('modalOutputCardModel').value;
        const pixels = PARTS_CATALOG[modelKey] ? PARTS_CATALOG[modelKey].pixels : 0;
        document.getElementById('modalMaxPortsPerCard').value = formatLarge(pixels * 2) + ' Pixels'; // Display as 1.3Mk/port (650k x 2)
    }

    function onModalControllerChange(){
      const selectedName = document.getElementById('modalControllerModel').value;
      const type = getControllerType(selectedName);
      
      const isModular = type === 'Modular';
      document.getElementById('outputCardRow').style.display = isModular ? 'grid' : 'none';
      document.getElementById('inputCardRow').style.display = isModular ? 'grid' : 'none';
      
      // Prefill values
      const current = getControllerModel(selectedName);
      if(current && isModular){
          // Try to set a default output card based on standard
          document.getElementById('modalOutputCardModel').value = 'H_20_RJ45';
          updatePortsFromOutputCard();
      }
    }

    function openControllerModal(){
      if(!finalCalculationData || !finalCalculationData.totalCabinets){
          document.getElementById('errorMessage').textContent = 'ERROR: Please calculate the wall first before editing components.';
          document.getElementById('errorMessage').style.display='block';
          return;
      }

      // Initialize modal fields with current/calculated data
      document.getElementById('modalControllerModel').value = finalCalculationData.controllerName;
      document.getElementById('modalSplicerSolution').value = finalCalculationData.splicerSolution;
      document.getElementById('modalOutputCardModel').value = finalCalculationData.outputCardModel;
      document.getElementById('modalInputCardModel').value = finalCalculationData.inputCardModel;
      document.getElementById('modalInputCardQty').value = finalCalculationData.inputCardQty;
      
      onModalControllerChange(); // Calls this to hide/show H-series options
      updatePortsFromOutputCard(); // Update port field

      document.getElementById('controllerModal').style.display = 'flex';
    }
    
    function closeControllerModal(){
        document.getElementById('controllerModal').style.display = 'none';
    }

    function applyModalChanges(){
      // Save changes to global data structure
      controllerModalData = {
          controllerOverrideName: document.getElementById('modalControllerModel').value,
          splicerSolution: document.getElementById('modalSplicerSolution').value,
          outputCardModel: document.getElementById('modalOutputCardModel').value,
          inputCardModel: document.getElementById('modalInputCardModel').value,
          inputCardQty: parseInt(document.getElementById('modalInputCardQty').value) || 1,
          outputCardPixels: PARTS_CATALOG[document.getElementById('modalOutputCardModel').value] ? PARTS_CATALOG[document.getElementById('modalOutputCardModel').value].pixels * 2 : PIXELS_PER_PORT_DEFAULT * 2 // save as 1.3Mk
      };
      closeControllerModal();
      // Re-run calculation with overrides and update UI
      showVisualization();
    }
    
    function showVisualization(){ 
      const d = calculateLEDWall();
      if(!d) return; 

      // specs panel 
      document.getElementById('spec_model').textContent = d.productName; 
      document.getElementById('spec_pitch').textContent = d.pixelPitch_mm + ' mm';
      document.getElementById('spec_dims').textContent = `${(d.finalW_mm/MM_PER_METER).toFixed(2)} m x ${(d.finalH_mm/MM_PER_METER).toFixed(2)} m`;
      document.getElementById('spec_res').textContent = `${d.finalResW} x ${d.finalResH}`;
      document.getElementById('spec_diag').textContent = `${d.finalDiagonal_in.toFixed(1)} inches (${d.aspectRatioText})`;
      document.getElementById('spec_density').textContent = `${fmt(d.pixelDensity,0)} p/m²`;
      document.getElementById('spec_area').textContent = `${d.finalArea_m2.toFixed(2)} m²`;
      document.getElementById('spec_cabs').textContent = `${d.numCabW} x ${d.numCabH} (${d.totalCabinets})`;
      document.getElementById('spec_modules').textContent = `${d.totalModules}`;
      document.getElementById('spec_cabsize').textContent = `${d.cabinetW_mm}mm x ${d.cabinetH_mm}mm`;
      document.getElementById('spec_cabpix').textContent = `${d.cabPixW} x ${d.cabPixH}`;

      // control panel
      document.getElementById('ctrl_name').textContent = d.controllerName + (d.controllerType.includes('Modular') ? ' (Modular)' : '');
      document.getElementById('ctrl_ports').textContent = `${d.requiredPortsBuffered} (Max ${formatLarge(d.outputCardPixels)}/port)`;
      
      const shortEthBase = d.totalCabinets - d.requiredLongEthRuns;
      document.getElementById('ctrl_shorteth').textContent = `${d.requiredShortEthernet} (Base: ${shortEthBase} - No buffer)`;
      document.getElementById('ctrl_longeth').textContent = `${d.requiredLongEthRuns} (Cabling Constraint: Max ${d.cabsPerRun} Cabs/Run)`;

      document.getElementById('ctrl_pwr_cables').textContent = `${d.requiredPowerCables} (${d.totalCabinets} Daisy-chain + ${d.totalPowerRuns} Input Runs @ ${MAX_POWER_PER_RUN_W}W/run)`;
      document.getElementById('spec_power').textContent = `${fmt(d.designPowerW,0)} W`;
      document.getElementById('spec_weight').textContent = `${fmt(d.designWeight,1)} kg`;
      
      const sendingEl = document.querySelector('.spec-row.hseries-only');
      if(d.controllerType.includes('Modular')){
        sendingEl.style.display = 'flex';
        document.getElementById('ctrl_sending').textContent = `${d.requiredSendCards} x ${d.outputCardModel}`;
      } else {
        sendingEl.style.display = 'none';
      }

      // visualization (unchanged)
      const overlay = document.getElementById('cabinetOverlay');
      overlay.style.gridTemplateColumns = `repeat(${d.numCabW}, 1fr)`;
      overlay.style.gridTemplateRows = `repeat(${d.numCabH}, 1fr)`;
      overlay.innerHTML = '';
      
      let tooltip = document.getElementById('cabinetTooltip');
      if(!tooltip){
          tooltip = document.createElement('div');
          tooltip.id = 'cabinetTooltip';
          tooltip.style.position = 'absolute'; tooltip.style.zIndex = '1000'; tooltip.style.background = '#fff'; tooltip.style.padding = '5px 8px'; 
          tooltip.style.border = '1px solid #e6eef6'; tooltip.style.borderRadius = '5px'; 
          tooltip.style.boxShadow = '0 8px 24px rgba(6,25,57,0.08)'; tooltip.style.display = 'none'; 
          tooltip.style.fontSize = '12px'; document.body.appendChild(tooltip);
      }
      
      for(let r=0;r<d.numCabH;r++){
        for(let c=0;c<d.numCabW;c++){
          const cell = document.createElement('div');
          const label = document.createElement('div');
          label.className = 'cab-label';
          label.textContent = `${r+1}×${c+1}`;
          cell.appendChild(label);
          
          cell.addEventListener('mouseenter', e=>{
            tooltip.textContent = `Cabinet: ${r+1} x ${c+1} — Pixels: ${d.cabPixW}×${d.cabPixH}`;
            tooltip.style.display='block';
          });
          cell.addEventListener('mousemove', e=>{
            tooltip.style.left = (e.pageX + 12) + 'px';
            tooltip.style.top = (e.pageY + 12) + 'px';
          });
          cell.addEventListener('mouseleave', ()=> tooltip.style.display='none');
          
          overlay.appendChild(cell);
        }
      }
      document.getElementById('visDimensions').textContent = `${(d.finalW_mm/MM_PER_METER).toFixed(2)} m × ${(d.finalH_mm/MM_PER_METER).toFixed(2)} m`;
      
      // BOQ preview
      renderBOQPreview(d);
    }
    
    function resetForm(){
      document.getElementById('productModel').value='';
      document.getElementById('unit').value='';
      document.getElementById('width').value='';
      document.getElementById('height').value='';
      document.getElementById('diagonal').value='';
      document.getElementById('aspectRatio').value='';
      document.getElementById('errorMessage').style.display='none';
      document.getElementById('cabinetOverlay').innerHTML='';
      document.getElementById('boqPreviewContainer').innerHTML='';
      
      ['spec_model','spec_pitch','spec_dims','spec_res','spec_diag','spec_density','spec_area','spec_cabs','spec_modules','spec_cabsize','spec_cabpix','ctrl_name','ctrl_ports','ctrl_sending','ctrl_shorteth','ctrl_longeth','ctrl_pwr_cables','spec_power','spec_weight'].forEach(id=>{
        const el = document.getElementById(id); if(el) el.textContent = '--';
      });
      finalCalculationData = {};
      controllerModalData = {};
      toggleMeasurementFields();
    }
    
    function toggleMeasurementFields(){
      const unit = document.getElementById('unit').value;
      document.getElementById('widthGroup').classList.toggle('hidden', unit === 'inches');
      document.getElementById('heightGroup').classList.toggle('hidden', unit === 'inches');
      document.getElementById('diagonalGroup').classList.toggle('hidden', unit !== 'inches');
      
      if(unit === 'meters'){
        document.getElementById('widthLabel').textContent = 'Desired Width (m)';
        document.getElementById('heightLabel').textContent = 'Desired Height (m)';
      } else if (unit === 'feet'){
        document.getElementById('widthLabel').textContent = 'Desired Width (ft)';
        document.getElementById('heightLabel').textContent = 'Desired Height (ft)';
      }
    }

    function openContactModal(){document.getElementById('contactModal').style.display='flex';}
    function closeContactModal(){document.getElementById('contactModal').style.display='none';}
    function handleDownloadRequest(){
      contactInfo.email = document.getElementById('downloadEmail').value.trim();
      contactInfo.phone = document.getElementById('downloadPhone').value.trim();
      closeContactModal();
      proceedToDownloadPdf();
    }

    /************************************************************************
     * Init
     ************************************************************************/
    document.addEventListener('DOMContentLoaded', ()=>{
      toggleMeasurementFields();
      populateModalControllers();
      populateModalOutputCards();
      populateModalInputCards();

      // close modals on background click
      window.addEventListener('click', (e)=>{
        if(e.target === document.getElementById('controllerModal')) closeControllerModal();
        if(e.target === document.getElementById('contactModal')) closeContactModal();
      });
    });

  </script>
</body>
</html>
