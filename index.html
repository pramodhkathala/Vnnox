<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PeopleLink LED Video Wall — Wizard (650k-port rule, viewing distance)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#f4f7fb; --card:#fff; --accent:#0d47a1; --red:#b71c1c; --muted:#f7f9fc; --ok:#1b5e20;
    --nice-shadow: 0 6px 20px rgba(14, 35, 75, 0.06);
  }
  *{box-sizing:border-box}
  body{font-family:'Inter',sans-serif;background:var(--bg);color:#12202b;margin:24px}
  .wrap{max-width:1200px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  header h1{font-size:1.25rem;color:var(--accent);margin:0}
  .wizard{display:grid;grid-template-columns:420px 1fr;gap:18px}
  .card{background:var(--card);padding:18px;border-radius:10px;box-shadow:var(--nice-shadow)}
  .form-row{margin-bottom:12px}
  label{display:block;font-weight:600;margin-bottom:6px;color:#344};
  select,input{width:100%;padding:9px;border-radius:8px;border:1px solid #e1e6ef;background:#fff}
  .small{font-size:0.9rem;color:#556}
  .buttons{display:flex;gap:10px;margin-top:12px}
  button{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--accent);color:#fff}
  .btn-ghost{background:#fff;border:1px solid #e6eefb;color:var(--accent)}
  .hidden{display:none}
  .error{color:var(--red);background:#fff0f0;padding:10px;border-radius:8px;margin-top:10px;border:1px solid #f4caca}
  .preview {display:grid;grid-template-rows:auto 1fr auto; gap:12px}
  .specs-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .kv{display:flex;justify-content:space-between;padding:8px 10px;border-radius:6px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #eef4ff}
  .vis-stage{height:420px;border-radius:8px;border:2px solid rgba(183,28,28,0.08);position:relative;overflow:hidden;background:linear-gradient(180deg,#eaf4ff,#e9f0fb);display:flex;align-items:center;justify-content:center}
  #cabOverlay{position:absolute;inset:24px;display:grid;gap:2px;pointer-events:none}
  .cab{border:1px dashed rgba(13,71,161,0.25);background:rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;font-size:12px;color:#355}
  .escalation{padding:8px 10px;border-radius:8px;background:#fff3f3;border:1px solid #f2c2c2;color:var(--red);font-weight:700}
  footer{margin-top:16px;text-align:center;color:#9fb0d6;font-size:13px}
  @media (max-width:1000px){.wizard{grid-template-columns:1fr}#cabOverlay{inset:12px}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>PeopleLink LED Wall — Configuration Wizard</h1>
    <div class="small">Rules: viewing-min = pitch(mm) → meters | bandwidth = 650,000 px / port | cabinets-per-long-cable = floor(650k / cabinetPixels)</div>
  </header>

  <div class="wizard">
    <!-- LEFT: Form / steps -->
    <div class="card" id="leftPanel">

      <div id="step1">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:800">Step 1 — Input</div>
          <div class="small">Enter model & dimensions</div>
        </div>

        <div class="form-row">
          <label>LED Model / Pixel Pitch</label>
          <select id="productModel">
            <option value="">-- select model --</option>
            <optgroup label="COB (600×337.5mm)">
              <option value="cob_09">COB 0.9375 mm</option>
              <option value="cob_125">COB 1.25 mm</option>
              <option value="cob_15">COB 1.5625 mm</option>
            </optgroup>
            <optgroup label="Indoor SMD (640×480mm)">
              <option value="indoor_186">1.86 mm</option>
              <option value="indoor_20">2.0 mm</option>
              <option value="indoor_25">2.5 mm</option>
            </optgroup>
            <optgroup label="Outdoor SMD (960×960mm)">
              <option value="outdoor_40">4.0 mm</option>
              <option value="outdoor_667">6.67 mm</option>
              <option value="outdoor_80">8.0 mm</option>
              <option value="outdoor_100">10.0 mm</option>
            </optgroup>
          </select>
        </div>

        <div class="form-row">
          <label>Unit</label>
          <select id="unit" onchange="toggleUnits()">
            <option value="">-- select --</option>
            <option value="meters">Meters (m)</option>
            <option value="feet">Feet (ft)</option>
            <option value="inches">Inches (in) — Diagonal</option>
          </select>
        </div>

        <div id="dimInputs">
          <div class="form-row">
            <label id="widthLabel">Width (m)</label>
            <input id="width" type="number" min="0.01" step="0.01" placeholder="Enter width (leave blank to infer)">
          </div>
          <div class="form-row">
            <label id="heightLabel">Height (m)</label>
            <input id="height" type="number" min="0.01" step="0.01" placeholder="Enter height (leave blank to infer)">
          </div>
        </div>

        <div id="diagInputs" class="hidden">
          <div class="form-row">
            <label>Diagonal (inches)</label>
            <input id="diagonal" type="number" min="10" step="1" placeholder="Diagonal in inches">
          </div>
        </div>

        <div class="form-row">
          <label>Aspect Ratio (optional)</label>
          <select id="aspectRatio">
            <option value="">(none)</option>
            <option value="16:9">16:9</option>
            <option value="16:10">16:10</option>
            <option value="4:3">4:3</option>
            <option value="1:1">1:1</option>
          </select>
        </div>

        <div id="step1Error" class="error hidden"></div>

        <div class="buttons">
          <button class="btn-primary" onclick="goToPreview()">Next — Preview</button>
          <button class="btn-ghost" onclick="resetAll()">Reset</button>
        </div>
      </div>

      <!-- Step 3: download & BOQ confirmation -->
      <div id="step3" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:800">Step 3 — Download & BOQ</div>
          <div class="small">Save technical summary (PDF)</div>
        </div>

        <div style="margin-bottom:12px">
          <div class="kv"><div><strong>Controller</strong></div><div id="pdfCtrl">--</div></div>
          <div class="kv"><div><strong>Long Ethernet Ports</strong></div><div id="pdfPorts">--</div></div>
          <div class="kv"><div><strong>Sending Cards</strong></div><div id="pdfSend">--</div></div>
          <div class="kv"><div><strong>Receiving Cards</strong></div><div id="pdfRecv">--</div></div>
        </div>

        <div class="buttons">
          <button class="btn-primary" onclick="downloadPdf()">Download PDF</button>
          <button class="btn-ghost" onclick="backToPreview()">Back</button>
        </div>
      </div>

    </div>

    <!-- RIGHT: Preview / visualization -->
    <div class="card preview">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Step 2 — Visualization & BOQ</div>
        <div id="escalationNote" class="hidden escalation"></div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="kv"><div><strong>Pixel Pitch</strong></div><div id="pvPixel">--</div></div>
        <div class="kv"><div><strong>Cabinet Pixels (W×H)</strong></div><div id="pvCabPix">--</div></div>
        <div class="kv"><div><strong>Final Resolution</strong></div><div id="pvRes">--</div></div>
        <div class="kv"><div><strong>Total Pixels</strong></div><div id="pvTotPix">--</div></div>
        <div class="kv"><div><strong>Matrix (W×H)</strong></div><div id="pvMatrix">--</div></div>
        <div class="kv"><div><strong>Final Dim (m)</strong></div><div id="pvDim">--</div></div>
      </div>

      <div class="vis-stage" style="margin-top:12px">
        <div id="visInfo" style="position:absolute;top:12px;left:12px;background:rgba(255,255,255,0.85);padding:6px 8px;border-radius:6px;border:1px solid #eef4ff;font-weight:700;color:var(--accent)"></div>
        <div id="cabOverlay"></div>
        <div style="position:absolute;bottom:12px;left:12px;background:rgba(255,255,255,0.95);padding:8px;border-radius:8px;border:1px solid #eef4ff">
          <div class="small">Viewing Distance (min / comfort / ideal)</div>
          <div id="pvView" style="font-weight:700"></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:800;margin-bottom:6px">Connection Summary & BOQ</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
          <div class="kv"><div><strong>Ports (bandwidth)</strong></div><div id="pvBwPorts">--</div></div>
          <div class="kv"><div><strong>Cabinets / long-cable</strong></div><div id="pvCabsPerCable">--</div></div>
          <div class="kv"><div><strong>Cables (cab rule)</strong></div><div id="pvCablesCab">--</div></div>
          <div class="kv"><div><strong>Required Long Ports</strong></div><div id="pvReqPorts">--</div></div>
          <div class="kv"><div><strong>Short Ethernet (between cabs)</strong></div><div id="pvShortEth">--</div></div>
          <div class="kv"><div><strong>Sending Cards</strong></div><div id="pvSendCards">--</div></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn-primary" onclick="confirmAndProceed()">Proceed → Save & Download</button>
          <button class="btn-ghost" onclick="backToInput()">Back to Edit</button>
        </div>
      </div>

    </div>
  </div>

  <footer>© 2025 PeopleLink Unified Communications Pvt. Ltd. — UI prototype</footer>
</div>

<script>
/* ---------- constants ---------- */
const MM_PER_METER = 1000;
const MM_PER_INCH = 25.4;
const METER_TO_FEET = 3.28084;
const PIXELS_PER_PORT = 650000; // bandwidth rule

const LED_PRODUCTS = {
  cob_09:   {name:"COB 0.9375", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300},
  cob_125:  {name:"COB 1.25",    pitch_mm:1.25,   cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300},
  cob_15:   {name:"COB 1.5625", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300},
  indoor_186:{name:"Indoor 1.86", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560},
  indoor_20:{name:"Indoor 2.0", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560},
  indoor_25:{name:"Indoor 2.5", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560},
  outdoor_40:{name:"Outdoor 4.0", pitch_mm:4.0, cabW_mm:960, cabH_mm:960, cabPixW:240, cabPixH:240, modulesPerCab:18, weight_kg:8.28, maxPower_W_m2:937.5},
  outdoor_667:{name:"Outdoor 6.67", pitch_mm:6.67, cabW_mm:960, cabH_mm:960, cabPixW:144, cabPixH:144, modulesPerCab:18, weight_kg:8.28, maxPower_W_m2:937.5},
  outdoor_80:{name:"Outdoor 8.0", pitch_mm:8.0, cabW_mm:960, cabH_mm:960, cabPixW:120, cabPixH:120, modulesPerCab:18, weight_kg:8.28, maxPower_W_m2:937.5},
  outdoor_100:{name:"Outdoor 10.0", pitch_mm:10.0, cabW_mm:960, cabH_mm:960, cabPixW:96, cabPixH:96, modulesPerCab:18, weight_kg:8.28, maxPower_W_m2:937.5}
};

const CONTROLLERS = [
  {name:"TB40", ports:2, maxPixels:1300000},
  {name:"TB60", ports:4, maxPixels:2300000},
  {name:"VX400 Pro", ports:4, maxPixels:2600000},
  {name:"VX600 Pro", ports:6, maxPixels:3900000},
  {name:"VX1000 Pro", ports:10, maxPixels:6500000},
  {name:"4K Prime", ports:16, maxPixels:10400000},
  {name:"H2 Splicer (2U)", ports:20, maxPixels:26000000},
  {name:"H5 Splicer (5U)", ports:20, maxPixels:39000000}
];

/* ---------- helpers ---------- */
function el(id){return document.getElementById(id)}
function gcd(a,b){return b===0?a:gcd(b,a%b)}
function fmt(n){return Number(n).toLocaleString()}

/* ---------- unit toggles ---------- */
function toggleUnits(){
  const u = el('unit').value;
  if(u === 'inches'){
    el('dimInputs').classList.add('hidden');
    el('diagInputs').classList.remove('hidden');
  } else {
    el('dimInputs').classList.remove('hidden');
    el('diagInputs').classList.add('hidden');
  }
}

/* ---------- navigation ---------- */
function goToPreview(){
  el('step1Error').classList.add('hidden');
  const model = el('productModel').value;
  const unit = el('unit').value;
  if(!model){ showErr('Select LED model'); return; }
  if(!unit){ showErr('Select unit'); return; }

  const calc = calculate();
  if(!calc){ return; }
  renderPreview(calc);
  // show step2 UI in right panel; left switches to step2 controls by hiding step1 fields and showing step3 area when needed
  window.scrollTo({top:0,behavior:'smooth'});
}

function showErr(msg){
  el('step1Error').textContent = msg;
  el('step1Error').classList.remove('hidden');
  el('step1Error').scrollIntoView({behavior:'smooth',block:'center'});
}

function backToInput(){
  // keep data
}

function confirmAndProceed(){
  // Show download step on left
  const d = window._lastCalc;
  if(!d) return;
  el('step1').classList.add('hidden');
  el('step3').classList.remove('hidden');
  el('pdfCtrl').textContent = `${d.suggestedController.name} (${d.suggestedController.ports} ports)`;
  el('pdfPorts').textContent = d.requiredPorts;
  el('pdfSend').textContent = `${d.requiredSendCards} × 20-port`;
  el('pdfRecv').textContent = d.totalCabinets;
  // highlight escalation if any
  if(d.escalated){
    el('escalationNote').classList.remove('hidden');
    el('escalationNote').textContent = `Escalated → ${d.suggestedController.name} (required ports ${d.requiredPorts})`;
  } else {
    el('escalationNote').classList.add('hidden');
  }
}

function backToPreview(){
  el('step3').classList.add('hidden');
  el('step1').classList.remove('hidden');
}

/* ---------- core calculation ---------- */
function calculate(){
  const pk = el('productModel').value;
  const unit = el('unit').value;
  const widthRaw = el('width').value;
  const heightRaw = el('height').value;
  const diagRaw = el('diagonal').value;
  const aspect = el('aspectRatio').value;

  const prod = LED_PRODUCTS[pk];
  if(!prod) { showErr('Invalid product'); return null; }

  let desiredW_mm = 0, desiredH_mm = 0;
  if(unit === 'inches'){
    const d = Number(diagRaw);
    if(!d || d <= 0){ showErr('Enter diagonal (inches)'); return null; }
    const ratio = aspect || '16:9';
    const [rW, rH] = ratio.split(':').map(Number);
    const diagRatio = Math.sqrt(rW*rW + rH*rH);
    const factor = d / diagRatio; // d in inches
    desiredW_mm = rW * factor * MM_PER_INCH;
    desiredH_mm = rH * factor * MM_PER_INCH;
  } else {
    const hasW = widthRaw !== '' && Number(widthRaw) > 0;
    const hasH = heightRaw !== '' && Number(heightRaw) > 0;
    if(!hasW && !hasH){ showErr('Enter width or height'); return null; }
    const unitFactor = unit === 'meters' ? MM_PER_METER : MM_PER_FOOT;
    if(aspect){
      const [rW,rH] = aspect.split(':').map(Number);
      if(hasW){ desiredW_mm = Number(widthRaw) * unitFactor; desiredH_mm = (Number(widthRaw) / rW) * rH * unitFactor; }
      else { desiredH_mm = Number(heightRaw) * unitFactor; desiredW_mm = (Number(heightRaw) / rH) * rW * unitFactor; }
    } else {
      const cabAR = prod.cabW_mm / prod.cabH_mm;
      if(hasW && !hasH){ desiredW_mm = Number(widthRaw) * unitFactor; desiredH_mm = desiredW_mm / cabAR; }
      else if(hasH && !hasW){ desiredH_mm = Number(heightRaw) * unitFactor; desiredW_mm = desiredH_mm * cabAR; }
      else { desiredW_mm = Number(widthRaw) * unitFactor; desiredH_mm = Number(heightRaw) * unitFactor; }
    }
  }

  // snap to nearest whole cabinets
  const numCabW = Math.max(1, Math.round(desiredW_mm / prod.cabW_mm));
  const numCabH = Math.max(1, Math.round(desiredH_mm / prod.cabH_mm));
  const totalCabinets = numCabW * numCabH;
  const finalW_mm = numCabW * prod.cabW_mm;
  const finalH_mm = numCabH * prod.cabH_mm;
  const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);
  const finalResW = numCabW * prod.cabPixW;
  const finalResH = numCabH * prod.cabPixH;
  const totalPixels = finalResW * finalResH;
  const ratioG = gcd(finalResW, finalResH);
  const aspectText = `${finalResW/ratioG}:${finalResH/ratioG}`;
  const finalDiag_in = Math.sqrt(finalW_mm*finalW_mm + finalH_mm*finalH_mm) / MM_PER_INCH;

  // viewing distance rule: min = pitch (mm -> m)
  const minView_m = prod.pitch_mm / 1000.0;
  const comfortView_m = minView_m * 2;
  const idealView_m = minView_m * 3;

  // ports/cables logic
  const bandwidth_ports = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT));
  // cabinets per long cable = floor(PIXELS_PER_PORT / cabinetPixels)
  let cabinetsPerLong = Math.floor(PIXELS_PER_PORT / (prod.cabPixW * prod.cabPixH));
  if(cabinetsPerLong < 1) cabinetsPerLong = 1;
  const cablesByCabRule = Math.max(1, Math.ceil(totalCabinets / cabinetsPerLong));
  const requiredPorts = Math.max(bandwidth_ports, cablesByCabRule);
  const outputCardPorts = 20; // default 20-port sending card
  const requiredSendCards = Math.max(1, Math.ceil(requiredPorts / outputCardPorts));
  const requiredShortEth = Math.max(0, totalCabinets - requiredPorts);

  // controller suggestion logic:
  // aim to choose controller that meets both pixels and ports if possible; otherwise escalate by ports
  let suggested = CONTROLLERS.find(c => c.maxPixels >= totalPixels && c.ports >= requiredPorts);
  if(!suggested) suggested = CONTROLLERS.find(c => c.ports >= requiredPorts);
  if(!suggested) suggested = CONTROLLERS.find(c => c.maxPixels >= totalPixels);
  if(!suggested) suggested = CONTROLLERS[CONTROLLERS.length - 1];
  const baseline = CONTROLLERS.find(c => c.maxPixels >= totalPixels) || CONTROLLERS[0];
  const escalated = (suggested.name !== baseline.name);

  // store last calc
  const result = {
    prod, numCabW, numCabH, totalCabinets, finalW_mm, finalH_mm, finalArea_m2,
    finalResW, finalResH, totalPixels, aspectText, finalDiag_in,
    minView_m, comfortView_m, idealView_m,
    minView_ft: minView_m * METER_TO_FEET, comfortView_ft: comfortView_m * METER_TO_FEET, idealView_ft: idealView_m * METER_TO_FEET,
    bandwidth_ports, cabinetsPerLong, cablesByCabRule, requiredPorts, requiredShortEth,
    outputCardPorts, requiredSendCards,
    suggestedController: suggested, baselineController: baseline, escalated
  };
  window._lastCalc = result;
  return result;
}

/* ---------- render preview ---------- */
function renderPreview(d){
  // left: concise info in card top
  el('pvPixel').textContent = d.prod.pitch_mm + ' mm';
  el('pvCabPix').textContent = `${d.prod.cabPixW} × ${d.prod.cabPixH}`;
  el('pvRes').textContent = `${d.finalResW} × ${d.finalResH}`;
  el('pvTotPix').textContent = fmt(d.totalPixels);
  el('pvMatrix').textContent = `${d.numCabW} × ${d.numCabH}`;
  el('pvDim').textContent = `${(d.finalW_mm/1000).toFixed(2)} m × ${(d.finalH_mm/1000).toFixed(2)} m`;
  el('pvView').textContent = `${d.minView_m.toFixed(2)}m / ${d.comfortView_m.toFixed(2)}m / ${d.idealView_m.toFixed(2)}m — ${d.minView_ft.toFixed(1)}ft / ${d.comfortView_ft.toFixed(1)}ft / ${d.idealView_ft.toFixed(1)}ft`;

  el('pvBwPorts').textContent = d.bandwidth_ports;
  el('pvCabsPerCable').textContent = d.cabinetsPerLong;
  el('pvCablesCab').textContent = d.cablesByCabRule;
  el('pvReqPorts').textContent = d.requiredPorts;
  el('pvShortEth').textContent = d.requiredShortEth;
  el('pvSendCards').textContent = `${d.requiredSendCards} × ${d.outputCardPorts}-port`;

  // escalation UI
  if(d.escalated){
    el('escalationNote').classList.remove('hidden');
    el('escalationNote').textContent = `Escalation recommended → ${d.suggestedController.name} (ports ${d.suggestedController.ports}, required ${d.requiredPorts})`;
  } else {
    el('escalationNote').classList.add('hidden');
  }

  // visualize cabinets in grid (cabOverlay)
  const overlay = el('cabOverlay');
  overlay.innerHTML = '';
  overlay.style.gridTemplateColumns = `repeat(${d.numCabW}, 1fr)`;
  overlay.style.gridTemplateRows = `repeat(${d.numCabH}, 1fr)`;
  // limit visible total cells for rendering performance
  const maxCells = 200;
  if(d.totalCabinets > maxCells){
    // show sparse grid with text instead
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.innerHTML = `<div style="text-align:center;color:#345"><strong>${d.numCabW} × ${d.numCabH}</strong><div class="small">${d.totalCabinets} Cabinets</div></div>`;
  } else {
    overlay.style.display = 'grid';
    for(let r=0;r<d.numCabH;r++){
      for(let c=0;c<d.numCabW;c++){
        const div = document.createElement('div');
        div.className = 'cab';
        div.style.padding = '2px';
        div.innerHTML = `<div style="font-size:11px">${c+1},${r+1}</div>`;
        overlay.appendChild(div);
      }
    }
  }
}

/* ---------- actions ---------- */
function resetAll(){
  el('productModel').value='';
  el('unit').value='';
  el('width').value='';
  el('height').value='';
  el('diagonal').value='';
  el('aspectRatio').value='';
  el('step1Error').classList.add('hidden');
  el('step3').classList.add('hidden');
  el('step1').classList.remove('hidden');
  el('escalationNote').classList.add('hidden');
  el('pvPixel').textContent='--';
  el('cabOverlay').innerHTML='';
}

function backToPreview(){
  el('step3').classList.add('hidden');
  el('step1').classList.remove('hidden');
}

/* ---------- finalize & pdf ---------- */
function downloadPdf(){
  const d = window._lastCalc;
  if(!d){ alert('Please calculate configuration first'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 14;
  let y = 10;
  doc.setFontSize(16); doc.setTextColor(13,71,161);
  doc.text('PeopleLink LED Video Wall — Technical Summary', pageW/2, y, {align:'center'}); y+=8;
  doc.setFontSize(10); doc.setTextColor(80,80,80);
  doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y); y+=8;

  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('1. Wall & Performance', margin, y); y+=6;
  const perf = [
    ['Model', d.prod.name],
    ['Final Dimensions', `${(d.finalW_mm/1000).toFixed(2)}m × ${(d.finalH_mm/1000).toFixed(2)}m`],
    ['Cabinet Matrix (W×H)', `${d.numCabW} × ${d.numCabH}`],
    ['Final Resolution', `${d.finalResW} × ${d.finalResH}`],
    ['Total Pixels / Area', `${fmt(d.totalPixels)} / ${d.finalArea_m2.toFixed(2)} m²`],
    ['Viewing Distance (min/comfort/ideal)', `${d.minView_m.toFixed(2)}m / ${d.comfortView_m.toFixed(2)}m / ${d.idealView_m.toFixed(2)}m`]
  ];
  doc.autoTable({ startY: y+2, body: perf, theme:'striped', margin:{left:margin,right:margin}, styles:{fontSize:9} });
  y = doc.lastAutoTable.finalY + 6;

  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('2. Control & Connections', margin, y); y+=6;
  const control = [
    ['Suggested Controller', `${d.suggestedController.name} (${d.suggestedController.ports} ports)`],
    ['Required Long Ethernet Ports', `${d.requiredPorts}`],
    ['Bandwidth-based ports', `${d.bandwidth_ports}`],
    ['Cables needed (cab rule)', `${d.cablesByCabRule || d.cablesByCabRule}`],
    ['Cabinets per long cable', `${d.cabinetsPerLong}`],
    ['Required Sending Cards', `${d.requiredSendCards} × 20-port`],
    ['Short Ethernet cables (inter-cabinet)', `${d.requiredShortEth}`]
  ];
  doc.autoTable({ startY: y+2, body: control, theme:'striped', margin:{left:margin,right:margin}, styles:{fontSize:9} });
  y = doc.lastAutoTable.finalY + 6;

  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('3. BOQ (Summary)', margin, y); y+=6;
  const boq = [
    ['LED Cabinets', d.prod.name, `${d.totalCabinets}`, 'PCS'],
    ['Controller', d.suggestedController.name, '1', 'PCS'],
    ['Receiving Cards', 'Embedded in cabinets', `${d.totalCabinets}`, 'PCS'],
    ['Sending Cards', '20-port', `${d.requiredSendCards}`, 'PCS'],
    ['Long Ethernet Cables (CAT6/7)', 'Controller → Wall', `${d.requiredPorts}`, 'PCS'],
    ['Short Ethernet Cables', 'Cabinet interconnect', `${d.requiredShortEth}`, 'PCS'],
  ];
  doc.autoTable({ startY: y+2, head:[['Item','Desc','Qty','Unit']], body: boq, theme:'grid', margin:{left:margin,right:margin}, styles:{fontSize:9} });
  y = doc.lastAutoTable.finalY + 8;

  doc.setFontSize(8); doc.setTextColor(90,90,90);
  doc.text('Notes: Ports and cable counts follow the 650k pixels per long LAN port rule and cabinets-per-long-cable = floor(650k / cabinetPixels). Minimum 1 cabinet per cable. Viewing distance minimum equals pixel pitch in meters.', margin, y, {maxWidth: pageW - margin*2});

  doc.save(`PeopleLink_LED_${d.finalResW}x${d.finalResH}_Summary.pdf`);
}

/* ---------- init ---------- */
document.addEventListener('DOMContentLoaded', ()=>{ toggleUnits(); });
</script>
</body>
</html>
