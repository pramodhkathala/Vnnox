<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PeopleLink LED Video Wall Configuration Calculator</title> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* General Styles */
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 40px; background: #eef1f8; color: #1c2738; font-size: 14px; }
        .main-wrapper { max-width: 1200px; margin: auto; }
        h2 { text-align: center; color: #0D47A1; margin-top: 0; margin-bottom: 30px; font-weight: 700; font-size: 1.8em; display: flex; align-items: center; justify-content: center; }
        
        /* Input Panel Styles */
        .input-panel { background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: all 0.5s ease-in-out; }
        .input-panel.minimized { max-height: 120px; padding: 10px 30px; margin-bottom: 20px; overflow: hidden; }
        
        /* Form Layout */
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; align-items: end; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-weight: 600; color: #37474F; font-size: 13px; }
        .form-group select, .form-group input { padding: 10px 12px; border: 1px solid #CFD8DC; border-radius: 6px; font-size: 14px; background: #fafafa; transition: border-color 0.3s; }
        .form-group select:focus, .form-group input:focus { border-color: #0D47A1; outline: none; background: #ffffff; }
        .hidden { display: none !important; }

        /* Buttons */
        .button-group { grid-column: 1 / -1; display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s; }
        .btn-primary { background: #0D47A1; color: white; box-shadow: 0 4px 10px rgba(13, 71, 161, 0.4); }
        .btn-primary:hover { background: #0b51a9; }
        .btn-secondary { background: #E0E0E0; color: #37474F; }
        .btn-secondary:hover { background: #CFD8DC; }
        .back-btn-placeholder { grid-column: 1; text-align: left; }
        .back-btn { padding: 8px 15px; background: #FFD54F; color: #333; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; }
        .back-btn:hover { background: #FFCA28; }
        
        /* Error Message */
        #errorMessage { background: #FFCDD2; color: #B71C1C; padding: 10px; border-radius: 4px; margin-top: 20px; font-weight: 600; text-align: center; }

        /* Visualization Panel */
        #visualization { margin-top: 40px; background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); opacity: 0; transform: translateY(20px); transition: opacity 0.5s, transform 0.5s; }
        #visualization.visible { opacity: 1; transform: translateY(0); }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; padding: 15px 0; border-bottom: 1px solid #ECEFF1; }
        .summary-grid span { display: flex; justify-content: space-between; align-items: center; background: #F5F5F5; padding: 8px 12px; border-radius: 4px; }
        .summary-grid strong { font-weight: 700; color: #37474F; font-size: 13px; }
        .summary-grid small { font-weight: 600; color: #0D47A1; font-size: 14px; }
        #enteredSummaryText { grid-column: 1 / -1; text-align: center; font-size: 1.1em; font-weight: 700; color: #1B5E20; margin-bottom: 10px; }

        /* Wall Visualization Box */
        .vis-container { position: relative; display: flex; flex-direction: column; align-items: center; margin-top: 20px; }
        .vis-grid { border: 3px solid #0D47A1; position: relative; background: #e0e0e0; min-height: 150px; width: 100%; transition: height 0.3s; margin-top: 15px; }
        .vis-label-w { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-weight: 700; color: #0D47A1; font-size: 12px; }
        .vis-label-h { position: absolute; right: -70px; top: 50%; transform: translateY(-50%) rotate(90deg); font-weight: 700; color: #0D47A1; font-size: 12px; }
        
        /* Cabinet Overlay */
        #cabinetOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; }
        #cabinetOverlay > div { border: 1px solid rgba(255, 255, 255, 0.4); box-sizing: border-box; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: rgba(255, 255, 255, 0.8); background: rgba(0, 0, 0, 0.1); cursor: help; transition: background 0.1s; }
        #cabinetOverlay > div:hover { background: rgba(13, 71, 161, 0.2); }
        .cab-label { pointer-events: none; }

        /* Tooltip */
        .tooltip-cab { position: absolute; background: #333; color: white; padding: 5px 10px; border-radius: 4px; font-size: 11px; z-index: 1000; pointer-events: none; display: none; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border-radius: 10px; width: 50%; min-width: 350px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .modal-grid-full { grid-column: 1 / -1; }
        .modal-form-group { display: flex; flex-direction: column; }
        .modal-form-group label { margin-bottom: 5px; font-weight: 600; font-size: 13px; }
        .modal-form-group input[type="text"], .modal-form-group input[type="number"], .modal-form-group select { padding: 8px 10px; border: 1px solid #CFD8DC; border-radius: 4px; }
        .checkbox-group { display: flex; align-items: center; margin-top: 10px; }
        .checkbox-group input { margin-right: 10px; }

        /* Download Link */
        #downloadPdfLink { text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <h2>PeopleLink LED Video Wall Configuration Calculator</h2>

        <div id="formContainer" class="input-panel">
            <div id="errorMessage" class="hidden"></div>
            
            <div class="form-grid">
                
                <div class="form-group">
                    <label for="productModel">LED Product Model</label>
                    <select id="productModel" name="productModel">
                        <option value="" disabled selected>Select Model</option>
                        <optgroup label="COB (Fine Pitch)">
                            <option value="cob_09">COB (0.9375mm)</option>
                            <option value="cob_125">COB (1.25mm)</option>
                            <option value="cob_15">COB (1.5625mm)</option>
                        </optgroup>
                        <optgroup label="SMD Indoor">
                            <option value="indoor_186">SMD Indoor (1.86mm)</option>
                            <option value="indoor_20">SMD Indoor (2.0mm)</option>
                            <option value="indoor_25">SMD Indoor (2.5mm)</option>
                        </optgroup>
                        <optgroup label="SMD Outdoor">
                            <option value="outdoor_40">SMD Outdoor (4.0mm)</option>
                            <option value="outdoor_667">SMD Outdoor (6.67mm)</option>
                            <option value="outdoor_80">SMD Outdoor (8.0mm)</option>
                            <option value="outdoor_100">SMD Outdoor (10.0mm)</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <label for="unit">Measurement Unit</label>
                    <select id="unit" name="unit" onchange="toggleMeasurementFields()">
                        <option value="meter">Meter (m)</option>
                        <option value="feet">Feet (ft)</option>
                        <option value="inches">Diagonal Inches (in)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="aspectRatio" id="aspectRatioLabel">Target Aspect Ratio (Optional)</label>
                    <select id="aspectRatio" name="aspectRatio">
                        <option value="">-- None --</option>
                        <option value="16:9">16:9 (HD/FHD/4K)</option>
                        <option value="21:9">21:9 (Widescreen)</option>
                        <option value="4:3">4:3 (Legacy)</option>
                        <option value="1:1">1:1 (Square)</option>
                    </select>
                </div>
                
                <div class="form-group" id="widthGroup">
                    <label for="width" id="widthLabel">Desired Width (m)</label>
                    <input type="number" id="width" name="width" step="0.01" placeholder="e.g., 4.8">
                </div>

                <div class="form-group" id="heightGroup">
                    <label for="height" id="heightLabel">Desired Height (m)</label>
                    <input type="number" id="height" name="height" step="0.01" placeholder="e.g., 2.7">
                </div>
                
                <div class="form-group hidden" id="diagonalGroup">
                    <label for="diagonal" id="diagonalLabel">Desired Diagonal (inches)</label>
                    <input type="number" id="diagonal" name="diagonal" step="1" placeholder="e.g., 130">
                </div>

                <div class="back-btn-placeholder hidden">
                    <button type="button" class="back-btn" onclick="hideVisualization()">← Back to Input</button>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" id="submitButton" onclick="showVisualization()">Calculate Wall</button>
                </div>
            </div>
        </div>
        
        <div id="visualization">
            <h3>Configuration Summary</h3>
            
            <div id="enteredSummaryText"></div>

            <div class="summary-grid">
                <span id="pixelPitchDisplay"></span>
                <span id="finalArea"></span>
                <span id="cabinetSize"></span>
                <span id="cabinetPixels"></span>
                <span id="numCabinets"></span>
                <span id="totalModules"></span>
                <span id="aspectRatioValue"></span>
                <span id="finalDiagonal"></span>
                <span id="finalDimensions" style="grid-column: 1 / -1; background: #FFF3E0; color: #E65100;"></span>
                <span id="resolution" style="grid-column: 1 / -1; background: #E8F5E9; color: #1B5E20;"></span>
                <span id="totalPixels" style="grid-column: 1 / -1; background: #E8EAF6; color: #1A237E;"></span>
            </div>
            
            <h4>Control System & Logistics (Recommended)</h4>
            <div id="controlSystemDetails" class="summary-grid">
                </div>
            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="openControllerModal()">Customize Control System</button>
            </div>

            <h4 style="margin-top: 30px;">Wall Visualization (Cabinet Layout)</h4>
            <div class="vis-container">
                <div id="visWidthLabel" class="vis-label-w"></div>
                <div class="vis-grid" id="visGrid">
                    <div id="cabinetOverlay"></div>
                </div>
                <div id="visHeightLabel" class="vis-label-h"></div>
            </div>

            <div id="downloadPdfLink" class="button-group hidden">
                <button type="button" class="btn btn-primary" onclick="openContactModal()">Download PDF & Excel BOQ</button>
            </div>
        </div>

    </div>

    <div id="controllerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0; color: #0D47A1;">Customize Control System</h3>
                <span class="close" onclick="closeControllerModal()">&times;</span>
            </div>
            <p style="font-size: 13px; color: #666; margin-top: -10px;">Adjust the suggested controller and modular cards based on project specifics.</p>
            <div class="modal-grid">
                <div class="modal-form-group modal-grid-full">
                    <label for="modalControllerModel">Controller / Processor Model</label>
                    <select id="modalControllerModel" name="modalControllerModel"></select>
                </div>
                <div class="modal-form-group modal-grid-full">
                    <label for="modalSplicerSolution">Splicer / Modular Frame (if applicable)</label>
                    <input type="text" id="modalSplicerSolution" value="H5 Modular Splicer (5U) - Suggested for H-Series Cards">
                </div>
                <div class="modal-form-group">
                    <label for="modalOutputCardModel">Output/Sending Card Model</label>
                    <select id="modalOutputCardModel" onchange="updatePortsFromOutputCard()"></select>
                </div>
                <div class="modal-form-group">
                    <label for="modalMaxPortsPerCard">Max Ports per Card</label>
                    <input type="number" id="modalMaxPortsPerCard" readonly style="background: #eee;">
                </div>
                <div class="modal-form-group">
                    <label for="modalInputCardModel">Input Card Model</label>
                    <select id="modalInputCardModel"></select>
                </div>
                <div class="modal-form-group">
                    <label for="modalInputCardQty">Input Card Quantity</label>
                    <input type="number" id="modalInputCardQty" value="2" min="1">
                </div>
                <div class="checkbox-group modal-grid-full">
                    <input type="checkbox" id="modalIncludeHdmiOutput">
                    <label for="modalIncludeHdmiOutput" style="font-weight: 400;">Include H_4 x HDMI Output Card (for monitoring/loopout)</label>
                </div>
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button type="button" class="btn btn-primary" onclick="applyModalChanges()">Apply Changes & Recalculate</button>
                <button type="button" class="btn btn-secondary" onclick="closeControllerModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin: 0; color: #1B5E20;">Download BOQ</h3>
                <span class="close" onclick="closeContactModal()">&times;</span>
            </div>
            <p style="font-size: 13px; color: #666; margin-top: -10px;">The document will be downloaded in both **PDF** (Quotation format) and **CSV/Excel** (for easy price editing).</p>
            <div id="contactError" style="background: #FFCDD2; color: #B71C1C; padding: 10px; border-radius: 4px; margin-bottom: 15px;" class="hidden"></div>
            <div class="modal-form-group modal-grid-full" style="margin-bottom: 15px;">
                <label for="downloadEmail">Email ID (Optional, but recommended)</label>
                <input type="email" id="downloadEmail" placeholder="e.g., yourname@company.com">
            </div>
            <div class="modal-form-group modal-grid-full" style="margin-bottom: 15px;">
                <label for="downloadPhone">Phone Number (Optional)</label>
                <input type="tel" id="downloadPhone" placeholder="e.g., +91 99999 99999">
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button type="button" class="btn btn-primary" onclick="handleDownloadRequest()">Confirm & Download</button>
            </div>
        </div>
    </div>

<footer class="page-footer">
    </footer>

<script>
    // --- Constants ---
    const MM_PER_METER = 1000;
    const MM_PER_INCH = 25.4;
    const MM_PER_FOOT = MM_PER_INCH * 12;
    const METER_TO_FEET = 3.28084;
    const PIXELS_PER_PORT_DEFAULT = 650000; // fallback
    // Buffers: set global buffer to 5% as requested
    const GLOBAL_PORT_BUFFER_PCT = 0.05; // 5%
    const POWER_BUFFER = 1.15;
    const WEIGHT_BUFFER = 1.15;
    const MARGIN_PERCENT_TEXT = "15%";
    // --- PeopleLink LED Models ---
    const LED_PRODUCTS = {
        'cob_09': { name: "PeopleLink COB (0.9375mm)", pitch_mm: 0.9375, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 640, cabPixH: 360, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-1000", maxPower_W_m2: 300 },
        'cob_125': { name: "PeopleLink COB (1.25mm)", pitch_mm: 1.25, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 480, cabPixH: 270, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-800", maxPower_W_m2: 300 },
        'cob_15': { name: "PeopleLink COB (1.5625mm)", pitch_mm: 1.5625, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 384, cabPixH: 216, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-800", maxPower_W_m2: 300 },
        'indoor_186': { name: "PeopleLink SMD Indoor (1.86mm)", pitch_mm: 1.86, cabW_mm: 640, cabH_mm: 480, cabPixW: 344, cabPixH: 258, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 },
        'indoor_20': { name: "PeopleLink SMD Indoor (2.0mm)", pitch_mm: 2.0, cabW_mm: 640, cabH_mm: 480, cabPixW: 320, cabPixH: 240, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 },
        'indoor_25': { name: "PeopleLink SMD Indoor (2.5mm)", pitch_mm: 2.5, cabW_mm: 640, cabH_mm: 480, cabPixW: 256, cabPixH: 192, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 },
        'outdoor_40': { name: "PeopleLink SMD Outdoor (4.0mm)", pitch_mm: 4.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 240, cabPixH: 240, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 },
        'outdoor_667': { name: "PeopleLink SMD Outdoor (6.67mm)", pitch_mm: 6.67, cabW_mm: 960, cabH_mm: 960, cabPixW: 144, cabPixH: 144, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 },
        'outdoor_80': { name: "PeopleLink SMD Outdoor (8.0mm)", pitch_mm: 8.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 120, cabPixH: 120, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 },
        'outdoor_100': { name: "PeopleLink SMD Outdoor (10.0mm)", pitch_mm: 10.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 96, cabPixH: 96, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 },
    };

    const H_SERIES_DEFAULTS = {
        SPLICER_NAME: 'H5 Modular Splicer (5U) - Suggested for H-Series Cards',
        CONTROLLER_OPTIONS: [
            { model: 'VX1000', display: 'VX1000 Processor (AIO) - Max 6.5M Pixels', pixels: 6500000, type: 'AIO' },
            { model: 'VX600', display: 'VX600 Processor (AIO) - Max 3.9M Pixels', pixels: 3900000, type: 'AIO' },
            { model: 'VX400', display: 'VX400 Processor (AIO) - Max 2.6M Pixels', pixels: 2600000, type: 'AIO' },
            { model: 'H9', display: 'H9 Processor (Modular Frame)', pixels: 65000000, type: 'Modular' },
            { model: 'H5', display: 'H5 Processor (Modular Frame)', pixels: 32500000, type: 'Modular' },
        ],
        INPUT_CARD_OPTIONS: [
            { model: "H_1xHDMI2.0 input card (4K)", display: "1x 4K HDMI (Single Input)", qty: 1, type: "4K Single Input" },
            { model: "H_2xHDMI2.0 input card (4K)", display: "2x 4K HDMI (Dual Input)", qty: 1, type: "4K Dual Input" },
            { model: "H_4xHDMI input card (1080P)", display: "4x FHD HDMI (Quad Input)", qty: 1, type: "HD Quad Input" },
        ],
        DEFAULT_INPUT_CARD_MODEL: "H_1xHDMI2.0 input card (4K)",
        DEFAULT_INPUT_CARD_QTY: 2,
        OUTPUT_CARD_20_PORTS: 20,
        OUTPUT_CARD_20_MODEL: "H_20xRJ45 Sending Card",
        OUTPUT_CARD_16_PORTS: 16,
        OUTPUT_CARD_16_MODEL: "H_16xRJ45 Sending Card",
    };

    // Cabinets-per-long-LAN mapping — buffer fields replaced by global 5% buffer
    const CABINETS_PER_LONG_LAN = {
        'cob_09': { cabinetsPerRun: 2 }, // COB 0.9375 mm → 2 cabinets / long LAN cable
        'cob_125': { cabinetsPerRun: 5 }, // COB 1.25 mm → 5 cabinets / long LAN cable
        'cob_15': { cabinetsPerRun: 7 }, // COB 1.5625 mm → 7 cabinets / long LAN cable
        // SMD handled separately (pixel->port + 5% buffer)
    };

    // --- Parts Catalog (from provided spreadsheet image) ---
    const PARTS_CATALOG = {
        // Controllers / Processors
        'VX1000': { part: 'TP-AIO-VX1000', desc: 'AIO LED Video Processor/Controller' },
        'VX600': { part: 'TP-AIO-VX600', desc: 'AIO LED Video Processor/Controller' },
        'VX400': { part: 'TP-AIO-VX400', desc: 'AIO LED Video Processor/Controller' },
        'H9': { part: 'TP-PRO-H9', desc: 'Modular 9-Slot Processor Frame' },
        'H5': { part: 'TP-PRO-H5', desc: 'Modular 5-Slot Processor Frame' },
        // Sending / Input / Output Cards
        'H_20xRJ45 Sending Card': { part: 'TP-XOC-RJ45-20', desc: 'H_20 x RJ45 Sending Card' },
        'H_16xRJ45 Sending Card': { part: 'TP-XOC-RJ45-16', desc: 'H_16 x RJ45 Sending Card' },
        'H_1xHDMI2.0 input card (4K)': { part: 'TP-XIC-HDMI2.0', desc: 'H_1x HDMI2.0 Input Card (4K)' },
        'H_2xHDMI2.0 input card (4K)': { part: 'TP-XIC-HDMI2.0-2', desc: 'H_2x HDMI2.0 Input Card (4K)' },
        'H_4xHDMI input card (1080P)': { part: 'TP-XIC-HDMI-4', desc: 'H_4x HDMI Input Card (1080P)' },
        'H_4_HDMI_Out': { part: 'TP-XOC-HDMI4', desc: 'H_4 x HDMI Output Card' },
        // Power / accessories
        'H_800W_PSU': { part: 'TP-XPS-H800W', desc: 'H_800W Power Supply' },
        'H_preview_card': { part: 'TP-XOC-RJ45-2-HDMI1', desc: 'H_2 x RJ45 + 1 x HDMI preview card' },
        'VNNOX_Cloud': { part: 'TBD', desc: 'One-Stop Cloud Platform VNNOX Standard' },
        'H_audio_card': { part: 'TBD', desc: 'H_2xAudio input+2xAudio output card' },
        // Active LED Products / Modules (COB)
        'PPL-COB-09': { part: 'PPL-COB-MDL-CU-09', desc: 'PeopleLink Active LED | 0.9PP COB (Including Modules)' },
        'PPL-COB-125': { part: 'PPL-COB-MDL-CU-12', desc: 'PeopleLink Active LED | 1.25PP COB (Including Modules)' },
        'PPL-COB-156': { part: 'PPL-COB-MDL-CU-12', desc: 'PeopleLink Active LED | 1.56PP COB (Including Modules)' },
        // SMB Indoor
        'PPL-SMD-18': { part: 'PPL-SMD-MDL-CU-18', desc: 'PeopleLink ActiveLED | 1.8PP Video LED Cabinets (Including Modules)' },
        'PPL-ALD-CU': { part: 'PPL-ALD-CU', desc: 'PeopleLink ActiveLED | Video Wall Cabinet Unit (640x480mm)' },
        'PDS-TP-15-T': { part: 'PDS-TP-15-T', desc: 'PeopleLink ActiveLED | 2.0PP Video LED Modules' },
        // SMB Outdoor
        'PPL-SMD-40': { part: 'PPL-SMD-MDL-CU-40', desc: 'PeopleLink ActiveLED | 4.0PP Outdoor Video Wall Cabinet' },
        'PPL-SMD-667': { part: 'PPL-SMD-MDL-CU-667', desc: 'PeopleLink ActiveLED | 6.67PP Outdoor Video Wall Cabinet' },
        'PPL-SMD-80': { part: 'PPL-SMD-MDL-CU-80', desc: 'PeopleLink ActiveLED | 8.0PP Outdoor Video Wall Cabinet' },
        'PPL-SMD-100': { part: 'PPL-SMD-MDL-CU-100', desc: 'PeopleLink ActiveLED | 10.0PP Outdoor Video Wall Cabinet' },
        // Mounting
        'PPL-FMOUNT-60': { part: 'PPL-FMOUNT-60', desc: 'Front Maintenance Mounting Frame (600x337.5mm)' },
        'PPL-FMOUNT-64': { part: 'PPL-FMOUNT-64', desc: 'Front Maintenance Mounting Frame (640x480mm)' },
        'PPL-FMOUNT-96': { part: 'PPL-FMOUNT-96', desc: 'Front Maintenance Mounting Frame (960x960mm)' },
        'PPL-FMOUNT-ADAPTOR': { part: 'PPL-FMOUNT-ADAPTOR', desc: 'Cabinet to Wall Adaptor (Per Cabinet)' },
    };

    // --- State Variables ---
    let finalCalculationData = null;
    let contactInfo = { email: '', phone: '' };

    // --- Helper Functions ---
    function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
    function formatNumber(num, fixed = 0) { return num.toFixed(fixed).replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function escapeHtml(unsafe) {
        return unsafe.replace(/[&<>"'`=\/]/g, function (s) {
            return ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
                '/': '&#x2F;',
                '`': '&#x60;',
                '=': '&#x3D;'
            })[s];
        });
    }

    // Helper: build BOQ items using calculated data + parts catalog
    function generateBOQList(data) {
        // returns array of { combined, partcode, qty, unit }
        const list = [];
        // Controller
        let ctrlKey = null;
        if (data.controllerName) {
            const m = data.controllerName.match(/(VX1000|VX600|VX400|H9|H5)/i);
            if (m) ctrlKey = m[0];
            else {
                // Fallback for modular systems where the name is complex
                if (data.controllerName.includes('H9')) ctrlKey = 'H9';
                if (data.controllerName.includes('H5')) ctrlKey = 'H5';
            }
        }
        const ctrlPart = (ctrlKey && PARTS_CATALOG[ctrlKey])
            ? PARTS_CATALOG[ctrlKey].part : (PARTS_CATALOG[data.controllerName] ? PARTS_CATALOG[data.controllerName].part : 'TBD');
        const ctrlDesc = (ctrlKey && PARTS_CATALOG[ctrlKey]) ? PARTS_CATALOG[ctrlKey].desc : (data.controllerName || 'Controller/Processor');
        list.push({ combined: `Controller/Processor — ${ctrlDesc}`, partcode: ctrlPart || 'TBD', qty: 1, unit: 'PCS' });

        // Receiving Cards (embedded)
        list.push({ combined: `Receiving Cards (embedded) — ${data.totalRecCards} R-cards`, partcode: 'Embedded', qty: data.totalRecCards, unit: 'PCS' });

        // Sending / Output cards (modular)
        if (data.controllerType && data.controllerType.includes('Modular')) {
            const outCardModel = data.outputCardModel || H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL;
            const outCardPart = PARTS_CATALOG[outCardModel] ? PARTS_CATALOG[outCardModel].part : 'TBD';
            list.push({ combined: `Modular Output Card — ${outCardModel}`, partcode: outCardPart, qty: data.requiredSendCards, unit: 'PCS' });

            // Input Card
            const inputCardModel = data.inputCardModel || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL;
            const inputCardPart = PARTS_CATALOG[inputCardModel] ? PARTS_CATALOG[inputCardModel].part : 'TBD';
            list.push({ combined: `Input Card — ${inputCardModel}`, partcode: inputCardPart, qty: data.inputCardQty, unit: 'PCS' });

            // Splicer
            if (data.splicerSolution) {
                list.push({ combined: `Splicer Frame/Solution — ${data.splicerSolution}`, partcode: 'TBD', qty: 1, unit: 'PCS' });
            }

            // Optional HDMI Output Card
            if (data.includeHdmiOutput) {
                list.push({ combined: `Optional Output Card — H_4 x HDMI Output Card (for monitoring/loopout)`, partcode: PARTS_CATALOG['H_4_HDMI_Out'] ? PARTS_CATALOG['H_4_HDMI_Out'].part : 'TBD', qty: 1, unit: 'PCS' });
            }
        }

        // Long ethernet ports / controller ports
        list.push({ combined: `Controller → Wall Long Ethernet Ports (post-buffer)`, partcode: 'TBD', qty: data.requiredPortsBuffered, unit: 'PCS' });
        list.push({ combined: `Inter-Cabinet Short Ethernet (CAT6)`, partcode: 'TBD', qty: data.requiredShortEthernet, unit: 'PCS' });

        // LED Cabinets & Modules
        const ledPartKey = (() => {
            if (data.pixelPitch_mm <= 1.0) return 'PPL-COB-09';
            if (data.pixelPitch_mm <= 1.3) return 'PPL-COB-125';
            if (data.pixelPitch_mm <= 1.7) return 'PPL-COB-156';
            if (data.cabinetW_mm === 640 && data.pixelPitch_mm <= 2.0) return 'PPL-SMD-18';
            if (data.cabinetW_mm === 640) return 'PPL-ALD-CU'; // Generic SMD indoor cabinet (2.5mm)
            if (data.cabinetW_mm === 960 && data.pixelPitch_mm <= 4.0) return 'PPL-SMD-40';
            if (data.cabinetW_mm === 960 && data.pixelPitch_mm <= 6.67) return 'PPL-SMD-667';
            if (data.cabinetW_mm === 960 && data.pixelPitch_mm <= 8.0) return 'PPL-SMD-80';
            if (data.cabinetW_mm === 960) return 'PPL-SMD-100';
            return 'PPL-ALD-CU';
        })();
        const ledPart = PARTS_CATALOG[ledPartKey] ? PARTS_CATALOG[ledPartKey].part : 'TBD';
        list.push({ combined: `LED Cabinets (including modules) — ${data.productName}`, partcode: ledPart || 'TBD', qty: data.totalCabinets, unit: 'PCS' });

        // Spare modules
        const sparePct = (data.productName && data.productName.toLowerCase().includes('cob')) ? 0.05 : 0.10;
        const spareModulesQty = Math.max(1, Math.round(data.totalModules * sparePct));
        list.push({ combined: `Spare Modules (Recommended ${Math.round(sparePct * 100)}% of total)`, partcode: 'TBD', qty: spareModulesQty, unit: 'PCS' });

        // Mounting Frames
        let mountPartKey = null;
        if (data.cabinetW_mm === 600) mountPartKey = 'PPL-FMOUNT-60';
        else if (data.cabinetW_mm === 640) mountPartKey = 'PPL-FMOUNT-64';
        else if (data.cabinetW_mm === 960) mountPartKey = 'PPL-FMOUNT-96';
        if (mountPartKey) {
            list.push({ combined: `Front Maintenance Mounting Frame (Per Cabinet)`, partcode: PARTS_CATALOG[mountPartKey].part, qty: data.totalCabinets, unit: 'PCS' });
        } else {
            list.push({ combined: `Cabinet to Wall Adaptor`, partcode: PARTS_CATALOG['PPL-FMOUNT-ADAPTOR'].part, qty: data.totalCabinets, unit: 'PCS' });
        }

        // Power Supplies
        const psuQty = Math.max(1, Math.ceil(data.maxPower_W_buffered / 800)); // Assuming 800W PSUs
        list.push({ combined: `Modular Power Supplies (800W/ea) - Buffered`, partcode: PARTS_CATALOG['H_800W_PSU'].part, qty: psuQty, unit: 'PCS' });

        return list;
    }

    // --- Core Logic Functions ---
    function toggleMeasurementFields() {
        const unit = document.getElementById('unit').value;
        const isDiagonal = (unit === 'inches');
        document.getElementById('widthLabel').textContent = `Desired Width (${unit === 'feet' ? 'ft' : 'm'})`;
        document.getElementById('heightLabel').textContent = `Desired Height (${unit === 'feet' ? 'ft' : 'm'})`;
        document.getElementById('aspectRatioLabel').textContent = 'Target Aspect Ratio (Optional)';
        document.getElementById('widthGroup').classList.toggle('hidden', isDiagonal);
        document.getElementById('heightGroup').classList.toggle('hidden', isDiagonal);
        document.getElementById('diagonalGroup').classList.toggle('hidden', !isDiagonal);
        if (isDiagonal) {
            document.getElementById('width').value = '';
            document.getElementById('height').value = '';
        } else {
            document.getElementById('diagonal').value = '';
        }
        document.getElementById('errorMessage').classList.add('hidden');
    }

    function calculateLEDWall() {
        const productKey = document.getElementById('productModel').value;
        const unit = document.getElementById('unit').value;
        const widthInput = document.getElementById('width').value;
        const heightInput = document.getElementById('height').value;
        const diagonalInput = document.getElementById('diagonal').value;
        const aspectRatioKey = document.getElementById('aspectRatio').value;
        let inputW = parseFloat(widthInput);
        let inputH = parseFloat(heightInput);
        let inputD = parseFloat(diagonalInput);
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.classList.add('hidden');

        if (!productKey || !unit || ((unit !== 'inches' && (!inputW && !inputH)) || (unit === 'inches' && !inputD))) {
            errorDiv.textContent = 'ERROR: Please select a Model, Unit, and enter valid dimensions to continue.';
            errorDiv.classList.remove('hidden');
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return null;
        }

        const details = LED_PRODUCTS[productKey];
        const cabinetW_mm = details.cabW_mm;
        const cabinetH_mm = details.cabH_mm;
        let desiredW_mm, desiredH_mm;
        let usedW_input, usedH_input, usedRatio = aspectRatioKey || 'None Specified';
        let inputDiagonal;

        if (unit === 'inches') {
            const ratioToUse = aspectRatioKey || '16:9';
            const [ratioW, ratioH] = ratioToUse.split(':').map(Number);
            const ratioDiagonal = Math.sqrt(ratioW * ratioW + ratioH * ratioH);
            const factor = inputD / ratioDiagonal;
            desiredW_mm = factor * ratioW * MM_PER_INCH;
            desiredH_mm = factor * ratioH * MM_PER_INCH;
            usedW_input = `${(desiredW_mm / MM_PER_METER).toFixed(2)}m`;
            usedH_input = `${(desiredH_mm / MM_PER_METER).toFixed(2)}m`;
            inputDiagonal = inputD;
        } else {
            const conversionFactor = (unit === 'feet') ? MM_PER_FOOT : MM_PER_METER;
            let hasW = !isNaN(inputW) && inputW > 0;
            let hasH = !isNaN(inputH) && inputH > 0;

            if (hasW) desiredW_mm = inputW * conversionFactor;
            if (hasH) desiredH_mm = inputH * conversionFactor;

            if (hasW && hasH) {
                // Both provided, use both
                usedW_input = `${inputW}${unit === 'feet' ? 'ft' : 'm'}`;
                usedH_input = `${inputH}${unit === 'feet' ? 'ft' : 'm'}`;
            } else if (hasW) {
                // Width provided, calculate H based on target ratio or cabinet AR
                const [ratioW, ratioH] = (aspectRatioKey || `${cabinetW_mm}:${cabinetH_mm}`).split(':').map(Number);
                desiredH_mm = desiredW_mm * (ratioH / ratioW);
                usedW_input = `${inputW}${unit === 'feet' ? 'ft' : 'm'}`;
                usedH_input = 'Calculated from W';
                if (!aspectRatioKey) usedRatio = `Inferred from Cabinet AR (${cabinetW_mm}:${cabinetH_mm})`;
            } else if (hasH) {
                // Height provided, calculate W based on target ratio or cabinet AR
                const [ratioW, ratioH] = (aspectRatioKey || `${cabinetW_mm}:${cabinetH_mm}`).split(':').map(Number);
                desiredW_mm = desiredH_mm * (ratioW / ratioH);
                usedW_input = 'Calculated from H';
                usedH_input = `${inputH}${unit === 'feet' ? 'ft' : 'm'}`;
                if (!aspectRatioKey) usedRatio = `Inferred from Cabinet AR (${cabinetW_mm}:${cabinetH_mm})`;
            }
            inputDiagonal = 0;
        }

        // Cabinet counts and basic geometry
        let numCabW = Math.max(1, Math.round(desiredW_mm / cabinetW_mm));
        let numCabH = Math.max(1, Math.round(desiredH_mm / cabinetH_mm));
        const totalCabinets = numCabW * numCabH;
        const totalModules = totalCabinets * details.modulesPerCab;
        const finalW_mm = numCabW * cabinetW_mm;
        const finalH_mm = numCabH * cabinetH_mm;

        const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);
        const finalResW = numCabW * details.cabPixW;
        const finalResH = numCabH * details.cabPixH;
        const totalPixels = finalResW * finalResH;
        const ratioGCD = gcd(finalResW, finalResH);
        const aspectRatioText = `${finalResW / ratioGCD}:${finalResH / ratioGCD}`;
        const finalDiagonal_mm = Math.sqrt(finalW_mm * finalW_mm + finalH_mm * finalH_mm);
        const finalDiagonal_in = finalDiagonal_mm / MM_PER_INCH;
        const minViewingDistance_ft = details.pitch_mm * METER_TO_FEET;

        // Power & weight
        const actualPower_W_unbuffered = finalArea_m2 * details.maxPower_W_m2;
        const maxPower_W_buffered = actualPower_W_unbuffered * POWER_BUFFER;
        const actualCurrent_A = actualPower_W_unbuffered / 220;
        const totalWallWeight_buffered = details.weight_kg * totalCabinets * WEIGHT_BUFFER;

        // --- LAN / Port Rules with global 5% buffer ---
        const ports_by_pixels = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_DEFAULT));
        let cabinetsRule = CABINETS_PER_LONG_LAN[productKey];
        let requiredLongEthRuns = 0;
        let ports_by_cabinets = 0;

        if (cabinetsRule) {
            // Rule 1: Use specific cabinet-per-run rule for COB
            requiredLongEthRuns = Math.max(1, Math.ceil(numCabH * numCabW / cabinetsRule.cabinetsPerRun));
            ports_by_cabinets = requiredLongEthRuns;
        } else {
            // Rule 2: Use pixel-based rule for SMD
            requiredLongEthRuns = Math.max(1, ports_by_pixels);
            ports_by_cabinets = requiredLongEthRuns;
        }

        // Final required ports is the maximum of the two rules
        const requiredPorts = Math.max(ports_by_pixels, ports_by_cabinets);
        const requiredPortsBuffered = Math.max(1, Math.ceil(requiredPorts * (1 + GLOBAL_PORT_BUFFER_PCT)));

        // Recommended Controller logic
        const suggestedController = H_SERIES_DEFAULTS.CONTROLLER_OPTIONS.find(c => c.pixels >= totalPixels) || H_SERIES_DEFAULTS.CONTROLLER_OPTIONS[H_SERIES_DEFAULTS.CONTROLLER_OPTIONS.length - 1];
        let controllerName = suggestedController.display;
        let controllerType = suggestedController.type;
        let outputCardModel = H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL;
        let outputCardPorts = H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS;
        let splicerSolution = H_SERIES_DEFAULTS.SPLICER_NAME;
        let requiredSendCards = 1;
        let inputCardModel = H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL; // Store only the model name
        let inputCardQty = H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;
        let totalRecCards = totalCabinets;

        if (controllerType === 'Modular') {
            // Calculate required output cards based on buffered ports
            requiredSendCards = Math.max(1, Math.ceil(requiredPortsBuffered / outputCardPorts));
        }

        // Short Ethernet required: (numCabW-1) * numCabH + (numCabH-1) * numCabW + totalCabinets (for runs into the cab)
        const totalCabinetConnections = (numCabW * numCabH) - 1; // minimum connections
        const requiredShortEthernet = Math.max(totalCabinetConnections, totalCabinets * 2); // Buffer to total cabinets * 2

        const finalCalculationData = {
            productName: details.name,
            pixelPitch_mm: details.pitch_mm,
            cabinetW_mm: cabinetW_mm,
            cabinetH_mm: cabinetH_mm,
            cabPixW: details.cabPixW,
            cabPixH: details.cabPixH,
            modulesPerCab: details.modulesPerCab,
            numCabW: numCabW,
            numCabH: numCabH,
            totalCabinets: totalCabinets,
            totalModules: totalModules,
            finalW_mm: finalW_mm,
            finalH_mm: finalH_mm,
            finalArea_m2: finalArea_m2,
            finalResW: finalResW,
            finalResH: finalResH,
            totalPixels: totalPixels,
            aspectRatioText: aspectRatioText,
            finalDiagonal_in: finalDiagonal_in,
            minViewingDistance_ft: minViewingDistance_ft,
            pixelDensity: totalPixels / finalArea_m2,
            actualPower_W_unbuffered: actualPower_W_unbuffered,
            maxPower_W_buffered: maxPower_W_buffered,
            actualCurrent_A: actualCurrent_A,
            maxCurrent_A_buffered: maxPower_W_buffered / 220,
            actualWallWeight_unbuffered: details.weight_kg * totalCabinets,
            totalWallWeight_buffered: totalWallWeight_buffered,
            controllerName: controllerName,
            controllerType: controllerType,
            requiredPorts: requiredPorts,
            requiredPortsBuffered: requiredPortsBuffered,
            requiredLongEthRuns: requiredLongEthRuns,
            requiredShortEthernet: requiredShortEthernet,
            outputCardPorts: outputCardPorts,
            outputCardModel: outputCardModel,
            requiredSendCards: requiredSendCards,
            inputCardModel: inputCardModel, // Stored as model name only
            inputCardQty: inputCardQty,
            splicerSolution: splicerSolution,
            totalRecCards: totalCabinets,
            includeHdmiOutput: false // Initialize optional setting
        };
        return finalCalculationData;
    }

    function calculateDimensions(data) {
        const finalW_M = data.finalW_mm / MM_PER_METER;
        const finalH_M = data.finalH_mm / MM_PER_METER;
        const finalW_FT = data.finalW_mm / MM_PER_FOOT;
        const finalH_FT = data.finalH_mm / MM_PER_FOOT;
        return { finalW_M, finalH_M, finalW_FT, finalH_FT };
    }

    function showVisualization() {
        const data = finalCalculationData = calculateLEDWall();
        if (!data) return;
        
        // This block ensures that if the calculation runs again, it preserves user customization
        if (!data.outputCardModel) {
             data.outputCardModel = H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL;
             data.outputCardPorts = H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS;
             data.inputCardModel = H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL;
             data.inputCardQty = H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;
             data.splicerSolution = H_SERIES_DEFAULTS.SPLICER_NAME;
        }

        const { finalW_M, finalH_M, finalW_FT, finalH_FT } = calculateDimensions(data);
        document.getElementById('enteredSummaryText').textContent = `Cabinet Matrix: ${data.numCabW}x${data.numCabH} (${data.totalCabinets} Cabinets)`;
        document.getElementById('aspectRatioValue').textContent = data.aspectRatioText;
        document.getElementById('formContainer').classList.add('minimized');
        document.getElementById('submitButton').classList.add('hidden');
        document.querySelector('.back-btn-placeholder').classList.remove('hidden');
        document.getElementById('visualization').classList.add('visible');
        document.getElementById('pixelPitchDisplay').innerHTML = `<strong>Pixel Pitch :</strong><small>${data.pixelPitch_mm} mm</small>`;
        document.getElementById('finalDimensions').innerHTML = `<strong>Actual Final Dimensions (WxH) :</strong><small>(${finalW_FT.toFixed(2)}ft x ${finalH_FT.toFixed(2)}ft) - ${finalW_M.toFixed(2)}m x ${finalH_M.toFixed(2)}m</small>`;
        document.getElementById('resolution').innerHTML = `<strong>Actual Final Resolution (WxH) :</strong><small>${data.finalResW} x ${data.finalResH}</small>`;
        document.getElementById('numCabinets').innerHTML = `<strong>Total Cabinets (W x H) :</strong><small>${data.totalCabinets} (${data.numCabW} x ${data.numCabH})</small>`;
        document.getElementById('totalModules').innerHTML = `<strong>Total Modules Required :</strong><small>${data.totalModules} (${data.modulesPerCab} per cabinet)</small>`;
        document.getElementById('finalDiagonal').innerHTML = `<strong>Final Diagonal Size :</strong><small>${data.finalDiagonal_in.toFixed(1)} in</small>`;
        document.getElementById('finalArea').innerHTML = `<strong>Final Wall Area :</strong><small>${data.finalArea_m2.toFixed(2)} m²</small>`;
        document.getElementById('totalPixels').innerHTML = `<strong>Total Pixels :</strong><small>${formatNumber(data.totalPixels, 0)}</small>`;
        document.getElementById('cabinetSize').innerHTML = `<strong>Cabinet Size :</strong><small>${data.cabinetW_mm}mm x ${data.cabinetH_mm}mm</small>`;
        document.getElementById('cabinetPixels').innerHTML = `<strong>Cabinet Resolution :</strong><small>${data.cabPixW} x ${data.cabPixH}</small>`;

        const controlSystemDetailsDiv = document.getElementById('controlSystemDetails');
        let htmlContent = `
            <span><strong>Suggested Controller/Processor :</strong><small>${data.controllerName}</small></span>
            <span><strong>Required Sending Ports (Buffered):</strong><small>${data.requiredPortsBuffered} Ports (+${(GLOBAL_PORT_BUFFER_PCT * 100).toFixed(0)}% safety buffer)</small></span>
        `;
        if (data.controllerType === 'Modular') {
            htmlContent += `
                <span><strong>Required Output Cards :</strong><small>${data.requiredSendCards} x ${data.outputCardModel} (${data.outputCardPorts} ports/card)</small></span>
                <span><strong>Input Cards (Example) :</strong><small>${data.inputCardQty} x ${data.inputCardModel}</small></span>
                <span><strong>Splicer/Processor Frame :</strong><small>${data.splicerSolution}</small></span>
            `;
        }

        htmlContent += `
            <span><strong>Min. Viewing Distance :</strong><small>${data.minViewingDistance_ft.toFixed(1)} ft</small></span>
            <span style="grid-column: 1 / -1; font-weight: 700; color: #0D47A1; border-bottom: 1px solid #0D47A1; padding-bottom: 5px; margin-bottom: 5px; margin-top: 10px;">Power and Weight (Buffered Figures)</span>
            <span id="wallPowerActual"><strong>Max Power Consumption (Buffered) :</strong><small>${formatNumber(data.maxPower_W_buffered, 0)} W</small></span>
            <span id="wallCurrent"><strong>Max Current Draw (Buffered @220V) :</strong><small>${data.maxCurrent_A_buffered.toFixed(2)} A</small></span>
            <span id="cabinetWeightActual"><strong>Total Wall Weight (Buffered) :</strong><small>${formatNumber(data.totalWallWeight_buffered, 1)} kg</small></span>
        `;
        controlSystemDetailsDiv.innerHTML = htmlContent;

        const aspectRatio = data.finalW_mm / data.finalH_mm;
        const visualizationHeight = 300;
        const visGrid = document.getElementById('visGrid');
        visGrid.style.width = '100%';
        setTimeout(() => {
            try {
                const w = visGrid.clientWidth || Math.min(window.innerWidth - 200, 800);
                const computedH = Math.max(120, Math.min(visualizationHeight, Math.round(w / aspectRatio)));
                visGrid.style.height = `${computedH}px`;
            } catch (e) {
                visGrid.style.height = `${visualizationHeight}px`;
            }
        }, 50);

        document.getElementById('visWidthLabel').textContent = `${finalW_M.toFixed(2)} m (W)`;
        document.getElementById('visHeightLabel').textContent = `${finalH_M.toFixed(2)} m (H)`;

        // Cabinet overlay
        const cabinetOverlay = document.getElementById('cabinetOverlay');
        cabinetOverlay.innerHTML = '';
        cabinetOverlay.style.gridTemplateColumns = `repeat(${data.numCabW}, 1fr)`;
        cabinetOverlay.style.gridTemplateRows = `repeat(${data.numCabH}, 1fr)`;
        cabinetOverlay.style.display = 'grid';
        let tooltip = document.getElementById('cabTooltip');
        if (!tooltip) {
            tooltip = document.createElement('div');
            tooltip.id = 'cabTooltip';
            tooltip.className = 'tooltip-cab';
            document.body.appendChild(tooltip);
        }

        for (let r = 0; r < data.numCabH; r++) {
            for (let c = 0; c < data.numCabW; c++) {
                const cabDiv = document.createElement('div');
                cabDiv.innerHTML = `<span class="cab-label">${c + 1}-${r + 1}</span>`;

                const mouseEnterHandler = function (e) {
                    tooltip.style.display = 'block';
                    tooltip.innerHTML = `Cabinet: ${c + 1}-${r + 1}<br>Resolution: ${data.cabPixW}x${data.cabPixH}<br>Pixels: ${formatNumber(data.cabPixW * data.cabPixH, 0)}`;
                };
                const mouseMoveHandler = function (e) {
                    tooltip.style.left = `${e.pageX + 10}px`;
                    tooltip.style.top = `${e.pageY - 10}px`;
                };
                const mouseLeaveHandler = function () {
                    tooltip.style.display = 'none';
                };

                cabDiv.addEventListener('mouseenter', mouseEnterHandler);
                cabDiv.addEventListener('mousemove', mouseMoveHandler);
                cabDiv.addEventListener('mouseleave', mouseLeaveHandler);

                cabinetOverlay.appendChild(cabDiv);
            }
        }
        document.getElementById('downloadPdfLink').classList.remove('hidden');
        document.getElementById('visualization').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function hideVisualization() {
        document.getElementById('formContainer').classList.remove('minimized');
        document.getElementById('submitButton').classList.remove('hidden');
        document.querySelector('.back-btn-placeholder').classList.add('hidden');
        document.getElementById('visualization').classList.remove('visible');
        document.getElementById('downloadPdfLink').classList.add('hidden');
        const tooltip = document.getElementById('cabTooltip');
        if (tooltip) tooltip.style.display = 'none';
        document.getElementById('formContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- Modal Functions ---
    function populateModalControllers() {
        const select = document.getElementById('modalControllerModel');
        select.innerHTML = '';
        H_SERIES_DEFAULTS.CONTROLLER_OPTIONS.forEach(controller => {
            const opt = document.createElement('option');
            opt.value = controller.model;
            opt.textContent = controller.display;
            select.appendChild(opt);
        });
    }

    function populateModalOutputCards() {
        const select = document.getElementById('modalOutputCardModel');
        select.innerHTML = '';
        const cards = [
            { model: H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL, ports: H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS },
            { model: H_SERIES_DEFAULTS.OUTPUT_CARD_16_MODEL, ports: H_SERIES_DEFAULTS.OUTPUT_CARD_16_PORTS },
            { model: 'H_4_HDMI_Out', ports: 4 }
        ];
        cards.forEach(card => {
            const opt = document.createElement('option');
            opt.value = `${card.model}|${card.ports}`;
            opt.textContent = `${card.model} (${card.ports} ports)`;
            select.appendChild(opt);
        });
    }

    function populateModalInputCards() {
        const select = document.getElementById('modalInputCardModel');
        select.innerHTML = '';
        H_SERIES_DEFAULTS.INPUT_CARD_OPTIONS.forEach(option => {
            const opt = document.createElement('option');
            opt.value = `${option.model}|${option.qty}`;
            opt.textContent = option.display;
            select.appendChild(opt);
        });
    }

    function updatePortsFromOutputCard() {
        const select = document.getElementById('modalOutputCardModel');
        const [model, ports] = select.value.split('|');
        document.getElementById('modalMaxPortsPerCard').value = ports;
    }

    function openControllerModal() {
        if (!finalCalculationData) return; // Safety check

        populateModalControllers();
        populateModalOutputCards();
        populateModalInputCards();

        const suggestedControllerModel = finalCalculationData.controllerName.split('(')[0].trim().split(' ')[0]; // VX1000 or H5
        const controllerSelect = document.getElementById('modalControllerModel');
        if (controllerSelect.querySelector(`option[value="${suggestedControllerModel}"]`)) {
            controllerSelect.value = suggestedControllerModel;
        }

        document.getElementById('modalSplicerSolution').value = finalCalculationData.splicerSolution || H_SERIES_DEFAULTS.SPLICER_NAME;

        const currentOutputCardValue = `${finalCalculationData.outputCardModel}|${finalCalculationData.outputCardPorts}`;
        const outputCardSelect = document.getElementById('modalOutputCardModel');
        if (outputCardSelect.querySelector(`option[value="${currentOutputCardValue}"]`)) {
            outputCardSelect.value = currentOutputCardValue;
        } else {
            outputCardSelect.value = `${H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL}|${H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS}`;
        }
        updatePortsFromOutputCard(); // Set the ports display based on selection

        // Fix: Use the model name to find the correct option value for input card selection
        const inputCardOption = H_SERIES_DEFAULTS.INPUT_CARD_OPTIONS.find(o => o.model === finalCalculationData.inputCardModel);
        if (inputCardOption) {
             const inputCardValue = `${inputCardOption.model}|${inputCardOption.qty}`;
             document.getElementById('modalInputCardModel').value = inputCardValue;
        } else {
             // Fallback to default
             document.getElementById('modalInputCardModel').value = `${H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL}|${H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY}`;
        }

        document.getElementById('modalInputCardQty').value = finalCalculationData.inputCardQty;
        document.getElementById('modalIncludeHdmiOutput').checked = finalCalculationData.includeHdmiOutput || false;

        document.getElementById('controllerModal').style.display = 'block';
    }

    function closeControllerModal() {
        document.getElementById('controllerModal').style.display = 'none';
    }

    function applyModalChanges() {
        const controllerModel = document.getElementById('modalControllerModel').value;
        const splicerSolution = document.getElementById('modalSplicerSolution').value.trim();
        const [outputCardModel, outputCardPorts] = document.getElementById('modalOutputCardModel').value.split('|');
        const [inputCardModelNew] = document.getElementById('modalInputCardModel').value.split('|'); // Get only the model name
        const inputCardQtyManual = parseInt(document.getElementById('modalInputCardQty').value) || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;
        const includeHdmiOutput = document.getElementById('modalIncludeHdmiOutput').checked;

        // Find the selected controller's full display name and type
        const selectedController = H_SERIES_DEFAULTS.CONTROLLER_OPTIONS.find(c => c.model === controllerModel);

        finalCalculationData.controllerName = selectedController.display;
        finalCalculationData.controllerType = selectedController.type;
        finalCalculationData.splicerSolution = splicerSolution;
        finalCalculationData.outputCardModel = outputCardModel;
        finalCalculationData.outputCardPorts = parseInt(outputCardPorts);
        finalCalculationData.inputCardModel = inputCardModelNew; // Store model name only
        finalCalculationData.inputCardQty = inputCardQtyManual;
        finalCalculationData.includeHdmiOutput = includeHdmiOutput;

        // Recalculate sending cards based on the new output card ports
        if (finalCalculationData.controllerType === 'Modular') {
            finalCalculationData.requiredSendCards = Math.max(1, Math.ceil(finalCalculationData.requiredPortsBuffered / finalCalculationData.outputCardPorts));
        }

        closeControllerModal();
        showVisualization(); // Re-render the visualization with new controller details
    }

    function openContactModal() {
        document.getElementById('contactModal').style.display = 'block';
        document.getElementById('contactError').classList.add('hidden');
    }

    function closeContactModal() {
        document.getElementById('contactModal').style.display = 'none';
    }

    function handleDownloadRequest() {
        const email = document.getElementById('downloadEmail').value.trim();
        const phone = document.getElementById('downloadPhone').value.trim();
        const contactError = document.getElementById('contactError');
        contactError.classList.add('hidden');

        if (email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                contactError.textContent = 'Please enter a valid Email ID.';
                contactError.classList.remove('hidden');
                return;
            }
        }
        contactInfo.email = email;
        contactInfo.phone = phone;

        closeContactModal();

        // Fulfill request: Download in both PDF and Excel formats
        proceedToDownloadPdf();
        downloadExcelBOQ(finalCalculationData);
    }
    
    // --- NEW FUNCTION: Download BOQ as Excel (CSV) ---
    function downloadExcelBOQ(data) {
        if (!data) return;
        const boqList = generateBOQList(data);
        
        let csv = "S.No.,Description / Item,Part Code,Quantity,Unit,Unit Price,Total Price\n";
        
        boqList.map((item, index) => {
            // Replace commas in description to avoid breaking CSV format
            const description = item.combined.replace(/,/g, ' '); 
            const row = [
                index + 1,
                description,
                item.partcode,
                item.qty,
                item.unit,
                "", // Unit Price Placeholder
                ""  // Total Price Placeholder
            ];
            csv += row.join(',') + '\n';
        });
        
        // Create and download CSV file
        const link = document.createElement('a');
        link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
        link.download = `PeopleLink_LED_Config_${data.finalResW}x${data.finalResH}_BOQ.csv`; // CSV is easily editable in Excel
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // --- MODIFIED FUNCTION: proceedToDownloadPdf (FIXED OVERLAP) ---
    function proceedToDownloadPdf() {
        const data = finalCalculationData;
        const { finalW_M, finalH_M, finalW_FT, finalH_FT } = calculateDimensions(data);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        let y = 8;
        const margin = 10;
        const lineHeight = 5.5;
        const pageW = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const primaryColor = [13, 71, 161]; // #0D47A1
        const secondaryColor = [27, 94, 32]; // #1B5E20

        // --- Quotation Format Header --- 
        doc.setFontSize(16);
        doc.setTextColor(...primaryColor);
        doc.setFont('inter', 'bold');
        doc.text('PeopleLink LED Video Wall - Quotation & Technical Summary', margin, y);
        y += lineHeight * 2;
        
        doc.setFontSize(10);
        doc.setTextColor(50, 50, 50);
        doc.setFont('inter', 'normal');
        
        // Technical Details Section (updated with Pixel Density)
        const leftColX = margin;
        const rightColX = pageW / 2;
        let curY = y;
        
        // Add Pixel Density
        doc.text('Pixel Density:', leftColX, curY);
        doc.setTextColor(...secondaryColor);
        doc.setFont('inter', 'bold');
        doc.text(`${formatNumber(data.pixelDensity, 0)} Pixels/m²`, leftColX + 45, curY); 
        doc.setTextColor(50, 50, 50);
        doc.setFont('inter', 'normal');
        curY += lineHeight;
        
        doc.text('Final Dimensions:', leftColX, curY);
        doc.setTextColor(...secondaryColor);
        doc.setFont('inter', 'bold');
        doc.text(`${finalW_M.toFixed(2)}m x ${finalH_M.toFixed(2)}m`, leftColX + 45, curY); 
        doc.setTextColor(50, 50, 50);
        doc.setFont('inter', 'normal');
        
        doc.text('Final Resolution:', rightColX, curY);
        doc.setTextColor(...secondaryColor);
        doc.setFont('inter', 'bold');
        doc.text(`${data.finalResW} x ${data.finalResH}`, rightColX + 45, curY);
        doc.setTextColor(50, 50, 50);
        doc.setFont('inter', 'normal');
        curY += lineHeight;
        
        doc.text('Product Model:', leftColX, curY);
        doc.setTextColor(...secondaryColor);
        doc.setFont('inter', 'bold');
        doc.text(data.productName, leftColX + 45, curY);
        doc.setTextColor(50, 50, 50);
        doc.setFont('inter', 'normal');

        doc.text('Total Cabinets:', rightColX, curY);
        doc.setTextColor(...secondaryColor);
        doc.setFont('inter', 'bold');
        doc.text(`${data.totalCabinets} (${data.numCabW} x ${data.numCabH})`, rightColX + 45, curY);
        doc.setTextColor(50, 50, 50);
        doc.setFont('inter', 'normal');
        curY += lineHeight * 2;
        y = curY;

        // --- Visual Box ---
        doc.setFontSize(12);
        doc.setTextColor(...primaryColor);
        doc.setFont('inter', 'bold');
        doc.text('Physical Wall Visualization', margin, y);
        y += lineHeight * 0.5;
        
        const visW_A4_mm = pageW - margin * 2;
        const visH_A4_mm = 40; 
        const aspectRatio = data.finalW_mm / data.finalH_mm;
        let wallW = visW_A4_mm * 0.7; // use 70% of page width for max size
        let wallH = wallW / aspectRatio;

        if (wallH > visH_A4_mm) { // constrain by height
            wallH = visH_A4_mm;
            wallW = wallH * aspectRatio;
        }
        
        // Draw the box
        const centerX = pageW / 2;
        const startX = centerX - wallW / 2;
        doc.setDrawColor(183, 28, 28); // #B71C1C
        doc.setLineWidth(0.5);
        doc.rect(startX, y, wallW, wallH, 'S'); 
        
        // Add dimensions labels
        doc.setFontSize(8);
        doc.setTextColor(183, 28, 28); // #B71C1C
        // Width label
        doc.text(`${finalW_M.toFixed(2)} m W`, centerX, y - 2, { align: 'center' });
        // Height label (rotated)
        doc.saveGraphicsState();
        doc.translate(startX + wallW + 2, y + wallH / 2);
        doc.rotate(90);
        doc.text(`${finalH_M.toFixed(2)} m H`, 0, 0, { align: 'center' });
        doc.restoreGraphicsState();
        
        y += visH_A4_mm + lineHeight * 2;

        // --- Bill of Quantities Table ---
        doc.setFontSize(12);
        doc.setTextColor(...primaryColor);
        doc.setFont('inter', 'bold');
        doc.text('Bill of Quantities (BOQ) - Pricelist', margin, y);
        y += lineHeight * 0.5;

        // Generate BOQ data
        const boqList = generateBOQList(data);
        let tableData = boqList.map((item, index) => {
            return [
                index + 1, 
                item.combined, 
                item.partcode, 
                item.qty, 
                item.unit, 
                'TBD / Add Formula', 
                'TBD / Add Formula'
            ];
        });

        // Reorder for clarity: put LED Cabinets item first if possible
        const ledWallItemIndex = tableData.findIndex(row => row[1].includes('LED Cabinets'));
        if (ledWallItemIndex > -1) {
            const mainItem = tableData.splice(ledWallItemIndex, 1)[0];
            tableData.unshift(mainItem);
            // Re-index
            tableData.forEach((row, index) => row[0] = index + 1);
        }
        
        doc.autoTable({
            startY: y,
            head: [['S.No.', 'Description / Item', 'Part Code', 'Qty', 'Unit', 'Unit Price', 'Total Price']],
            body: tableData,
            theme: 'striped',
            styles: { 
                fontSize: 8,
                cellPadding: 1,
                lineColor: 220, 
                lineWidth: 0.1
            },
            headStyles: {
                fillColor: [230, 230, 230],
                textColor: primaryColor,
                fontStyle: 'bold'
            },
            columnStyles: {
                0: { cellWidth: 10, halign: 'center' },
                1: { cellWidth: 70 },
                2: { cellWidth: 25, halign: 'center' },
                3: { cellWidth: 15, halign: 'center' },
                4: { cellWidth: 15, halign: 'center' },
                5: { cellWidth: 25, halign: 'right' },
                6: { cellWidth: 25, halign: 'right' }
            },
            margin: { left: margin, right: margin },
            didDrawPage: (data) => {
                // Footer on every page
                doc.setFontSize(7);
                doc.setTextColor(120, 120, 120);
                doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageW - margin, pageH - 8, { align: 'right' });
                doc.text('Design figures include a 15% safety margin for power/weight. | PeopleLink Unified Communications Pvt. Ltd.', margin, pageH - 8);
            }
        });

        // Terms and Conditions (FIXED: Added robust page break)
        y = doc.autoTable.previous.finalY + 10;
        
        // Safety check before drawing the heading
        if (y > pageH - 50) { 
            doc.addPage(); 
            y = margin;
        }
        
        doc.setFontSize(10);
        doc.setTextColor(...primaryColor);
        doc.setFont('inter', 'bold');
        doc.text('Terms & Conditions', margin, y);
        y += lineHeight;

        const terms = [
          "1) Prices are ex-works/FOB unless otherwise specified.",
          "2) Excludes installation, commissioning, duties, and taxes.",
          "3) Payment terms are TBD and must be agreed upon separately.",
          "4) Lead time is typically 4-6 weeks from confirmation and advance payment.",
          "5) Warranty is 3 years on cabinets/modules and 1 year on control systems. Excludes misuse, surges, unauthorized repairs.",
          "6) Site access and lifting equipment to be provided by client."
        ];
        doc.setFontSize(8);
        let tcy = y;
        terms.forEach(t=>{
          // Safety check for each line of text
          if (tcy > pageH - 20) { // Keep 20mm from the bottom for footer safety
            doc.addPage(); 
            tcy = margin;
          }
          doc.text(t, margin, tcy);
          tcy += 4.5;
        });

        // Save
        doc.save(`PeopleLink_LED_Config_${data.finalResW}x${data.finalResH}_BOQ.pdf`);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        toggleMeasurementFields();
        populateModalControllers();
        populateModalOutputCards();
        populateModalInputCards();
        window.onclick = function(event) {
          const controllerModal = document.getElementById('controllerModal');
          const contactModal = document.getElementById('contactModal');
          if (event.target == controllerModal) { controllerModal.style.display = "none"; }
          if (event.target == contactModal) { contactModal.style.display = "none"; }
        }
    });
</script>
</body>
</html>
