<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{
      --bg:#eef1f8; --card:#ffffff; --brand:#0D47A1; --accent:#B71C1C; --muted:#f7f9fc; --text:#1c2738; --ok:#1B5E20;
      --radius:10px; --shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;margin:0;padding:24px;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .container{max-width:1100px;margin:0 auto}
    h1{font-size:1.5rem;color:var(--brand);text-align:center;margin:6px 0 18px;font-weight:700}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin-bottom:16px}
    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    label{display:block;font-weight:600;margin-bottom:6px;color:#444}
    select,input{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px}
    input[type="number"]::-webkit-inner-spin-button{height:auto}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{background:var(--brand);color:#fff;padding:12px 14px;border-radius:8px;border:0;font-weight:700;cursor:pointer}
    .btn.secondary{background:#6c757d}
    .btn.positive{background:var(--ok)}
    .muted{color:#6b7280;font-size:13px}
    .note{font-size:13px;color:#586376}
    .hidden{display:none!important}
    .error{background:#ffebee;color: #b71c1c;padding:10px;border-radius:8px;border:1px solid rgba(183,28,28,0.12);margin-top:10px}
    /* visualization */
    .output-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .details-list{display:grid;row-gap:8px}
    .details-list span{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dotted #eceff1}
    .vis-area{border:3px solid var(--accent);background:linear-gradient(135deg,#e3f2fd,#bbdefb);height:300px;position:relative;overflow:hidden;border-radius:8px}
    #cabinetOverlay{position:absolute;inset:0;display:grid;pointer-events:none}
    .overlay-cell{border:1px dashed rgba(13,71,161,0.35);box-sizing:border-box}
    .dimension-label{position:absolute;background:rgba(255,255,255,0.95);padding:6px 8px;border-radius:6px;font-weight:700;color:var(--accent);box-shadow:0 1px 3px rgba(0,0,0,0.08)}
    .dim-top{top:8px;left:50%;transform:translateX(-50%)}
    .dim-right{right:8px;top:50%;transform:translateY(-50%) rotate(90deg)}
    /* responsive */
    @media(max-width:980px){ .cols-2{grid-template-columns:1fr}; .output-grid{grid-template-columns:1fr} .vis-area{height:260px} }
    @media(max-width:560px){ body{padding:14px} .vis-area{height:200px} .dimension-label{font-size:12px;padding:5px 6px} }
    footer{margin-top:14px;text-align:center;color:#8fa3c2;font-size:12px}
    /* accessibility focus styles */
    select:focus,input:focus,button:focus{outline:3px solid rgba(13,71,161,0.12);outline-offset:2px}
    /* lightweight table for BOQ */
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border:1px solid #e9eef6;font-size:13px;text-align:left}
    th{background:#f3f7ff;color:var(--brand)}
    .partcode{background:#f4f6f8;padding:4px 6px;border-radius:4px;color:#0b3e6f;cursor:pointer;display:inline-block}
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>PeopleLink LED Video Wall Configuration Calculator</h1>

    <!-- Input card -->
    <section class="card" aria-labelledby="calc-heading">
      <h2 id="calc-heading" class="muted" style="margin:0 0 12px;font-size:1rem">Enter model & desired size</h2>

      <form id="calcForm" onsubmit="event.preventDefault(); showVisualization();" aria-describedby="calc-note">
        <div class="grid cols-2" role="group" aria-label="Calculator inputs">
          <div>
            <label for="productModel">LED Model / Pixel Pitch</label>
            <select id="productModel" aria-required="true" required>
              <option value="">Select LED Model</option>
              <optgroup label="COB (600x337.5mm)">
                  <option value="cob_09">0.9375mm</option>
                  <option value="cob_125">1.25mm</option>
                  <option value="cob_15">1.5625mm</option>
              </optgroup>
              <optgroup label="SMD Indoor (640x480mm)">
                  <option value="indoor_186">1.86mm</option>
                  <option value="indoor_20">2.0mm</option>
                  <option value="indoor_25">2.5mm</option>
              </optgroup>
              <optgroup label="SMD Outdoor (960x960mm)">
                  <option value="outdoor_40">4.0mm</option>
                  <option value="outdoor_667">6.67mm</option>
                  <option value="outdoor_80">8.0mm</option>
                  <option value="outdoor_100">10.0mm</option>
              </optgroup>
            </select>
          </div>

          <div>
            <label for="unit">Unit</label>
            <select id="unit" aria-controls="width height diagonal" onchange="toggleMeasurementFields()" aria-required="true" required>
              <option value="">Select unit</option>
              <option value="meters">Meters (m)</option>
              <option value="feet">Feet (ft)</option>
              <option value="inches">Inches (in) - Diagonal</option>
            </select>
          </div>

          <div id="widthGroup">
            <label for="width" id="widthLabel">Desired Width (m)</label>
            <input id="width" type="number" inputmode="decimal" min="0.01" step="0.01" aria-labelledby="widthLabel" />
          </div>

          <div id="heightGroup">
            <label for="height" id="heightLabel">Desired Height (m)</label>
            <input id="height" type="number" inputmode="decimal" min="0.01" step="0.01" aria-labelledby="heightLabel" />
          </div>

          <div id="diagonalGroup" class="hidden">
            <label for="diagonal" id="diagonalLabel">Desired Diagonal (inches)</label>
            <input id="diagonal" type="number" inputmode="numeric" min="10" step="1" aria-labelledby="diagonalLabel" />
          </div>

          <div>
            <label for="aspectRatio">Target Aspect Ratio (Optional)</label>
            <select id="aspectRatio" aria-label="Aspect ratio">
              <option value="">Auto / None</option>
              <option value="16:9">16:9</option>
              <option value="16:10">16:10</option>
              <option value="4:3">4:3</option>
              <option value="21:9">21:9</option>
              <option value="1:1">1:1</option>
            </select>
          </div>

          <div style="align-self:end">
            <button type="submit" class="btn" id="calcBtn" aria-controls="visualization">Calculate & Visualize</button>
          </div>
        </div>
      </form>

      <div id="calc-note" class="note" style="margin-top:10px">Assumption: <strong>650,000 pixels per long LAN run</strong>. Controller selected based on required long-LAN ports and pixel capacity.</div>
      <div id="errorMessage" class="error hidden" role="alert" aria-live="polite"></div>
    </section>

    <!-- Visualization area -->
    <section id="visualization" class="card hidden" aria-live="polite" aria-hidden="true">
      <div class="output-grid" role="region" aria-label="Calculation output summary">
        <div>
          <h3 style="margin:0 0 8px;color:var(--brand)">LED Wall Specifications</h3>
          <div class="details-list" id="specList" role="list">
            <span role="listitem"><strong>Pixel Pitch</strong><small id="specPitch">--</small></span>
            <span role="listitem"><strong>Final Dimensions (W x H)</strong><small id="specDim">--</small></span>
            <span role="listitem"><strong>Resolution (W x H)</strong><small id="specRes">--</small></span>
            <span role="listitem"><strong>Cabinet Matrix</strong><small id="specMatrix">--</small></span>
            <span role="listitem"><strong>Total Modules</strong><small id="specModules">--</small></span>
            <span role="listitem"><strong>Diagonal</strong><small id="specDiag">--</small></span>
            <span role="listitem"><strong>Area</strong><small id="specArea">--</small></span>
            <span role="listitem"><strong>Total Pixels</strong><small id="specPixels">--</small></span>
            <span role="listitem"><strong>Min Viewing (m / ft)</strong><small id="specMinView">--</small></span>
            <span role="listitem"><strong>Comfort Viewing (m / ft)</strong><small id="specComfortView">--</small></span>
            <span role="listitem"><strong>Ideal Viewing (m / ft)</strong><small id="specIdealView">--</small></span>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 8px;color:var(--brand)">Control System & Connections</h3>
          <div class="details-list" id="controlList" role="list">
            <span role="listitem"><strong>Suggested Controller</strong><small id="ctrlName">--</small></span>
            <span role="listitem"><strong>Receiving Cards</strong><small id="ctrlRecv">--</small></span>
            <span role="listitem"><strong>Long Ethernet Ports</strong><small id="ctrlLong">--</small></span>
            <span role="listitem"><strong>Short Ethernet Cables</strong><small id="ctrlShort">--</small></span>
            <span role="listitem"><strong>Power (Design / Actual)</strong><small id="ctrlPower">--</small></span>
            <span role="listitem"><strong>Weight (Design / Actual)</strong><small id="ctrlWeight">--</small></span>
          </div>
        </div>
      </div>

      <!-- Physical Wall Visualization requested block (exact structure inserted) -->
      <h3 style="margin:14px 0 8px;color:var(--brand)">Physical Wall Visualization</h3>
      <div class="vis-area" id="visArea" aria-label="Physical wall visualization">
        <div id="cabinetOverlay"></div>
        <div class="dimension-label dim-top" id="dimTop">-- W --</div>
        <div class="dimension-label dim-right" id="dimRight">-- H --</div>
      </div>

      <!-- BOQ -->
      <div style="margin-top:14px">
        <h3 style="margin:8px 0 8px;color:var(--brand)">Bill of Quantities (BOQ)</h3>
        <div class="note">Part codes are placeholders (TBD). Click a part code to edit inline.</div>
        <table id="boqTable" aria-label="Bill of Quantities table">
          <thead><tr><th>Item</th><th>Description / Model</th><th>Qty</th><th>Unit</th><th>Part Code</th></tr></thead>
          <tbody id="boqBody"></tbody>
        </table>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
        <button class="btn" id="downloadPdf" onclick="proceedToDownloadPdf()" aria-label="Download PDF technical summary">Download PDF Technical Summary ðŸ“„</button>
        <button class="btn secondary" onclick="hideVisualization()" aria-label="Modify configuration">Modify Configuration</button>
      </div>
    </section>

    <footer>Â© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala</footer>
  </div>

<script>
/* -------------------------
   Constants & Data
   ------------------------- */
const MM_PER_METER = 1000;
const MM_PER_INCH = 25.4;
const MM_PER_FOOT = MM_PER_INCH * 12;
const METER_TO_FEET = 3.28084;
const PIXELS_PER_PORT_DEFAULT = 650000; // per request
const POWER_BUFFER = 1.15;
const WEIGHT_BUFFER = 1.15;

const LED_PRODUCTS = {
  'cob_09':   { name:"PeopleLink COB (0.9375mm)", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, nits_range:"600-1000", maxPower_W_m2:300 },
  'cob_125':  { name:"PeopleLink COB (1.25mm)", pitch_mm:1.25, cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
  'cob_15':   { name:"PeopleLink COB (1.5625mm)", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
  'indoor_186':{ name:"PeopleLink SMD Indoor (1.86mm)", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
  'indoor_20':{ name:"PeopleLink SMD Indoor (2.0mm)", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
  'indoor_25':{ name:"PeopleLink SMD Indoor (2.5mm)", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
  'outdoor_40':{ name:"PeopleLink SMD Outdoor (4.0mm)", pitch_mm:4.0, cabW_mm:960, cabH_mm:960, cabPixW:240, cabPixH:240, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
  'outdoor_667':{ name:"PeopleLink SMD Outdoor (6.67mm)", pitch_mm:6.67, cabW_mm:960, cabH_mm:960, cabPixW:144, cabPixH:144, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
  'outdoor_80':{ name:"PeopleLink SMD Outdoor (8.0mm)", pitch_mm:8.0, cabW_mm:960, cabH_mm:960, cabPixW:120, cabPixH:120, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
  'outdoor_100':{ name:"PeopleLink SMD Outdoor (10.0mm)", pitch_mm:10.0, cabW_mm:960, cabH_mm:960, cabPixW:96, cabPixH:96, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 }
};

const CONTROLLERS = [
  {name:"TB40", type:"Multimedia Player", ports:2, maxPixels:1300000, maxW:10240, maxH:8192},
  {name:"TB60", type:"Multimedia Player", ports:4, maxPixels:2300000, maxW:4096, maxH:4096},
  {name:"VX400 Pro", type:"All-in-One", ports:4, maxPixels:2600000, maxW:10240, maxH:8192},
  {name:"VX600 Pro", type:"All-in-One", ports:6, maxPixels:3900000, maxW:10240, maxH:8192},
  {name:"4K Prime", type:"All-in-One", ports:16, maxPixels:10400000, maxW:16384, maxH:8192},
  {name:"4K Prime Pro", type:"All-in-One", ports:20, maxPixels:13000000, maxW:16384, maxH:8192},
  {name:"H5 (5U)", type:"Modular Splicer", ports:20, maxPixels:39000000, maxW:16384, maxH:8192}
];

let BOQ = [];
let finalData = null;

/* -------------------------
   Helpers
   ------------------------- */
const $ = id => document.getElementById(id);
function show(el){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
function hide(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }
function gcd(a,b){ return b===0? a : gcd(b, a%b); }
function formatLarge(n){ if(n>=1e6) return (n/1e6).toFixed(2)+'M'; if(n>=1e3) return (n/1e3).toFixed(1)+'K'; return n.toString(); }

/* -------------------------
   Measurement toggle
   ------------------------- */
function toggleMeasurementFields(){
  const unit = $('unit').value;
  const diagMode = unit === 'inches';
  $('widthGroup').classList.toggle('hidden', diagMode);
  $('heightGroup').classList.toggle('hidden', diagMode);
  $('diagonalGroup').classList.toggle('hidden', !diagMode);

  $('widthLabel').textContent = `Desired Width ${diagMode? '(in)': unit==='feet' ? '(ft)' : '(m)'}`;
  $('heightLabel').textContent = `Desired Height ${diagMode? '(in)': unit==='feet' ? '(ft)' : '(m)'}`;
}

/* -------------------------
   Controller selection (port-driven)
   ------------------------- */
function selectController(requiredLongPorts, totalPixels, finalResW, finalResH){
  // prefer controllers with ports >= requiredLongPorts AND pixel/res capacity
  let candidates = CONTROLLERS.filter(c => c.ports >= requiredLongPorts && c.maxPixels >= totalPixels && c.maxW >= finalResW && c.maxH >= finalResH);
  if(candidates.length){
    candidates.sort((a,b)=>a.ports-b.ports || a.maxPixels-b.maxPixels);
    return candidates[0];
  }
  // fallback: controllers fitting pixels & resolution (choose closest ports)
  candidates = CONTROLLERS.filter(c => c.maxPixels >= totalPixels && c.maxW >= finalResW && c.maxH >= finalResH);
  if(candidates.length){
    let best = candidates.reduce((bestSoFar, cur) => {
      if(!bestSoFar) return cur;
      if(Math.abs(cur.ports - requiredLongPorts) < Math.abs(bestSoFar.ports - requiredLongPorts)) return cur;
      return bestSoFar;
    }, null);
    return best;
  }
  // final fallback: modular splicer (last)
  return CONTROLLERS[CONTROLLERS.length-1];
}

/* -------------------------
   Core calculation
   ------------------------- */
function calculateLEDWall(){
  const productKey = $('productModel').value;
  const unit = $('unit').value;
  const widthVal = parseFloat($('width').value);
  const heightVal = parseFloat($('height').value);
  const diagVal = parseFloat($('diagonal').value);
  const aspectRatioOpt = $('aspectRatio').value;

  const errEl = $('errorMessage');
  errEl.classList.add('hidden'); errEl.textContent='';

  if(!productKey || !unit || ((unit!=='inches' && !(widthVal>0 || heightVal>0)) || (unit==='inches' && !(diagVal>0)))){
    errEl.textContent = 'ERROR: select Model, Unit and enter a valid dimension.';
    errEl.classList.remove('hidden');
    return null;
  }

  const prod = LED_PRODUCTS[productKey];
  const cabW = prod.cabW_mm, cabH = prod.cabH_mm;
  let desiredW_mm=0, desiredH_mm=0;

  if(unit === 'inches'){
    const ratioUse = aspectRatioOpt || '16:9';
    const [rw,rh] = ratioUse.split(':').map(Number);
    const diagRatio = Math.sqrt(rw*rw + rh*rh);
    const factor = diagVal / diagRatio;
    desiredW_mm = rw * factor * MM_PER_INCH;
    desiredH_mm = rh * factor * MM_PER_INCH;
  } else {
    const unitFactor = unit === 'meters' ? MM_PER_METER : MM_PER_FOOT;
    const hasW = !isNaN(widthVal) && widthVal>0;
    const hasH = !isNaN(heightVal) && heightVal>0;
    if(aspectRatioOpt){
      const [rw,rh] = aspectRatioOpt.split(':').map(Number);
      if(hasW){ desiredW_mm = widthVal * unitFactor; desiredH_mm = (widthVal / rw) * rh * unitFactor; }
      else if(hasH){ desiredH_mm = heightVal * unitFactor; desiredW_mm = (heightVal / rh) * rw * unitFactor; }
    } else {
      const cabAR = cabW / cabH;
      if(hasW && !hasH){ desiredW_mm = widthVal * unitFactor; desiredH_mm = (widthVal * unitFactor) / cabAR; }
      else if(hasH && !hasW){ desiredH_mm = heightVal * unitFactor; desiredW_mm = (heightVal * unitFactor) * cabAR; }
      else { desiredW_mm = widthVal * unitFactor || cabW; desiredH_mm = heightVal * unitFactor || cabH; }
    }
  }

  // snap to cabinets (round to nearest integer but ensure >=1)
  let numCabW = Math.max(1, Math.round(desiredW_mm / cabW));
  let numCabH = Math.max(1, Math.round(desiredH_mm / cabH));
  const totalCab = numCabW * numCabH;
  const totalModules = totalCab * prod.modulesPerCab;

  const finalW_mm = numCabW * cabW;
  const finalH_mm = numCabH * cabH;
  const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);

  const finalResW = numCabW * prod.cabPixW;
  const finalResH = numCabH * prod.cabPixH;
  const totalPixels = finalResW * finalResH;

  const ratioG = gcd(finalResW, finalResH);
  const aspectRatioText = `${finalResW/ratioG}:${finalResH/ratioG}`;
  const finalDiagonal_mm = Math.sqrt(finalW_mm*finalW_mm + finalH_mm*finalH_mm);
  const finalDiagonal_in = finalDiagonal_mm / MM_PER_INCH;

  // viewing-distance rule: min = pitch*1.2 m, comfort = pitch*2 m, ideal = pitch*3 m
  const minView_m = prod.pitch_mm * 1.2;
  const comfortView_m = prod.pitch_mm * 2.0;
  const idealView_m = prod.pitch_mm * 3.0;

  const minView_ft = minView_m * METER_TO_FEET;
  const comfortView_ft = comfortView_m * METER_TO_FEET;
  const idealView_ft = idealView_m * METER_TO_FEET;

  // Determine required long ports using 650,000 px per run
  const cabinetPixels = prod.cabPixW * prod.cabPixH;
  const portsByBandwidth = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_DEFAULT));
  const maxCabPerPort = Math.max(1, Math.floor(PIXELS_PER_PORT_DEFAULT / cabinetPixels));
  const portsByCabinets = Math.max(1, Math.ceil(totalCab / maxCabPerPort));
  const portsByColumns = numCabW;
  const requiredLongPorts = Math.max(portsByBandwidth, portsByCabinets, portsByColumns);
  const requiredShortEthernet = Math.max(0, totalCab - requiredLongPorts);
  const requiredSendCards = Math.max(1, Math.ceil(requiredLongPorts / 20)); // assume 20 ports per sending card

  // Power & weight
  const actualPower_W = finalArea_m2 * prod.maxPower_W_m2;
  const designPower_W = actualPower_W * POWER_BUFFER;
  const actualCurrent_A = actualPower_W / 220;
  const designCurrent_A = designPower_W / 220;
  const actualWeight_kg = prod.weight_kg * totalCab;
  const designWeight_kg = actualWeight_kg * WEIGHT_BUFFER;

  // Controller selection (port-driven)
  const suggestedController = selectController(requiredLongPorts, totalPixels, finalResW, finalResH);

  finalData = {
    productKey,
    productName: prod.name,
    prod,
    numCabW, numCabH, totalCab, totalModules,
    finalW_mm, finalH_mm, finalArea_m2,
    finalResW, finalResH, totalPixels,
    aspectRatioText, finalDiagonal_in,
    minView_m, comfortView_m, idealView_m,
    minView_ft, comfortView_ft, idealView_ft,
    requiredLongPorts, requiredShortEthernet, requiredSendCards,
    actualPower_W, designPower_W, actualCurrent_A, designCurrent_A,
    actualWeight_kg, designWeight_kg,
    suggestedController
  };

  return finalData;
}

/* -------------------------
   Render UI + BOQ
   ------------------------- */
function showVisualization(){
  const data = calculateLEDWall();
  if(!data) return;
  finalData = data;

  $('specPitch').innerText = data.prod.pitch_mm + ' mm';
  $('specDim').innerText = `${(data.finalW_mm/1000).toFixed(2)} m x ${(data.finalH_mm/1000).toFixed(2)} m`;
  $('specRes').innerText = `${data.finalResW} x ${data.finalResH}`;
  $('specMatrix').innerText = `${data.numCabW} x ${data.numCabH} = ${data.totalCab} cab`;
  $('specModules').innerText = `${data.totalModules}`;
  $('specDiag').innerText = `${data.finalDiagonal_in.toFixed(1)} in`;
  $('specArea').innerText = `${data.finalArea_m2.toFixed(2)} mÂ²`;
  $('specPixels').innerText = formatLarge(data.totalPixels);

  $('specMinView').innerText = `${data.minView_m.toFixed(2)} m / ${data.minView_ft.toFixed(2)} ft`;
  $('specComfortView').innerText = `${data.comfortView_m.toFixed(2)} m / ${data.comfortView_ft.toFixed(2)} ft`;
  $('specIdealView').innerText = `${data.idealView_m.toFixed(2)} m / ${data.idealView_ft.toFixed(2)} ft`;

  $('ctrlName').innerText = `${data.suggestedController.name} (${data.suggestedController.type})`;
  $('ctrlRecv').innerText = `${data.totalCab} (embedded)`;
  $('ctrlLong').innerText = `${data.requiredLongPorts}`;
  $('ctrlShort').innerText = `${data.requiredShortEthernet}`;
  $('ctrlPower').innerText = `${Math.round(data.designPower_W)} W design / ${Math.round(data.actualPower_W)} W actual`;
  $('ctrlWeight').innerText = `${Math.round(data.designWeight_kg)} kg design / ${Math.round(data.actualWeight_kg)} kg actual`;

  renderCabinetOverlay(data.numCabW, data.numCabH);
  populateBOQ(data);

  show($('visualization'));
  // scroll to visualization for small screens
  setTimeout(()=> $('visualization').scrollIntoView({behavior:'smooth', block:'start'}), 80);
}

function hideVisualization(){
  hide($('visualization'));
}

/* -------------------------
   Cabinet overlay
   ------------------------- */
function renderCabinetOverlay(cols, rows){
  const overlay = $('cabinetOverlay');
  overlay.innerHTML = '';
  overlay.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  overlay.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const d = document.createElement('div');
      d.className = 'overlay-cell';
      overlay.appendChild(d);
    }
  }
  $('dimTop').innerText = `${(finalData.finalW_mm/1000).toFixed(2)} m (W)`;
  $('dimRight').innerText = `${(finalData.finalH_mm/1000).toFixed(2)} m (H)`;
}

/* -------------------------
   BOQ handling (inline part codes)
   ------------------------- */
function populateBOQ(data){
  BOQ = [
    {item:'LED Cabinets', desc: data.productName, qty: data.totalCab, unit:'PCS', part:'TBD'},
    {item:'Controller/Processor', desc: data.suggestedController.name, qty:1, unit:'PCS', part:'TBD'},
    {item:'Receiving Cards (R-Card)', desc:'Embedded in cabinet', qty:data.totalCab, unit:'PCS', part:'TBD'},
    {item:'Output Sending Cards', desc:'H-series sending card (20-port typical)', qty:data.requiredSendCards, unit:'PCS', part:'TBD'},
    {item:'Long Ethernet Cables', desc:'Controller -> Wall (CAT6/7)', qty:data.requiredLongPorts, unit:'PCS', part:'TBD'},
    {item:'Short Ethernet Cables', desc:'Cabinet interconnect (CAT6/7)', qty:data.requiredShortEthernet, unit:'PCS', part:'TBD'},
    {item:'Installation / Configuration', desc:'Mounting & commissioning', qty:1, unit:'LS', part:'TBD'},
    {item:'Transport / Logistics', desc:'Freight to site', qty:1, unit:'LS', part:'TBD'}
  ];

  const tbody = $('boqBody');
  tbody.innerHTML = '';
  BOQ.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.item}</td><td>${r.desc}</td><td style="text-align:right">${r.qty}</td><td>${r.unit}</td><td style="text-align:center"><span class="partcode" data-i="${i}" tabindex="0">${r.part}</span></td>`;
    tbody.appendChild(tr);
  });

  // attach inline-edit
  document.querySelectorAll('.partcode').forEach(el=>{
    el.addEventListener('click', e => editPartCode(e.currentTarget));
    el.addEventListener('keypress', e => { if(e.key==='Enter') editPartCode(e.currentTarget); });
  });
}

function editPartCode(el){
  const idx = parseInt(el.dataset.i,10);
  const input = document.createElement('input');
  input.type = 'text'; input.value = BOQ[idx].part || 'TBD';
  input.style.width='100%'; input.style.boxSizing='border-box';
  el.replaceWith(input);
  input.focus();
  input.select();
  function save(){ BOQ[idx].part = input.value.trim() || 'TBD'; populateBOQ(finalData); }
  input.addEventListener('blur', save);
  input.addEventListener('keydown', ev => { if(ev.key==='Enter'){ ev.preventDefault(); save(); } if(ev.key==='Escape'){ populateBOQ(finalData); }});
}

/* -------------------------
   PDF generation (no contact/watermark)
   ------------------------- */
function proceedToDownloadPdf(){
  if(!finalData){ alert('Please calculate first'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  const margin = 12;
  let y = 10;
  const pageW = doc.internal.pageSize.getWidth();

  doc.setFontSize(16); doc.setTextColor(13,71,161);
  doc.text('PeopleLink LED Video Wall Technical Summary', pageW/2, y, {align:'center'});
  y += 8;
  doc.setFontSize(8); doc.setTextColor(80,80,80);
  doc.text(`Generated: ${new Date().toLocaleDateString()} | Model: ${finalData.productName}`, pageW/2, y, {align:'center'});
  y += 10;

  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('1. Wall Performance & Dimensions', margin, y); y+=6;
  const perf = [
    ['Final Dimensions (W x H) :', `${(finalData.finalW_mm/1000).toFixed(2)} m x ${(finalData.finalH_mm/1000).toFixed(2)} m`],
    ['Resolution (W x H) :', `${finalData.finalResW} x ${finalData.finalResH}`],
    ['Aspect Ratio :', finalData.aspectRatioText],
    ['Final Diagonal :', `${finalData.finalDiagonal_in.toFixed(1)} in`],
    ['Total Pixels / Area :', `${formatLarge(finalData.totalPixels)} / ${finalData.finalArea_m2.toFixed(2)} mÂ²`],
    ['Viewing Distances (min/comfort/ideal) :', `${finalData.minView_m.toFixed(2)} m / ${finalData.comfortView_m.toFixed(2)} m / ${finalData.idealView_m.toFixed(2)} m`]
  ];
  doc.autoTable({ startY: y, body: perf, margin:{left:margin,right:margin}, theme:'striped', styles:{fontSize:8}, columnStyles:{0:{cellWidth:80},1:{cellWidth:100}}});
  y = doc.lastAutoTable.finalY + 6;

  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('2. Physical & Cabinet Specifications', margin, y); y+=6;
  const specs = [
    ['Pixel Pitch :', `${finalData.prod.pitch_mm} mm`],
    ['Cabinet Size (W x H) :', `${finalData.prod.cabW_mm} mm x ${finalData.prod.cabH_mm} mm`],
    ['Cabinet Pixels (W x H) :', `${finalData.prod.cabPixW} x ${finalData.prod.cabPixH}`],
    ['Cabinet Matrix (W x H) :', `${finalData.numCabW} x ${finalData.numCabH}`],
    ['Total Cabinets :', `${finalData.totalCab}`],
    ['Total Modules :', `${finalData.totalModules}`],
    ['Brightness Range :', finalData.prod.nits_range]
  ];
  doc.autoTable({ startY: y, body: specs, margin:{left:margin,right:margin}, theme:'plain', styles:{fontSize:8}, columnStyles:{0:{cellWidth:80},1:{cellWidth:100}}});
  y = doc.lastAutoTable.finalY + 6;

  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('3. Control System & Connections', margin, y); y+=6;
  const conn = [
    ['Controller/Processor :', `${finalData.suggestedController.name} (${finalData.suggestedController.type})`],
    ['Receiving Cards :', `${finalData.totalCab}`],
    ['Long Ethernet Ports (Controller â†’ Wall) :', `${finalData.requiredLongPorts}`],
    ['Short Ethernet Cables (Between cabinets) :', `${finalData.requiredShortEthernet}`],
    ['Output Sending Cards :', `${finalData.requiredSendCards}`]
  ];
  doc.autoTable({ startY: y, body: conn, margin:{left:margin,right:margin}, theme:'striped', styles:{fontSize:8}, columnStyles:{0:{cellWidth:90},1:{cellWidth:90}}});
  y = doc.lastAutoTable.finalY + 6;

  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('4. Power and Weight', margin, y); y+=6;
  const pw = [
    ['Actual Max Power (W) :', `${Math.round(finalData.actualPower_W)} W`],
    ['Design Max Power (W) :', `${Math.round(finalData.designPower_W)} W`],
    ['Current Draw (Actual @220V) :', `${finalData.actualCurrent_A.toFixed(2)} A`],
    ['Design Current (with margin) :', `${finalData.designCurrent_A.toFixed(2)} A`],
    ['Wall Weight (Actual) :', `${finalData.actualWeight_kg.toFixed(1)} kg`],
    ['Wall Weight (Design w/ margin) :', `${finalData.designWeight_kg.toFixed(1)} kg`]
  ];
  doc.autoTable({ startY: y, body: pw, margin:{left:margin,right:margin}, theme:'plain', styles:{fontSize:8}, columnStyles:{0:{cellWidth:90},1:{cellWidth:90}}});
  y = doc.lastAutoTable.finalY + 8;

  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('5. Bill of Quantities (BOQ)', margin, y); y+=6;
  const boqRows = BOQ.map(r => [r.item, r.desc, r.qty.toString(), r.unit, r.part || 'TBD']);
  doc.autoTable({ startY: y, head: [['Item','Description','Qty','Unit','Part Code']], body: boqRows, margin:{left:margin,right:margin}, styles:{fontSize:8} });
  y = doc.lastAutoTable.finalY + 8;

  doc.setFontSize(9); doc.setTextColor(60,60,60);
  doc.text('Note: Part codes are placeholders (TBD). Provide final part codes and the BOQ can be updated.', margin, y);
  y += 8;

  const terms = [
    '1. Price Validity: Quotation valid for 30 days from date of issue.',
    '2. Payment Terms: Typical 50% advance, 40% on delivery, 10% on commissioning.',
    '3. Civil Work: Client provides mounting structure unless specified in BOQ.',
    '4. Power & Data: Ensure stable power and LAN drops near installation area.',
    '5. Warranty: 1 year standard on panels & accessories (manufacturing defects).'
  ];
  terms.forEach(t=>{
    if(y > doc.internal.pageSize.getHeight() - 40){ doc.addPage(); y = 15; }
    const spl = doc.splitTextToSize(t, pageW - margin*2);
    doc.text(spl, margin, y); y += (spl.length * 4) + 1;
  });

  doc.setFontSize(8); doc.setTextColor(176,196,222);
  doc.text('Â© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala', pageW/2, doc.internal.pageSize.getHeight() - 8, {align:'center'});

  doc.save(`PeopleLink_LED_Config_${finalData.finalResW}x${finalData.finalResH}_BOQ.pdf`);
}

/* -------------------------
   Init
   ------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  toggleMeasurementFields();
  $('unit').addEventListener('change', toggleMeasurementFields);
  // allow Enter key on form
  $('calcForm').addEventListener('submit', e => { e.preventDefault(); showVisualization(); });
});
</script>
</body>
</html>
