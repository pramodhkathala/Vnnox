<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --bg: #eef1f8;
      --card: #ffffff;
      --ink: #1c2738;
      --brand: #0d47a1;
      --accent: #b71c1c;
      --muted: #f7f9fc;
      --ok: #1b5e20;
    }
    html,body{height:100%}
    body{font-family:Inter, sans-serif;margin:0;padding:40px;background:var(--bg);color:var(--ink);font-size:14px}
    .main-wrapper{max-width:1200px;margin:auto}
    h2{ text-align:center;color:var(--brand);margin:0 0 30px;font-weight:700;font-size:1.8em;display:flex;align-items:center;justify-content:center;}

    .input-panel{background:var(--card);padding:30px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.05);transition:all .6s}
    .input-panel.minimized{height:120px;padding-top:15px;padding-bottom:10px;opacity:.95;overflow:hidden;background:var(--muted)}
    .input-panel.minimized>*:not(h2):not(#enteredValuesDisplay):not(.back-btn-placeholder){opacity:0;max-height:0;overflow:hidden;pointer-events:none}
    .input-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px 30px}
    label{display:block;margin-bottom:5px;font-weight:600;color:#444}
    select,input[type="number"],input[type="text"]{width:100%;padding:10px 12px;font-size:15px;border:1px solid #dcdcdc;border-radius:6px;background:#fff;box-sizing:border-box}
    select:focus,input:focus{border-color:var(--brand);box-shadow:0 0 0 2px rgba(13,71,161,.12);outline:none}

    .btn{background:var(--brand);color:#fff;padding:14px;border:none;border-radius:8px;font-size:16px;width:100%;cursor:pointer;font-weight:600}
    .btn.gray{background:#6c757d}
    .btn.ok{background:var(--ok)}

    .hidden{display:none !important}
    .error-message{color:var(--accent);font-weight:700;text-align:center;margin-top:15px;padding:12px;background:#ffebee;border:2px solid var(--accent);border-radius:8px}

    .visualization{background:var(--card);padding:30px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.05);opacity:0;max-height:0;overflow-y:hidden;transition:opacity .6s,max-height 1s;margin-top:30px}
    .visualization.visible{opacity:1;max-height:2000px}
    .output-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-top:20px}
    .details-box,.vis-box{border:1px solid #e0e0e0;padding:20px;border-radius:8px;background:var(--muted)}
    .details-box h4{margin:0 0 15px;color:var(--brand);border-bottom:2px solid #e0e0e0;padding-bottom:8px;font-size:1.1em}
    .vis-details{display:grid;grid-template-columns:1fr;gap:10px;font-size:.95em;color:#333}
    .vis-details span{display:flex;align-items:center;line-height:1.4;padding-bottom:6px;border-bottom:1px dotted #e0e0e0}
    .vis-details strong{min-width:250px;font-weight:500;margin-right:15px}
    .vis-details small{font-weight:700;color:var(--accent)}
    .vis-content{position:relative;width:100%;margin-bottom:20px;padding-top:35px;padding-right:45px;padding-bottom:10px;box-sizing:border-box}
    .grid{position:relative;width:100%;border:3px solid var(--accent);min-height:100px;overflow:hidden;background:linear-gradient(135deg,#e3f2fd,#bbdefb)}
    #cabinetOverlay{position:absolute;top:0;left:0;width:100%;height:100%;box-sizing:border-box;pointer-events:none;z-index:5;display:grid}
    .dimension-label{position:absolute;color:var(--accent);background:rgba(255,255,255,0.95);padding:3px 6px;border-radius:3px;font-weight:700}
    #downloadPdfLink{grid-column:1/-1;margin-top:15px;text-align:center;cursor:pointer;color:var(--ok);text-decoration:underline;padding:8px 0;font-weight:600}
    footer{text-align:center;color:#b0c4de;font-size:12px;margin-top:24px}

    .modal{position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.4);display:none}
    .modal:not(.hidden){display:block}
    .modal-content{background:#fff;margin:5% auto;padding:24px;border-radius:10px;width:90%;max-width:700px;box-shadow:0 5px 15px rgba(0,0,0,.3)}
    .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width:900px){.input-grid,.output-grid,.modal-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="input-panel" id="formContainer">
      <h2>LED Video Wall Configuration Calculator</h2>

      <div id="enteredValuesDisplay" class="hidden">
        <span id="enteredSummaryText"></span><br />
        Actual Final Aspect Ratio: <strong><span id="aspectRatioValue">--</span></strong>
      </div>

      <div id="errorMessage" class="error-message hidden"></div>

      <div class="input-grid">
        <div class="input-group">
          <label for="productModel">LED Model / Pixel Pitch</label>
          <select id="productModel">
            <option value="">Select LED Model</option>
            <optgroup label="COB Models (16:9 Cabinet - 600x337.5mm)">
              <option value="cob_09">0.9375mm</option>
              <option value="cob_125">1.25mm</option>
              <option value="cob_15">1.5625mm</option>
            </optgroup>
            <optgroup label="SMD Indoor Models (4:3 Cabinet - 640x480mm)">
              <option value="indoor_186">1.86mm</option>
              <option value="indoor_20">2.0mm</option>
              <option value="indoor_25">2.5mm</option>
            </optgroup>
            <optgroup label="SMD Outdoor Models (1:1 Cabinet - 960x960mm)">
              <option value="outdoor_40">4.0mm</option>
              <option value="outdoor_667">6.67mm</option>
              <option value="outdoor_80">8.0mm</option>
              <option value="outdoor_100">10.0mm</option>
            </optgroup>
          </select>
        </div>

        <div class="input-group">
          <label for="unit">Unit of Measurement</label>
          <select id="unit" onchange="toggleMeasurementFields()">
            <option value="">Select unit</option>
            <option value="meters">Meters (m)</option>
            <option value="feet">Feet (ft)</option>
            <option value="inches">Inches (in) - Diagonal</option>
          </select>
        </div>

        <div class="input-group" id="widthGroup">
          <label for="width" id="widthLabel">Desired Width (m)</label>
          <input id="width" type="number" min="0.1" step="0.01" placeholder="Enter desired width" />
        </div>

        <div class="input-group" id="heightGroup">
          <label for="height" id="heightLabel">Desired Height (m)</label>
          <input id="height" type="number" min="0.1" step="0.01" placeholder="Enter desired height" />
        </div>

        <div class="input-group hidden" id="diagonalGroup">
          <label for="diagonal" id="diagonalLabel">Desired Diagonal (inches)</label>
          <input id="diagonal" type="number" min="10" step="1" placeholder="Enter desired diagonal inches" />
        </div>

        <div class="input-group" id="aspectRatioGroup">
          <label for="aspectRatio" id="aspectRatioLabel">Target Aspect Ratio (Optional)</label>
          <select id="aspectRatio">
            <option value="">Select ratio (Optional)</option>
            <option value="16:9">16:9 (HD/UHD)</option>
            <option value="16:10">16:10 (WUXGA)</option>
            <option value="4:3">4:3 (Legacy)</option>
            <option value="2:1">2:1 (Cinematic)</option>
            <option value="21:9">21:9 (Cinematic/2.37:1)</option>
            <option value="1:1">1:1 (Square)</option>
          </select>
        </div>

        <button class="btn" id="submitButton" onclick="showVisualization()">Calculate & Visualize System</button>
        <div class="back-btn-placeholder hidden"></div>
      </div>
    </div>

    <div class="visualization" id="visualization">
      <div class="output-grid">
        <div class="details-box">
          <h4>LED Wall Specifications</h4>
          <div class="vis-details">
            <span id="pixelPitchDisplay"><strong>Pixel Pitch :</strong><small>--</small></span>
            <span id="finalDimensions"><strong>Actual Final Dimensions (WxH) :</strong><small>--</small></span>
            <span id="resolution"><strong>Actual Final Resolution (WxH) :</strong><small>--</small></span>
            <span id="numCabinets"><strong>Total Cabinets (W x H) :</strong><small>--</small></span>
            <span id="totalModules"><strong>Total Modules Required :</strong><small>--</small></span>
            <span id="finalDiagonal"><strong>Final Diagonal Size :</strong><small>--</small></span>
            <span id="finalArea"><strong>Final Area :</strong><small>--</small></span>
            <span id="totalPixels"><strong>Total Pixels :</strong><small>--</small></span>
            <span id="viewingDistance"><strong>Viewing Distance (min / comfort / ideal) :</strong><small>--</small></span>
            <span id="cabinetSize"><strong>Cabinet Size (WxH) :</strong><small>--</small></span>
            <span id="cabinetPixels"><strong>Cabinet Pixels (WxH) :</strong><small>--</small></span>
          </div>
        </div>

        <div class="details-box">
          <h4>Control System Requirements <button class="edit-btn" onclick="openControllerModal()">Edit/View Components ‚öôÔ∏è</button></h4>
          <div class="vis-details" id="controlSystemDetails"></div>
        </div>
      </div>

      <div class="vis-box" style="margin-top:30px">
        <h4>Physical Wall Visualization</h4>
        <div class="vis-content">
          <div class="grid" id="visGrid">
            <div id="cabinetOverlay"></div>
            <span class="dimension-label dim-top" id="visWidthLabel">-- W --</span>
            <span class="dimension-label dim-right" id="visHeightLabel">-- H --</span>
          </div>
        </div>
      </div>

      <span id="downloadPdfLink" onclick="proceedToDownloadPdf()" class="hidden">Download PDF Technical Summary üìÑ</span>
      <button class="btn gray" onclick="hideVisualization()">Modify Configuration</button>
    </div>

    <div id="controllerModal" class="modal hidden" aria-hidden="true">
      <div class="modal-content" role="dialog" aria-modal="true">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h3 style="margin:0;color:var(--brand)">Edit Control System Components</h3>
          <button style="background:none;border:0;font-size:24px;cursor:pointer" onclick="closeControllerModal()">&times;</button>
        </div>
        <div class="modal-grid">
          <div>
            <label>Suggested Controller/Processor Model (Select):</label>
            <select id="modalControllerModel"></select>
          </div>
          <div>
            <label>Splicer Frame/Solution (Optional):</label>
            <input id="modalSplicerSolution" type="text" placeholder="e.g., H5 Modular Splicer (5U)"/>
          </div>
          <div>
            <label>Max Ports per Output Card (Read Only):</label>
            <input id="modalMaxPortsPerCard" type="number" readonly placeholder="e.g., 20"/>
          </div>
          <div>
            <label>Output Card Model (Select):</label>
            <select id="modalOutputCardModel" onchange="updatePortsFromOutputCard()"></select>
          </div>
          <div>
            <label>Input Card Model (Select):</label>
            <select id="modalInputCardModel"></select>
          </div>
          <div>
            <label>Input Card Quantity:</label>
            <input id="modalInputCardQty" type="number" min="1" step="1" placeholder="e.g., 2"/>
          </div>
        </div>
        <div style="margin-top:12px;padding:10px;background:#fffde7;border:1px solid #ffeb3b;border-radius:6px">
          <strong>Note:</strong> Edit input/output card models/quantities if required. The solution regenerates using the selected <em>Max Ports per Output Card</em>.
        </div>
        <div style="margin-top:12px">
          <button class="btn ok" onclick="applyModalChanges()">Apply Changes & Recalculate</button>
        </div>
      </div>
    </div>
  </div>

  <footer>¬© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala</footer>

  <script>
    // -----------------------
    // Constants & Products
    // -----------------------
    const MM_PER_METER = 1000;
    const MM_PER_INCH = 25.4;
    const MM_PER_FOOT = MM_PER_INCH * 12;
    const METER_TO_FEET = 3.28084;
    const PIXELS_PER_PORT_DEFAULT = 650000; // each long cable supports up to ~650k pixels (bandwidth)
    const POWER_BUFFER = 1.15;
    const WEIGHT_BUFFER = 1.15;
    const MARGIN_PERCENT_TEXT = "15%";

    const LED_PRODUCTS = {
      cob_09:   { name:"PeopleLink COB (0.9375mm)", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, nits_range:"600-1000", maxPower_W_m2:300 },
      cob_125:  { name:"PeopleLink COB (1.25mm)" , pitch_mm:1.25, cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
      cob_15:   { name:"PeopleLink COB (1.5625mm)", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
      indoor_186:{ name:"PeopleLink SMD Indoor (1.86mm)", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      indoor_20:{ name:"PeopleLink SMD Indoor (2.0mm)", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      indoor_25:{ name:"PeopleLink SMD Indoor (2.5mm)", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      outdoor_40:{ name:"PeopleLink SMD Outdoor (4.0mm)", pitch_mm:4.0, cabW_mm:960, cabH_mm:960, cabPixW:240, cabPixH:240, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
      outdoor_667:{ name:"PeopleLink SMD Outdoor (6.67mm)", pitch_mm:6.67, cabW_mm:960, cabH_mm:960, cabPixW:144, cabPixH:144, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
      outdoor_80:{ name:"PeopleLink SMD Outdoor (8.0mm)", pitch_mm:8.0, cabW_mm:960, cabH_mm:960, cabPixW:120, cabPixH:120, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
      outdoor_100:{ name:"PeopleLink SMD Outdoor (10.0mm)", pitch_mm:10.0, cabW_mm:960, cabH_mm:960, cabPixW:96, cabPixH:96, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 }
    };

    // Controllers (ordered by priority)
    const CONTROLLER_MODELS = [
      { name:"TB40", type:"Multimedia Player", ports:2,  maxPixels:1300000, maxW:10240, maxH:8192, priority:1 },
      { name:"TB60", type:"Multimedia Player", ports:4,  maxPixels:2300000, maxW:4096,  maxH:4096, priority:2 },
      { name:"VX400 Pro / DSP400 Pro", type:"All-in-One Processor", ports:4,  maxPixels:2600000, maxW:10240, maxH:8192, priority:3 },
      { name:"VX600 Pro / DSP600 Pro", type:"All-in-One Processor", ports:6,  maxPixels:3900000, maxW:10240, maxH:8192, priority:4 },
      { name:"VX1000 Pro / DSP1000 Pro", type:"All-in-One Processor", ports:10, maxPixels:6500000, maxW:10240, maxH:8192, priority:5 },
      { name:"4K Prime", type:"All-in-One Processor", ports:16, maxPixels:10400000, maxW:16384, maxH:8192, priority:6 },
      { name:"4K Prime Pro", type:"All-in-One Processor", ports:20, maxPixels:13000000, maxW:16384, maxH:8192, priority:7 },
      { name:"H2 (2U)", type:"Modular Splicer", ports:20, maxPixels:26000000, maxW:16384, maxH:8192, priority:8 },
      { name:"H5 (5U)", type:"Modular Splicer", ports:20, maxPixels:39000000, maxW:16384, maxH:8192, priority:9 },
      { name:"H9 (9U)", type:"Modular Splicer", ports:20, maxPixels:65000000, maxW:16384, maxH:8192, priority:10 },
      { name:"H15 (15U)", type:"Modular Splicer", ports:20, maxPixels:130000000, maxW:16384, maxH:8192, priority:11 },
      { name:"H20 (20U)", type:"Modular Splicer", ports:20, maxPixels:260000000, maxW:16384, maxH:8192, priority:12 }
    ].sort((a,b)=>a.priority-b.priority);

    const H_SERIES_DEFAULTS = {
      SPLICER_NAME: "H-Series Modular Splicer Frame",
      INPUT_CARD_OPTIONS:[
        { model:"H_1xHDMI2.0 input card (4K)", display:"1x 4K HDMI (Single Input)", qty:1 },
        { model:"H_2xHDMI2.0 input card (4K)", display:"2x 4K HDMI (Dual Input)", qty:1 },
        { model:"H_4xHDMI input card (1080P)", display:"4x FHD HDMI (Quad Input)", qty:1 }
      ],
      DEFAULT_INPUT_CARD_MODEL:"H_1xHDMI2.0 input card (4K)",
      DEFAULT_INPUT_CARD_QTY:2,
      OUTPUT_CARD_20_PORTS:20, OUTPUT_CARD_20_MODEL:"H_20xRJ45 Sending Card",
      OUTPUT_CARD_16_PORTS:16, OUTPUT_CARD_16_MODEL:"H_16xRJ45 Sending Card"
    };

    // -----------------------
    // Helpers
    // -----------------------
    let finalCalculationData = {};
    function formatNumber(n,d=1){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}); }
    function formatLargeNumber(n){ n=Number(n); if(n>=1e6) return (n/1e6).toFixed(2)+"M"; if(n>=1e3) return (n/1e3).toFixed(1)+"K"; return n.toLocaleString(); }
    function gcd(a,b){ return b===0? a: gcd(b,a%b); }

    function toggleMeasurementFields(){
      const unit = document.getElementById('unit').value;
      const isDiagonal = unit==='inches';
      const isFeet = unit==='feet';
      let unitText = ' (m)';
      if (isFeet) unitText=' (ft)';
      if (isDiagonal) unitText=' (in)';
      document.getElementById('widthLabel').textContent = `Desired Width${unitText}`;
      document.getElementById('heightLabel').textContent = `Desired Height${unitText}`;
      document.getElementById('widthGroup').classList.toggle('hidden', isDiagonal);
      document.getElementById('heightGroup').classList.toggle('hidden', isDiagonal);
      document.getElementById('diagonalGroup').classList.toggle('hidden', !isDiagonal);
      if (isDiagonal){ document.getElementById('width').value=''; document.getElementById('height').value=''; } else { document.getElementById('diagonal').value=''; }
      document.getElementById('errorMessage').classList.add('hidden');
    }

    function populateModalControllers(){
      const s=document.getElementById('modalControllerModel'); if(!s) return;
      s.innerHTML='';
      CONTROLLER_MODELS.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; o.textContent=`${c.name} (${c.type}, ${formatLargeNumber(c.maxPixels)} max px)`; s.appendChild(o); });
    }
    function populateModalOutputCards(){
      const s=document.getElementById('modalOutputCardModel'); if(!s) return;
      s.innerHTML='';
      [[H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL,H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS],[H_SERIES_DEFAULTS.OUTPUT_CARD_16_MODEL,H_SERIES_DEFAULTS.OUTPUT_CARD_16_PORTS]].forEach(c=>{
        const o=document.createElement('option'); o.value=`${c[0]}|${c[1]}`; o.textContent=`${c[0]} (${c[1]} ports)`; s.appendChild(o);
      });
    }
    function populateModalInputCards(){
      const s=document.getElementById('modalInputCardModel'); if(!s) return;
      s.innerHTML='';
      H_SERIES_DEFAULTS.INPUT_CARD_OPTIONS.forEach(o=>{ const el=document.createElement('option'); el.value=`${o.model}|${o.qty}`; el.textContent=o.display; s.appendChild(el); });
    }
    function updatePortsFromOutputCard(){ const v=document.getElementById('modalOutputCardModel').value.split('|'); document.getElementById('modalMaxPortsPerCard').value=v[1]; }

    function openControllerModal(){
      populateModalControllers(); populateModalOutputCards(); populateModalInputCards();
      const suggested = finalCalculationData.controllerOverrideName || (finalCalculationData.controllerName||'').split('(')[0].trim();
      const s=document.getElementById('modalControllerModel');
      if (s && Array.from(s.options).some(o=>o.value===suggested)) s.value=suggested;
      document.getElementById('modalSplicerSolution').value = finalCalculationData.splicerSolution || H_SERIES_DEFAULTS.SPLICER_NAME;
      const currentOut = (finalCalculationData.outputCardModel||H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL) + '|' + (finalCalculationData.outputCardPorts || H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS);
      const outSelect=document.getElementById('modalOutputCardModel'); if (outSelect && Array.from(outSelect.options).some(o=>o.value===currentOut)) outSelect.value=currentOut;
      document.getElementById('modalMaxPortsPerCard').value = finalCalculationData.outputCardPorts || H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS;
      const inSelect=document.getElementById('modalInputCardModel');
      const desired = finalCalculationData.inputCardModel || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL;
      const opt = Array.from(inSelect.options).find(o=>o.value.startsWith(desired));
      inSelect.value = opt ? opt.value : inSelect.options[0].value;
      document.getElementById('modalInputCardQty').value = finalCalculationData.inputCardQty || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;

      const modal = document.getElementById('controllerModal'); modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
    }
    function closeControllerModal(){ const modal=document.getElementById('controllerModal'); modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }
    function applyModalChanges(){
      finalCalculationData.controllerOverrideName = document.getElementById('modalControllerModel').value;
      finalCalculationData.splicerSolution = document.getElementById('modalSplicerSolution').value;
      const out = document.getElementById('modalOutputCardModel').value.split('|');
      finalCalculationData.outputCardModel = out[0]; finalCalculationData.outputCardPorts = parseInt(out[1],10);
      const inp = document.getElementById('modalInputCardModel').value.split('|');
      finalCalculationData.inputCardModel = inp[0]; finalCalculationData.inputCardQty = parseInt(document.getElementById('modalInputCardQty').value,10) || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;
      closeControllerModal(); showVisualization();
    }

    // -----------------------
    // Controller selection helper
    // -----------------------
    function getSuggestedControllerModel(totalPixels, finalResW, finalResH, productKey, requiredPorts){
      // prefer controllers that meet pixel/resolution and ports
      let candidates = CONTROLLER_MODELS.filter(c => c.maxPixels >= totalPixels && c.maxW >= finalResW && c.maxH >= finalResH);
      let best = candidates.find(c => (requiredPorts ? c.ports >= requiredPorts : true));
      if (best) return best;
      if (candidates.length>0) return candidates[0];
      // fallback - find any controller with enough ports
      let byPorts = CONTROLLER_MODELS.find(c => c.ports >= (requiredPorts || 1));
      if (byPorts) return byPorts;
      return CONTROLLER_MODELS[CONTROLLER_MODELS.length-1];
    }

    // -----------------------
    // Full calculateLEDWall() function (complete) - paste/replace exactly
    // -----------------------
    function calculateLEDWall(){
      // --- read inputs safely ---
      const productKey = document.getElementById('productModel').value;
      const unit = document.getElementById('unit').value;
      const widthRaw = document.getElementById('width').value;
      const heightRaw = document.getElementById('height').value;
      const diagonalRaw = document.getElementById('diagonal').value;
      const aspectRatioKey = document.getElementById('aspectRatio').value || '';

      const widthInput = widthRaw === '' ? NaN : parseFloat(widthRaw);
      const heightInput = heightRaw === '' ? NaN : parseFloat(heightRaw);
      const diagonalInput = diagonalRaw === '' ? NaN : parseFloat(diagonalRaw);

      const errorDiv = document.getElementById('errorMessage');
      errorDiv.classList.add('hidden');
      errorDiv.textContent = '';

      // --- validation ---
      if (!productKey) { errorDiv.textContent = 'ERROR: Please select an LED Model / Pixel Pitch.'; errorDiv.classList.remove('hidden'); console.warn('Validation failed: product not selected'); return null; }
      if (!unit) { errorDiv.textContent = 'ERROR: Please select Unit of Measurement (meters / feet / inches).'; errorDiv.classList.remove('hidden'); console.warn('Validation failed: unit not selected'); return null; }
      if (unit === 'inches') {
        if (isNaN(diagonalInput) || diagonalInput <= 0) { errorDiv.textContent = 'ERROR: For Inches unit, please enter a valid diagonal (in inches).'; errorDiv.classList.remove('hidden'); console.warn('Validation failed: diagonal missing/invalid'); return null; }
      } else {
        const hasW = !isNaN(widthInput) && widthInput > 0;
        const hasH = !isNaN(heightInput) && heightInput > 0;
        if (!hasW && !hasH) { errorDiv.textContent = 'ERROR: Please enter Width or Height (at least one) for meters/feet units.'; errorDiv.classList.remove('hidden'); console.warn('Validation failed: width & height missing/invalid'); return null; }
      }

      // --- product details & cabinet dims ---
      const details = LED_PRODUCTS[productKey];
      const cabinetW_mm = details.cabW_mm;
      const cabinetH_mm = details.cabH_mm;

      // --- desired dimensions (mm) ---
      let desiredW_mm = 0;
      let desiredH_mm = 0;

      if (unit === 'inches') {
        const ratioToUse = aspectRatioKey || '16:9';
        const [rW, rH] = ratioToUse.split(':').map(Number);
        const rDiag = Math.sqrt((rW * rW) + (rH * rH));
        const factor = diagonalInput / rDiag; // diagonalInput is in inches
        desiredW_mm = rW * factor * MM_PER_INCH;
        desiredH_mm = rH * factor * MM_PER_INCH;
      } else {
        const unitFactor = (unit === 'meters') ? MM_PER_METER : MM_PER_FOOT;
        const hasW = !isNaN(widthInput) && widthInput > 0;
        const hasH = !isNaN(heightInput) && heightInput > 0;

        if (aspectRatioKey) {
          const [rW, rH] = aspectRatioKey.split(':').map(Number);
          if (hasW) {
            desiredW_mm = widthInput * unitFactor;
            desiredH_mm = (widthInput / rW) * rH * unitFactor;
          } else if (hasH) {
            desiredH_mm = heightInput * unitFactor;
            desiredW_mm = (heightInput / rH) * rW * unitFactor;
          } else {
            desiredW_mm = (isNaN(widthInput) ? 0 : widthInput) * unitFactor;
            desiredH_mm = (isNaN(heightInput) ? 0 : heightInput) * unitFactor;
          }
        } else {
          const cabAR = cabinetW_mm / cabinetH_mm;
          if (hasW && !hasH) {
            desiredW_mm = widthInput * unitFactor;
            desiredH_mm = desiredW_mm / cabAR;
          } else if (hasH && !hasW) {
            desiredH_mm = heightInput * unitFactor;
            desiredW_mm = desiredH_mm * cabAR;
          } else {
            desiredW_mm = (isNaN(widthInput) ? 0 : widthInput) * unitFactor;
            desiredH_mm = (isNaN(heightInput) ? 0 : heightInput) * unitFactor;
          }
        }
      }

      // --- snap to nearest whole cabinets ---
      const numCabW = Math.max(1, Math.round(desiredW_mm / cabinetW_mm));
      const numCabH = Math.max(1, Math.round(desiredH_mm / cabinetH_mm));
      const totalCabinets = numCabW * numCabH;
      const totalModules = totalCabinets * details.modulesPerCab;
      const finalW_mm = numCabW * cabinetW_mm;
      const finalH_mm = numCabH * cabinetH_mm;
      const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);

      // --- resolution & pixels ---
      const finalResW = numCabW * details.cabPixW;
      const finalResH = numCabH * details.cabPixH;
      const totalPixels = finalResW * finalResH;

      const ratioGCD = gcd(finalResW, finalResH);
      const aspectRatioText = `${finalResW / ratioGCD}:${finalResH / ratioGCD}`;
      const finalDiagonal_mm = Math.sqrt((finalW_mm * finalW_mm) + (finalH_mm * finalH_mm));
      const finalDiagonal_in = finalDiagonal_mm / MM_PER_INCH;

      // --- viewing distance (1x / 2x / 3x pitch in meters -> feet) ---
      const minView_m = details.pitch_mm / 1000;
      const comfortView_m = (details.pitch_mm * 2) / 1000;
      const idealView_m = (details.pitch_mm * 3) / 1000;
      const minView_ft = minView_m * METER_TO_FEET;
      const comfortView_ft = comfortView_m * METER_TO_FEET;
      const idealView_ft = idealView_m * METER_TO_FEET;

      // --- power & weight calculations ---
      const actualPower_W_unbuffered = finalArea_m2 * details.maxPower_W_m2;
      const maxPower_W_buffered = actualPower_W_unbuffered * POWER_BUFFER;
      const actualCurrent_A = actualPower_W_unbuffered / 220;
      const maxCurrent_A_buffered = maxPower_W_buffered / 220;
      const actualCabinetWeight_unbuffered = details.weight_kg * totalCabinets;
      const totalWallWeight_buffered = actualCabinetWeight_unbuffered * WEIGHT_BUFFER;

      // ------------------------------
      // Long-cable & ports / sending card logic (updated)
      // ------------------------------
      const bandwidth_ports_needed = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_DEFAULT));
      const cabPixels = details.cabPixW * details.cabPixH;
      let cabinets_per_long_cable = Math.floor(PIXELS_PER_PORT_DEFAULT / cabPixels);
      if (cabinets_per_long_cable < 1) cabinets_per_long_cable = 1;
      const cables_needed_by_cabinets = Math.max(1, Math.ceil(totalCabinets / cabinets_per_long_cable));
      const requiredPorts = Math.max(bandwidth_ports_needed, cables_needed_by_cabinets);

      const outputCardPorts = finalCalculationData.outputCardPorts || H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS;
      const outputCardModel = finalCalculationData.outputCardModel || H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL;
      const requiredSendCards = Math.max(1, Math.ceil(requiredPorts / outputCardPorts));
      const requiredShortEthernet = Math.max(0, totalCabinets - requiredPorts);

      // --- controller suggestion + escalation if ports insufficient ---
      let suggestedController = getSuggestedControllerModel(totalPixels, finalResW, finalResH, productKey, requiredPorts);
      if (suggestedController.ports < requiredPorts) {
        let escalated = CONTROLLER_MODELS.find(c => c.ports >= requiredPorts && c.maxPixels >= totalPixels);
        if (!escalated) escalated = CONTROLLER_MODELS.find(c => c.ports >= requiredPorts);
        if (escalated) suggestedController = escalated;
        else suggestedController = CONTROLLER_MODELS[CONTROLLER_MODELS.length - 1];
      }

      const controllerName = finalCalculationData.controllerOverrideName || suggestedController.name;

      // --- final result object ---
      finalCalculationData = {
        productName: details.name,
        pixelPitch_mm: details.pitch_mm,
        cabinetW_mm: cabinetW_mm,
        cabinetH_mm: cabinetH_mm,
        cabPixW: details.cabPixW,
        cabPixH: details.cabPixH,
        finalW_mm: finalW_mm,
        finalH_mm: finalH_mm,
        finalArea_m2: finalArea_m2,
        finalResW: finalResW,
        finalResH: finalResH,
        totalPixels: totalPixels,
        aspectRatioText: aspectRatioText,
        finalDiagonal_in: finalDiagonal_in,
        totalCabinets: totalCabinets,
        totalModules: totalModules,
        totalRecCards: totalCabinets,
        numCabW: numCabW,
        numCabH: numCabH,
        modulesPerCab: details.modulesPerCab,
        nits_range: details.nits_range,
        minView_m: minView_m,
        comfortView_m: comfortView_m,
        idealView_m: idealView_m,
        minView_ft: minView_ft,
        comfortView_ft: comfortView_ft,
        idealView_ft: idealView_ft,
        actualPower_W_unbuffered: actualPower_W_unbuffered,
        maxPower_W: maxPower_W_buffered,
        actualCurrent_A: actualCurrent_A,
        maxCurrent_A_buffered: maxCurrent_A_buffered,
        actualWallWeight_unbuffered: actualCabinetWeight_unbuffered,
        totalWallWeight_buffered: totalWallWeight_buffered,
        controllerName: controllerName,
        controllerType: suggestedController.type,
        bandwidth_ports_needed: bandwidth_ports_needed,
        cabPixels: cabPixels,
        cabinets_per_long_cable: cabinets_per_long_cable,
        cables_needed_by_cabinets: cables_needed_by_cabinets,
        requiredPorts: requiredPorts,
        requiredShortEthernet: requiredShortEthernet,
        outputCardPorts: outputCardPorts,
        outputCardModel: outputCardModel,
        requiredSendCards: requiredSendCards,
        inputCardModel: finalCalculationData.inputCardModel || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL,
        inputCardQty: finalCalculationData.inputCardQty || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY,
        splicerSolution: finalCalculationData.splicerSolution || (suggestedController.type.includes('Modular') ? H_SERIES_DEFAULTS.SPLICER_NAME : 'N/A'),
        controllerOverrideName: finalCalculationData.controllerOverrideName || null
      };

      return finalCalculationData;
    }

    // -----------------------
    // UI render
    // -----------------------
    function calculateDimensions(data){
      return {
        finalW_M: data.finalW_mm / MM_PER_METER,
        finalH_M: data.finalH_mm / MM_PER_METER,
        finalW_FT: data.finalW_mm / MM_PER_FOOT,
        finalH_FT: data.finalH_mm / MM_PER_FOOT
      };
    }

    function showVisualization(){
      const data = calculateLEDWall(); if (!data) return;
      const dims = calculateDimensions(data);

      document.getElementById('enteredSummaryText').textContent = `Cabinet Matrix: ${data.numCabW}x${data.numCabH} (${data.totalCabinets} Cabinets)`;
      document.getElementById('aspectRatioValue').textContent = data.aspectRatioText;
      document.getElementById('formContainer').classList.add('minimized');
      document.getElementById('submitButton').classList.add('hidden');
      document.querySelector('.back-btn-placeholder').classList.remove('hidden');
      document.getElementById('visualization').classList.add('visible');

      document.getElementById('pixelPitchDisplay').innerHTML = `<strong>Pixel Pitch :</strong><small>${data.pixelPitch_mm} mm</small>`;
      document.getElementById('finalDimensions').innerHTML = `<strong>Actual Final Dimensions (WxH) :</strong><small>(${dims.finalW_FT.toFixed(2)}ft x ${dims.finalH_FT.toFixed(2)}ft) - ${dims.finalW_M.toFixed(2)}m x ${dims.finalH_M.toFixed(2)}m</small>`;
      document.getElementById('resolution').innerHTML = `<strong>Actual Final Resolution (WxH) :</strong><small>${data.finalResW} x ${data.finalResH}</small>`;
      document.getElementById('numCabinets').innerHTML = `<strong>Total Cabinets (W x H) :</strong><small>${data.totalCabinets} (${data.numCabW} x ${data.numCabH})</small>`;
      document.getElementById('totalModules').innerHTML = `<strong>Total Modules Required :</strong><small>${data.totalModules} (${data.modulesPerCab} per cabinet)</small>`;
      document.getElementById('finalDiagonal').innerHTML = `<strong>Final Diagonal Size :</strong><small>${data.finalDiagonal_in.toFixed(1)} in</small>`;
      document.getElementById('finalArea').innerHTML = `<strong>Final Area :</strong><small>${data.finalArea_m2.toFixed(2)} m¬≤</small>`;
      document.getElementById('totalPixels').innerHTML = `<strong>Total Pixels :</strong><small>${formatLargeNumber(data.totalPixels)}</small>`;
      document.getElementById('viewingDistance').innerHTML = `<strong>Viewing Distance (min / comfort / ideal) :</strong><small>${data.minView_m.toFixed(2)}m / ${data.comfortView_m.toFixed(2)}m / ${data.idealView_m.toFixed(2)}m ‚Äî ${data.minView_ft.toFixed(1)}ft / ${data.comfortView_ft.toFixed(1)}ft / ${data.idealView_ft.toFixed(1)}ft</small>`;
      document.getElementById('cabinetSize').innerHTML = `<strong>Cabinet Size (WxH) :</strong><small>${data.cabinetW_mm}mm x ${data.cabinetH_mm}mm</small>`;
      document.getElementById('cabinetPixels').innerHTML = `<strong>Cabinet Pixels (WxH) :</strong><small>${data.cabPixW} x ${data.cabPixH}</small>`;

      // control & connection summary
      const controlDiv = document.getElementById('controlSystemDetails');
      const isHSeries = data.controllerType.includes('Modular');
      let html = `
        <span style="grid-column:1/-1;font-weight:700;color:var(--brand);border-bottom:1px solid var(--brand);padding-bottom:5px;margin-bottom:5px;margin-top:10px;">Control System Summary</span>
        <span><strong>Controller/Processor Model (${data.controllerType}) :</strong><small>${data.controllerName}</small></span>
      `;

      if (isHSeries){
        html += `
          <div style="grid-column:1/-1;gap:5px;border-top:1px solid #e0e0e0;padding-top:10px;margin-top:5px;">
            <span style="font-weight:700;color:var(--accent)">Modular Components (H-Series)</span>
            <span><strong>Splicer Frame :</strong><small>${data.splicerSolution}</small></span>
            <span><strong>Output Card (${data.outputCardPorts} ports/card) :</strong><small>${data.requiredSendCards} x ${data.outputCardModel}</small></span>
            <span><strong>Input Card :</strong><small>${data.inputCardQty} x ${data.inputCardModel}</small></span>
          </div>
        `;
      }

      html += `
        <span style="grid-column:1/-1;font-weight:700;color:var(--brand);border-bottom:1px solid var(--brand);padding-bottom:5px;margin-bottom:5px;margin-top:10px;">Connection Summary</span>
        <span><strong>Total Receiving Cards Required :</strong><small>${data.totalRecCards}</small></span>
        <span><strong>Long Ethernet Ports/Runs :</strong><small>${data.requiredPorts} (Bandwidth-based: ${data.bandwidth_ports_needed} ; Cabinets-based: ${data.cables_needed_by_cabinets})</small></span>
        <span><strong>Cabinets per Long Cable (floor):</strong><small>${data.cabinets_per_long_cable}</small></span>
        <span><strong>Short Ethernet Cables (Between Cabinets) :</strong><small>${data.requiredShortEthernet}</small></span>
        <span style="grid-column:1/-1;font-weight:700;color:var(--brand);border-bottom:1px solid var(--brand);padding-bottom:5px;margin-bottom:5px;margin-top:10px;">Power and Weight</span>
        <span><strong>Max Power Consumption (Actual) :</strong><small>${formatNumber(data.actualPower_W_unbuffered,0)} W</small></span>
        <span><strong>Max Current Draw (Actual @220V) :</strong><small>${data.actualCurrent_A.toFixed(2)} A</small></span>
        <span><strong>Total Wall Weight (Actual Cabinets) :</strong><small>${formatNumber(data.actualWallWeight_unbuffered,1)} kg</small></span>
      `;
      controlDiv.innerHTML = html;

      // visualization grid
      const aspectRatio = data.finalW_mm / data.finalH_mm; const visualizationHeight = 300; const visGrid = document.getElementById('visGrid');
      if (visualizationHeight * aspectRatio > 800) { visGrid.style.width = '800px'; visGrid.style.height = (800 / aspectRatio) + 'px'; }
      else { visGrid.style.height = visualizationHeight + 'px'; visGrid.style.width = (visualizationHeight * aspectRatio) + 'px'; }
      visGrid.style.margin = '0 auto';
      document.getElementById('visWidthLabel').textContent = `${dims.finalW_M.toFixed(2)} m (W)`;
      document.getElementById('visHeightLabel').textContent = `${dims.finalH_M.toFixed(2)} m (H)`;
      const cabinetOverlay = document.getElementById('cabinetOverlay');
      cabinetOverlay.innerHTML = '';
      cabinetOverlay.style.gridTemplateColumns = `repeat(${data.numCabW}, 1fr)`;
      cabinetOverlay.style.gridTemplateRows = `repeat(${data.numCabH}, 1fr)`;
      for (let r=0; r<data.numCabH; r++){
        for (let c=0; c<data.numCabW; c++){
          const cell = document.createElement('div'); cell.style.border='1px dashed rgba(13,71,161,0.35)'; cell.style.boxSizing='border-box';
          cabinetOverlay.appendChild(cell);
        }
      }
      document.getElementById('downloadPdfLink').classList.remove('hidden');
    }

    function hideVisualization(){
      document.getElementById('formContainer').classList.remove('minimized');
      document.getElementById('visualization').classList.remove('visible');
      document.getElementById('submitButton').classList.remove('hidden');
      document.querySelector('.back-btn-placeholder').classList.add('hidden');
      document.getElementById('downloadPdfLink').classList.add('hidden');
    }

    // -----------------------
    // PDF generation (BOQ & Terms cleaned)
    // -----------------------
    function proceedToDownloadPdf(){
      const data = finalCalculationData;
      if (!data || !data.totalPixels) { const e=document.getElementById('errorMessage'); e.textContent='ERROR: Please calculate the LED wall configuration first.'; e.classList.remove('hidden'); e.scrollIntoView({behavior:'smooth', block:'center'}); return; }

      const dims = calculateDimensions(data);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p','mm','a4');
      let y=10; const margin=15; const lineHeight=7; const pageW = doc.internal.pageSize.getWidth();
      const primaryColor = [13,71,161]; const secondaryColor = [183,28,28];

      // Header
      doc.setFontSize(18); doc.setTextColor(...primaryColor); doc.text('PeopleLink LED Video Wall Technical Summary', pageW/2, y, {align:'center'}); y+=lineHeight;
      doc.setFontSize(8); doc.setTextColor(100,100,100); doc.text(`Generated: ${new Date().toLocaleDateString()} | Model: ${data.productName}`, pageW/2, y, {align:'center'}); y+=lineHeight*1.2;

      // 1. Performance
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('1. Wall Performance & Dimensions', margin, y); y+=lineHeight;
      const performanceData = [
        ['Actual Final Dimensions (WxH) :', `(${dims.finalW_FT.toFixed(2)}ft x ${dims.finalH_FT.toFixed(2)}ft) ‚Äî ${dims.finalW_M.toFixed(2)}m x ${dims.finalH_M.toFixed(2)}m`],
        ['Actual Final Resolution (WxH) :', `${data.finalResW} x ${data.finalResH}`],
        ['Aspect Ratio :', data.aspectRatioText],
        ['Final Diagonal Size :', `${data.finalDiagonal_in.toFixed(1)} inches`],
        ['Total Pixels / Area :', `${formatLargeNumber(data.totalPixels)} / ${data.finalArea_m2.toFixed(2)} m¬≤`],
        ['Viewing Distance (min / comfort / ideal) :', `${data.minView_m.toFixed(2)} m / ${data.comfortView_m.toFixed(2)} m / ${data.idealView_m.toFixed(2)} m`]
      ];
      doc.autoTable({ startY: y+2, body: performanceData, margin:{left:margin,right:margin}, theme:'striped', headStyles:{fillColor:primaryColor,halign:'center'}, styles:{fontSize:8,cellPadding:1.5}, columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}} });
      y = doc.lastAutoTable.finalY + lineHeight;

      // 2. Cab & Physical
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('2. Physical & Cabinet Specifications', margin, y); y+=lineHeight;
      const specsData = [
        ['Pixel Pitch :', `${data.pixelPitch_mm} mm`],
        ['Cabinet Dimensions (W x H) :', `${data.cabinetW_mm}mm x ${data.cabinetH_mm}mm`],
        ['Cabinet Pixels (W x H) :', `${data.cabPixW} x ${data.cabPixH}`],
        ['Cabinet Matrix (W x H) :', `${data.numCabW} x ${data.numCabH}`],
        ['Total Cabinets Required :', `${data.totalCabinets}`],
        ['Total Modules Required :', `${data.totalModules}`],
        ['Brightness Range :', data.nits_range ? `${data.nits_range} cd/m¬≤` : 'N/A']
      ];
      doc.autoTable({ startY: y+2, body: specsData, margin:{left:margin,right:margin}, theme:'plain', styles:{fontSize:8,cellPadding:1.5}, columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}} });
      y = doc.lastAutoTable.finalY + lineHeight;

      // 3. Control & Connections
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('3. Control System & Connections', margin, y); y+=lineHeight;
      const controllerData = [
        ['Controller/Processor Model :', `${data.controllerName} (${data.controllerType})`],
        ['Total Receiving Cards :', `${data.totalRecCards}`],
        ['Long Ethernet Ports/Runs : (Controller ‚Üí Wall)', `${data.requiredPorts}`],
        ['Cabinets per Long Cable (floor) :', `${data.cabinets_per_long_cable}`],
        ['Short Ethernet Cables (Between Cabinets)', `${data.requiredShortEthernet}`]
      ];
      if (data.controllerType.includes('Modular')) {
        controllerData.push(['Modular Splicer Frame :', data.splicerSolution || 'Not Specified']);
        controllerData.push(['Output Card (Sending) :', `${data.requiredSendCards} x ${data.outputCardModel}`]);
        controllerData.push(['Input Card (User Config) :', `${data.inputCardQty} x ${data.inputCardModel}`]);
      }
      doc.autoTable({ startY: y+2, body: controllerData, margin:{left:margin,right:margin}, theme:'striped', styles:{fontSize:8,cellPadding:1.5}, columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}} });
      y = doc.lastAutoTable.finalY + lineHeight;

      // 4. Power & Weight
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('4. Power and Weight', margin, y); y+=lineHeight;
      const powerWeightData = [
        ['Actual Max Power Consumption (W) :', `${formatNumber(data.actualPower_W_unbuffered,0)} W`],
        ['Design Max Power Consumption (W) :', `${formatNumber(data.maxPower_W,0)} W`],
        ['Max Current Draw (Actual @220V) :', `${data.actualCurrent_A.toFixed(2)} A`],
        ['Max Current Draw (Design @220V) :', `${data.maxCurrent_A_buffered.toFixed(2)} A`],
        ['Actual Wall Weight (kg) :', `${formatNumber(data.actualWallWeight_unbuffered,1)} kg`],
        ['Total Wall Weight (Installation Design) :', `${formatNumber(data.totalWallWeight_buffered,1)} kg`]
      ];
      doc.autoTable({ startY: y+2, body: powerWeightData, margin:{left:margin,right:margin}, theme:'plain', styles:{fontSize:8,cellPadding:1.5}, columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}} });
      y = doc.lastAutoTable.finalY + lineHeight*2;

      // 5. BOQ (cleaned)
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('5. Bill of Quantities (BOQ)', margin, y); y+=lineHeight;
      const sparesModules = Math.max(2, Math.ceil(data.totalModules * 0.03));
      const sparesRcv = Math.max(2, Math.ceil(data.totalRecCards * 0.02));
      const sparesPSU = Math.max(2, Math.ceil(data.totalCabinets * 0.02));
      const boqData = [
        ['LED Cabinets', data.productName, data.totalCabinets, 'PCS'],
        ['Controller/Processor', data.controllerName, 1, 'PCS'],
        ['Receiving Cards (R-Card)', 'Embedded in Cabinet', data.totalRecCards, 'PCS'],
        ['Output (Sending) Cards', data.outputCardModel || '-', data.requiredSendCards, 'PCS'],
        ['Input Cards', data.inputCardModel || '-', data.inputCardQty, 'PCS'],
        ['Spare LED Modules', 'Recommended ~3% spares', sparesModules, 'PCS'],
        ['Spare Receiving Cards', 'Recommended ~2% spares', sparesRcv, 'PCS'],
        ['Spare Power Supplies', 'Recommended ~2% spares', sparesPSU, 'PCS'],
        ['Long Ethernet Cables', 'Controller to Wall runs (CAT6/7)', data.requiredPorts, 'PCS'],
        ['Short Ethernet Cables', 'Cabinet interconnect (CAT6/7)', data.requiredShortEthernet, 'PCS'],
        ['Mounting Structure', 'Wall/stacking structure as per site', 1, 'LS'],
        ['Power Distribution', 'PDUs / Circuit Breakers as per load plan', 1, 'LS'],
        ['Installation / Commissioning', 'Wall mounting, stacking, cabling & testing', 1, 'LS'],
        ['Transport / Logistics', 'Shipping & handling to site', 1, 'LS']
      ];
      doc.autoTable({ startY: y+2, head:[['Item','Description / Model','Quantity','Unit']], body: boqData, margin:{left:margin,right:margin}, theme:'grid', headStyles:{fillColor:primaryColor,halign:'center'}, styles:{fontSize:8,cellPadding:1.5}, columnStyles:{0:{fontStyle:'bold'},2:{halign:'right'},3:{halign:'center'}} });
      y = doc.lastAutoTable.finalY + lineHeight*2;

      // 6. Terms & Conditions
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('6. Standard Terms & Conditions for Active LED', margin, y); y+=lineHeight;
      doc.setFontSize(8); doc.setTextColor(50,50,50);
      const terms = [
        '1. Validity: Quotation valid for 30 days from issue date.',
        '2. Payment: Default 50% advance, 40% on delivery, 10% on commissioning (negotiable).',
        '3. Scope: Civil works, wall reinforcement, and primary mounting structures are excluded unless specified in BOQ.',
        '4. Power & Data: Client to provide stable power sources (UPS/isolated circuits) and LAN drops at rack/console area. Long-run media converters or fiber extenders are extra if distances exceed standard assumptions.',
        '5. Cable Assumptions: Long Ethernet runs (Controller ‚Üí Wall) are counted as per BOQ. If additional routes / intermediate distribution are required, charges apply.',
        '6. Warranty: 1 year on LED modules and supplied electronics for manufacturing defects. Excludes physical damage, surge, and unauthorized repair.',
        '7. Acceptance: System acceptance after successful onsite commissioning. Basic user training included.',
        '8. Site Access: Safe access, storage and lifting equipment to be provided by client during installation.'
      ];
      terms.forEach(t => { const s=doc.splitTextToSize(t, pageW - 2*margin); doc.text(s, margin, y); y += (s.length*3.5) + 1; });

      // final note & footer
      y += lineHeight * 0.5;
      if (y > doc.internal.pageSize.getHeight() - margin - 20){ doc.addPage(); y = margin; }
      doc.setFontSize(7); doc.setTextColor(100,100,100);
      doc.text(`Note: Design Power & Weight include a ${MARGIN_PERCENT_TEXT} safety margin for structural & electrical planning.`, margin, y);
      doc.setFontSize(8); doc.setTextColor(176,196,222);
      doc.text('¬© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala', pageW/2, doc.internal.pageSize.getHeight()-10, {align:'center'});

      doc.save(`PeopleLink_LED_Config_${data.finalResW}x${data.finalResH}_BOQ.pdf`);
    }

    // -----------------------
    // Init
    // -----------------------
    document.addEventListener('DOMContentLoaded', ()=>{
      toggleMeasurementFields();
      populateModalControllers(); populateModalOutputCards(); populateModalInputCards();
      window.addEventListener('click', (evt) => {
        const modal = document.getElementById('controllerModal');
        if (evt.target === modal) closeControllerModal();
      });
    });
  </script>
</body>
</html>
