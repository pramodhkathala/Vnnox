<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{
      --bg:#eef1f8; --card:#fff; --brand:#0D47A1; --accent:#B71C1C; --muted:#f7f9fc; --ok:#1B5E20;
    }
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Arial;margin:0;padding:30px;background:var(--bg);color:#1c2738}
    .container{max-width:1100px;margin:0 auto}
    h2{text-align:center;color:var(--brand);margin:0 0 18px;font-size:1.6rem}
    .card{background:var(--card);padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    label{display:block;font-weight:600;margin-bottom:6px;color:#444}
    select,input{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    .btn{background:var(--brand);color:#fff;padding:12px;border-radius:8px;border:0;font-weight:700;cursor:pointer}
    .btn.gray{background:#6c757d}
    .btn.ok{background:var(--ok)}
    .hidden{display:none!important}
    .vis{margin-top:18px}
    .output-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    .details-list{display:grid;row-gap:8px}
    .details-list span{display:flex;justify-content:space-between;padding-bottom:6px;border-bottom:1px dotted #e6e6e6}
    .small{font-size:0.9rem;color:#666}
    .vis-area{border:3px solid var(--accent);background:linear-gradient(135deg,#e3f2fd,#bbdefb);height:300px;position:relative;overflow:hidden;border-radius:6px}
    #cabinetOverlay{position:absolute;inset:0;display:grid;pointer-events:none;grid-gap:0}
    .overlay-cell{border:1px dashed rgba(13,71,161,0.35);box-sizing:border-box}
    .dimension-label{position:absolute;background:rgba(255,255,255,0.95);padding:4px 8px;border-radius:4px;font-weight:700;color:var(--accent)}
    .dim-top{top:8px;left:50%;transform:translateX(-50%)}
    .dim-right{right:8px;top:50%;transform:translateY(-50%) rotate(90deg)}
    #boqContainer{margin-top:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border:1px solid #e9e9e9;font-size:13px}
    th{background:#f3f7ff;color:var(--brand);text-align:left}
    code.partcode{background:#f4f6f8;padding:4px 6px;border-radius:4px;cursor:pointer;color:#0b3e6f}
    .note{font-size:12px;color:#555;margin-top:8px}
    footer{margin-top:18px;text-align:center;color:#8fa3c2;font-size:12px}
    @media(max-width:900px){.grid,.output-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h2>PeopleLink LED Video Wall Configuration Calculator</h2>

    <div class="card" id="formCard">
      <div class="grid">
        <div>
          <label for="productModel">LED Model / Pixel Pitch</label>
          <select id="productModel">
            <option value="">Select LED Model</option>
            <optgroup label="COB (600x337.5mm)">
              <option value="cob_09">0.9375mm</option>
              <option value="cob_125">1.25mm</option>
              <option value="cob_15">1.5625mm</option>
            </optgroup>
            <optgroup label="SMD Indoor (640x480mm)">
              <option value="indoor_186">1.86mm</option>
              <option value="indoor_20">2.0mm</option>
              <option value="indoor_25">2.5mm</option>
            </optgroup>
            <optgroup label="SMD Outdoor (960x960mm)">
              <option value="outdoor_40">4.0mm</option>
              <option value="outdoor_667">6.67mm</option>
              <option value="outdoor_80">8.0mm</option>
              <option value="outdoor_100">10.0mm</option>
            </optgroup>
          </select>
        </div>

        <div>
          <label for="unit">Unit</label>
          <select id="unit" onchange="toggleMeasurementFields()">
            <option value="">Select unit</option>
            <option value="meters">Meters (m)</option>
            <option value="feet">Feet (ft)</option>
            <option value="inches">Inches (in) - Diagonal</option>
          </select>
        </div>

        <div id="widthGroup">
          <label id="widthLabel" for="width">Desired Width (m)</label>
          <input id="width" type="number" placeholder="Width" min="0.1" step="0.01">
        </div>
        <div id="heightGroup">
          <label id="heightLabel" for="height">Desired Height (m)</label>
          <input id="height" type="number" placeholder="Height" min="0.1" step="0.01">
        </div>

        <div id="diagonalGroup" class="hidden">
          <label id="diagonalLabel" for="diagonal">Diagonal (inches)</label>
          <input id="diagonal" type="number" placeholder="Diagonal in inches" min="10" step="1">
        </div>

        <div>
          <label for="aspectRatio">Aspect Ratio (optional)</label>
          <select id="aspectRatio">
            <option value="">Auto / None</option>
            <option value="16:9">16:9</option>
            <option value="16:10">16:10</option>
            <option value="4:3">4:3</option>
            <option value="21:9">21:9</option>
            <option value="1:1">1:1</option>
          </select>
        </div>

        <div style="align-self:end">
          <button class="btn" id="calcBtn" onclick="showVisualization()">Calculate & Visualize</button>
        </div>
      </div>

      <p id="errorMessage" class="note" style="color:#B71C1C;display:none"></p>
    </div>

    <div id="visualization" class="vis hidden">
      <div class="output-grid">
        <div class="card">
          <h3 style="margin:0 0 8px;color:var(--brand)">LED Wall Specifications</h3>
          <div class="details-list" id="specList">
            <span><strong>Pixel Pitch</strong><small id="specPitch">--</small></span>
            <span><strong>Final Dimensions (W x H)</strong><small id="specDim">--</small></span>
            <span><strong>Resolution (W x H)</strong><small id="specRes">--</small></span>
            <span><strong>Cabinet Matrix</strong><small id="specMatrix">--</small></span>
            <span><strong>Total Modules</strong><small id="specModules">--</small></span>
            <span><strong>Diagonal</strong><small id="specDiag">--</small></span>
            <span><strong>Area</strong><small id="specArea">--</small></span>
            <span><strong>Total Pixels</strong><small id="specPixels">--</small></span>
            <span><strong>Min Viewing (m / ft)</strong><small id="specMinView">--</small></span>
            <span><strong>Comfort Viewing (m / ft)</strong><small id="specComfortView">--</small></span>
            <span><strong>Ideal Viewing (m / ft)</strong><small id="specIdealView">--</small></span>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;color:var(--brand)">Control System & Connections</h3>
          <div class="details-list" id="controlList">
            <span><strong>Suggested Controller</strong><small id="ctrlName">--</small></span>
            <span><strong>Receiving Cards</strong><small id="ctrlRecv">--</small></span>
            <span><strong>Long Ethernet Ports</strong><small id="ctrlLong">--</small></span>
            <span><strong>Short Ethernet Cables</strong><small id="ctrlShort">--</small></span>
            <span><strong>Power (Design / Actual)</strong><small id="ctrlPower">--</small></span>
            <span><strong>Weight (Design / Actual)</strong><small id="ctrlWeight">--</small></span>
          </div>
        </div>
      </div>

      <div class="card vis" style="margin-top:14px">
        <h3 style="margin:0 0 8px;color:var(--brand)">Physical Wall Visualization</h3>
        <div class="vis-area" id="visArea">
          <div id="cabinetOverlay"></div>
          <div class="dimension-label dim-top" id="dimTop">-- W --</div>
          <div class="dimension-label dim-right" id="dimRight">-- H --</div>
        </div>
      </div>

      <div id="boqContainer" class="card">
        <h3 style="margin:0 0 8px;color:var(--brand)">Bill of Quantities (BOQ) â€” Part Codes</h3>
        <div class="note" style="margin-bottom:8px">Part codes are placeholders (TBD). Click a Part Code to edit inline, then press Enter or click away to save.</div>
        <table id="boqTable" aria-live="polite">
          <thead><tr><th>Item</th><th>Description / Model</th><th>Qty</th><th>Unit</th><th>Part Code</th></tr></thead>
          <tbody id="boqBody"></tbody>
        </table>
        <div class="note" id="boqNote" style="margin-top:8px">Note: After you finalize part codes, I can update the system to accept a CSV to bulk-import them.</div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <button class="btn" id="downloadPdf" onclick="proceedToDownloadPdf()">Download PDF Technical Summary ðŸ“„</button>
        <button class="btn gray" onclick="hideVisualization()">Modify Configuration</button>
      </div>
    </div>

    <footer>Â© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala</footer>
  </div>

<script>
/* -------------------------
   Constants & Product Data
   ------------------------- */
const MM_PER_METER = 1000;
const MM_PER_INCH = 25.4;
const MM_PER_FOOT = MM_PER_INCH * 12;
const METER_TO_FEET = 3.28084;
const PIXELS_PER_PORT_DEFAULT = 650000; // ~650K/port baseline
const POWER_BUFFER = 1.15;
const WEIGHT_BUFFER = 1.15;

// LED Products
const LED_PRODUCTS = {
  'cob_09':   { name:"PeopleLink COB (0.9375mm)", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, nits_range:"600-1000", maxPower_W_m2:300 },
  'cob_125':  { name:"PeopleLink COB (1.25mm)", pitch_mm:1.25, cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
  'cob_15':   { name:"PeopleLink COB (1.5625mm)", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
  'indoor_186':{ name:"PeopleLink SMD Indoor (1.86mm)", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
  'indoor_20':{ name:"PeopleLink SMD Indoor (2.0mm)", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
  'indoor_25':{ name:"PeopleLink SMD Indoor (2.5mm)", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
  'outdoor_40':{ name:"PeopleLink SMD Outdoor (4.0mm)", pitch_mm:4.0, cabW_mm:960, cabH_mm:960, cabPixW:240, cabPixH:240, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
  'outdoor_667':{ name:"PeopleLink SMD Outdoor (6.67mm)", pitch_mm:6.67, cabW_mm:960, cabH_mm:960, cabPixW:144, cabPixH:144, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
  'outdoor_80':{ name:"PeopleLink SMD Outdoor (8.0mm)", pitch_mm:8.0, cabW_mm:960, cabH_mm:960, cabPixW:120, cabPixH:120, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
  'outdoor_100':{ name:"PeopleLink SMD Outdoor (10.0mm)", pitch_mm:10.0, cabW_mm:960, cabH_mm:960, cabPixW:96, cabPixH:96, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 }
};

// Controller shortlist (used for suggestion)
const CONTROLLERS = [
  {name:"TB40", type:"Multimedia Player", ports:2, maxPixels:1300000, maxW:10240, maxH:8192},
  {name:"TB60", type:"Multimedia Player", ports:4, maxPixels:2300000, maxW:4096, maxH:4096},
  {name:"VX400 Pro", type:"All-in-One", ports:4, maxPixels:2600000, maxW:10240, maxH:8192},
  {name:"VX600 Pro", type:"All-in-One", ports:6, maxPixels:3900000, maxW:10240, maxH:8192},
  {name:"4K Prime", type:"All-in-One", ports:16, maxPixels:10400000, maxW:16384, maxH:8192},
  {name:"H5 (5U)", type:"Modular Splicer", ports:20, maxPixels:39000000, maxW:16384, maxH:8192}
];

// BOQ master structure (will be populated dynamically)
let BOQ_MASTER = [];

/* -------------------------
   UI Helpers
   ------------------------- */
function $(id){ return document.getElementById(id); }
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }

/* -------------------------
   Measurement toggles
   ------------------------- */
function toggleMeasurementFields(){
  const unit = $('unit').value;
  const diagMode = unit === 'inches';
  $('widthGroup').classList.toggle('hidden', diagMode);
  $('heightGroup').classList.toggle('hidden', diagMode);
  $('diagonalGroup').classList.toggle('hidden', !diagMode);

  $('widthLabel').textContent = `Desired Width ${diagMode? '(in)': unit==='feet' ? '(ft)' : '(m)'}`;
  $('heightLabel').textContent = `Desired Height ${diagMode? '(in)': unit==='feet' ? '(ft)' : '(m)'}`;
}

/* -------------------------
   GCD helper (for aspect ratio)
   ------------------------- */
function gcd(a,b){ return b===0? a : gcd(b, a%b); }

/* -------------------------
   Main calculation
   ------------------------- */
let finalData = {}; // store last calculation

function suggestController(totalPixels, resW, resH){
  // prefer small multimedia for small counts; otherwise pick first that fits
  let found = CONTROLLERS.find(c => (c.type === 'Multimedia Player') && c.maxPixels >= totalPixels && c.maxW >= resW && c.maxH >= resH);
  if(found) return found;
  found = CONTROLLERS.find(c => c.maxPixels >= totalPixels && c.maxW >= resW && c.maxH >= resH);
  return found || CONTROLLERS[CONTROLLERS.length-1];
}

function calculateLEDWall(){
  const productKey = $('productModel').value;
  const unit = $('unit').value;
  const widthVal = parseFloat($('width').value);
  const heightVal = parseFloat($('height').value);
  const diagVal = parseFloat($('diagonal').value);
  const aspectRatioOpt = $('aspectRatio').value;

  const err = $('errorMessage'); err.style.display='none';
  if(!productKey || !unit || ((unit !== 'inches' && !(widthVal>0 || heightVal>0)) || (unit==='inches' && !(diagVal>0)))){
    err.innerText = 'ERROR: select Model, Unit and enter at least one valid dimension.';
    err.style.display='block';
    return null;
  }

  const prod = LED_PRODUCTS[productKey];
  const cabW = prod.cabW_mm, cabH = prod.cabH_mm;

  let desiredW_mm = 0, desiredH_mm = 0;
  if(unit === 'inches'){
    const ratioUse = aspectRatioOpt || '16:9';
    const [rw,rh] = ratioUse.split(':').map(Number);
    const diagRatio = Math.sqrt(rw*rw + rh*rh);
    const factor = diagVal / diagRatio;
    desiredW_mm = rw * factor * MM_PER_INCH;
    desiredH_mm = rh * factor * MM_PER_INCH;
  } else {
    const unitFactor = unit === 'meters' ? MM_PER_METER : MM_PER_FOOT;
    const hasW = !isNaN(widthVal) && widthVal>0;
    const hasH = !isNaN(heightVal) && heightVal>0;
    if(aspectRatioOpt){
      const [rw,rh] = aspectRatioOpt.split(':').map(Number);
      if(hasW){ desiredW_mm = widthVal * unitFactor; desiredH_mm = (widthVal / rw) * rh * unitFactor; }
      else if(hasH){ desiredH_mm = heightVal * unitFactor; desiredW_mm = (heightVal / rh) * rw * unitFactor; }
      else { desiredW_mm = widthVal * unitFactor; desiredH_mm = heightVal * unitFactor; }
    } else {
      // infer missing dimension using cabinet aspect ratio
      const cabAR = cabW / cabH;
      if(hasW && !hasH){ desiredW_mm = widthVal * unitFactor; desiredH_mm = (widthVal * unitFactor) / cabAR; }
      else if(hasH && !hasW){ desiredH_mm = heightVal * unitFactor; desiredW_mm = (heightVal * unitFactor) * cabAR; }
      else { desiredW_mm = widthVal * unitFactor; desiredH_mm = heightVal * unitFactor; }
    }
  }

  // Snap to number of cabinets
  let numCabW = Math.max(1, Math.round(desiredW_mm / cabW));
  let numCabH = Math.max(1, Math.round(desiredH_mm / cabH));
  const totalCab = numCabW * numCabH;
  const totalModules = totalCab * prod.modulesPerCab;

  const finalW_mm = numCabW * cabW, finalH_mm = numCabH * cabH;
  const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);

  const finalResW = numCabW * prod.cabPixW;
  const finalResH = numCabH * prod.cabPixH;
  const totalPixels = finalResW * finalResH;

  const ratioG = gcd(finalResW, finalResH);
  const aspectRatioText = `${finalResW/ratioG}:${finalResH/ratioG}`;
  const finalDiagonal_mm = Math.sqrt(finalW_mm*finalW_mm + finalH_mm*finalH_mm);
  const finalDiagonal_in = finalDiagonal_mm / MM_PER_INCH;

  // ------------------------------
  // UPDATED viewing-distance rule:
  // min = pitch_mm * 1.2 (m)
  // comfort = pitch_mm * 2.0 (m)
  // ideal = pitch_mm * 3.0 (m)
  // ------------------------------
  const minView_m = prod.pitch_mm * 1.2;
  const comfortView_m = prod.pitch_mm * 2.0;
  const idealView_m = prod.pitch_mm * 3.0;
  const minView_ft = minView_m * METER_TO_FEET;
  const comfortView_ft = comfortView_m * METER_TO_FEET;
  const idealView_ft = idealView_m * METER_TO_FEET;

  // Port / sending card logic (bandwidth + cabinet distribution + columns)
  const cabinetPixels = prod.cabPixW * prod.cabPixH;
  const portsByBandwidth = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_DEFAULT));
  const maxCabinetsPerPort = Math.max(1, Math.floor(PIXELS_PER_PORT_DEFAULT / cabinetPixels));
  const requiredPortsByCabinets = Math.max(1, Math.ceil((numCabW * numCabH) / maxCabinetsPerPort));
  const requiredPortsByColumns = numCabW;
  const requiredLongPorts = Math.max(portsByBandwidth, requiredPortsByCabinets, requiredPortsByColumns);
  const requiredShortEthernet = Math.max(0, (numCabW * numCabH) - requiredLongPorts);
  const requiredSendCards = Math.max(1, Math.ceil(requiredLongPorts / 20)); // assume 20 ports per sending card by default

  // Power & weight
  const actualPower_W_unbuffered = finalArea_m2 * prod.maxPower_W_m2;
  const maxPower_W = actualPower_W_unbuffered * POWER_BUFFER;
  const actualCurrent_A = actualPower_W_unbuffered / 220;
  const maxCurrent_A_buffered = maxPower_W / 220;
  const actualWallWeight_unbuffered = prod.weight_kg * totalCab;
  const totalWallWeight_buffered = actualWallWeight_unbuffered * WEIGHT_BUFFER;

  // Controller suggestion
  const suggested = suggestController(totalPixels, finalResW, finalResH);

  // Save final data
  finalData = {
    productKey, prod,
    numCabW, numCabH, totalCab, totalModules,
    finalW_mm, finalH_mm, finalArea_m2,
    finalResW, finalResH, totalPixels,
    aspectRatioText, finalDiagonal_in,
    minView_m, comfortView_m, idealView_m,
    minView_ft, comfortView_ft, idealView_ft,
    requiredLongPorts, requiredShortEthernet, requiredSendCards,
    actualPower_W_unbuffered, maxPower_W, actualCurrent_A, maxCurrent_A_buffered,
    actualWallWeight_unbuffered, totalWallWeight_buffered,
    suggestedController: suggested
  };

  return finalData;
}

/* -------------------------
   Render UI with results
   ------------------------- */
function formatLarge(n){
  if(n>=1e6) return (n/1e6).toFixed(2)+'M';
  if(n>=1e3) return (n/1e3).toFixed(1)+'K';
  return n.toString();
}
function showVisualization(){
  const data = calculateLEDWall();
  if(!data) return;
  // show panel
  $('visualization').classList.remove('hidden');

  // specs
  $('specPitch').innerText = data.prod.pitch_mm + ' mm';
  $('specDim').innerText = `${(data.finalW_mm/1000).toFixed(2)} m x ${(data.finalH_mm/1000).toFixed(2)} m`;
  $('specRes').innerText = `${data.finalResW} x ${data.finalResH}`;
  $('specMatrix').innerText = `${data.numCabW} x ${data.numCabH} = ${data.totalCab} cab`;
  $('specModules').innerText = `${data.totalModules}`;
  $('specDiag').innerText = `${data.finalDiagonal_in.toFixed(1)} in`;
  $('specArea').innerText = `${data.finalArea_m2.toFixed(2)} mÂ²`;
  $('specPixels').innerText = formatLarge(data.totalPixels);

  $('specMinView').innerText = `${data.minView_m.toFixed(2)} m / ${data.minView_ft.toFixed(2)} ft`;
  $('specComfortView').innerText = `${data.comfortView_m.toFixed(2)} m / ${data.comfortView_ft.toFixed(2)} ft`;
  $('specIdealView').innerText = `${data.idealView_m.toFixed(2)} m / ${data.idealView_ft.toFixed(2)} ft`;

  // control
  $('ctrlName').innerText = `${data.suggestedController.name} (${data.suggestedController.type})`;
  $('ctrlRecv').innerText = `${data.totalCab} (embedded)`;
  $('ctrlLong').innerText = `${data.requiredLongPorts}`;
  $('ctrlShort').innerText = `${data.requiredShortEthernet}`;
  $('ctrlPower').innerText = `${Math.round(data.maxPower_W)} W design / ${Math.round(data.actualPower_W_unbuffered)} W actual`;
  $('ctrlWeight').innerText = `${Math.round(data.totalWallWeight_buffered)} kg design / ${Math.round(data.actualWallWeight_unbuffered)} kg actual`;

  // visualization grid
  renderCabinetOverlay(data.numCabW, data.numCabH);

  // BOQ generation
  generateBOQ(data);
}

/* -------------------------
   Cabinet overlay drawing
   ------------------------- */
function renderCabinetOverlay(cols, rows){
  const overlay = $('cabinetOverlay');
  overlay.innerHTML = '';
  overlay.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  overlay.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const d = document.createElement('div');
      d.className = 'overlay-cell';
      overlay.appendChild(d);
    }
  }
  $('dimTop').innerText = `${(finalData.finalW_mm/1000).toFixed(2)} m (W)`;
  $('dimRight').innerText = `${(finalData.finalH_mm/1000).toFixed(2)} m (H)`;
}

/* -------------------------
   BOQ: create rows & render editable codes
   ------------------------- */
function generateBOQ(data){
  // Create a BOQ master list (items, desc, qty, unit, part)
  BOQ_MASTER = [
    {item:'LED Cabinets', desc: data.prod.name, qty: data.totalCab, unit:'PCS', part:'TBD'},
    {item:'Controller/Processor', desc: data.suggestedController.name, qty:1, unit:'PCS', part:'TBD'},
    {item:'Receiving Cards (R-Card)', desc:'Embedded in cabinet', qty:data.totalCab, unit:'PCS', part:'TBD'},
    {item:'Output Sending Cards', desc:'H-series sending card (20-port typical)', qty:data.requiredSendCards, unit:'PCS', part:'TBD'},
    {item:'Long Ethernet Cables', desc:'Controller -> Wall (CAT6/7)', qty:data.requiredLongPorts, unit:'PCS', part:'TBD'},
    {item:'Short Ethernet Cables', desc:'Cabinet interconnect (CAT6/7)', qty:data.requiredShortEthernet, unit:'PCS', part:'TBD'},
    {item:'Installation / Configuration', desc:'Mounting & commissioning', qty:1, unit:'LS', part:'TBD'},
    {item:'Transport / Logistics', desc:'Freight to site', qty:1, unit:'LS', part:'TBD'}
  ];

  // Render table body
  const tbody = $('boqBody');
  tbody.innerHTML = '';
  BOQ_MASTER.forEach((row, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.item}</td>
                    <td>${row.desc}</td>
                    <td style="text-align:right">${row.qty}</td>
                    <td style="text-align:center">${row.unit}</td>
                    <td style="text-align:center"><code class="partcode" data-idx="${idx}">${row.part}</code></td>`;
    tbody.appendChild(tr);
  });

  // Attach click handlers for inline editing of part codes
  document.querySelectorAll('code.partcode').forEach(el=>{
    el.addEventListener('click', (e)=>{
      const idx = parseInt(e.currentTarget.dataset.idx,10);
      editPartCodeInline(idx, e.currentTarget);
    });
  });
}

/* inline edit for part codes */
function editPartCodeInline(idx, element){
  const prev = BOQ_MASTER[idx].part || 'TBD';
  const input = document.createElement('input');
  input.type = 'text'; input.value = prev;
  input.style.width='100%'; input.style.boxSizing='border-box';
  element.replaceWith(input);
  input.focus();
  input.select();

  function saveAndRestore(){
    const val = input.value.trim() || 'TBD';
    BOQ_MASTER[idx].part = val;
    // re-render BOQ body quickly
    generateBOQ(finalData);
  }

  input.addEventListener('blur', saveAndRestore);
  input.addEventListener('keydown', (ev)=>{
    if(ev.key === 'Enter'){ ev.preventDefault(); saveAndRestore(); }
    if(ev.key === 'Escape'){ generateBOQ(finalData); }
  });
}

/* -------------------------
   PDF generation (includes Part Codes)
   ------------------------- */
function proceedToDownloadPdf(){
  if(!finalData || !finalData.totalPixels){
    alert('Please calculate configuration first.');
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  const margin = 12;
  let y = 10;
  const pageW = doc.internal.pageSize.getWidth();

  doc.setFontSize(16); doc.setTextColor(13,71,161);
  doc.text('PeopleLink LED Video Wall Technical Summary', pageW/2, y, {align:'center'});
  y += 8;
  doc.setFontSize(8); doc.setTextColor(80,80,80);
  doc.text(`Generated: ${new Date().toLocaleDateString()} | Model: ${finalData.prod.name}`, pageW/2, y, {align:'center'});
  y += 10;

  // 1. Wall Performance
  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('1. Wall Performance & Dimensions', margin, y); y+=6;
  const perf = [
    ['Final Dimensions (W x H) :', `${(finalData.finalW_mm/1000).toFixed(2)} m x ${(finalData.finalH_mm/1000).toFixed(2)} m`],
    ['Resolution (W x H) :', `${finalData.finalResW} x ${finalData.finalResH}`],
    ['Aspect Ratio :', finalData.aspectRatioText],
    ['Final Diagonal :', `${finalData.finalDiagonal_in.toFixed(1)} in`],
    ['Total Pixels / Area :', `${formatLarge(finalData.totalPixels)} / ${finalData.finalArea_m2.toFixed(2)} mÂ²`],
    ['Viewing Distances (min/comfort/ideal) :',
      `${finalData.minView_m.toFixed(2)} m / ${finalData.comfortView_m.toFixed(2)} m / ${finalData.idealView_m.toFixed(2)} m`]
  ];
  doc.autoTable({ startY: y, body: perf, margin:{left:margin,right:margin}, theme:'striped', styles:{fontSize:8}, columnStyles:{0:{cellWidth:80},1:{cellWidth:100}}});
  y = doc.lastAutoTable.finalY + 6;

  // 2. Cabinet Specs
  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('2. Physical & Cabinet Specifications', margin, y); y+=6;
  const specs = [
    ['Pixel Pitch :', `${finalData.prod.pitch_mm} mm`],
    ['Cabinet Size (W x H) :', `${finalData.prod.cabW_mm} mm x ${finalData.prod.cabH_mm} mm`],
    ['Cabinet Pixels (W x H) :', `${finalData.prod.cabPixW} x ${finalData.prod.cabPixH}`],
    ['Cabinet Matrix (W x H) :', `${finalData.numCabW} x ${finalData.numCabH}`],
    ['Total Cabinets :', `${finalData.totalCab}`],
    ['Total Modules :', `${finalData.totalModules}`],
    ['Brightness Range :', finalData.prod.nits_range]
  ];
  doc.autoTable({ startY: y, body: specs, margin:{left:margin,right:margin}, theme:'plain', styles:{fontSize:8}, columnStyles:{0:{cellWidth:80},1:{cellWidth:100}}});
  y = doc.lastAutoTable.finalY + 6;

  // 3. Control & Connections
  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('3. Control System & Connections', margin, y); y+=6;
  const conn = [
    ['Controller/Processor :', `${finalData.suggestedController.name} (${finalData.suggestedController.type})`],
    ['Receiving Cards :', `${finalData.totalCab}`],
    ['Long Ethernet Ports (Controller â†’ Wall) :', `${finalData.requiredLongPorts}`],
    ['Short Ethernet Cables (Between cabinets) :', `${finalData.requiredShortEthernet}`],
    ['Output Sending Cards :', `${finalData.requiredSendCards}`]
  ];
  doc.autoTable({ startY: y, body: conn, margin:{left:margin,right:margin}, theme:'striped', styles:{fontSize:8}, columnStyles:{0:{cellWidth:90},1:{cellWidth:90}}});
  y = doc.lastAutoTable.finalY + 6;

  // 4. Power & Weight
  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('4. Power and Weight', margin, y); y+=6;
  const pw = [
    ['Actual Max Power (W) :', `${Math.round(finalData.actualPower_W_unbuffered)} W`],
    ['Design Max Power (W) :', `${Math.round(finalData.maxPower_W)} W`],
    ['Current Draw (Actual @220V) :', `${finalData.actualCurrent_A.toFixed(2)} A`],
    ['Design Current (with margin) :', `${finalData.maxCurrent_A_buffered.toFixed(2)} A`],
    ['Wall Weight (Actual) :', `${finalData.actualWallWeight_unbuffered.toFixed(1)} kg`],
    ['Wall Weight (Design w/ margin) :', `${finalData.totalWallWeight_buffered.toFixed(1)} kg`]
  ];
  doc.autoTable({ startY: y, body: pw, margin:{left:margin,right:margin}, theme:'plain', styles:{fontSize:8}, columnStyles:{0:{cellWidth:90},1:{cellWidth:90}}});
  y = doc.lastAutoTable.finalY + 8;

  // 5. BOQ (with Part Codes)
  doc.setFontSize(12); doc.setTextColor(183,28,28);
  doc.text('5. Bill of Quantities (BOQ)', margin, y); y+=6;

  // Prepare BOQ rows
  const boqRows = BOQ_MASTER.map(r => [r.item, r.desc, r.qty.toString(), r.unit, r.part || 'TBD']);
  // Add table with header
  doc.autoTable({ startY: y, head: [['Item','Description','Qty','Unit','Part Code']], body: boqRows, margin:{left:margin,right:margin}, styles:{fontSize:8} });
  y = doc.lastAutoTable.finalY + 8;

  // Terms & Note about part codes
  doc.setFontSize(9); doc.setTextColor(60,60,60);
  doc.text('Note: Part codes listed in this BOQ are placeholders (TBD). Provide final part codes and the BOQ will be updated.', margin, y);
  y += 8;

  const terms = [
    '1. Price Validity: Quotation valid for 30 days from date of issue.',
    '2. Payment Terms: Typical 50% advance, 40% delivery, 10% commissioning.',
    '3. Civil Work: Client provides mounting structure unless specified in BOQ.',
    '4. Power & Data: Ensure stable power and LAN drops near installation area.',
    '5. Warranty: 1 year standard on panels & accessories (manufacturing defects).'
  ];
  terms.forEach(t=>{
    if(y > doc.internal.pageSize.getHeight() - 40){ doc.addPage(); y = 15; }
    const spl = doc.splitTextToSize(t, pageW - margin*2);
    doc.text(spl, margin, y); y += (spl.length * 4) + 1;
  });

  // Footer
  doc.setFontSize(8); doc.setTextColor(176,196,222);
  doc.text('Â© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala', pageW/2, doc.internal.pageSize.getHeight() - 8, {align:'center'});

  doc.save(`PeopleLink_LED_Config_${finalData.finalResW}x${finalData.finalResH}_BOQ.pdf`);
}

/* -------------------------
   Small helpers & events
   ------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  toggleMeasurementFields();
  $('calcBtn').addEventListener('click', showVisualization);
  $('unit').addEventListener('change', toggleMeasurementFields);
});

function hideVisualization(){
  $('visualization').classList.add('hidden');
}

/* -------------------------
   Utility: formatting
   ------------------------- */
function formatLarge(n){
  if(n>=1e6) return (n/1e6).toFixed(2) + 'M';
  if(n>=1e3) return (n/1e3).toFixed(1) + 'K';
  return n.toString();
}
</script>
</body>
</html>
