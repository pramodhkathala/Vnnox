<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>PeopleLink LED Video Wall — Compact (PDF/CSV fixed)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<!-- jspdf + autotable + html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  :root{--brand:#0D47A1;--accent:#B71C1C}
  /* compact sizing */
  html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0; padding:18px; background:#eef6fb; color:#0c1; font-size:13px}
  .main{max-width:1100px;margin:0 auto}
  h2{color:var(--brand);margin:0 0 10px;font-weight:700;font-size:1.05rem}
  .panel-grid{display:grid;grid-template-columns:1fr 380px;gap:14px}
  .card{background:#fff;padding:12px;border-radius:8px;border:1px solid rgba(13,71,161,0.06);box-shadow:0 6px 18px rgba(6,25,57,0.04)}
  label{display:block;font-weight:600;color:var(--brand);margin-bottom:6px;font-size:12px}
  input,select{width:100%;padding:7px 8px;border-radius:6px;border:1px solid #e6eef6;font-size:13px}
  .controls{display:flex;gap:8px;justify-content:flex-start;margin-top:10px}
  button.primary{background:var(--brand);color:#fff;border:0;padding:8px 10px;border-radius:7px;font-weight:700;cursor:pointer;font-size:13px}
  button.ghost{background:#f3f8ff;border:1px solid #e6eef6;color:var(--brand);padding:7px 9px;border-radius:7px;cursor:pointer;font-weight:600}
  .specs .title, .ctrl .title{color:var(--brand);font-weight:800;margin-bottom:8px;font-size:13px}
  .spec-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dotted rgba(0,0,0,0.06);font-size:13px}
  .spec-row .lbl{font-weight:700;color:var(--brand);width:58%}
  .spec-row .val{font-weight:800;color:var(--accent);text-align:right;width:42%}
  .vis-box{margin-top:10px;border-radius:6px;padding:8px;background:linear-gradient(180deg,#eaf4ff,#e5f2ff);border:2px solid rgba(13,71,161,0.08)}
  .vis-grid{width:100%;height:240px;position:relative;border:1px solid rgba(13,71,161,0.10);display:flex;align-items:center;justify-content:center;overflow:hidden}
  #cabinetOverlay{position:absolute;inset:6px;display:grid;gap:0;padding:4px;box-sizing:border-box}
  #cabinetOverlay > div{border:1px solid rgba(13,71,161,0.12);display:flex;align-items:center;justify-content:center;background:transparent;font-weight:700;color:var(--brand);font-size:11px}
  table#boq{width:100%;border-collapse:collapse;font-size:12px;margin-top:10px}
  table#boq th, table#boq td{border:1px solid #e6eef6;padding:6px}
  table#boq th{background:linear-gradient(90deg, rgba(13,71,161,0.06), rgba(27,94,32,0.02));color:var(--brand);font-weight:700;font-size:12px}
  .muted{color:#6b7280;font-size:12px}
  footer{margin-top:12px;color:#8fa6c8;text-align:center;font-size:12px}
  @media(max-width:980px){ .panel-grid{grid-template-columns:1fr} .vis-grid{height:180px} }
</style>
</head>
<body>
  <div class="main">
    <h2>PeopleLink LED Video Wall — Compact</h2>

    <div class="panel-grid">
      <div class="card">
        <div style="font-weight:800;color:var(--brand);margin-bottom:8px;font-size:13px">Configure LED Wall</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label>LED Model / Pixel Pitch</label>
            <select id="productModel">
              <option value="">Select</option>
              <optgroup label="COB (600x337.5mm)">
                <option value="cob_09">0.9375 mm</option>
                <option value="cob_125">1.25 mm</option>
                <option value="cob_15">1.5625 mm</option>
              </optgroup>
              <optgroup label="SMD Indoor (640x480mm)">
                <option value="indoor_186">1.86 mm</option>
                <option value="indoor_20">2.0 mm</option>
                <option value="indoor_25">2.5 mm</option>
              </optgroup>
            </select>
          </div>

          <div>
            <label>Unit</label>
            <select id="unit" onchange="toggleMeasurementFields()">
              <option value="">Select</option>
              <option value="meters">Meters (m)</option>
              <option value="feet">Feet (ft)</option>
              <option value="inches">Inches (Diagonal)</option>
            </select>
          </div>

          <div id="widthGroup">
            <label id="widthLabel">Desired Width (m)</label>
            <input id="width" type="number" step="0.01" min="0.1">
          </div>

          <div id="heightGroup">
            <label id="heightLabel">Desired Height (m)</label>
            <input id="height" type="number" step="0.01" min="0.1">
          </div>

          <div id="diagonalGroup" style="display:none">
            <label id="diagonalLabel">Diagonal (in)</label>
            <input id="diagonal" type="number" step="1" min="10">
          </div>

          <div>
            <label>Aspect Ratio (optional)</label>
            <select id="aspectRatio">
              <option value="">Auto</option>
              <option value="16:9">16:9</option>
              <option value="16:10">16:10</option>
              <option value="4:3">4:3</option>
              <option value="21:9">21:9</option>
              <option value="1:1">1:1</option>
            </select>
          </div>

          <div style="display:flex;align-items:flex-end;">
            <div class="controls">
              <button class="primary" onclick="showVisualization()">Calculate & Visualize</button>
              <button class="ghost" onclick="resetForm()">Reset</button>
            </div>
          </div>
        </div>

        <div id="errorMessage" class="muted" style="color:#b71c1c;margin-top:8px;display:none"></div>

        <div class="vis-box">
          <div style="font-weight:800;color:var(--brand);margin-bottom:6px;font-size:13px">Physical Wall Visualization</div>
          <div class="vis-grid" id="visGrid">
            <div id="cabinetOverlay" aria-hidden="true"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:8px">
            <div class="muted">Hover cabinet for label</div>
            <div id="visDimensions" style="font-weight:700;color:var(--brand);font-size:12px"></div>
          </div>
        </div>

        <div id="boqPreviewContainer"></div>
      </div>

      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="card specs">
          <div class="title">LED Wall Specifications</div>
          <div id="specRows">
            <div class="spec-row"><div class="lbl">Model:</div><div class="val" id="spec_model">--</div></div>
            <div class="spec-row"><div class="lbl">Pixel Pitch:</div><div class="val" id="spec_pitch">--</div></div>
            <div class="spec-row"><div class="lbl">Actual Final Dimensions (WxH):</div><div class="val" id="spec_dims">--</div></div>
            <div class="spec-row"><div class="lbl">Actual Final Resolution (WxH):</div><div class="val" id="spec_res">--</div></div>
            <div class="spec-row"><div class="lbl">Final Diagonal:</div><div class="val" id="spec_diag">--</div></div>
            <div class="spec-row"><div class="lbl">Pixel Density:</div><div class="val" id="spec_density">--</div></div>
            <div class="spec-row"><div class="lbl">Final Area:</div><div class="val" id="spec_area">--</div></div>
            <div class="spec-row"><div class="lbl">Total Cabinets:</div><div class="val" id="spec_cabs">--</div></div>
          </div>
        </div>

        <div class="card ctrl">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="title">Control & Connection Summary</div>
            <button class="ghost" onclick="openControllerModal()">Edit</button>
          </div>
          <div style="margin-top:8px">
            <div class="spec-row"><div class="lbl">Suggested Controller:</div><div class="val" id="ctrl_name">--</div></div>
            <div class="spec-row"><div class="lbl">Controller Ports (post buffer):</div><div class="val" id="ctrl_ports">--</div></div>
            <div class="spec-row" id="sendingRow"><div class="lbl">Sending Cards needed:</div><div class="val" id="ctrl_sending">--</div></div>
            <div class="spec-row"><div class="lbl">Inter-cabinet Short Ethernet:</div><div class="val" id="ctrl_shorteth">--</div></div>
            <div class="spec-row"><div class="lbl">Max Power (Est.):</div><div class="val" id="spec_power">--</div></div>
            <div class="spec-row"><div class="lbl">Total Weight (Est.):</div><div class="val" id="spec_weight">--</div></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="primary" onclick="openContactModal()">Download PDF</button>
            <button class="ghost" onclick="downloadBOQCSV()">Download Excel (CSV)</button>
          </div>
        </div>
      </div>
    </div>

    <footer>© 2025 PeopleLink Unified Communications Pvt. Ltd.</footer>
  </div>

  <!-- Controller modal -->
  <div class="modal" id="controllerModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:40">
    <div class="card" style="width:760px;max-width:94%">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;color:var(--brand)">Edit Control System</div>
        <div><button class="ghost" onclick="closeControllerModal()">Close</button></div>
      </div>
      <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Controller/Processor Model</label>
          <select id="modalControllerModel" onchange="onModalControllerChange()"></select>
        </div>
        <div>
          <label>Splicer Frame / Solution</label>
          <input id="modalSplicerSolution" />
        </div>
        <div>
          <label>Output (Sending) Card</label>
          <select id="modalOutputCardModel" onchange="updatePortsFromOutputCard()"></select>
        </div>
        <div>
          <label>Max Ports per Output Card</label>
          <input id="modalMaxPortsPerCard" readonly />
        </div>
        <div>
          <label>Input Card Model</label>
          <select id="modalInputCardModel"></select>
        </div>
        <div>
          <label>Input Card Quantity</label>
          <input id="modalInputCardQty" type="number" min="1" value="2" />
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="ghost" onclick="closeControllerModal()">Cancel</button>
        <button class="primary" onclick="applyModalChanges()">Apply</button>
      </div>
    </div>
  </div>

  <!-- Contact modal -->
  <div class="modal" id="contactModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:40">
    <div class="card" style="width:520px;max-width:94%">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;color:var(--brand)">Contact (optional)</div>
        <div><button class="ghost" onclick="closeContactModal()">Close</button></div>
      </div>
      <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Email</label>
          <input id="downloadEmail" type="email" />
        </div>
        <div>
          <label>Phone</label>
          <input id="downloadPhone" type="tel" />
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="ghost" onclick="closeContactModal()">Cancel</button>
        <button class="primary" onclick="handleDownloadRequest()">Download PDF</button>
      </div>
      <div id="contactError" style="color:#b71c1c;margin-top:8px;display:none"></div>
    </div>
  </div>

<script>
/* ---------- calculations and datasets left unchanged ---------- */
const MM_PER_METER = 1000, MM_PER_INCH = 25.4, MM_PER_FOOT = MM_PER_INCH*12;
const PIXELS_PER_PORT_DEFAULT = 650000;
const GLOBAL_PORT_BUFFER_PCT = 0.05, POWER_BUFFER = 1.15, WEIGHT_BUFFER = 1.15;

const LED_PRODUCTS = {
  'cob_09': { name:"PeopleLink COB (0.9375mm)", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300 },
  'cob_125': { name:"PeopleLink COB (1.25mm)", pitch_mm:1.25, cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300 },
  'cob_15': { name:"PeopleLink COB (1.5625mm)", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300 },
  'indoor_186': { name:"PeopleLink SMD Indoor (1.86mm)", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560 },
  'indoor_20': { name:"PeopleLink SMD Indoor (2.0mm)", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560 },
  'indoor_25': { name:"PeopleLink SMD Indoor (2.5mm)", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560 }
};

const CONTROLLER_MODELS = [
  { name:"TB40", type:"Multimedia", ports:2, maxPixels:1300000, priority:1 },
  { name:"TB60", type:"Multimedia", ports:4, maxPixels:2300000, priority:2 },
  { name:"VX400 Pro / DSP400 Pro", type:"All-in-One", ports:4, maxPixels:2600000, priority:3 },
  { name:"VX600 Pro / DSP600 Pro", type:"All-in-One", ports:6, maxPixels:3900000, priority:4 },
  { name:"VX1000 Pro / DSP1000 Pro", type:"All-in-One", ports:10, maxPixels:6500000, priority:5 },
  { name:"H2", type:"Modular", ports:20, maxPixels:26000000, maxSendCards:2, priority:6 },
  { name:"H5", type:"Modular", ports:20, maxPixels:39000000, maxSendCards:3, priority:7 },
  { name:"H9", type:"Modular", ports:20, maxPixels:65000000, maxSendCards:6, priority:8 },
  { name:"H15", type:"Modular", ports:20, maxPixels:130000000, maxSendCards:12, priority:9 }
];

const PARTS_CATALOG = {
  'TB40':{part:'TP-VWC-NS-TB40',desc:'TB40 Controller'},
  'TB60':{part:'TP-VWC-NS-TB60',desc:'TB60 Controller'},
  'VX600':{part:'TP-VWC-NS-VX600',desc:'VX600 Pro / DSP600 Pro'},
  'H2':{part:'TP-XMF-H2',desc:'H2 Modular Splicer'},
  'H5':{part:'TP-XMF-H5',desc:'H5 Modular Splicer'},
  'H9':{part:'TP-XMF-H9',desc:'H9 Modular Splicer'},
  'H_20_RJ45':{part:'TP-XOC-RJ45-20',desc:'H 20xRJ45 Sending Card'},
  'H_16_RJ45':{part:'TP-XOC-RJ45-16-OF2',desc:'H 16xRJ45 + 2fiber Sending Card'},
  'H_4_HDMI_Out':{part:'TP-XOC-HDMI4',desc:'H 4xHDMI Output Card'},
  'H_1xHDMI':{part:'TP-XIC-HDMI',desc:'H 1xHDMI Input Card'},
  'H_2xHDMI':{part:'TP-XIC-HDMI2',desc:'H 2xHDMI Input Card'},
  'H_800W_PSU':{part:'TP-XPS-H800W',desc:'H 800W Power Supply'},
  'PPL-COB-125':{part:'PPL-COB-MDL-CU-12',desc:'PeopleLink COB 1.25 Cabinet (incl modules)'},
  'PPL-COB-156':{part:'PPL-COB-MDL-CU-12',desc:'PeopleLink COB 1.56 Cabinet (incl modules)'}
};

const CABINETS_PER_LONG_LAN = { 'cob_09':2, 'cob_125':5, 'cob_15':7 };

let finalCalculationData = {};
let contactInfo = { email:'', phone:'' };

/* small helpers */
function gcd(a,b){ return b===0 ? a : gcd(b, a%b); }
function fmt(n,d=0){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}); }
function formatLarge(n){ return n.toLocaleString(undefined,{maximumFractionDigits:0}); }

/* populate modal selects */
function populateModal(){
  const sel = document.getElementById('modalControllerModel'); sel.innerHTML='';
  CONTROLLER_MODELS.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; o.textContent=`${c.name} (${c.type})`; sel.appendChild(o); });
  const out = document.getElementById('modalOutputCardModel'); out.innerHTML='';
  [['H_20_RJ45',20],['H_16_RJ45',16],['H_4_HDMI_Out',4]].forEach(it=>{ const o=document.createElement('option'); o.value=`${it[0]}|${it[1]}`; o.textContent=`${it[0]} (${it[1]} ports)`; out.appendChild(o); });
  const inSel = document.getElementById('modalInputCardModel'); inSel.innerHTML='';
  ['H_1xHDMI','H_2xHDMI'].forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent = PARTS_CATALOG[m]?PARTS_CATALOG[m].desc:m; inSel.appendChild(o); });
}

/* show/hide measurement */
function toggleMeasurementFields(){
  const u = document.getElementById('unit').value; const diag = u==='inches';
  document.getElementById('widthGroup').style.display = diag ? 'none' : 'block';
  document.getElementById('heightGroup').style.display = diag ? 'none' : 'block';
  document.getElementById('diagonalGroup').style.display = diag ? 'block' : 'none';
  document.getElementById('widthLabel').textContent = `Desired Width ${u==='feet'?'(ft)':u==='inches'?'(in)':'(m)'}`;
  document.getElementById('heightLabel').textContent = `Desired Height ${u==='feet'?'(ft)':u==='inches'?'(in)':'(m)'}`;
}

/* Calculation function: formulas preserved exactly (no changes) */
function calculateLEDWall(){
  const productKey = document.getElementById('productModel').value;
  const unit = document.getElementById('unit').value;
  const widthInput = parseFloat(document.getElementById('width').value || 0);
  const heightInput = parseFloat(document.getElementById('height').value || 0);
  const diagonalInput = parseFloat(document.getElementById('diagonal').value || 0);
  const aspectRatioKey = document.getElementById('aspectRatio').value;

  const err = document.getElementById('errorMessage'); err.style.display='none';
  if(!productKey || !unit || ((unit!=='inches' && !widthInput && !heightInput) || (unit==='inches' && !diagonalInput))){
    err.textContent='ERROR: Select model, unit and enter valid dimensions.'; err.style.display='block'; return null;
  }

  const details = LED_PRODUCTS[productKey];
  let desiredW_mm=0, desiredH_mm=0;

  if(unit === 'inches'){
    const ratio = aspectRatioKey || '16:9';
    const [rw,rh] = ratio.split(':').map(Number);
    const diagRatio = Math.sqrt(rw*rw + rh*rh);
    const factor = diagonalInput / diagRatio;
    desiredW_mm = rw * factor * MM_PER_INCH;
    desiredH_mm = rh * factor * MM_PER_INCH;
  } else {
    const unitFactor = unit === 'meters' ? MM_PER_METER : MM_PER_FOOT;
    if(aspectRatioKey){
      const [rw,rh] = aspectRatioKey.split(':').map(Number);
      if(widthInput && heightInput){
         desiredW_mm = widthInput * unitFactor;
         desiredH_mm = heightInput * unitFactor;
      } else if(widthInput){
         desiredW_mm = widthInput * unitFactor;
         desiredH_mm = (widthInput / rw) * rh * unitFactor;
      } else if(heightInput){
         desiredH_mm = heightInput * unitFactor;
         desiredW_mm = (heightInput / rh) * rw * unitFactor;
      } else {
         desiredW_mm = widthInput * unitFactor;
         desiredH_mm = heightInput * unitFactor;
      }
    } else {
      if(widthInput && !heightInput){
        desiredW_mm = widthInput * unitFactor;
        desiredH_mm = (desiredW_mm / details.cabW_mm) * details.cabH_mm;
      } else if(heightInput && !widthInput) {
        desiredH_mm = heightInput * unitFactor;
        desiredW_mm = (desiredH_mm / details.cabH_mm) * details.cabW_mm;
      } else {
        desiredW_mm = widthInput * unitFactor;
        desiredH_mm = heightInput * unitFactor;
      }
    }
  }

  const numCabW = Math.max(1, Math.round(desiredW_mm / details.cabW_mm));
  const numCabH = Math.max(1, Math.round(desiredH_mm / details.cabH_mm));
  const totalCabinets = numCabW * numCabH;
  const totalModules = totalCabinets * details.modulesPerCab;
  const finalW_mm = numCabW * details.cabW_mm;
  const finalH_mm = numCabH * details.cabH_mm;
  const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);
  const finalResW = numCabW * details.cabPixW;
  const finalResH = numCabH * details.cabPixH;
  const totalPixels = finalResW * finalResH;
  const ratioG = gcd(finalResW, finalResH);
  const aspectRatioText = `${finalResW/ratioG}:${finalResH/ratioG}`;
  const finalDiagonal_in = Math.sqrt(finalW_mm*finalW_mm + finalH_mm*finalH_mm) / MM_PER_INCH;
  const pixelDensity = Math.round((totalPixels) / finalArea_m2);

  const actualPowerW = finalArea_m2 * details.maxPower_W_m2;
  const designPowerW = actualPowerW * POWER_BUFFER;
  const actualWeight = details.weight_kg * totalCabinets;
  const designWeight = actualWeight * WEIGHT_BUFFER;

  const pixels_per_port_no_buffer = PIXELS_PER_PORT_DEFAULT;
  const ports_by_pixels = Math.max(1, Math.ceil(totalPixels / pixels_per_port_no_buffer));
  
  const cabinetsRule = CABINETS_PER_LONG_LAN[productKey];
  let requiredLongEthRuns = 0;
  if(cabinetsRule){
    requiredLongEthRuns = Math.max(1, Math.ceil(totalCabinets / cabinetsRule));
  } else {
    requiredLongEthRuns = ports_by_pixels; 
  }
  
  const requiredPorts_NoBuffer = Math.max(ports_by_pixels, requiredLongEthRuns);
  const requiredPortsBufferedFloat = requiredPorts_NoBuffer * (1 + GLOBAL_PORT_BUFFER_PCT);
  const requiredPortsCeiling = Math.max(1, Math.ceil(requiredPortsBufferedFloat));
  const requiredShortEthernet = Math.max(0, totalCabinets - requiredPortsCeiling); 

  let suggested = CONTROLLER_MODELS.find(c => {
    if(c.type === 'Modular') {
      return c.maxPixels >= totalPixels;
    } else {
      return c.maxPixels >= totalPixels && c.ports >= requiredPortsCeiling; 
    }
  }) || CONTROLLER_MODELS[CONTROLLER_MODELS.length-1];

  const outputCardPorts_default = 20;
  let requiredSendCards = Math.max(1, Math.ceil(requiredPortsCeiling / outputCardPorts_default)); 

  if(suggested.type === 'Modular'){
    const idx = CONTROLLER_MODELS.findIndex(c=>c.name === suggested.name);
    let j = idx;
    while(j < CONTROLLER_MODELS.length && (CONTROLLER_MODELS[j].type === 'Modular') && (CONTROLLER_MODELS[j].maxSendCards < requiredSendCards || CONTROLLER_MODELS[j].maxPixels < totalPixels)){
      j++;
    }
    if(j < CONTROLLER_MODELS.length && CONTROLLER_MODELS[j].type === 'Modular') suggested = CONTROLLER_MODELS[j];
  }
  
  finalCalculationData = {
    productKey, productName: details.name, pixelPitch_mm: details.pitch_mm,
    cabinetW_mm: details.cabW_mm, cabinetH_mm: details.cabH_mm, cabPixW: details.cabPixW, cabPixH: details.cabPixH, modulesPerCab: details.modulesPerCab,
    numCabW, numCabH, totalCabinets, totalModules, finalW_mm, finalH_mm, finalArea_m2, finalResW, finalResH, totalPixels,
    aspectRatioText, finalDiagonal_in, pixelDensity, actualPowerW, designPowerW, requiredPowerRuns: Math.max(1, Math.ceil((finalArea_m2*details.maxPower_W_m2) / 1000)),
    actualWeight, designWeight,
    requiredPorts_NoBuffer, requiredPortsBufferedFloat, requiredPortsCeiling,
    requiredShortEthernet, requiredLongEthRuns, requiredSendCards,
    controllerName: finalCalculationData.controllerOverrideName || suggested.name, controllerType: suggested.type, suggestedControllerObj: suggested,
    outputCardPorts: finalCalculationData.outputCardPorts || outputCardPorts_default, 
    outputCardModel: finalCalculationData.outputCardModel || 'H_20_RJ45',
    inputCardModel: finalCalculationData.inputCardModel || 'H_1xHDMI', inputCardQty: finalCalculationData.inputCardQty || 2,
    splicerSolution: finalCalculationData.splicerSolution || (suggested.type==='Modular' ? `${suggested.name} Splicer` : 'N/A')
  };

  return finalCalculationData;
}

/* render viz + BOQ preview (unchanged) */
function renderCabinetOverlay(data){
  const overlay = document.getElementById('cabinetOverlay'); overlay.innerHTML='';
  overlay.style.gridTemplateColumns = `repeat(${data.numCabW}, 1fr)`; overlay.style.gridTemplateRows = `repeat(${data.numCabH}, 1fr)`;
  let tooltip = document.getElementById('cabTooltip');
  if(!tooltip){ tooltip = document.createElement('div'); tooltip.id='cabTooltip'; tooltip.style.position='absolute'; tooltip.style.zIndex=9999; tooltip.style.padding='6px 8px'; tooltip.style.background='#fff'; tooltip.style.border='1px solid rgba(13,71,161,0.12)'; tooltip.style.borderRadius='5px'; tooltip.style.boxShadow='0 8px 24px rgba(6,25,57,0.08)'; tooltip.style.display='none'; tooltip.style.fontSize='12px'; document.body.appendChild(tooltip); }
  for(let r=0;r<data.numCabH;r++){
    for(let c=0;c<data.numCabW;c++){
      const cell = document.createElement('div');
      cell.textContent = `${r+1}×${c+1}`;
      cell.addEventListener('mouseenter', e=>{ tooltip.textContent = `Cabinet: ${r+1} x ${c+1} — Pixels: ${data.cabPixW}×${data.cabPixH}`; tooltip.style.display='block'; });
      cell.addEventListener('mousemove', e=>{ tooltip.style.left = (e.pageX+10)+'px'; tooltip.style.top = (e.pageY+10)+'px'; });
      cell.addEventListener('mouseleave', ()=> tooltip.style.display='none');
      overlay.appendChild(cell);
    }
  }
  document.getElementById('visDimensions').textContent = `${(data.finalW_mm/MM_PER_METER).toFixed(2)} m × ${(data.finalH_mm/MM_PER_METER).toFixed(2)} m`;
}

function generateBOQList(data){
  const list = [];
  const isModular = data.controllerType && data.controllerType.includes('Modular');

  let ctrlKey = data.controllerName.split(' ')[0];
  if(data.controllerName.includes('VX600')) ctrlKey='VX600';
  if(PARTS_CATALOG[ctrlKey]) list.push({ item:'Controller/Processor', partcode:PARTS_CATALOG[ctrlKey].part, desc:PARTS_CATALOG[ctrlKey].desc, qty:1, unit:'PCS' });
  else list.push({ item:'Controller/Processor', partcode:'TBD', desc:data.controllerName, qty:1, unit:'PCS' });

  if(isModular){
    const outModel = data.outputCardModel || 'H_20_RJ45';
    const outPart = PARTS_CATALOG[outModel] ? PARTS_CATALOG[outModel].part : 'TBD';
    list.push({ item:'Output (Sending) Card', partcode:outPart, desc: outModel, qty:data.requiredSendCards, unit:'PCS' });
    const inModel = data.inputCardModel || 'H_1xHDMI';
    const inPart = PARTS_CATALOG[inModel] ? PARTS_CATALOG[inModel].part : 'TBD';
    list.push({ item:'Input Card(s)', partcode:inPart, desc:inModel, qty:data.inputCardQty || 2, unit:'PCS' });
    list.push({ item:'Modular Splicer Frame', partcode: PARTS_CATALOG[data.suggestedControllerObj?.name]?.part || 'TBD', desc: data.splicerSolution, qty:1, unit:'PCS' });
    list.push({ item:'Power Supply (est)', partcode:PARTS_CATALOG['H_800W_PSU']?PARTS_CATALOG['H_800W_PSU'].part:'TBD', desc:'H 800W PSU (est.)', qty: Math.max(1, Math.ceil(data.totalCabinets/10)), unit:'PCS'});
  } else {
    list.push({ item:'Output (Sending) / Integrated', partcode:PARTS_CATALOG['H_4_HDMI_Out']?PARTS_CATALOG['H_4_HDMI_Out'].part:'TBD', desc:'Integrated output or optional H_4_HDMI_Out', qty:1, unit:'PCS' });
  }

  list.push({ item:'Long Ethernet Ports (Controller→Wall)', partcode:'TBD', desc:`Long ethernet runs (min ${data.requiredPortsCeiling})`, qty:data.requiredPortsCeiling, unit:'Ports' });
  list.push({ item:'Short Ethernet (Between Cabinets)', partcode:'TBD', desc:'Inter-cabinet CAT6 runs', qty:data.requiredShortEthernet, unit:'PCS' });

  const ledKey = data.pixelPitch_mm <= 1.0 ? 'PPL-COB-09' : data.pixelPitch_mm <= 1.3 ? 'PPL-COB-125' : 'PPL-COB-156';
  const ledPart = PARTS_CATALOG[ledKey] ? PARTS_CATALOG[ledKey].part : 'TBD';
  list.push({ item:'LED Cabinets (Including Modules)', partcode:ledPart, desc:data.productName, qty:data.totalCabinets, unit:'PCS' });

  const sparePct = (data.productName.toLowerCase().includes('cob')) ? 0.05 : 0.10;
  const spareQty = Math.max(1, Math.round(data.totalModules * sparePct));
  list.push({ item:`Spare Modules (${Math.round(sparePct*100)}%)`, partcode:'TBD', desc:'Spare modules (site spares)', qty:spareQty, unit:'PCS' });

  list.push({ item:'Installation / Configuration', partcode:'ALED-INST-IN', desc:'Installation & configuration (indoor)', qty:1, unit:'LS' });
  list.push({ item:'Transportation (Indoor)', partcode:'ALED-TRS-IN-REG', desc:'Transport (indoor) per cabinet', qty:data.totalCabinets, unit:'Per Cabinet' });
  list.push({ item:'Total Power (W) - Design', partcode:'TBD', desc:`Design Power ${Math.round(data.designPowerW)} W`, qty:Math.round(data.designPowerW), unit:'W' });

  return list;
}

function renderBOQPreview(data){
  const list = generateBOQList(data);
  let html = `<div class="card"><div style="font-weight:800;color:var(--brand);margin-bottom:8px">Bill of Quantities (Compact)</div>`;
  html += `<table id="boq"><thead><tr><th style="width:6%">S.No</th><th style="width:24%">Item</th><th style="width:18%">Partcode</th><th style="width:32%">Description</th><th style="width:8%" class="right">Qty</th><th style="width:8%">Unit</th></tr></thead><tbody>`;
  list.forEach((r,i)=>{ html += `<tr><td>${i+1}</td><td>${escapeHtml(r.item)}</td><td>${escapeHtml(r.partcode)}</td><td>${escapeHtml(r.desc)}</td><td class="right">${r.qty}</td><td>${r.unit}</td></tr>`; });
  html += `</tbody></table></div>`;
  document.getElementById('boqPreviewContainer').innerHTML = html;
}
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"'`=\/]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[ch]));}

/* controller modal functions */
function openControllerModal(){
  if(!finalCalculationData || !finalCalculationData.totalPixels){ alert('Calculate first'); return; }
  populateModal();
  const sel = document.getElementById('modalControllerModel'); sel.value = finalCalculationData.controllerOverrideName || finalCalculationData.controllerName || CONTROLLER_MODELS[0].name;
  const out = document.getElementById('modalOutputCardModel'); out.value = `${finalCalculationData.outputCardModel||'H_20_RJ45'}|20`;
  updatePortsFromOutputCard();
  document.getElementById('modalInputCardModel').value = finalCalculationData.inputCardModel || 'H_1xHDMI';
  document.getElementById('modalInputCardQty').value = finalCalculationData.inputCardQty || 2;
  document.getElementById('modalSplicerSolution').value = finalCalculationData.splicerSolution || '';
  document.getElementById('controllerModal').style.display='flex';
  onModalControllerChange();
}
function closeControllerModal(){ document.getElementById('controllerModal').style.display='none'; }
function onModalControllerChange(){ const sel = document.getElementById('modalControllerModel').value; const ctrl = CONTROLLER_MODELS.find(c=>c.name===sel)||{}; const isH = ctrl.type==='Modular'; document.getElementById('modalOutputCardModel').disabled = !isH; document.getElementById('modalInputCardModel').disabled = !isH; document.getElementById('modalInputCardQty').disabled = !isH; document.getElementById('modalSplicerSolution').disabled = !isH; }
function updatePortsFromOutputCard(){ const val = document.getElementById('modalOutputCardModel').value; if(!val) return; document.getElementById('modalMaxPortsPerCard').value = val.split('|')[1] || ''; }
function applyModalChanges(){ finalCalculationData.controllerOverrideName = document.getElementById('modalControllerModel').value; const out = document.getElementById('modalOutputCardModel').value.split('|')[0]; const outPorts = parseInt(document.getElementById('modalOutputCardModel').value.split('|')[1]||'20',10); finalCalculationData.outputCardModel = out; finalCalculationData.outputCardPorts = outPorts; finalCalculationData.inputCardModel = document.getElementById('modalInputCardModel').value; finalCalculationData.inputCardQty = parseInt(document.getElementById('modalInputCardQty').value||'2',10); finalCalculationData.splicerSolution = document.getElementById('modalSplicerSolution').value; closeControllerModal(); showVisualization(); }

/* reset */
function resetForm(){
  document.getElementById('productModel').value=''; document.getElementById('unit').value=''; document.getElementById('width').value=''; document.getElementById('height').value=''; document.getElementById('diagonal').value=''; document.getElementById('aspectRatio').value='';
  document.getElementById('errorMessage').style.display='none'; document.getElementById('cabinetOverlay').innerHTML=''; document.getElementById('boqPreviewContainer').innerHTML='';
  ['spec_model','spec_pitch','spec_dims','spec_res','spec_diag','spec_density','spec_area','spec_cabs','ctrl_name','ctrl_ports','ctrl_sending','ctrl_shorteth','spec_power','spec_weight'].forEach(id=>{const el=document.getElementById(id); if(el) el.textContent='--';});
  finalCalculationData = {};
}

/* Contact modal and PDF generation (fixed: html2canvas included and awaited) */
function openContactModal(){
  if(!finalCalculationData || !finalCalculationData.totalPixels){ alert('Calculate first'); return; }
  // show contact modal
  document.getElementById('downloadEmail').value = contactInfo.email || '';
  document.getElementById('downloadPhone').value = contactInfo.phone || '';
  document.getElementById('contactModal').style.display='flex';
}
function closeContactModal(){ document.getElementById('contactModal').style.display='none'; }
function handleDownloadRequest(){
  const e = document.getElementById('downloadEmail').value.trim();
  const p = document.getElementById('downloadPhone').value.trim();
  if(e && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){ document.getElementById('contactError').style.display='block'; document.getElementById('contactError').textContent='Invalid email'; return; }
  contactInfo.email = e; contactInfo.phone = p;
  closeContactModal();
  proceedToDownloadPdf();
}

/* Simple small connectivity drawing in PDF */
function drawConnectivityDiagram(doc, x, y, w){
  doc.setDrawColor(13,71,161); doc.setLineWidth(0.6);
  doc.setFontSize(8); doc.setTextColor(13,71,161);
  doc.rect(x, y, 28, 10, 'S'); doc.text('Controller', x+14, y+6, {align:'center'});
  doc.line(x+28, y+5, x+42, y+5);
  doc.rect(x+42, y-6, 34, 18, 'S'); doc.text('PoE Switch', x+59, y+4, {align:'center'});
  doc.line(x+76, y+5, x+92, y+5);
  doc.rect(x+92, y-8, 36, 22, 'S'); doc.text('LED Wall', x+110, y+4, {align:'center'});
}

/* PDF flow: capture visualization using html2canvas, embed and save */
async function proceedToDownloadPdf(){
  const d = finalCalculationData;
  if(!d || !d.totalPixels){ alert('Calculate first'); return; }
  // capture viz — if html2canvas not loaded, fallback to saving without image
  let imgData = null;
  if(window.html2canvas){
    try{
      const vis = document.getElementById('visGrid');
      const canvas = await html2canvas(vis, {scale:2, backgroundColor:null});
      imgData = canvas.toDataURL('image/png');
    }catch(err){
      console.warn('html2canvas capture failed — proceeding without viz image', err);
      imgData = null;
    }
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 12;
  let y = 10;

  doc.setFontSize(14); doc.setTextColor(13,71,161); doc.setFont(undefined,'bold');
  doc.text('PeopleLink LED Video Wall — Quotation', pageW/2, y, {align:'center'});
  y += 8;
  doc.setFontSize(9); doc.setFont(undefined,'normal'); doc.setTextColor(80,80,80);
  doc.text(`Date: ${new Date().toLocaleDateString()}  |  Model: ${d.productName}`, margin, y);
  doc.text(`Contact: ${contactInfo.email || 'N/A'} ${contactInfo.phone ? ' | ' + contactInfo.phone : ''}`, pageW - margin, y, { align:'right' });
  y += 8;

  // brief specs (compact)
  doc.setFontSize(10); doc.setTextColor(13,71,161); doc.text('1. Key Specs', margin, y); y += 6;
  doc.setFontSize(9); doc.setTextColor(40,40,40);
  const rows = [
    ['Final Dimensions:', `${(d.finalW_mm/MM_PER_METER).toFixed(2)} m x ${(d.finalH_mm/MM_PER_METER).toFixed(2)} m`],
    ['Resolution:', `${d.finalResW} × ${d.finalResH}`],
    ['Pixel Pitch:', `${d.pixelPitch_mm} mm`],
    ['Pixel Density:', `${formatLarge(d.pixelDensity)} px/m²`],
    ['Total Cabinets:', `${d.numCabW} × ${d.numCabH} (${d.totalCabinets})`],
    ['Final Area:', `${d.finalArea_m2.toFixed(2)} m²`]
  ];
  let leftX = margin, rightX = pageW/2 + 6;
  for(let i=0;i<Math.ceil(rows.length/2);i++){
    const L = rows[i]; const R = rows[i + Math.ceil(rows.length/2)];
    doc.text(L[0], leftX, y); doc.setTextColor(183,28,28); doc.text(L[1], leftX+46, y);
    if(R){ doc.setTextColor(40,40,40); doc.text(R[0], rightX, y); doc.setTextColor(183,28,28); doc.text(R[1], rightX+46, y); }
    doc.setTextColor(40,40,40); y += 6;
  }
  y += 6;

  // embed viz image if present
  if(imgData){
    const maxW = pageW - margin*2; const maxH = 60;
    doc.addImage(imgData, 'PNG', margin, y, maxW, maxH);
    y += maxH + 6;
  }

  // connectivity + control summary
  doc.setFontSize(10); doc.setTextColor(13,71,161); doc.text('2. Control & Connectivity', margin, y); y += 6;
  drawConnectivityDiagram(doc, margin+2, y, pageW - margin*2 - 4);
  y += 24;
  doc.setFontSize(9); doc.setTextColor(40,40,40);
  const ctrlRows = [
    ['Controller/Processor:', `${d.controllerName} (${d.controllerType})`],
    ['Controller Ports (post buffer):', `${d.requiredPortsCeiling}`],
    ['Long Ethernet Ports/Runs:', `${d.requiredLongEthRuns} (Controller → Wall)`],
    ['Short Ethernet Cables:', `${d.requiredShortEthernet} (Between Cabinets)`],
    ['Design Power (Est.):', `${fmt(d.designPowerW,0)} W`]
  ];
  ctrlRows.forEach(r=>{ doc.text(r[0], margin, y); doc.setTextColor(183,28,28); doc.text(r[1], pageW - margin, y, {align:'right'}); doc.setTextColor(40,40,40); y+=6; });
  y += 6;

  // BOQ table (compact) — only the BOQ (similar to preview)
  const boqList = generateBOQList(d);
  const head = [['S.No','Item','Partcode','Description','Qty','Unit','Unit Price (INR)','Total (INR)']];
  const body = boqList.map((r,i)=>[String(i+1), r.item, r.partcode, r.desc, String(r.qty), r.unit, '', '']);
  body.push(['', 'Sub Total Amount (INR)', '', '', '', '', '', '']);
  body.push(['', 'GST (18%)', '', '', '', '', '', '']);
  body.push(['', 'Grand Total (INR)', '', '', '', '', '', '']);
  doc.autoTable({
    startY: y,
    head: head,
    body: body,
    theme: 'grid',
    styles: { fontSize:8.5, cellPadding:3 },
    headStyles: { fillColor:[13,71,161], textColor:255 },
    columnStyles: {0:{cellWidth:8},1:{cellWidth:38},2:{cellWidth:26},3:{cellWidth:60},4:{cellWidth:12},5:{cellWidth:12},6:{cellWidth:24},7:{cellWidth:24}}
  });
  y = doc.lastAutoTable.finalY + 8;

  doc.setFontSize(8); doc.setTextColor(150,170,200);
  doc.text('© 2025 PeopleLink Unified Communications Pvt. Ltd.', pageW/2, doc.internal.pageSize.getHeight() - 10, { align:'center' });

  const fname = `PeopleLink_Quotation_${d.finalResW}x${d.finalResH}.pdf`;
  doc.save(fname);
}

/* CSV download: ONLY BOQ (no headers, no specs, no T&C) */
function downloadBOQCSV(){
  const d = finalCalculationData;
  if(!d || !d.totalPixels){ alert('Please calculate configuration first.'); return; }
  const list = generateBOQList(d);
  // CSV header (BOQ table only)
  let csv = 'S.No,Item,Partcode,Description,Qty,Unit,Unit Price (INR),Total Price (INR)\n';
  list.forEach((r,i)=>{
    // ensure commas escaped by quotes
    csv += `${i+1},"${r.item}","${r.partcode}","${r.desc}",${r.qty},"${r.unit}",,\n`;
  });
  // summary rows
  csv += `,,,Sub Total Amount (INR),,,,\n`;
  csv += `,,,GST (18%),,,,\n`;
  csv += `,,,Grand Total (INR),,,,\n`;

  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.href = url;
  link.download = `PeopleLink_BOQ_${d.finalResW}x${d.finalResH}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/* UI showVisualization (compact) */
function showVisualization(){
  const d = calculateLEDWall();
  if(!d) return;
  document.getElementById('spec_model').textContent = d.productName;
  document.getElementById('spec_pitch').textContent = d.pixelPitch_mm + ' mm';
  document.getElementById('spec_dims').textContent = `${(d.finalW_mm/MM_PER_METER).toFixed(2)} m x ${(d.finalH_mm/MM_PER_METER).toFixed(2)} m`;
  document.getElementById('spec_res').textContent = `${d.finalResW} × ${d.finalResH}`;
  document.getElementById('spec_diag').textContent = `${d.finalDiagonal_in.toFixed(1)} in`;
  document.getElementById('spec_density').textContent = `${formatLarge(d.pixelDensity)} px/m²`;
  document.getElementById('spec_area').textContent = `${d.finalArea_m2.toFixed(2)} m²`;
  document.getElementById('spec_cabs').textContent = `${d.numCabW} × ${d.numCabH} (${d.totalCabinets})`;

  document.getElementById('ctrl_name').textContent = `${d.controllerName} (${d.controllerType})`;
  document.getElementById('ctrl_ports').textContent = d.requiredPortsCeiling;
  document.getElementById('ctrl_shorteth').textContent = `${d.requiredShortEthernet} (Between Cabinets)`;
  document.getElementById('spec_power').textContent = `${fmt(d.designPowerW,0)} W`;
  document.getElementById('spec_weight').textContent = `${fmt(d.designWeight,1)} kg`;

  if(d.controllerType && d.controllerType.includes('Modular')){
    document.getElementById('sendingRow').style.display='flex';
    document.getElementById('ctrl_sending').textContent = `${d.requiredSendCards} x ${d.outputCardModel}`;
  } else {
    document.getElementById('sendingRow').style.display='none';
  }

  renderCabinetOverlay(d);
  renderBOQPreview(d);
}

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  populateModal(); toggleMeasurementFields();
  window.addEventListener('click', (e)=>{ if(e.target.id === 'controllerModal') closeControllerModal(); if(e.target.id === 'contactModal') closeContactModal(); });
});
</script>
</body>
</html>
