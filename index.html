<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --brand: #0D47A1;
      --accent: #B71C1C;
      --muted: #6b7280;
    }

    /* tightened overall spacing but preserved colors/format */
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 24px; background: #eef1f8; color: #1c2738; font-size: 14px; }
    .main-wrapper { max-width: 1200px; margin: auto; }

    h2 { text-align:center; color:var(--brand); margin:0 0 20px; font-weight:700; font-size:1.6em; display:flex; align-items:center; justify-content:center; }

    .input-panel { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); transition:all .45s ease-out; }
    .input-panel.minimized { height:110px; padding:12px; background:#f7f9fc; }
    .input-panel.minimized > *:not(h2):not(#enteredValuesDisplay):not(.back-btn-placeholder) { opacity:0; max-height:0; overflow:hidden; pointer-events:none; transition:opacity .25s, max-height .25s; }

    .input-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:16px 20px; }
    label { display:block; margin-bottom:6px; font-weight:600; color:#444; font-size:0.95rem; }
    select, input[type="number"], input[type="text"] { width:100%; padding:9px 10px; font-size:14px; border:1px solid #dcdcdc; border-radius:6px; box-sizing:border-box; }
    select:focus, input:focus { border-color:var(--brand); box-shadow:0 0 0 2px rgba(13,71,161,0.12); outline:none; }

    /* smaller button but same style */
    .submit-btn { margin-top:18px; grid-column:1 / -1; background-color:var(--brand); color:#fff; padding:10px; border:none; border-radius:8px; font-size:15px; width:100%; cursor:pointer; font-weight:600; }
    .submit-btn:hover { background-color:#1565C0; transform:translateY(-1px); }
    .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:var(--brand); color:#fff; font-weight:600; }
    .btn.gray { background:#6c757d; }

    .error-message { color:var(--accent); font-weight:700; text-align:center; margin-top:12px; padding:10px; background:#ffebee; border:2px solid var(--accent); border-radius:8px; display:none; }
    .hidden { display:none !important; }
    #enteredValuesDisplay { text-align:center; font-size:0.95em; color:#444; margin-bottom:12px; display:none; }

    /* visualization tightened */
    .visualization { background:#fff; padding:18px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); opacity:0; max-height:0; overflow:hidden; transition:opacity .45s, max-height .8s; margin-top:20px; }
    .visualization.visible { opacity:1; max-height:2000px; }

    .output-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:12px; }

    .details-box { border:1px solid #e0e0e0; padding:14px; border-radius:8px; background:#f7f9fc; }
    .details-box h4 { margin:0 0 10px; color:var(--brand); font-size:1.05em; }

    /* responsive preview container (no fixed starting size) */
    .vis-area {
      position:relative;
      margin:12px auto;
      width:100%;
      max-width:800px;      /* preview bounded */
      border-radius:8px;
      overflow:hidden;
      box-sizing:border-box;
      background: linear-gradient(135deg,#e3f2fd,#bbdefb);
      border:3px solid #bbdefb;
      min-height:120px;
    }

    /* overlay grid fills container and cells auto-size */
    #cabinetOverlay {
      position:absolute; top:0; left:0; right:0; bottom:0;
      display:grid;
      z-index:5;
      padding:6px;
      gap:0;
      box-sizing:border-box;
      align-items:stretch;
      justify-items:stretch;
      grid-auto-rows:1fr; /* equal row heights */
    }
    #cabinetOverlay > div { border:1px dashed rgba(13,71,161,0.4); box-sizing:border-box; width:100%; height:100%; min-width:6px; min-height:6px; }

    .dimension-label { position:absolute; color:var(--accent); background:rgba(255,255,255,0.95); padding:4px 6px; font-size:0.9em; border-radius:4px; font-weight:700; z-index:10; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
    .dim-top { top:8px; left:50%; transform:translateX(-50%); }
    .dim-right { top:50%; right:8px; transform:translateY(-50%) rotate(90deg); transform-origin:center center; }

    .edit-btn { background:none; border:none; color:var(--brand); font-size:0.9em; cursor:pointer; text-decoration:underline; padding:0; margin-left:8px; }

    footer { text-align:center; font-size:11px; color:var(--muted); margin-top:14px; }

    /* modal */
    .modal { position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4); display:none; }
    .modal-content { background:#fff; margin:5% auto; padding:20px; border-radius:10px; width:90%; max-width:700px; box-shadow:0 5px 15px rgba(0,0,0,0.25); }
    .close-btn { color:#aaa; font-size:28px; font-weight:bold; cursor:pointer; }

    @media (max-width:900px) {
      .input-grid { grid-template-columns:1fr; }
      .output-grid { grid-template-columns:1fr; }
      .vis-area { max-width:100%; }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <div class="input-panel" id="formContainer">
      <h2>LED Video Wall Configuration Calculator</h2>

      <div id="enteredValuesDisplay" class="hidden">
        <span id="enteredSummaryText"></span><br>
        Actual Final Aspect Ratio: <strong><span id="aspectRatioValue">--</span></strong>
      </div>

      <div id="errorMessage" class="error-message" role="alert" aria-live="assertive"></div>

      <div class="input-grid">
        <div>
          <label for="productModel">LED Model / Pixel Pitch</label>
          <select id="productModel">
            <option value="">Select LED Model</option>
            <optgroup label="COB Models (16:9 Cabinet - 600x337.5mm)">
              <option value="cob_09">0.9375mm</option>
              <option value="cob_125">1.25mm</option>
              <option value="cob_15">1.5625mm</option>
            </optgroup>
            <optgroup label="SMD Indoor Models (4:3 Cabinet - 640x480mm)">
              <option value="indoor_186">1.86mm</option>
              <option value="indoor_20">2.0mm</option>
              <option value="indoor_25">2.5mm</option>
            </optgroup>
            <optgroup label="SMD Outdoor Models (1:1 Cabinet - 960x960mm)">
              <option value="outdoor_40">4.0mm</option>
              <option value="outdoor_667">6.67mm</option>
              <option value="outdoor_80">8.0mm</option>
              <option value="outdoor_100">10.0mm</option>
            </optgroup>
          </select>
        </div>

        <div>
          <label for="unit">Unit of Measurement</label>
          <select id="unit" onchange="toggleMeasurementFields()">
            <option value="">Select unit</option>
            <option value="meters">Meters (m)</option>
            <option value="feet">Feet (ft)</option>
            <option value="inches">Inches (in) - Diagonal</option>
          </select>
        </div>

        <div id="widthGroup">
          <label for="width" id="widthLabel">Desired Width (m)</label>
          <input type="number" id="width" placeholder="Enter desired width" min="0.1" step="0.01">
        </div>

        <div id="heightGroup">
          <label for="height" id="heightLabel">Desired Height (m)</label>
          <input type="number" id="height" placeholder="Enter desired height" min="0.1" step="0.01">
        </div>

        <div id="diagonalGroup" class="hidden">
          <label for="diagonal" id="diagonalLabel">Desired Diagonal (inches)</label>
          <input type="number" id="diagonal" placeholder="Enter diagonal (inches)" min="10" step="1">
        </div>

        <div id="aspectRatioGroup">
          <label for="aspectRatio">Target Aspect Ratio (Optional)</label>
          <select id="aspectRatio">
            <option value="">Select ratio (Optional)</option>
            <option value="16:9">16:9 (HD/UHD)</option>
            <option value="16:10">16:10 (WUXGA)</option>
            <option value="4:3">4:3 (Legacy)</option>
            <option value="2:1">2:1 (Cinematic)</option>
            <option value="21:9">21:9</option>
            <option value="1:1">1:1 (Square)</option>
          </select>
        </div>

        <button class="submit-btn" id="submitButton" onclick="showVisualization()" aria-controls="visualization">Calculate & Visualize System</button>
        <div class="back-btn-placeholder hidden"></div>
      </div>
    </div>

    <div class="visualization" id="visualization" aria-hidden="true">
      <div class="output-grid" aria-live="polite">
        <div class="details-box">
          <h4>LED Wall Specifications</h4>
          <div class="vis-details" id="wallSpecs">
            <span id="pixelPitchDisplay"><strong>--</strong><small>--</small></span>
            <span id="finalDimensions"><strong>--</strong><small>--</small></span>
            <span id="resolution"><strong>--</strong><small>--</small></span>
            <span id="numCabinets"><strong>--</strong><small>--</small></span>
            <span id="totalModules"><strong>--</strong><small>--</small></span>
            <span id="finalDiagonal"><strong>--</strong><small>--</small></span>
            <span id="finalArea"><strong>--</strong><small>--</small></span>
            <span id="totalPixels"><strong>--</strong><small>--</small></span>
            <span id="cabinetSize"><strong>--</strong><small>--</small></span>
            <span id="cabinetPixels"><strong>--</strong><small>--</small></span>
          </div>
        </div>

        <div class="details-box">
          <h4>Control System Requirements <button class="edit-btn" onclick="openControllerModal()" aria-haspopup="dialog">Edit/View Components ‚öôÔ∏è</button></h4>
          <div class="vis-details" id="controlSystemDetails"></div>
        </div>
      </div>

      <h3 style="margin:0 0 8px;color:var(--brand)">Physical Wall Visualization</h3>
      <div class="vis-area" id="visArea" role="img" aria-label="LED wall preview"></div>
      <div class="dimension-label dim-top" id="dimTop">-- W --</div>
      <div class="dimension-label dim-right" id="dimRight">-- H --</div>

      <div style="display:flex;gap:12px;margin-top:12px;justify-content:center;">
        <button class="btn" id="downloadPdf" onclick="proceedToDownloadPdf()" aria-label="Download PDF Technical Summary">Download PDF Technical Summary üìÑ</button>
        <button class="btn gray" onclick="hideVisualization()" aria-label="Modify Configuration">Modify Configuration</button>
      </div>
    </div>

    <footer>¬© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala</footer>
  </div>

  <!-- Controller Modal -->
  <div id="controllerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="controllerModalTitle">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding-bottom:8px;margin-bottom:12px;">
        <h3 id="controllerModalTitle" style="margin:0;color:var(--brand)">Edit Control System Components</h3>
        <span class="close-btn" onclick="closeControllerModal()" role="button" aria-label="Close modal">&times;</span>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="grid-column:1 / -1;">
          <label for="modalControllerModel">Suggested Controller/Processor Model (Select):</label>
          <select id="modalControllerModel"></select>
        </div>

        <div>
          <label for="modalSplicerSolution">Splicer Frame/Solution (Optional):</label>
          <input type="text" id="modalSplicerSolution" placeholder="e.g., H5 Modular Splicer (5U)">
        </div>

        <div>
          <label for="modalMaxPortsPerCard">Max Ports per Output Card (Read Only):</label>
          <input type="number" id="modalMaxPortsPerCard" readonly placeholder="e.g., 20">
        </div>

        <div>
          <label for="modalOutputCardModel">Output Card Model (Select):</label>
          <select id="modalOutputCardModel" onchange="updatePortsFromOutputCard()"></select>
        </div>

        <div>
          <label for="modalInputCardModel">Input Card Model (Select):</label>
          <select id="modalInputCardModel"></select>
        </div>

        <div>
          <label for="modalInputCardQty">Input Card Quantity:</label>
          <input type="number" id="modalInputCardQty" min="1" step="1" placeholder="e.g., 2">
        </div>
      </div>

      <div style="margin-top:12px;padding:10px;background:#fffde7;border:1px solid #ffeb3b;border-radius:6px;font-size:0.9em;color:#616161;">
        <strong>Crucial Disclaimer:</strong> Edit input/sending cards as required. System regenerates solution based on pixel count and selected max ports per output card. Default input card qty: 2.
      </div>

      <button class="submit-btn" style="margin-top:12px;" onclick="applyModalChanges()">Apply Changes & Recalculate</button>
    </div>
  </div>

  <script>
    // --- Constants & Models ---
    const MM_PER_METER = 1000;
    const MM_PER_INCH = 25.4;
    const MM_PER_FOOT = MM_PER_INCH * 12;
    const METER_TO_FEET = 3.28084;
    const PIXELS_PER_PORT_DEFAULT = 650000; // fallback / bandwidth estimate

    const POWER_BUFFER = 1.15;
    const WEIGHT_BUFFER = 1.15;
    const CONTROLLER_PORT_BUFFER = 1.20; // 20% buffer on controller ports

    const LED_PRODUCTS = {
      'cob_09': { name: "PeopleLink COB (0.9375mm)", pitch_mm: 0.9375, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 640, cabPixH: 360, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-1000", maxPower_W_m2: 300 },
      'cob_125': { name: "PeopleLink COB (1.25mm)", pitch_mm: 1.25, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 480, cabPixH: 270, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-800", maxPower_W_m2: 300 },
      'cob_15': { name: "PeopleLink COB (1.5625mm)", pitch_mm: 1.5625, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 384, cabPixH: 216, modulesPerCab: 8, weight_kg: 4.6, nits_range: "600-800", maxPower_W_m2: 300 },
      'indoor_186': { name: "PeopleLink SMD Indoor (1.86mm)", pitch_mm: 1.86, cabW_mm: 640, cabH_mm: 480, cabPixW: 344, cabPixH: 258, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 },
      'indoor_20': { name: "PeopleLink SMD Indoor (2.0mm)", pitch_mm: 2.0, cabW_mm: 640, cabH_mm: 480, cabPixW: 320, cabPixH: 240, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 },
      'indoor_25': { name: "PeopleLink SMD Indoor (2.5mm)", pitch_mm: 2.5, cabW_mm: 640, cabH_mm: 480, cabPixW: 256, cabPixH: 192, modulesPerCab: 6, weight_kg: 6.24, nits_range: "450-600", maxPower_W_m2: 560 },
      'outdoor_40': { name: "PeopleLink SMD Outdoor (4.0mm)", pitch_mm: 4.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 240, cabPixH: 240, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 },
      'outdoor_667': { name: "PeopleLink SMD Outdoor (6.67mm)", pitch_mm: 6.67, cabW_mm: 960, cabH_mm: 960, cabPixW: 144, cabPixH: 144, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 },
      'outdoor_80': { name: "PeopleLink SMD Outdoor (8.0mm)", pitch_mm: 8.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 120, cabPixH: 120, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 },
      'outdoor_100': { name: "PeopleLink SMD Outdoor (10.0mm)", pitch_mm: 10.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 96, cabPixH: 96, modulesPerCab: 18, weight_kg: 8.28, nits_range: "4500-5000", maxPower_W_m2: 937.5 }
    };

    const CONTROLLER_MODELS = [
      { name: "TB40", type: "Multimedia Player", ports: 2, maxPixels: 1300000, maxW: 10240, maxH: 8192, priority:1 },
      { name: "TB60", type: "Multimedia Player", ports: 4, maxPixels: 2300000, maxW: 4096, maxH: 4096, priority:2 },
      { name: "VX400 Pro / DSP400 Pro", type: "All-in-One Processor", ports:4, maxPixels:2600000, maxW:10240, maxH:8192, priority:3 },
      { name: "VX600 Pro / DSP600 Pro", type:"All-in-One Processor", ports:6, maxPixels:3900000, maxW:10240, maxH:8192, priority:4 },
      { name: "VX1000 Pro / DSP1000 Pro", type:"All-in-One Processor", ports:10, maxPixels:6500000, maxW:10240, maxH:8192, priority:5 },
      { name: "4K Prime", type:"All-in-One Processor", ports:16, maxPixels:10400000, maxW:16384, maxH:8192, priority:6 },
      { name: "4K Prime Pro", type:"All-in-One Processor", ports:20, maxPixels:13000000, maxW:16384, maxH:8192, priority:7 },
      { name: "H2 (2U)", type:"Modular Splicer", ports:20, maxPixels:26000000, maxW:16384, maxH:8192, priority:8 },
      { name: "H5 (5U)", type:"Modular Splicer", ports:20, maxPixels:39000000, maxW:16384, maxH:8192, priority:9 },
      { name: "H9 (9U)", type:"Modular Splicer", ports:20, maxPixels:65000000, maxW:16384, maxH:8192, priority:10 }
    ].sort((a,b)=>a.priority-b.priority);

    const H_SERIES_DEFAULTS = {
      SPLICER_NAME: "H-Series Modular Splicer Frame",
      INPUT_CARD_OPTIONS: [
        { model: "H_1xHDMI2.0 input card (4K)", display:"1x 4K HDMI (Single Input)", qty:1 },
        { model: "H_2xHDMI2.0 input card (4K)", display:"2x 4K HDMI (Dual Input)", qty:1 },
        { model: "H_4xHDMI input card (1080P)", display:"4x FHD HDMI (Quad Input)", qty:1 }
      ],
      DEFAULT_INPUT_CARD_MODEL: "H_1xHDMI2.0 input card (4K)",
      DEFAULT_INPUT_CARD_QTY: 2,
      OUTPUT_CARD_20_PORTS: 20,
      OUTPUT_CARD_20_MODEL: "H_20xRJ45 Sending Card"
    };

    // --- Globals ---
    let finalCalculationData = {};
    let contactInfo = { email:'', phone:'' };

    function gcd(a,b){ return b===0? a : gcd(b, a%b); }
    function formatNumber(n,d=1){ return n.toLocaleString(undefined,{minimumFractionDigits:d, maximumFractionDigits:d}); }
    function formatLargeNumber(n){ if(n>=1e6) return (n/1e6).toFixed(2)+"M"; if(n>=1e3) return (n/1e3).toFixed(1)+"K"; return n.toLocaleString(); }

    // --- Modal population helpers (unchanged) ---
    function populateModalControllers(){
      const sel = document.getElementById('modalControllerModel'); sel.innerHTML='';
      CONTROLLER_MODELS.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; o.textContent=`${c.name} (${c.type}, ${formatLargeNumber(c.maxPixels)} max px)`; sel.appendChild(o); });
    }
    function populateModalOutputCards(){
      const sel=document.getElementById('modalOutputCardModel'); sel.innerHTML='';
      const cards=[ { model: H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL, ports:H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS } ];
      cards.forEach(card=>{ const o=document.createElement('option'); o.value=`${card.model}|${card.ports}`; o.textContent=`${card.model} (${card.ports} ports)`; sel.appendChild(o); });
    }
    function populateModalInputCards(){
      const sel=document.getElementById('modalInputCardModel'); sel.innerHTML='';
      H_SERIES_DEFAULTS.INPUT_CARD_OPTIONS.forEach(opt=>{ const o=document.createElement('option'); o.value=`${opt.model}|${opt.qty}`; o.textContent=opt.display; sel.appendChild(o); });
    }
    function updatePortsFromOutputCard(){ const [m,p]=document.getElementById('modalOutputCardModel').value.split('|'); document.getElementById('modalMaxPortsPerCard').value=p; }
    function openControllerModal(){
      populateModalControllers(); populateModalOutputCards(); populateModalInputCards();
      const suggested = finalCalculationData.controllerOverrideName || (finalCalculationData.controllerName || '');
      const sel=document.getElementById('modalControllerModel');
      if(sel.querySelector(`option[value="${suggested}"]`)) sel.value=suggested;
      document.getElementById('modalSplicerSolution').value = finalCalculationData.splicerSolution || H_SERIES_DEFAULTS.SPLICER_NAME;
      const currentOutputVal = `${finalCalculationData.outputCardModel||H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL}|${finalCalculationData.outputCardPorts||H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS}`;
      const outSel=document.getElementById('modalOutputCardModel'); outSel.value = Array.from(outSel.options).find(o=>o.value===currentOutputVal)?.value || outSel.value;
      document.getElementById('modalMaxPortsPerCard').value = finalCalculationData.outputCardPorts || H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS;
      const inSel=document.getElementById('modalInputCardModel'); const desired = finalCalculationData.inputCardModel || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL;
      const match = Array.from(inSel.options).find(o=>o.value.startsWith(desired));
      if(match) inSel.value = match.value; document.getElementById('modalInputCardQty').value = finalCalculationData.inputCardQty || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;
      document.getElementById('controllerModal').style.display='block';
    }
    function closeControllerModal(){ document.getElementById('controllerModal').style.display='none'; }
    function applyModalChanges(){
      finalCalculationData.controllerOverrideName = document.getElementById('modalControllerModel').value;
      finalCalculationData.splicerSolution = document.getElementById('modalSplicerSolution').value;
      const [model,ports] = document.getElementById('modalOutputCardModel').value.split('|');
      finalCalculationData.outputCardModel = model; finalCalculationData.outputCardPorts = parseFloat(ports);
      const inputSel = document.getElementById('modalInputCardModel');
      finalCalculationData.inputCardModel = inputSel.value.split('|')[0];
      finalCalculationData.inputCardQty = parseFloat(document.getElementById('modalInputCardQty').value) || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;
      closeControllerModal(); showVisualization();
    }

    function toggleMeasurementFields(){
      const unit=document.getElementById('unit').value;
      const isDiagonal = unit==='inches'; const isFeet = unit==='feet';
      let unitText=' (m)'; if(isFeet) unitText=' (ft)'; if(isDiagonal) unitText=' (in)';
      document.getElementById('widthLabel').textContent=`Desired Width${unitText}`;
      document.getElementById('heightLabel').textContent=`Desired Height${unitText}`;
      document.getElementById('widthGroup').classList.toggle('hidden', isDiagonal);
      document.getElementById('heightGroup').classList.toggle('hidden', isDiagonal);
      document.getElementById('diagonalGroup').classList.toggle('hidden', !isDiagonal);
      if(isDiagonal){ document.getElementById('width').value=''; document.getElementById('height').value=''; } else { document.getElementById('diagonal').value=''; }
      document.getElementById('errorMessage').style.display='none';
    }

    // --- New: Cabinets-per-long-cable map for COB models ---
    const CABINETS_PER_LONG_CABLE = {
      'cob_09': 2,     // 0.9375mm => 2 cabinets per long cable
      'cob_125': 5,    // 1.25mm => 5 cabinets per long cable
      'cob_15': 7      // 1.5625mm => 7 cabinets per long cable
    };

    function getSuggestedControllerModel(totalPixels, finalResW, finalResH, productKey){
      let suggested = null;
      // prefer multimedia for small/outdoor
      const details = LED_PRODUCTS[productKey];
      const isOutdoor = productKey.startsWith('outdoor');
      const isSmall = totalPixels < 1500000;
      if(isOutdoor || isSmall){
        suggested = CONTROLLER_MODELS.find(c => c.type==="Multimedia Player" && c.maxPixels>=totalPixels && c.maxW>=finalResW && c.maxH>=finalResH);
      }
      if(!suggested){
        suggested = CONTROLLER_MODELS.find(c => c.type==="All-in-One Processor" && c.maxPixels>=totalPixels && c.maxW>=finalResW && c.maxH>=finalResH);
      }
      if(!suggested){
        suggested = CONTROLLER_MODELS.find(c => c.name.includes('4K Prime') && c.maxPixels>=totalPixels);
      }
      if(!suggested){
        const h = CONTROLLER_MODELS.filter(c=>c.type.includes('Modular') && c.maxPixels>=totalPixels).sort((a,b)=>a.maxPixels-b.maxPixels);
        if(h.length) suggested = h[0]; else suggested = CONTROLLER_MODELS[CONTROLLER_MODELS.length-1];
      }
      return suggested;
    }

    function calculateLEDWall(){
      const productKey = document.getElementById('productModel').value;
      const unit = document.getElementById('unit').value;
      const widthInput = parseFloat(document.getElementById('width').value);
      const heightInput = parseFloat(document.getElementById('height').value);
      const diagonalInput = parseFloat(document.getElementById('diagonal').value);
      const aspectRatioKey = document.getElementById('aspectRatio').value;

      const errorDiv = document.getElementById('errorMessage');
      errorDiv.style.display='none';

      if(!productKey || !unit || ((unit !== 'inches' && (isNaN(widthInput) && isNaN(heightInput))) || (unit==='inches' && isNaN(diagonalInput)))){
        errorDiv.textContent = 'ERROR: Please select a Model, Unit, and enter valid dimensions to continue.';
        errorDiv.style.display='block'; errorDiv.scrollIntoView({behavior:'smooth', block:'center'}); return null;
      }

      const details = LED_PRODUCTS[productKey];
      const cabinetW_mm = details.cabW_mm, cabinetH_mm = details.cabH_mm;

      let desiredW_mm, desiredH_mm, usedRatio='None Specified';
      if(unit === 'inches'){
        const ratioToUse = aspectRatioKey || '16:9';
        const [rw,rh] = ratioToUse.split(':').map(Number);
        const diagRatio = Math.sqrt(rw*rw + rh*rh);
        const f = diagonalInput / diagRatio;
        desiredW_mm = rw * f * MM_PER_INCH;
        desiredH_mm = rh * f * MM_PER_INCH;
        usedRatio = aspectRatioKey || '16:9 (Assumed)';
      } else {
        const unit_factor = unit === 'meters' ? MM_PER_METER : MM_PER_FOOT;
        const hasW = !isNaN(widthInput) && widthInput > 0;
        const hasH = !isNaN(heightInput) && heightInput > 0;
        if(aspectRatioKey){
          const [rw,rh] = aspectRatioKey.split(':').map(Number);
          if(hasW){ desiredW_mm = widthInput * unit_factor; desiredH_mm = (widthInput / rw) * rh * unit_factor; }
          else if(hasH){ desiredH_mm = heightInput * unit_factor; desiredW_mm = (heightInput / rh) * rw * unit_factor; }
          else { desiredW_mm = (widthInput||0) * unit_factor; desiredH_mm = (heightInput||0) * unit_factor; }
          usedRatio = aspectRatioKey;
        } else {
          const inferW = hasW ? widthInput : (heightInput * (cabinetW_mm/cabinetH_mm));
          const inferH = hasH ? heightInput : (widthInput * (cabinetH_mm/cabinetW_mm));
          desiredW_mm = inferW * unit_factor; desiredH_mm = inferH * unit_factor;
          if(hasW && !hasH) usedRatio = `Inferred from Cabinet AR (${cabinetW_mm}:${cabinetH_mm})`;
          if(hasH && !hasW) usedRatio = `Inferred from Cabinet AR (${cabinetW_mm}:${cabinetH_mm})`;
        }
      }

      // cabinets
      let numCabW = Math.max(1, Math.round(desiredW_mm / cabinetW_mm));
      let numCabH = Math.max(1, Math.round(desiredH_mm / cabinetH_mm));
      const totalCabinets = numCabW * numCabH;
      const totalModules = totalCabinets * details.modulesPerCab;

      // final dims & resolution
      const finalW_mm = numCabW * cabinetW_mm;
      const finalH_mm = numCabH * cabinetH_mm;
      const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);
      const finalResW = numCabW * details.cabPixW;
      const finalResH = numCabH * details.cabPixH;
      const totalPixels = finalResW * finalResH;
      const ratioG = gcd(finalResW, finalResH);
      const aspectRatioText = `${finalResW/ratioG}:${finalResH/ratioG}`;
      const finalDiagonal_mm = Math.sqrt(finalW_mm*finalW_mm + finalH_mm*finalH_mm);
      const finalDiagonal_in = finalDiagonal_mm / MM_PER_INCH;
      const minViewingDistance_ft = details.pitch_mm * METER_TO_FEET;

      // power & weight
      const actualPower_W_unbuffered = finalArea_m2 * details.maxPower_W_m2;
      const maxPower_W_buffered = actualPower_W_unbuffered * POWER_BUFFER;
      const actualCurrent_A = actualPower_W_unbuffered / 220;
      const maxCurrent_A_buffered = maxPower_W_buffered / 220;
      const actualCabinetWeight_unbuffered = details.weight_kg * totalCabinets;
      const totalWallWeight_buffered = actualCabinetWeight_unbuffered * WEIGHT_BUFFER;

      // suggested controller
      const suggestedController = getSuggestedControllerModel(totalPixels, finalResW, finalResH, productKey);
      const isHSeries = suggestedController.type.includes("Modular");

      // determine required long ethernet ports considering cabinets-per-cable for COB
      let ports_by_cable = 0;
      if(CABINETS_PER_LONG_CABLE[productKey]){
        const cabinetsPerCable = CABINETS_PER_LONG_CABLE[productKey];
        ports_by_cable = Math.max(1, Math.ceil(totalCabinets / cabinetsPerCable));
      } else {
        // for SMD indoor/outdoor we don't have cabinets-per-cable mapping -> rely on pixel bandwidth calc
        ports_by_cable = 0;
      }

      const ports_by_pixels = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_DEFAULT));

      // required ports = max(ports_by_cable, ports_by_pixels)
      let requiredPorts = Math.max(ports_by_cable, ports_by_pixels);

      // ALWAYS apply controller port buffer of 20% (round up)
      const requiredPortsBuffered = Math.max(1, Math.ceil(requiredPorts * CONTROLLER_PORT_BUFFER));

      // required send cards calculation (based on chosen output card ports)
      const outputCardPorts = finalCalculationData.outputCardPorts || H_SERIES_DEFAULTS.OUTPUT_CARD_20_PORTS;
      const outputCardModel = finalCalculationData.outputCardModel || H_SERIES_DEFAULTS.OUTPUT_CARD_20_MODEL;
      const requiredSendCards = Math.max(1, Math.ceil(requiredPortsBuffered / outputCardPorts));

      // short ethernet (between cabinets) estimate (keeps previous logic)
      const requiredShortEthernet = Math.max(0, totalCabinets - requiredPorts);

      // input card defaults
      const inputCardModel = finalCalculationData.inputCardModel || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_MODEL;
      const inputCardQty = finalCalculationData.inputCardQty || H_SERIES_DEFAULTS.DEFAULT_INPUT_CARD_QTY;
      const splicerSolution = finalCalculationData.splicerSolution || (isHSeries ? H_SERIES_DEFAULTS.SPLICER_NAME : 'N/A');

      const controllerName = finalCalculationData.controllerOverrideName || suggestedController.name;

      finalCalculationData = {
        ...finalCalculationData,
        productName: details.name,
        pixelPitch_mm: details.pitch_mm,
        cabinetW_mm, cabinetH_mm,
        cabPixW: details.cabPixW, cabPixH: details.cabPixH,
        finalW_mm, finalH_mm, finalArea_m2,
        finalResW, finalResH, totalPixels,
        aspectRatioText, finalDiagonal_in,
        totalCabinets, totalModules,
        totalRecCards: totalCabinets,
        numCabW, numCabH, modulesPerCab: details.modulesPerCab,
        nits_range: details.nits_range,
        minViewingDistance_ft,
        actualPower_W_unbuffered, maxPower_W: maxPower_W_buffered,
        actualCurrent_A, maxCurrent_A_buffered,
        actualWallWeight_unbuffered, totalWallWeight_buffered,
        controllerName, controllerType: suggestedController.type,
        requiredPorts: requiredPortsBuffered,       // buffered final ports
        requiredPortsRaw: requiredPorts,            // raw before buffer
        ports_by_cable, ports_by_pixels,
        requiredShortEthernet,
        outputCardPorts, outputCardModel, requiredSendCards,
        inputCardModel, inputCardQty, splicerSolution
      };

      return finalCalculationData;
    }

    function calculateDimensions(data){
      const finalW_M = data.finalW_mm / MM_PER_METER;
      const finalH_M = data.finalH_mm / MM_PER_METER;
      const finalW_FT = data.finalW_mm / MM_PER_FOOT;
      const finalH_FT = data.finalH_mm / MM_PER_FOOT;
      return { finalW_M, finalH_M, finalW_FT, finalH_FT };
    }

    // --- Responsive preview: compute height based on container width & aspect ratio ---
    function updatePreviewSize(visArea, aspectRatio){
      // visArea width is responsive (100% up to max-width)
      const computedStyle = window.getComputedStyle(visArea);
      const paddingLeft = parseFloat(computedStyle.paddingLeft||0);
      const paddingRight = parseFloat(computedStyle.paddingRight||0);
      const innerWidth = visArea.clientWidth - paddingLeft - paddingRight;
      // aspectRatio = width / height -> height = width / aspectRatio
      let areaWidth = Math.max(220, innerWidth);
      let areaHeight = Math.max(120, Math.min(900, Math.round(areaWidth / (aspectRatio || 1))));
      visArea.style.height = `${areaHeight}px`;
    }

    function showVisualization(){
      const data = calculateLEDWall();
      if(!data) return;

      const dims = calculateDimensions(data);
      document.getElementById('enteredSummaryText').textContent = `Cabinet Matrix: ${data.numCabW}x${data.numCabH} (${data.totalCabinets} Cabinets)`;
      document.getElementById('aspectRatioValue').textContent = data.aspectRatioText;

      document.getElementById('formContainer').classList.add('minimized');
      document.getElementById('submitButton').classList.add('hidden');
      document.querySelector('.back-btn-placeholder').classList.remove('hidden');
      document.getElementById('visualization').classList.add('visible');
      document.getElementById('visualization').setAttribute('aria-hidden','false');

      // Fill details
      document.getElementById('pixelPitchDisplay').innerHTML = `<strong>Pixel Pitch :</strong><small>${data.pixelPitch_mm} mm</small>`;
      document.getElementById('finalDimensions').innerHTML = `<strong>Actual Final Dimensions (WxH) :</strong><small>(${dims.finalW_FT.toFixed(2)}ft x ${dims.finalH_FT.toFixed(2)}ft) - ${dims.finalW_M.toFixed(2)}m x ${dims.finalH_M.toFixed(2)}m</small>`;
      document.getElementById('resolution').innerHTML = `<strong>Actual Final Resolution (WxH) :</strong><small>${data.finalResW} x ${data.finalResH}</small>`;
      document.getElementById('numCabinets').innerHTML = `<strong>Total Cabinets (W x H) :</strong><small>${data.totalCabinets} (${data.numCabW} x ${data.numCabH})</small>`;
      document.getElementById('totalModules').innerHTML = `<strong>Total Modules Required :</strong><small>${data.totalModules} (${data.modulesPerCab} per cabinet)</small>`;
      document.getElementById('finalDiagonal').innerHTML = `<strong>Final Diagonal Size :</strong><small>${data.finalDiagonal_in.toFixed(1)} in</small>`;
      document.getElementById('finalArea').innerHTML = `<strong>Final Area :</strong><small>${data.finalArea_m2.toFixed(2)} m¬≤</small>`;
      document.getElementById('totalPixels').innerHTML = `<strong>Total Pixels :</strong><small>${formatLargeNumber(data.totalPixels)}</small>`;
      document.getElementById('cabinetSize').innerHTML = `<strong>Cabinet Size (WxH) :</strong><small>${data.cabinetW_mm}mm x ${data.cabinetH_mm}mm</small>`;
      document.getElementById('cabinetPixels').innerHTML = `<strong>Cabinet Pixels (WxH) :</strong><small>${data.cabPixW} x ${data.cabPixH}</small>`;

      // Control summary (includes buffered ports and how they were derived)
      const controlDiv = document.getElementById('controlSystemDetails');
      let html = `<span style="grid-column:1 / -1;font-weight:700;color:var(--brand);border-bottom:1px solid var(--brand);padding-bottom:6px;margin-bottom:6px;">Control System Summary</span>`;
      html += `<span id="suggestedControllerModel"><strong>Controller/Processor Model (${data.controllerType}) :</strong><small>${data.controllerName}</small></span>`;
      html += `<span><strong>Required Controller Ports (buffered 20%) :</strong><small>${data.requiredPorts} (raw: ${data.requiredPortsRaw}, by-cable: ${data.ports_by_cable}, by-px: ${data.ports_by_pixels})</small></span>`;
      if(data.controllerType.includes('Modular')){
        html += `<div style="grid-column:1 / -1;border-top:1px solid #e0e0e0;padding-top:8px;margin-top:8px;"><span><strong>Splicer Frame/Solution :</strong><small>${data.splicerSolution || 'N/A'}</small></span><span><strong>Output Card (${data.outputCardPorts} ports):</strong><small>${data.requiredSendCards} x ${data.outputCardModel}</small></span><span><strong>Input Cards :</strong><small>${data.inputCardQty} x ${data.inputCardModel}</small></span></div>`;
      }
      html += `<span style="grid-column:1 / -1;font-weight:700;color:var(--brand);border-top:1px solid var(--brand);padding-top:6px;margin-top:8px;">Connection Summary</span>`;
      html += `<span><strong>Total Receiving Cards :</strong><small>${data.totalRecCards}</small></span>`;
      html += `<span><strong>Long Ethernet Ports/Runs :</strong><small>${data.requiredPorts} (controller to wall)</small></span>`;
      html += `<span><strong>Short Ethernet Cables :</strong><small>${data.requiredShortEthernet} (between cabinets)</small></span>`;
      html += `<span style="grid-column:1 / -1;font-weight:700;color:var(--brand);border-top:1px solid var(--brand);padding-top:6px;margin-top:8px;">Power & Weight</span>`;
      html += `<span><strong>Design Max Power (with ${Math.round((POWER_BUFFER-1)*100)}% buffer):</strong><small>${formatNumber(data.maxPower_W,0)} W</small></span>`;
      html += `<span><strong>Total Wall Weight (design):</strong><small>${formatNumber(data.totalWallWeight_buffered,1)} kg</small></span>`;
      controlDiv.innerHTML = html;

      // Visualization: create cabinet overlay inside vis-area
      const visArea = document.getElementById('visArea');
      const aspectRatio = data.finalW_mm / data.finalH_mm;
      // clear / ensure dimension labels inside container
      document.getElementById('dimTop').textContent = `${(data.finalW_mm/1000).toFixed(2)} m (W)`;
      document.getElementById('dimRight').textContent = `${(data.finalH_mm/1000).toFixed(2)} m (H)`;

      // render grid inside visArea
      const cabinetOverlay = document.getElementById('cabinetOverlay');
      // Move the dim labels inside visArea (to ensure they overlay correctly)
      if(!visArea.contains(document.getElementById('dimTop'))) visArea.appendChild(document.getElementById('dimTop'));
      if(!visArea.contains(document.getElementById('dimRight'))) visArea.appendChild(document.getElementById('dimRight'));
      // append cabinetOverlay into visArea
      if(!visArea.contains(cabinetOverlay)) visArea.appendChild(cabinetOverlay);

      cabinetOverlay.innerHTML = '';
      // set grid template
      cabinetOverlay.style.gridTemplateColumns = `repeat(${data.numCabW}, 1fr)`;
      cabinetOverlay.style.gridTemplateRows = `repeat(${data.numCabH}, 1fr)`;

      const totalCells = data.numCabW * data.numCabH;
      const maxCells = 300;
      if(totalCells > maxCells){
        const hint = document.createElement('div');
        hint.style.display='flex'; hint.style.alignItems='center'; hint.style.justifyContent='center';
        hint.style.fontSize='0.95rem'; hint.style.color='#1c2738'; hint.style.padding='8px';
        hint.textContent = `${data.numCabW} x ${data.numCabH} cabinets (${data.totalCabinets} total) ‚Äî preview simplified`;
        cabinetOverlay.appendChild(hint);
      } else {
        for(let r=0;r<data.numCabH;r++){
          for(let c=0;c<data.numCabW;c++){
            const d=document.createElement('div');
            d.setAttribute('aria-hidden','true');
            cabinetOverlay.appendChild(d);
          }
        }
      }

      // Make preview responsive: compute height based on container width & aspect ratio
      // Allow the browser to set visArea width (100% up to max-width). Then compute height using aspect ratio.
      // Use requestAnimationFrame to ensure layout has settled.
      requestAnimationFrame(()=>{ updatePreviewSize(visArea, aspectRatio); });

      // unhide download button
      const dlBtn = document.getElementById('downloadPdf'); if(dlBtn) dlBtn.classList.remove('hidden');
    }

    function hideVisualization(){
      document.getElementById('formContainer').classList.remove('minimized');
      document.getElementById('visualization').classList.remove('visible');
      document.getElementById('visualization').setAttribute('aria-hidden','true');
      document.getElementById('submitButton').classList.remove('hidden');
      document.querySelector('.back-btn-placeholder').classList.add('hidden');
      const dlBtn=document.getElementById('downloadPdf'); if(dlBtn) dlBtn.classList.add('hidden');
    }

    // --- PDF generation (watermark logic removed entirely) ---
    function proceedToDownloadPdf(){
      const data = finalCalculationData;
      if(!data || !data.finalResW){
        document.getElementById('errorMessage').textContent='ERROR: Please calculate the LED wall configuration first.';
        document.getElementById('errorMessage').style.display='block'; return;
      }
      const { finalW_M, finalH_M, finalW_FT, finalH_FT } = calculateDimensions(data);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p','mm','a4');
      const margin=15; let y=10; const lineHeight=7; const pageW = doc.internal.pageSize.getWidth();
      const primaryColor=[13,71,161]; const secondaryColor=[183,28,28];

      doc.setFontSize(18); doc.setTextColor(...primaryColor);
      doc.text('PeopleLink LED Video Wall Technical Summary', pageW/2, y, { align:'center' }); y+=lineHeight;
      doc.setFontSize(8); doc.setTextColor(100,100,100);
      doc.text(`Generated: ${new Date().toLocaleDateString()} | Model: ${data.productName}`, pageW/2, y, { align:'center' }); y+=lineHeight;
      doc.text(`Contact: ${contactInfo.email} ${contactInfo.phone}`, pageW/2, y, { align:'center' }); y+=lineHeight*1.2;

      // Wall performance table
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('1. Wall Performance & Dimensions', margin, y); y+=lineHeight;
      const performanceData=[
        ['Actual Final Dimensions (WxH) :', `(${finalW_FT.toFixed(2)}ft x ${finalH_FT.toFixed(2)}ft) - ${finalW_M.toFixed(2)}m x ${finalH_M.toFixed(2)}m`],
        ['Actual Final Resolution (WxH) :', `${data.finalResW} x ${data.finalResH}`],
        ['Aspect Ratio :', data.aspectRatioText],
        ['Final Diagonal Size :', `${data.finalDiagonal_in.toFixed(1)} in`],
        ['Total Pixels / Area :', `${formatLargeNumber(data.totalPixels)} / ${data.finalArea_m2.toFixed(2)} m¬≤`],
        ['Minimum Viewing Distance :', `${data.minViewingDistance_ft.toFixed(2)} ft`]
      ];
      doc.autoTable({ startY:y+2, body:performanceData, margin:{left:margin,right:margin,bottom:0}, theme:'striped', styles:{fontSize:8,cellPadding:1.5}, columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}}});
      y = doc.lastAutoTable.finalY + lineHeight;

      // physical specs
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('2. Physical & Cabinet Specifications', margin, y); y+=lineHeight;
      const specsData=[
        ['Pixel Pitch :', `${data.pixelPitch_mm} mm`],
        ['Cabinet Dimensions (W x H) :', `${data.cabinetW_mm}mm x ${data.cabinetH_mm}mm`],
        ['Cabinet Pixels (W x H) :', `${data.cabPixW} x ${data.cabPixH}`],
        ['Cabinet Matrix (W x H) :', `${data.numCabW} x ${data.numCabH}`],
        ['Total Cabinets Required :', `${data.totalCabinets}`],
        ['Total Modules Required :', `${data.totalModules}`],
        ['Brightness Range :', data.nits_range || 'N/A']
      ];
      doc.autoTable({ startY:y+2, body:specsData, margin:{left:margin,right:margin,bottom:0}, theme:'plain', styles:{fontSize:8,cellPadding:1.5}, columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}}});
      y = doc.lastAutoTable.finalY + lineHeight;

      // control system & connections (include buffered port numbers)
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('3. Control System & Connections', margin, y); y+=lineHeight;
      let controllerData=[
        ['Controller/Processor Model :', `${data.controllerName} (${data.controllerType})`],
        ['Total Receiving Cards :', `${data.totalRecCards}`],
        ['Long Ethernet Ports/Runs (buffered 20%) :', `${data.requiredPorts}`],
        ['Short Ethernet Cables :', `${data.requiredShortEthernet}`]
      ];
      if(data.controllerType.includes('Modular')){
        controllerData.push(['Modular Splicer Frame :', data.splicerSolution || 'Not Specified']);
        controllerData.push(['Output Card (Sending) :', `${data.requiredSendCards} x ${data.outputCardModel}`]);
        controllerData.push(['Input Card (User Config) :', `${data.inputCardModel} x ${data.inputCardQty}`]);
      }
      doc.autoTable({ startY:y+2, body:controllerData, margin:{left:margin,right:margin,bottom:0}, theme:'striped', styles:{fontSize:8,cellPadding:1.5}, columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}}});
      y = doc.lastAutoTable.finalY + lineHeight;

      // power & weight
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('4. Power and Weight', margin, y); y+=lineHeight;
      const powerWeightData=[
        ['Actual Max Power Consumption (W) :', `${formatNumber(data.actualPower_W_unbuffered,0)} W`],
        ['Design Max Power Consumption (W) :', `${formatNumber(data.maxPower_W,0)} W`],
        ['Max Current Draw (Actual @220V) :', `${data.actualCurrent_A.toFixed(2)} A`],
        ['Max Current Draw (Design @220V) :', `${data.maxCurrent_A_buffered.toFixed(2)} A`],
        ['Actual Wall Weight (kg) :', `${formatNumber(data.actualWallWeight_unbuffered,1)} kg`],
        ['Total Wall Weight (Design) :', `${formatNumber(data.totalWallWeight_buffered,1)} kg`]
      ];
      doc.autoTable({ startY:y+2, body:powerWeightData, margin:{left:margin,right:margin,bottom:0}, theme:'plain', styles:{fontSize:8,cellPadding:1.5}, columnStyles:{0:{fontStyle:'bold'},1:{halign:'right'}}});
      y = doc.lastAutoTable.finalY + lineHeight*2;

      // BOQ
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('5. Bill of Quantities (BOQ)', margin, y); y+=lineHeight;
      let boqData=[
        ['LED Cabinets', data.productName, data.totalCabinets, 'PCS'],
        ['Controller/Processor', data.controllerName, 1, 'PCS'],
        ['Receiving Cards (R-Card)', 'Embedded in Cabinet', data.totalRecCards, 'PCS'],
        ['Long Ethernet Cables', 'Controller to Wall runs (CAT6/7)', data.requiredPorts, 'PCS'],
        ['Short Ethernet Cables', 'Cabinet interconnect (CAT6/7)', data.requiredShortEthernet, 'PCS'],
        ['Installation / Configuration', 'Mounting/structure, site setup, commissioning', 1, 'LS'],
        ['Transport / Logistics', 'Shipping/freight to site', 1, 'LS']
      ];
      if(data.controllerType.includes('Modular')){
        boqData.push(['Modular Splicer Frame', data.splicerSolution || 'Not Specified', 1, 'PCS']);
        boqData.push(['Output Card (Sending)', data.outputCardModel, data.requiredSendCards, 'PCS']);
        boqData.push(['Input Card (User Config)', data.inputCardModel, data.inputCardQty, 'PCS']);
      }
      doc.autoTable({ startY:y+2, head:[['Item','Description / Model','Quantity','Unit']], body:boqData, margin:{left:margin,right:margin,bottom:0}, theme:'grid', headStyles:{fillColor:primaryColor,halign:'center'}, styles:{fontSize:8,cellPadding:1.5}, columnStyles:{0:{fontStyle:'bold'},2:{halign:'right'},3:{halign:'center'}}});
      y = doc.lastAutoTable.finalY + lineHeight*2;

      // T&C
      doc.setFontSize(12); doc.setTextColor(...secondaryColor); doc.text('6. Standard Terms & Conditions for Active LED', margin, y); y+=lineHeight;
      doc.setFontSize(8); doc.setTextColor(50,50,50);
      const terms=[
        "1. Price Validity: This quotation is valid for 30 days from the date of issue.",
        "2. Payment Terms: Standard terms are 50% advance, 40% upon delivery, and 10% upon successful commissioning, unless otherwise specified.",
        "3. Civil Work/Structure: All necessary civil works (wall reinforcement, recess creation, etc.) and primary mounting structure must be provided by the client, unless explicitly included in the BOQ.",
        "4. Power and Data: Stable power sources (UPS/Dedicated Circuit) and necessary data network drops (LAN for control) must be provided by the client near the installation area.",
        "5. Warranty: Standard warranty is 1 year on LED panels and accessories, covering manufacturing defects. Warranty does not cover misuse, power surges, or unauthorized repair.",
        "6. Site Access: Unrestricted, safe site access and use of site-provided lifting equipment (if required) must be available during installation and commissioning hours."
      ];
      terms.forEach(term=>{
        if(y > doc.internal.pageSize.getHeight() - margin - 30){ doc.addPage(); y = margin; doc.setFontSize(8); doc.setTextColor(50,50,50); }
        const split = doc.splitTextToSize(term, pageW - 2*margin);
        doc.text(split, margin, y); y += (split.length * 3.5) + 1;
      });

      // final note & footer
      y += lineHeight*0.5;
      if(y > doc.internal.pageSize.getHeight() - margin - 20){ doc.addPage(); y = margin; }
      doc.setFontSize(7); doc.setTextColor(100,100,100);
      doc.text(`Note: Design Power and Weight include a 15% safety margin for structural and electrical planning. Controller ports include a 20% buffer as requested.`, margin, y, { maxWidth: pageW - 2*margin });

      // footer
      doc.setFontSize(8); doc.setTextColor(176,196,222);
      doc.text('¬© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala', pageW/2, doc.internal.pageSize.getHeight() - 10, { align:'center' });

      doc.save(`PeopleLink_LED_Config_${data.finalResW}x${data.finalResH}_BOQ.pdf`);
    }

    document.addEventListener('DOMContentLoaded', () => {
      toggleMeasurementFields();
      populateModalControllers();
      populateModalOutputCards();
      populateModalInputCards();

      const dlBtn = document.getElementById('downloadPdf'); if(dlBtn) dlBtn.classList.add('hidden');

      window.onclick = function(event){
        const controllerModal = document.getElementById('controllerModal');
        if(event.target == controllerModal) controllerModal.style.display = "none";
      };

      // Also reflow preview on resize
      window.addEventListener('resize', ()=> {
        const data = finalCalculationData;
        if(data && data.finalResW){
          const visArea = document.getElementById('visArea');
          const aspectRatio = data.finalW_mm / data.finalH_mm;
          updatePreviewSize(visArea, aspectRatio);
        }
      });
    });
  </script>
</body>
</html>
