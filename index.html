<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PeopleLink LED Video Wall Config — Fixed</title>

  <!-- Optional: jsPDF + AutoTable for PDF export (kept external) -->
  <!-- If you don't need PDF, you can remove these lines. If these fail to load, PDF will be disabled but rest works. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js" integrity="" crossorigin="anonymous"></script>

  <style>
    :root { --brand:#0D47A1; --accent:#B71C1C; --muted:#6b7280; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;padding:28px;background:#f3f6fb;color:#1b2430}
    .container{max-width:1100px;margin:0 auto}
    h1{font-size:20px;margin:0 0 18px;color:var(--brand);text-align:center}
    .panel{background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 24px rgba(13,71,161,0.06)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    label{display:block;font-weight:600;margin-bottom:6px}
    select,input{width:100%;padding:10px;border-radius:6px;border:1px solid #d6dbe6;box-sizing:border-box;font-size:14px}
    button{cursor:pointer;border:0;border-radius:8px;padding:10px 14px;background:var(--brand);color:white;font-weight:700}
    .btn-ghost{background:#6c757d}
    .muted{color:#6c7280;font-size:13px}
    .error{background:#fff1f0;border:1px solid #f2b8b5;color:#721c24;padding:10px;border-radius:6px;margin-top:12px;display:none}
    .vis{margin-top:18px;display:none}
    .vis.visible{display:block}
    .vis-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .box{background:#fbfdff;border:1px solid #e8f0fb;padding:12px;border-radius:8px}
    .vis-area{background:linear-gradient(135deg,#eaf4ff,#dbeeff);border-radius:8px;padding:12px;display:flex;align-items:center;justify-content:center}
    #cabinetOverlay{width:100%;height:260px;display:grid;gap:3px;box-sizing:border-box;position:relative;overflow:hidden;border-radius:6px}
    #cabinetOverlay .cell{border:1px dashed rgba(13,71,161,0.35);box-sizing:border-box}
    .dim{font-weight:700;color:var(--accent);font-size:12px;margin-top:8px;text-align:center}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:12px}
    @media(max-width:800px){.grid{grid-template-columns:1fr}.vis-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>PeopleLink LED Video Wall Config — Fixed</h1>

    <div class="panel" id="formPanel" role="region" aria-labelledby="pageTitle">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div class="muted">Quick config — select LED model, unit & dimensions.</div>
        <div class="muted small" id="statusMsg" aria-live="polite"></div>
      </div>

      <div style="height:14px"></div>

      <div class="grid" role="form" aria-label="LED configuration form">
        <div>
          <label for="productModel">LED Model / Pixel Pitch</label>
          <select id="productModel" aria-label="LED model">
            <option value="">-- select model --</option>
            <optgroup label="COB (cabinet 600x337.5mm)">
              <option value="cob_09">COB 0.9375 mm</option>
              <option value="cob_125">COB 1.25 mm</option>
              <option value="cob_15">COB 1.5625 mm</option>
            </optgroup>
            <optgroup label="SMD Indoor (cabinet 640x480mm)">
              <option value="indoor_186">SMD 1.86 mm</option>
              <option value="indoor_20">SMD 2.0 mm</option>
              <option value="indoor_25">SMD 2.5 mm</option>
            </optgroup>
            <optgroup label="SMD Outdoor (cabinet 960x960mm)">
              <option value="outdoor_40">Outdoor 4.0 mm</option>
              <option value="outdoor_667">Outdoor 6.67 mm</option>
              <option value="outdoor_80">Outdoor 8.0 mm</option>
              <option value="outdoor_100">Outdoor 10.0 mm</option>
            </optgroup>
          </select>
        </div>

        <div>
          <label for="unit">Unit</label>
          <select id="unit" aria-label="Unit" onchange="toggleMeasurementFields()">
            <option value="meters">Meters (m)</option>
            <option value="feet">Feet (ft)</option>
            <option value="inches">Inches (diagonal)</option>
          </select>
        </div>

        <div id="widthGroup">
          <label for="width">Width (m)</label>
          <input id="width" type="number" step="0.01" min="0" placeholder="e.g. 3.5">
        </div>

        <div id="heightGroup">
          <label for="height">Height (m)</label>
          <input id="height" type="number" step="0.01" min="0" placeholder="e.g. 1.9">
        </div>

        <div id="diagGroup" style="display:none">
          <label for="diagonal">Diagonal (inches)</label>
          <input id="diagonal" type="number" min="1" step="0.5" placeholder="e.g. 110">
        </div>

        <div>
          <label for="aspectRatio">Aspect Ratio (optional)</label>
          <select id="aspectRatio">
            <option value="">Auto</option>
            <option value="16:9">16:9</option>
            <option value="4:3">4:3</option>
            <option value="1:1">1:1</option>
            <option value="21:9">21:9</option>
          </select>
        </div>

        <div style="display:flex;align-items:center;gap:8px;">
          <button id="calcBtn" type="button">Calculate & Visualize</button>
          <button id="resetBtn" type="button" class="btn-ghost" onclick="resetForm()">Reset</button>
        </div>
      </div>

      <div class="error" id="errorBox" role="alert" aria-live="assertive"></div>
    </div>

    <div class="vis" id="visualization" aria-live="polite">
      <div class="vis-grid">
        <div class="box" id="specBox">
          <h3 style="margin:0 0 8px;color:var(--brand)">LED Wall Specs</h3>
          <div id="specsContent" class="muted">
            <!-- populated dynamically -->
            -- no calculation yet --
          </div>
        </div>

        <div class="box" id="controlBox">
          <h3 style="margin:0 0 8px;color:var(--brand)">Control & Connections</h3>
          <div id="ctrlContent" class="muted">-- no calculation yet --</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="vis-area">
        <div id="cabinetOverlay" aria-hidden="true"></div>
      </div>

      <div class="dim" id="dimText">--</div>

      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
        <button id="downloadPdfBtn" type="button">Download PDF</button>
        <button id="backBtn" type="button" class="btn-ghost" onclick="hideVisualization()">Modify Configuration</button>
      </div>
    </div>

    <footer>© 2025 PeopleLink Unified Communications Pvt. Ltd. | Designed by Pramodh Kathala</footer>
  </div>

  <script>
  (() => {
    // Defensive, single-file script. Exposes functions on window for continued editing.
    'use strict';

    /* ---- Constants ---- */
    const MM_PER_METER = 1000;
    const MM_PER_INCH = 25.4;
    const MM_PER_FOOT = MM_PER_INCH * 12;
    const PIXELS_PER_PORT_DEFAULT = 650000;
    const CONTROLLER_PORT_BUFFER = 1.20; // +20%
    const COB_CABS_PER_CABLE = { cob_09: 2, cob_125: 5, cob_15: 7 };

    /* ---- Product data (small, sufficient for calculations) ---- */
    const LED_PRODUCTS = {
      cob_09: { name: 'COB 0.9375', pitch_mm: 0.9375, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 640, cabPixH: 360, modulesPerCab: 8, weight_kg: 4.6, maxPower_W_m2: 300 },
      cob_125: { name: 'COB 1.25', pitch_mm: 1.25, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 480, cabPixH: 270, modulesPerCab: 8, weight_kg: 4.6, maxPower_W_m2: 300 },
      cob_15: { name: 'COB 1.5625', pitch_mm: 1.5625, cabW_mm: 600, cabH_mm: 337.5, cabPixW: 384, cabPixH: 216, modulesPerCab: 8, weight_kg: 4.6, maxPower_W_m2: 300 },
      indoor_186: { name: 'SMD 1.86', pitch_mm: 1.86, cabW_mm: 640, cabH_mm: 480, cabPixW: 344, cabPixH: 258, modulesPerCab: 6, weight_kg: 6.24, maxPower_W_m2: 560 },
      indoor_20: { name: 'SMD 2.0', pitch_mm: 2.0, cabW_mm: 640, cabH_mm: 480, cabPixW: 320, cabPixH: 240, modulesPerCab: 6, weight_kg: 6.24, maxPower_W_m2: 560 },
      indoor_25: { name: 'SMD 2.5', pitch_mm: 2.5, cabW_mm: 640, cabH_mm: 480, cabPixW: 256, cabPixH: 192, modulesPerCab: 6, weight_kg: 6.24, maxPower_W_m2: 560 },
      outdoor_40: { name: 'Outdoor 4.0', pitch_mm: 4.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 240, cabPixH: 240, modulesPerCab: 18, weight_kg: 8.28, maxPower_W_m2: 937.5 },
      outdoor_667: { name: 'Outdoor 6.67', pitch_mm: 6.67, cabW_mm: 960, cabH_mm: 960, cabPixW: 144, cabPixH: 144, modulesPerCab: 18, weight_kg: 8.28, maxPower_W_m2: 937.5 },
      outdoor_80: { name: 'Outdoor 8.0', pitch_mm: 8.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 120, cabPixH: 120, modulesPerCab: 18, weight_kg: 8.28, maxPower_W_m2: 937.5 },
      outdoor_100: { name: 'Outdoor 10.0', pitch_mm: 10.0, cabW_mm: 960, cabH_mm: 960, cabPixW: 96, cabPixH: 96, modulesPerCab: 18, weight_kg: 8.28, maxPower_W_m2: 937.5 }
    };

    /* ---- Helpers ---- */
    function el(id){ return document.getElementById(id); }
    function showError(msg){
      const box = el('errorBox'); if(!box) return;
      box.style.display = 'block'; box.innerText = msg;
      console.error('User-visible error:', msg);
    }
    function clearError(){ const box = el('errorBox'); if(box){ box.style.display = 'none'; box.innerText = ''; } }
    function fmt(n){ return (typeof n === 'number') ? (Math.round(n*100)/100).toLocaleString() : String(n); }

    function gcd(a,b){ a=Math.abs(a)|0; b=Math.abs(b)|0; return b===0?a:gcd(b,a%b); }

    /* ---- Main calculation (defensive) ---- */
    function calculateLEDWall(){
      clearError();
      try {
        const productKey = (el('productModel') && el('productModel').value) || '';
        const unit = (el('unit') && el('unit').value) || 'meters';
        const aspectRatio = (el('aspectRatio') && el('aspectRatio').value) || '';

        // raw inputs
        const widthRaw = parseFloat(el('width') && el('width').value) || 0;
        const heightRaw = parseFloat(el('height') && el('height').value) || 0;
        const diagonalRaw = parseFloat(el('diagonal') && el('diagonal').value) || 0;

        if(!productKey){ showError('Select an LED model.'); return null; }
        if(!unit){ showError('Select a measurement unit.'); return null; }

        // For inches (diagonal) mode, diagonal must be provided.
        if(unit === 'inches'){
          if(!diagonalRaw || diagonalRaw <= 0){ showError('Enter valid diagonal (inches).'); return null; }
        } else {
          if((!widthRaw || widthRaw <= 0) && (!heightRaw || heightRaw <= 0)){ showError('Enter width and/or height for selected unit.'); return null; }
        }

        const product = LED_PRODUCTS[productKey];
        if(!product){ showError('Selected product not found in database.'); return null; }

        // Convert inputs to mm
        let desiredW_mm=0, desiredH_mm=0;
        if(unit === 'inches'){
          // diagonal -> compute using aspect ratio (fallback 16:9)
          const ar = aspectRatio || '16:9';
          const [arW, arH] = ar.split(':').map(Number);
          const diagPixels = Math.sqrt(arW*arW + arH*arH);
          const factor = diagonalRaw / diagPixels; // inches per ratio unit
          desiredW_mm = arW * factor * MM_PER_INCH;
          desiredH_mm = arH * factor * MM_PER_INCH;
        } else {
          const factor = (unit === 'meters') ? MM_PER_METER : MM_PER_FOOT;
          if(aspectRatio && widthRaw > 0){
            const [arW, arH] = aspectRatio.split(':').map(Number);
            desiredW_mm = widthRaw * factor;
            desiredH_mm = (widthRaw / arW) * arH * factor;
          } else if(aspectRatio && heightRaw > 0){
            const [arW, arH] = aspectRatio.split(':').map(Number);
            desiredH_mm = heightRaw * factor;
            desiredW_mm = (heightRaw / arH) * arW * factor;
          } else {
            // Use either provided width or height. If one missing, infer using cabinet aspect
            let w = widthRaw, h = heightRaw;
            if(!w && h){ w = h * (product.cabW_mm / product.cabH_mm); }
            if(!h && w){ h = w * (product.cabH_mm / product.cabW_mm); }
            desiredW_mm = (w || 0) * factor;
            desiredH_mm = (h || 0) * factor;
          }
        }

        // Ensure positive mm values
        desiredW_mm = Math.max(1, Math.round(desiredW_mm));
        desiredH_mm = Math.max(1, Math.round(desiredH_mm));

        // Compute cabinet matrix
        const numCabW = Math.max(1, Math.round(desiredW_mm / product.cabW_mm));
        const numCabH = Math.max(1, Math.round(desiredH_mm / product.cabH_mm));
        const totalCabinets = numCabW * numCabH;

        // pixels/resolution
        const finalResW = numCabW * product.cabPixW;
        const finalResH = numCabH * product.cabPixH;
        const totalPixels = finalResW * finalResH;

        // sizes
        const finalW_mm = numCabW * product.cabW_mm;
        const finalH_mm = numCabH * product.cabH_mm;
        const finalArea_m2 = (finalW_mm/1000) * (finalH_mm/1000);

        // ports: COB uses cabinets-per-long-LAN-cable rule, SMD uses pixels per port
        let requiredPortsRaw;
        if(productKey.startsWith('cob')){
          const perCable = COB_CABS_PER_CABLE[productKey] || 2;
          requiredPortsRaw = Math.max(1, Math.ceil(totalCabinets / perCable));
        } else {
          requiredPortsRaw = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_DEFAULT));
        }
        const requiredPorts = Math.max(1, Math.ceil(requiredPortsRaw * CONTROLLER_PORT_BUFFER)); // +20%

        // final object (guarantee all properties exist)
        const result = {
          productKey, productName: product.name,
          pitch_mm: product.pitch_mm,
          numCabW, numCabH, totalCabinets,
          cabinetW_mm: product.cabW_mm, cabinetH_mm: product.cabH_mm,
          finalW_mm, finalH_mm, finalArea_m2,
          finalResW, finalResH, totalPixels,
          requiredPortsRaw, requiredPorts,
          totalModules: totalCabinets * product.modulesPerCab,
          estimatedPower_W: Math.round(finalArea_m2 * product.maxPower_W_m2),
          input: { unit, widthRaw, heightRaw, diagonalRaw, aspectRatio }
        };

        return result;
      } catch (err){
        showError('Internal calculation error — see console.');
        console.error('calculateLEDWall error:', err);
        return null;
      }
    }

    /* ---- UI rendering ---- */
    function renderResult(data){
      if(!data){ return; }
      try {
        // show visualization container
        const vis = el('visualization'); if(vis) vis.classList.add('visible');

        // populate specs
        const specs = el('specsContent');
        if(specs){
          specs.innerHTML = `
            <div><strong>Model:</strong> ${data.productName}</div>
            <div><strong>Cabinet matrix:</strong> ${data.numCabW} × ${data.numCabH} = ${data.totalCabinets} cabinets</div>
            <div><strong>Final resolution:</strong> ${data.finalResW} × ${data.finalResH} (px)</div>
            <div><strong>Total pixels:</strong> ${data.totalPixels.toLocaleString()}</div>
            <div><strong>Final size:</strong> ${(data.finalW_mm/1000).toFixed(2)} m × ${(data.finalH_mm/1000).toFixed(2)} m</div>
            <div><strong>Estimated Power:</strong> ${data.estimatedPower_W} W (approx)</div>
            <div><strong>Required long Ethernet ports (after +20% buffer):</strong> ${data.requiredPorts}</div>
          `;
        }

        // populate control box
        const ctrl = el('ctrlContent');
        if(ctrl){
          ctrl.innerHTML = `
            <div><strong>Ports (raw):</strong> ${data.requiredPortsRaw}</div>
            <div><strong>Ports (with buffer):</strong> ${data.requiredPorts}</div>
            <div><strong>Modules required:</strong> ${data.totalModules}</div>
          `;
        }

        // render cabinet overlay — limit cells to avoid heavy DOM
        const overlay = el('cabinetOverlay');
        if(overlay){
          overlay.innerHTML = '';
          const MAX_CELLS = 200;
          const total = data.totalCabinets;
          if(total > MAX_CELLS){
            // show simplified text
            const notice = document.createElement('div');
            notice.style.padding = '14px';
            notice.style.textAlign = 'center';
            notice.style.color = '#0b3a66';
            notice.style.fontWeight = 700;
            notice.innerText = `${data.numCabW} × ${data.numCabH} (${total}) — preview simplified`;
            overlay.appendChild(notice);
          } else {
            // create grid template to visually show cabinets
            overlay.style.display = 'grid';
            overlay.style.gridTemplateColumns = `repeat(${data.numCabW}, 1fr)`;
            overlay.style.gridTemplateRows = `repeat(${data.numCabH}, 1fr)`;
            for(let i=0;i<total;i++){
              const d = document.createElement('div');
              d.className = 'cell';
              d.setAttribute('role','img');
              d.setAttribute('aria-label',`Cabinet ${i+1}`);
              overlay.appendChild(d);
            }
          }
        }

        // update dims text
        const dim = el('dimText');
        if(dim){
          dim.innerText = `Final (W x H): ${(data.finalW_mm/1000).toFixed(2)} m × ${(data.finalH_mm/1000).toFixed(2)} m`;
        }

        // show download button if jsPDF exists else hide
        const dl = el('downloadPdfBtn');
        if(window.jspdf && typeof window.jspdf.jsPDF === 'function'){
          dl.style.display = 'inline-block';
        } else {
          dl.style.display = 'none';
          const status = el('statusMsg');
          if(status) status.innerText = 'PDF disabled (jspdf not loaded)';
        }

      } catch (err){
        showError('Render error — see console');
        console.error('renderResult error:', err);
      }
    }

    /* ---- Event handlers ---- */
    function onCalculate(){
      clearError();
      try {
        const data = calculateLEDWall();
        if(!data){
          // calculate already shows error
          return;
        }
        renderResult(data);
      } catch(e){
        showError('Unexpected error during calculate — see console');
        console.error('onCalculate error:', e);
      }
    }

    function hideVisualization(){
      const vis = el('visualization'); if(vis) vis.classList.remove('visible');
    }

    function resetForm(){
      ['productModel','width','height','diagonal','aspectRatio'].forEach(id=>{
        const node = el(id); if(node) node.value = '';
      });
      el('unit').value = 'meters';
      toggleMeasurementFields();
      clearError();
      hideVisualization();
    }

    function toggleMeasurementFields(){
      const unit = el('unit') && el('unit').value;
      const diag = el('diagGroup');
      const w = el('widthGroup');
      const h = el('heightGroup');
      if(unit === 'inches'){
        if(diag) diag.style.display = 'block';
        if(w) w.style.display = 'none';
        if(h) h.style.display = 'none';
      } else {
        if(diag) diag.style.display = 'none';
        if(w) w.style.display = 'block';
        if(h) h.style.display = 'block';
      }
    }

    /* ---- PDF generation (optional, guarded) ---- */
    function generatePDF(){
      try {
        if(!(window.jspdf && typeof window.jspdf.jsPDF === 'function')){
          alert('PDF library not available. The calculation works — PDF export requires jsPDF (loaded via CDN).');
          return;
        }
        const data = calculateLEDWall();
        if(!data){ alert('Please calculate before downloading PDF'); return; }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p','mm','a4');
        const pageW = doc.internal.pageSize.getWidth();
        doc.setFontSize(14);
        doc.text('PeopleLink LED Video Wall — Technical Summary', pageW/2, 14, { align: 'center' });
        doc.setFontSize(10);
        let y = 24;
        const line = (l) => { doc.text(l, 15, y); y += 6; };

        line(`Model: ${data.productName}`);
        line(`Cabinet matrix: ${data.numCabW} × ${data.numCabH} = ${data.totalCabinets} pcs`);
        line(`Final resolution: ${data.finalResW} × ${data.finalResH} px`);
        line(`Total pixels: ${data.totalPixels.toLocaleString()}`);
        line(`Final size: ${(data.finalW_mm/1000).toFixed(2)} m × ${(data.finalH_mm/1000).toFixed(2)} m`);
        line(`Estimated power: ${data.estimatedPower_W} W`);
        line(`Required long Ethernet ports (after buffer): ${data.requiredPorts}`);

        doc.save(`PeopleLink_LED_Summary_${data.finalResW}x${data.finalResH}.pdf`);
      } catch (err){
        console.error('PDF error:', err);
        alert('PDF generation failed — see console.');
      }
    }

    /* ---- Attach event listeners safely ---- */
    function attach(){
      const calcBtn = el('calcBtn'); if(calcBtn) calcBtn.addEventListener('click', onCalculate);
      const backBtn = el('backBtn'); if(backBtn) backBtn.addEventListener('click', hideVisualization);
      const dlBtn = el('downloadPdfBtn'); if(dlBtn) dlBtn.addEventListener('click', generatePDF);
      const unitSel = el('unit'); if(unitSel) unitSel.addEventListener('change', toggleMeasurementFields);
    }

    /* expose for dev */
    window._calculateLEDWall = calculateLEDWall;
    window._renderResult = renderResult;
    window._generatePDF = generatePDF;
    window.toggleMeasurementFields = toggleMeasurementFields;
    window.hideVisualization = hideVisualization;
    window.resetForm = resetForm;

    // init
    attach();
    toggleMeasurementFields();

    // safety log
    console.info('LED config script initialized (defensive mode).');

  })();
  </script>
</body>
</html>
