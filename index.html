<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>PeopleLink LED Quotation — Configurator</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
  :root{--brand:#0D47A1;--accent:#B71C1C}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0; padding:24px; background:#eef6fb; color:#112;}
  .main{max-width:1180px;margin:0 auto}
  h2{color:var(--brand);margin:0 0 14px;font-weight:700}
  .panel-grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
  .card{background:#fff;padding:16px;border-radius:10px;border:1px solid rgba(13,71,161,0.06);box-shadow:0 6px 20px rgba(6,25,57,0.04)}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-weight:600;color:var(--brand);margin-bottom:6px}
  input,select{width:100%;padding:8px 10px;border-radius:6px;border:1px solid #e6eef6}
  .controls{display:flex;gap:8px;justify-content:flex-start;margin-top:12px}
  button.primary{background:var(--brand);color:#fff;border:0;padding:9px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  button.ghost{background:#f3f8ff;border:1px solid #e6eef6;color:var(--brand);padding:8px 10px;border-radius:8px;cursor:pointer}
  .specs .title, .ctrl .title{color:var(--brand);font-weight:800;margin-bottom:10px}
  .spec-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dotted rgba(0,0,0,0.06)}
  .spec-row .lbl{font-weight:700;color:var(--brand)}
  .spec-row .val{font-weight:800;color:var(--accent)}
  .vis-box{margin-top:12px;border-radius:8px;padding:10px;background:linear-gradient(180deg,#eaf4ff,#e5f2ff);border:3px solid rgba(13,71,161,0.08)}
  .vis-grid{width:100%;height:300px;position:relative;border:2px solid rgba(13,71,161,0.12);display:flex;align-items:center;justify-content:center;overflow:hidden}
  #cabinetOverlay{position:absolute;inset:6px;display:grid;gap:0;box-sizing:border-box;padding:4px}
  #cabinetOverlay > div{border:2px solid rgba(13,71,161,0.18);display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));font-weight:700;color:var(--brand);font-size:12px}
  .boq-preview{margin-top:14px}
  table#boq{width:100%;border-collapse:collapse;font-size:13px}
  table#boq th, table#boq td{border:1px solid #e6eef6;padding:8px}
  table#boq th{background:linear-gradient(90deg, rgba(13,71,161,0.06), rgba(27,94,32,0.02));color:var(--brand);font-weight:700}
  footer{margin-top:18px;color:#8fa6c8;text-align:center}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:999}
  .modal .card{width:92%;max-width:780px}
  @media(max-width:1000px){ .panel-grid{grid-template-columns:1fr} .vis-grid{height:220px} }
</style>
</head>
<body>
  <div class="main">
    <h2>PeopleLink LED — Quotation & Configurator</h2>

    <div class="panel-grid">
      <!-- main left -->
      <div class="card">
        <div style="font-weight:800;color:var(--brand);margin-bottom:8px">Configure LED Wall</div>
        <div class="form-grid">
          <div>
            <label>LED Model / Pixel Pitch</label>
            <select id="productModel">
              <option value="">Select model</option>
              <optgroup label="COB (600x337.5mm)">
                <option value="cob_09">0.9375 mm</option>
                <option value="cob_125">1.25 mm</option>
                <option value="cob_15">1.5625 mm</option>
              </optgroup>
              <optgroup label="SMD Indoor (640x480mm)">
                <option value="indoor_186">1.86 mm</option>
                <option value="indoor_20">2.0 mm</option>
                <option value="indoor_25">2.5 mm</option>
              </optgroup>
            </select>
          </div>

          <div>
            <label>Unit</label>
            <select id="unit" onchange="toggleMeasurementFields()">
              <option value="">Select</option>
              <option value="meters">Meters (m)</option>
              <option value="feet">Feet (ft)</option>
              <option value="inches">Inches (Diagonal)</option>
            </select>
          </div>

          <div id="widthGroup">
            <label id="widthLabel">Desired Width (m)</label>
            <input id="width" type="number" step="0.01" min="0.1">
          </div>

          <div id="heightGroup">
            <label id="heightLabel">Desired Height (m)</label>
            <input id="height" type="number" step="0.01" min="0.1">
          </div>

          <div id="diagonalGroup" style="display:none">
            <label id="diagonalLabel">Diagonal (in)</label>
            <input id="diagonal" type="number" step="1" min="10">
          </div>

          <div>
            <label>Aspect Ratio (optional)</label>
            <select id="aspectRatio">
              <option value="">Auto</option>
              <option value="16:9">16:9</option>
              <option value="16:10">16:10</option>
              <option value="4:3">4:3</option>
              <option value="21:9">21:9</option>
              <option value="1:1">1:1</option>
            </select>
          </div>

          <div style="display:flex;align-items:flex-end;">
            <div class="controls">
              <button class="primary" onclick="showVisualization()">Calculate & Visualize</button>
              <button class="ghost" onclick="resetForm()">Reset</button>
            </div>
          </div>
        </div>

        <div id="errorMessage" style="color:#b71c1c;margin-top:10px;display:none"></div>

        <div class="vis-box">
          <div style="font-weight:800;color:var(--brand);margin-bottom:8px">Physical Wall Visualization</div>
          <div class="vis-grid" id="visGrid">
            <div id="cabinetOverlay"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:10px">
            <div class="muted">Hover cabinet for label</div>
            <div id="visDimensions" style="font-weight:700;color:var(--brand)"></div>
          </div>
        </div>

        <div class="boq-preview" id="boqPreviewContainer"></div>
      </div>

      <!-- right sidebar -->
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="card specs">
          <div class="title">LED Wall Specifications</div>
          <div id="specRows">
            <div class="spec-row"><div class="lbl">Model:</div><div class="val" id="spec_model">--</div></div>
            <div class="spec-row"><div class="lbl">Pixel Pitch:</div><div class="val" id="spec_pitch">--</div></div>
            <div class="spec-row"><div class="lbl">Actual Final Dimensions (WxH):</div><div class="val" id="spec_dims">--</div></div>
            <div class="spec-row"><div class="lbl">Actual Final Resolution (WxH):</div><div class="val" id="spec_res">--</div></div>
            <div class="spec-row"><div class="lbl">Final Diagonal:</div><div class="val" id="spec_diag">--</div></div>
            <div class="spec-row"><div class="lbl">Pixel Density:</div><div class="val" id="spec_density">--</div></div>
            <div class="spec-row"><div class="lbl">Final Area:</div><div class="val" id="spec_area">--</div></div>
            <div class="spec-row"><div class="lbl">Total Cabinets:</div><div class="val" id="spec_cabs">--</div></div>
          </div>
        </div>

        <div class="card ctrl">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="title">Control & Connection Summary</div>
            <button class="ghost" onclick="openControllerModal()">Edit</button>
          </div>
          <div style="margin-top:10px">
            <div class="spec-row"><div class="lbl">Suggested Controller:</div><div class="val" id="ctrl_name">--</div></div>
            <div class="spec-row"><div class="lbl">Controller Ports (post buffer):</div><div class="val" id="ctrl_ports">--</div></div>
            <div class="spec-row" id="sendingRow"><div class="lbl">Sending Cards needed:</div><div class="val" id="ctrl_sending">--</div></div>
            <div class="spec-row"><div class="lbl">Inter-cabinet Short Ethernet:</div><div class="val" id="ctrl_shorteth">--</div></div>
            <div class="spec-row"><div class="lbl">Max Power (Est.):</div><div class="val" id="spec_power">--</div></div>
            <div class="spec-row"><div class="lbl">Total Weight (Est.):</div><div class="val" id="spec_weight">--</div></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="primary" onclick="openContactModal()">Download PDF</button>
            <button class="ghost" onclick="downloadXLSX()">Download Excel (XLSX)</button>
          </div>
        </div>
      </div>
    </div>

    <footer>© 2025 PeopleLink Unified Communications Pvt. Ltd.</footer>
  </div>

  <!-- controller modal -->
  <div class="modal" id="controllerModal">
    <div class="card" style="width:880px;max-width:94%">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;color:var(--brand)">Edit Control System</div>
        <div><button class="ghost" onclick="closeControllerModal()">Close</button></div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Controller/Processor Model</label>
          <select id="modalControllerModel" onchange="onModalControllerChange()"></select>
        </div>
        <div>
          <label>Splicer Frame / Solution</label>
          <input id="modalSplicerSolution" />
        </div>

        <div>
          <label>Output (Sending) Card</label>
          <select id="modalOutputCardModel" onchange="updatePortsFromOutputCard()"></select>
        </div>
        <div>
          <label>Max Ports per Output Card</label>
          <input id="modalMaxPortsPerCard" readonly />
        </div>

        <div>
          <label>Input Card Model</label>
          <select id="modalInputCardModel"></select>
        </div>
        <div>
          <label>Input Card Quantity</label>
          <input id="modalInputCardQty" type="number" min="1" value="2" />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="ghost" onclick="closeControllerModal()">Cancel</button>
        <button class="primary" onclick="applyModalChanges()">Apply</button>
      </div>
    </div>
  </div>

  <!-- contact modal -->
  <div class="modal" id="contactModal">
    <div class="card" style="max-width:560px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;color:var(--brand)">Contact (optional)</div>
        <div><button class="ghost" onclick="closeContactModal()">Close</button></div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Email</label>
          <input id="downloadEmail" type="email" />
        </div>
        <div>
          <label>Phone</label>
          <input id="downloadPhone" type="tel" />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="ghost" onclick="closeContactModal()">Cancel</button>
        <button class="primary" onclick="handleDownloadRequest()">Download PDF</button>
      </div>
      <div id="contactError" style="color:#b71c1c;margin-top:8px;display:none"></div>
    </div>
  </div>

<script>
/* ---------------------------
  Data, parts, controllers
   --------------------------- */
const MM_PER_METER = 1000, MM_PER_INCH = 25.4, MM_PER_FOOT = MM_PER_INCH*12;
const PIXELS_PER_PORT_DEFAULT = 650000;
const GLOBAL_PORT_BUFFER_PCT = 0.05, POWER_BUFFER = 1.15, WEIGHT_BUFFER = 1.15;

const LED_PRODUCTS = {
  'cob_09': { name:"PeopleLink COB (0.9375mm)", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300 },
  'cob_125': { name:"PeopleLink COB (1.25mm)", pitch_mm:1.25, cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300 },
  'cob_15': { name:"PeopleLink COB (1.5625mm)", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, maxPower_W_m2:300 },
  'indoor_186': { name:"PeopleLink SMD Indoor (1.86mm)", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560 },
  'indoor_20': { name:"PeopleLink SMD Indoor (2.0mm)", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560 },
  'indoor_25': { name:"PeopleLink SMD Indoor (2.5mm)", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, maxPower_W_m2:560 }
};

const CONTROLLER_MODELS = [
  { name:"TB40", type:"Multimedia", ports:2, maxPixels:1300000, priority:1 },
  { name:"TB60", type:"Multimedia", ports:4, maxPixels:2300000, priority:2 },
  { name:"VX400 Pro / DSP400 Pro", type:"All-in-One", ports:4, maxPixels:2600000, priority:3 },
  { name:"VX600 Pro / DSP600 Pro", type:"All-in-One", ports:6, maxPixels:3900000, priority:4 },
  { name:"VX1000 Pro / DSP1000 Pro", type:"All-in-One", ports:10, maxPixels:6500000, priority:5 },
  { name:"H2", type:"Modular", ports:20, maxPixels:26000000, maxSendCards:2, priority:6 },
  { name:"H5", type:"Modular", ports:20, maxPixels:39000000, maxSendCards:3, priority:7 },
  { name:"H9", type:"Modular", ports:20, maxPixels:65000000, maxSendCards:6, priority:8 },
  { name:"H15", type:"Modular", ports:20, maxPixels:130000000, maxSendCards:12, priority:9 }
];

const PARTS_CATALOG = {
  'TB40':{part:'TP-VWC-NS-TB40',desc:'TB40 Controller'},
  'TB60':{part:'TP-VWC-NS-TB60',desc:'TB60 Controller'},
  'VX600':{part:'TP-VWC-NS-VX600',desc:'VX600 Pro / DSP600 Pro'},
  'H2':{part:'TP-XMF-H2',desc:'H2 Modular Splicer'},
  'H5':{part:'TP-XMF-H5',desc:'H5 Modular Splicer'},
  'H9':{part:'TP-XMF-H9',desc:'H9 Modular Splicer'},
  'H_20_RJ45':{part:'TP-XOC-RJ45-20',desc:'H 20xRJ45 Sending Card'},
  'H_16_RJ45':{part:'TP-XOC-RJ45-16-OF2',desc:'H 16xRJ45 + 2fiber Sending Card'},
  'H_4_HDMI_Out':{part:'TP-XOC-HDMI4',desc:'H 4xHDMI Output Card'},
  'H_1xHDMI':{part:'TP-XIC-HDMI',desc:'H 1xHDMI Input Card'},
  'H_2xHDMI':{part:'TP-XIC-HDMI2',desc:'H 2xHDMI Input Card'},
  'H_800W_PSU':{part:'TP-XPS-H800W',desc:'H 800W Power Supply'},
  'PPL-COB-125':{part:'PPL-COB-MDL-CU-12',desc:'PeopleLink COB 1.25 Cabinet (incl modules)'},
  'PPL-COB-156':{part:'PPL-COB-MDL-CU-12',desc:'PeopleLink COB 1.56 Cabinet (incl modules)'}
};

const CABINETS_PER_LONG_LAN = { 'cob_09':2, 'cob_125':5, 'cob_15':7 };

/* globals */
let finalCalculationData = {};
let contactInfo = { email:'', phone:'' };

/* utilities */
function gcd(a,b){ return b===0 ? a : gcd(b, a%b); }
function fmt(n,d=0){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}); }
function formatLarge(n){ if(n>=1e6) return (n/1e6).toFixed(2)+"M"; if(n>=1e3) return (n/1e3).toFixed(1)+"K"; return n; }

/* populate modal selects */
function populateModal(){
  const csel = document.getElementById('modalControllerModel');
  csel.innerHTML='';
  CONTROLLER_MODELS.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; o.textContent=`${c.name} (${c.type})`; csel.appendChild(o); });

  const out = document.getElementById('modalOutputCardModel');
  out.innerHTML='';
  [['H_20_RJ45',20],['H_16_RJ45',16],['H_4_HDMI_Out',4]].forEach(it=>{
    const o=document.createElement('option'); o.value=`${it[0]}|${it[1]}`; o.textContent=`${it[0]} (${it[1]} ports)`; out.appendChild(o);
  });

  const inSel = document.getElementById('modalInputCardModel');
  inSel.innerHTML='';
  ['H_1xHDMI','H_2xHDMI'].forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent = PARTS_CATALOG[m]?PARTS_CATALOG[m].desc:m; inSel.appendChild(o);});
}

/* measurement toggle */
function toggleMeasurementFields(){
  const u = document.getElementById('unit').value;
  const diag = u === 'inches';
  document.getElementById('widthGroup').style.display = diag ? 'none' : 'block';
  document.getElementById('heightGroup').style.display = diag ? 'none' : 'block';
  document.getElementById('diagonalGroup').style.display = diag ? 'block' : 'none';
  document.getElementById('widthLabel').textContent = `Desired Width ${u==='feet'?'(ft)':u==='inches'?'(in)':'(m)'}`;
  document.getElementById('heightLabel').textContent = `Desired Height ${u==='feet'?'(ft)':u==='inches'?'(in)':'(m)'}`;
}

/* calculation */
function calculateLEDWall(){
  const productKey = document.getElementById('productModel').value;
  const unit = document.getElementById('unit').value;
  const widthInput = parseFloat(document.getElementById('width').value || 0);
  const heightInput = parseFloat(document.getElementById('height').value || 0);
  const diagonalInput = parseFloat(document.getElementById('diagonal').value || 0);
  const aspectRatioKey = document.getElementById('aspectRatio').value;

  const err = document.getElementById('errorMessage'); err.style.display='none';
  if(!productKey || !unit || ((unit!=='inches' && !widthInput && !heightInput) || (unit==='inches' && !diagonalInput))){
    err.textContent='ERROR: Please select model, unit, and enter dimensions.'; err.style.display='block'; return null;
  }

  const details = LED_PRODUCTS[productKey];
  let desiredW_mm=0, desiredH_mm=0;

  if(unit==='inches'){
    const ratio = aspectRatioKey||'16:9'; const [rw,rh]=ratio.split(':').map(Number);
    const diagRatio = Math.sqrt(rw*rw+rh*rh); const factor = diagonalInput/diagRatio;
    desiredW_mm = rw*factor*MM_PER_INCH; desiredH_mm = rh*factor*MM_PER_INCH;
  } else {
    const uf = unit==='meters' ? MM_PER_METER : MM_PER_FOOT;
    if(aspectRatioKey){
      const [rw,rh]=aspectRatioKey.split(':').map(Number);
      if(widthInput){ desiredW_mm = widthInput*uf; desiredH_mm = (widthInput/rw)*rh*uf; }
      else { desiredH_mm = heightInput*uf; desiredW_mm = (heightInput/rh)*rw*uf; }
    } else {
      desiredW_mm = (widthInput|| (heightInput*(details.cabW_mm/details.cabH_mm))) * uf;
      desiredH_mm = (heightInput|| (widthInput*(details.cabH_mm/details.cabW_mm))) * uf;
    }
  }

  const numCabW = Math.max(1, Math.round(desiredW_mm / details.cabW_mm));
  const numCabH = Math.max(1, Math.round(desiredH_mm / details.cabH_mm));
  const totalCabinets = numCabW * numCabH;
  const totalModules = totalCabinets * details.modulesPerCab;
  const finalW_mm = numCabW * details.cabW_mm;
  const finalH_mm = numCabH * details.cabH_mm;
  const finalArea_m2 = (finalW_mm/MM_PER_METER)*(finalH_mm/MM_PER_METER);
  const finalResW = numCabW * details.cabPixW;
  const finalResH = numCabH * details.cabPixH;
  const totalPixels = finalResW * finalResH;
  const ratioG = gcd(finalResW, finalResH);
  const aspectRatioText = `${finalResW/ratioG}:${finalResH/ratioG}`;
  const finalDiagonal_in = Math.sqrt(finalW_mm*finalW_mm + finalH_mm*finalH_mm)/MM_PER_INCH;
  const pixelDensity = Math.round(totalPixels / finalArea_m2);

  const actualPowerW = finalArea_m2 * details.maxPower_W_m2;
  const designPowerW = actualPowerW * POWER_BUFFER;
  const actualWeight = details.weight_kg * totalCabinets;
  const designWeight = actualWeight * WEIGHT_BUFFER;

  const ports_by_pixels = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_DEFAULT));
  const cabinetsRule = CABINETS_PER_LONG_LAN[productKey];
  let requiredLongEthRuns = cabinetsRule ? Math.max(1, Math.ceil(totalCabinets / cabinetsRule)) : Math.max(1, ports_by_pixels);
  let requiredPorts = Math.max(ports_by_pixels, requiredLongEthRuns);
  const requiredPortsBuffered = Math.max(1, Math.ceil(requiredPorts * (1 + GLOBAL_PORT_BUFFER_PCT)));
  const requiredShortEthernet = Math.max(0, totalCabinets - requiredPortsBuffered);

  // choose suggested controller:
  let suggested = CONTROLLER_MODELS.find(c => {
    if(c.type === 'Modular') return c.maxPixels >= totalPixels;
    return c.maxPixels >= totalPixels && c.ports >= Math.ceil(requiredPortsBuffered*0.9);
  }) || CONTROLLER_MODELS[CONTROLLER_MODELS.length-1];

  // required send cards with default 20-ports sending card
  const outputCardPorts_default = 20;
  let requiredSendCards = Math.max(1, Math.ceil(requiredPortsBuffered / outputCardPorts_default));

  // upgrade modular if necessary
  if(suggested.type==='Modular'){
    const idx = CONTROLLER_MODELS.findIndex(x=>x.name===suggested.name);
    let j = idx;
    while(j < CONTROLLER_MODELS.length && (CONTROLLER_MODELS[j].type==='Modular') && ( (CONTROLLER_MODELS[j].maxSendCards || 0) < requiredSendCards || CONTROLLER_MODELS[j].maxPixels < totalPixels)) j++;
    if(j < CONTROLLER_MODELS.length && CONTROLLER_MODELS[j].type==='Modular') suggested = CONTROLLER_MODELS[j];
  }

  finalCalculationData = {
    productKey, productName: details.name, pixelPitch_mm: details.pitch_mm,
    cabinetW_mm: details.cabW_mm, cabinetH_mm: details.cabH_mm, cabPixW: details.cabPixW, cabPixH: details.cabPixH,
    numCabW, numCabH, totalCabinets, totalModules, finalW_mm, finalH_mm, finalArea_m2, finalResW, finalResH, totalPixels,
    aspectRatioText, finalDiagonal_in, pixelDensity, actualPowerW, designPowerW, actualWeight, designWeight,
    requiredPortsBuffered, requiredShortEthernet, requiredLongEthRuns, requiredSendCards,
    controllerName: finalCalculationData.controllerOverrideName || suggested.name, controllerType: suggested.type, suggestedObj: suggested,
    outputCardPorts: outputCardPorts_default, outputCardModel: 'H_20_RJ45',
    inputCardModel: finalCalculationData.inputCardModel || 'H_1xHDMI', inputCardQty: finalCalculationData.inputCardQty || 2,
    splicerSolution: finalCalculationData.splicerSolution || (suggested.type==='Modular' ? `${suggested.name} Splicer` : 'N/A')
  };

  return finalCalculationData;
}

/* visualization render */
function renderCabinetOverlay(data){
  const overlay = document.getElementById('cabinetOverlay');
  overlay.innerHTML='';
  overlay.style.gridTemplateColumns = `repeat(${data.numCabW}, 1fr)`;
  overlay.style.gridTemplateRows = `repeat(${data.numCabH}, 1fr)`;

  let tooltip = document.getElementById('cabTooltip');
  if(!tooltip){
    tooltip = document.createElement('div'); tooltip.id='cabTooltip';
    tooltip.style.position='absolute'; tooltip.style.zIndex=9999; tooltip.style.padding='6px 8px'; tooltip.style.background='#fff'; tooltip.style.border='1px solid rgba(13,71,161,0.12)';
    tooltip.style.borderRadius='5px'; tooltip.style.boxShadow='0 8px 24px rgba(6,25,57,0.08)'; tooltip.style.display='none'; tooltip.style.fontSize='12px';
    document.body.appendChild(tooltip);
  }

  for(let r=0;r<data.numCabH;r++){
    for(let c=0;c<data.numCabW;c++){
      const cell = document.createElement('div');
      cell.textContent = `${r+1}×${c+1}`;
      cell.addEventListener('mouseenter', e=>{
        tooltip.textContent = `Cabinet ${r+1} x ${c+1} — ${data.cabPixW}×${data.cabPixH}`;
        tooltip.style.display='block';
      });
      cell.addEventListener('mousemove', e=>{ tooltip.style.left = (e.pageX+10)+'px'; tooltip.style.top=(e.pageY+10)+'px'; });
      cell.addEventListener('mouseleave', ()=> tooltip.style.display='none');
      overlay.appendChild(cell);
    }
  }
  document.getElementById('visDimensions').textContent = `${(data.finalW_mm/MM_PER_METER).toFixed(2)} m × ${(data.finalH_mm/MM_PER_METER).toFixed(2)} m`;
}

/* show visualization and update UI */
function showVisualization(){
  const data = calculateLEDWall();
  if(!data) return;
  document.getElementById('spec_model').textContent = data.productName;
  document.getElementById('spec_pitch').textContent = data.pixelPitch_mm + ' mm';
  document.getElementById('spec_dims').textContent = `${(data.finalW_mm/MM_PER_METER).toFixed(2)} m x ${(data.finalH_mm/MM_PER_METER).toFixed(2)} m`;
  document.getElementById('spec_res').textContent = `${data.finalResW} × ${data.finalResH}`;
  document.getElementById('spec_diag').textContent = `${data.finalDiagonal_in.toFixed(1)} in`;
  document.getElementById('spec_density').textContent = `${formatLarge(data.pixelDensity)} px/m²`;
  document.getElementById('spec_area').textContent = `${data.finalArea_m2.toFixed(2)} m²`;
  document.getElementById('spec_cabs').textContent = `${data.numCabW} × ${data.numCabH} (${data.totalCabinets})`;

  document.getElementById('ctrl_name').textContent = `${data.controllerName} (${data.controllerType})`;
  document.getElementById('ctrl_ports').textContent = data.requiredPortsBuffered;
  document.getElementById('ctrl_shorteth').textContent = `${data.requiredShortEthernet} (Between Cabinets)`;
  document.getElementById('spec_power').textContent = `${fmt(data.designPowerW,0)} W`;
  document.getElementById('spec_weight').textContent = `${fmt(data.designWeight,1)} kg`;

  if(data.controllerType && data.controllerType.includes('Modular')){
    document.getElementById('sendingRow').style.display='flex';
    document.getElementById('ctrl_sending').textContent = `${data.requiredSendCards} x ${data.outputCardModel}`;
  } else {
    document.getElementById('sendingRow').style.display='none';
  }

  renderCabinetOverlay(data);
  renderBOQPreview(data);
}

/* BOQ generation */
function generateBOQList(data){
  const list=[];
  // controller mapping
  let ctrlKey = data.controllerName.split(' ')[0];
  if(ctrlKey.startsWith('VX')) ctrlKey='VX600'; // best-effort mapping
  if(PARTS_CATALOG[ctrlKey]) list.push({item:'Controller/Processor', partcode:PARTS_CATALOG[ctrlKey].part, desc:PARTS_CATALOG[ctrlKey].desc, qty:1, unit:'PCS'});
  else list.push({item:'Controller/Processor', partcode:'TBD', desc:data.controllerName, qty:1, unit:'PCS'});

  if(data.controllerType.includes('Modular')){
    const outModel = data.outputCardModel || 'H_20_RJ45';
    const outPart = PARTS_CATALOG[outModel] ? PARTS_CATALOG[outModel].part : (PARTS_CATALOG['H_20_RJ45']?PARTS_CATALOG['H_20_RJ45'].part:'TBD');
    list.push({item:'Output (Sending) Card', partcode:outPart, desc:outModel, qty:data.requiredSendCards, unit:'PCS'});
    const inModel = data.inputCardModel || 'H_1xHDMI';
    const inPart = PARTS_CATALOG[inModel] ? PARTS_CATALOG[inModel].part : 'TBD';
    list.push({item:'Input Card(s)', partcode:inPart, desc:inModel, qty:data.inputCardQty||2, unit:'PCS'});
    list.push({item:'Power Supply (Est)', partcode:PARTS_CATALOG['H_800W_PSU']?PARTS_CATALOG['H_800W_PSU'].part:'TBD', desc:'H_800W PSU (est.)', qty:Math.max(1,Math.ceil(data.totalCabinets/10)), unit:'PCS'});
    list.push({item:'Modular Splicer Frame', partcode:PARTS_CATALOG[data.suggestedObj?.name]?.part || 'TBD', desc:data.splicerSolution, qty:1, unit:'PCS'});
  } else {
    list.push({item:'Output (Sending) / Integrated', partcode:PARTS_CATALOG['H_4_HDMI_Out']?PARTS_CATALOG['H_4_HDMI_Out'].part:'TBD', desc:'Integrated output or optional H_4_HDMI_Out', qty:1, unit:'PCS'});
  }

  list.push({item:'Long Ethernet Ports (Controller→Wall)', partcode:'TBD', desc:'Controller to wall long ethernet ports', qty:data.requiredPortsBuffered, unit:'PCS'});
  list.push({item:'Short Ethernet (Between Cabinets)', partcode:'TBD', desc:'Inter-cabinet CAT6 runs', qty:data.requiredShortEthernet, unit:'PCS'});

  // LED Cabinets
  const ledKey = data.pixelPitch_mm <= 1.0 ? 'PPL-COB-09' : data.pixelPitch_mm <= 1.3 ? 'PPL-COB-125' : 'PPL-COB-156';
  const ledPart = PARTS_CATALOG[ledKey] ? PARTS_CATALOG[ledKey].part : 'TBD';
  list.push({item:'LED Cabinets (Incl Modules)', partcode:ledPart, desc:data.productName, qty:data.totalCabinets, unit:'PCS'});

  const sparePct = data.productName.toLowerCase().includes('cob') ? 0.05 : 0.10;
  const spareQty = Math.max(1, Math.round(data.totalModules * sparePct));
  list.push({item:`Spare Modules (${Math.round(sparePct*100)}%)`, partcode:'TBD', desc:'Site spares', qty:spareQty, unit:'PCS' });

  list.push({item:'Installation / Configuration', partcode:'ALED-INST-IN', desc:'Installation & configuration (indoor)', qty:1, unit:'LS'});
  list.push({item:'Transportation (Indoor)', partcode:'ALED-TRS-IN-REG', desc:'Transport per cabinet (Indoor)', qty:data.totalCabinets, unit:'Per Cabinet'});

  list.push({item:'Design Power (W)', partcode:'TBD', desc:'Design power capacity (W)', qty:Math.round(data.designPowerW), unit:'W'});

  return list;
}

/* BOQ preview in UI */
function renderBOQPreview(data){
  const list = generateBOQList(data);
  let html = `<div class="card"><div style="font-weight:800;color:var(--brand);margin-bottom:8px">Bill of Quantities (Preview)</div>`;
  html += `<table id="boq"><thead><tr><th style="width:6%">S.No</th><th style="width:18%">Item</th><th style="width:14%">Partcode</th><th style="width:32%">Description</th><th style="width:8%" class="right">Qty</th><th style="width:8%">Unit</th><th style="width:12%">Unit Price</th></tr></thead><tbody>`;
  list.forEach((r,i)=>{
    html += `<tr><td>${i+1}</td><td>${escapeHtml(r.item)}</td><td>${escapeHtml(r.partcode)}</td><td>${escapeHtml(r.desc)}</td><td class="right">${r.qty}</td><td>${r.unit}</td><td></td></tr>`;
  });
  // add totals placeholder rows
  html += `<tr><td colspan="6" style="font-weight:700;text-align:right">Subtotal (INR)</td><td></td></tr>`;
  html += `<tr><td colspan="6" style="font-weight:700;text-align:right">GST (18%)</td><td></td></tr>`;
  html += `<tr><td colspan="6" style="font-weight:800;text-align:right">Grand Total (INR)</td><td style="font-weight:800"></td></tr>`;

  html += `</tbody></table></div>`;
  document.getElementById('boqPreviewContainer').innerHTML = html;
}

function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"'`=\/]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[ch]));}

/* modal & apply */
function openControllerModal(){
  populateModal();
  const sel = document.getElementById('modalControllerModel');
  sel.value = finalCalculationData.controllerOverrideName || finalCalculationData.controllerName || CONTROLLER_MODELS[0].name;
  const out = document.getElementById('modalOutputCardModel');
  out.value = `${finalCalculationData.outputCardModel||'H_20_RJ45'}|20`;
  updatePortsFromOutputCard();
  document.getElementById('modalInputCardModel').value = finalCalculationData.inputCardModel || 'H_1xHDMI';
  document.getElementById('modalInputCardQty').value = finalCalculationData.inputCardQty || 2;
  document.getElementById('modalSplicerSolution').value = finalCalculationData.splicerSolution || '';
  document.getElementById('controllerModal').style.display='flex';
  onModalControllerChange();
}
function closeControllerModal(){ document.getElementById('controllerModal').style.display='none'; }
function onModalControllerChange(){
  const sel = document.getElementById('modalControllerModel').value;
  const ctrl = CONTROLLER_MODELS.find(c=>c.name===sel) || {};
  const isH = ctrl.type==='Modular';
  document.getElementById('modalOutputCardModel').disabled = !isH;
  document.getElementById('modalInputCardModel').disabled = !isH;
  document.getElementById('modalInputCardQty').disabled = !isH;
  document.getElementById('modalSplicerSolution').disabled = !isH;
}
function updatePortsFromOutputCard(){
  const val = document.getElementById('modalOutputCardModel').value;
  if(!val) return;
  document.getElementById('modalMaxPortsPerCard').value = val.split('|')[1] || '';
}
function applyModalChanges(){
  finalCalculationData.controllerOverrideName = document.getElementById('modalControllerModel').value;
  const out = document.getElementById('modalOutputCardModel').value.split('|')[0];
  const outPorts = parseInt(document.getElementById('modalOutputCardModel').value.split('|')[1]||'20',10);
  finalCalculationData.outputCardModel = out;
  finalCalculationData.outputCardPorts = outPorts;
  finalCalculationData.inputCardModel = document.getElementById('modalInputCardModel').value;
  finalCalculationData.inputCardQty = parseInt(document.getElementById('modalInputCardQty').value||'2',10);
  finalCalculationData.splicerSolution = document.getElementById('modalSplicerSolution').value;
  closeControllerModal();
  showVisualization();
}

/* reset */
function resetForm(){
  document.getElementById('productModel').value='';
  document.getElementById('unit').value='';
  document.getElementById('width').value='';
  document.getElementById('height').value='';
  document.getElementById('diagonal').value='';
  document.getElementById('aspectRatio').value='';
  document.getElementById('errorMessage').style.display='none';
  document.getElementById('cabinetOverlay').innerHTML='';
  document.getElementById('boqPreviewContainer').innerHTML='';
  ['spec_model','spec_pitch','spec_dims','spec_res','spec_diag','spec_density','spec_area','spec_cabs','ctrl_name','ctrl_ports','ctrl_sending','ctrl_shorteth','spec_power','spec_weight'].forEach(id=>{const el=document.getElementById(id); if(el) el.textContent='--';});
  finalCalculationData = {};
}

/* contact modal & pdf generation */
function openContactModal(){
  if(!finalCalculationData || !finalCalculationData.totalPixels){ alert('Calculate first.'); return; }
  // if no contact info, skip modal and download directly (user preference)
  if(!contactInfo.email && !contactInfo.phone){ proceedToDownloadPdf(); return; }
  document.getElementById('downloadEmail').value = contactInfo.email||'';
  document.getElementById('downloadPhone').value = contactInfo.phone||'';
  document.getElementById('contactModal').style.display='flex';
}
function closeContactModal(){ document.getElementById('contactModal').style.display='none'; }
function handleDownloadRequest(){
  const e = document.getElementById('downloadEmail').value.trim();
  const p = document.getElementById('downloadPhone').value.trim();
  if(e && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){ document.getElementById('contactError').style.display='block'; document.getElementById('contactError').textContent='Invalid email'; return; }
  contactInfo.email=e; contactInfo.phone=p;
  closeContactModal();
  proceedToDownloadPdf();
}

/* Draw simple connectivity diagram inside PDF (Controller -> PoE Switch -> LED Wall) */
function drawConnectivityDiagram(doc, x, y, w){
  const center = x + w/2;
  const step = 28;
  // controller box
  doc.setDrawColor(13,71,161); doc.setLineWidth(0.8);
  doc.setFillColor(245,250,255);
  doc.roundedRect(x, y, 40, 16, 2, 2);
  doc.text('Controller', x+20, y+11, {align:'center'});
  // arrow to switch
  doc.line(x+40, y+8, x+40+20, y+8);
  doc.line(x+60, y+8, x+56, y+6);
  doc.line(x+60, y+8, x+56, y+10);
  // switch box
  doc.roundedRect(x+60, y-6, 48, 28, 2,2);
  doc.text('PoE Switch', x+84, y+8, {align:'center'});
  // arrow to wall
  doc.line(x+108, y+8, x+108+20, y+8);
  doc.line(x+128, y+8, x+124, y+6);
  doc.line(x+128, y+8, x+124, y+10);
  // wall box
  doc.roundedRect(x+128, y-8, 50, 36, 2,2);
  doc.text('LED Wall', x+153, y+10, {align:'center'});
  // labels
  doc.setFontSize(8); doc.text('Controller → PoE Switch → LED Wall (Controller to wall via long Ethernet runs)', x, y+34);
}

/* capture visualization as image (html2canvas) then generate PDF with jsPDF & autotable */
async function proceedToDownloadPdf(){
  const data = finalCalculationData;
  // capture visualization: ensure it's visible
  const vis = document.getElementById('visGrid');
  // html2canvas capture
  const canvas = await html2canvas(vis, {scale:2, backgroundColor:null});
  const imgData = canvas.toDataURL('image/png');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p','mm','a4');
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 12;
  let y = 10;

  // header
  doc.setFontSize(16); doc.setTextColor(13,71,161); doc.setFont(undefined,'bold');
  doc.text('PeopleLink Unified Communications Pvt. Ltd.', margin, y);
  doc.setFontSize(12); doc.setFont(undefined,'normal'); doc.text('LED Video Wall — Technical Quotation', pageW - margin, y, {align:'right'});
  y += 8;
  doc.setFontSize(9); doc.setTextColor(80,80,80);
  doc.text(`Date: ${new Date().toLocaleDateString()}`, margin, y);
  doc.text(`Contact: ${contactInfo.email||'N/A'} | ${contactInfo.phone||'N/A'}`, pageW - margin, y, {align:'right'});
  y += 10;

  // section: specs
  doc.setFontSize(11); doc.setTextColor(13,71,161); doc.text('1. Wall Performance & Dimensions', margin, y);
  y += 6;
  doc.setFontSize(9); doc.setTextColor(40,40,40);
  const leftX = margin, rightX = pageW/2 + 6;
  const rows = [
    ['Final Dimensions:', `${(data.finalW_mm/MM_PER_METER).toFixed(2)} m × ${(data.finalH_mm/MM_PER_METER).toFixed(2)} m`],
    ['Final Diagonal:', `${data.finalDiagonal_in.toFixed(1)} in`],
    ['Pixel Pitch:', `${data.pixelPitch_mm} mm`],
    ['Resolution:', `${data.finalResW} × ${data.finalResH}`],
    ['Pixel Density:', `${formatLarge(data.pixelDensity)} px/m²`],
    ['Cabinet Size:', `${data.cabinetW_mm}mm × ${data.cabinetH_mm}mm`],
    ['Total Cabinets:', `${data.numCabW} × ${data.numCabH} (${data.totalCabinets})`],
    ['Total Modules:', `${data.totalModules}`],
    ['Total Pixels:', `${formatLarge(data.totalPixels)}`],
    ['Final Area:', `${data.finalArea_m2.toFixed(2)} m²`]
  ];
  // print two-column
  const half = Math.ceil(rows.length/2);
  for(let i=0;i<half;i++){
    const L = rows[i]; const R = rows[i+half];
    doc.text(L[0], leftX, y); doc.setTextColor(183,28,28); doc.text(L[1], leftX+55, y);
    if(R){ doc.setTextColor(40,40,40); doc.text(R[0], rightX, y); doc.setTextColor(183,28,28); doc.text(R[1], rightX+55, y); }
    doc.setTextColor(40,40,40);
    y+=6;
  }
  y+=6;

  // embed visualization image
  doc.setFontSize(11); doc.setTextColor(13,71,161); doc.text('2. Physical Visualization', margin, y);
  y+=6;
  const maxW = pageW - margin*2, maxH = 60;
  doc.addImage(imgData, 'PNG', margin, y, maxW, maxH);
  y += maxH + 8;

  // connectivity diagram
  doc.setFontSize(11); doc.setTextColor(13,71,161); doc.text('3. Connectivity Diagram', margin, y);
  y += 6;
  drawConnectivityDiagram(doc, margin+2, y, pageW - margin*2 - 4);
  y += 38;

  // control & connections
  doc.setFontSize(11); doc.setTextColor(13,71,161); doc.text('4. Control System & Connections', margin, y);
  y += 6;
  doc.setFontSize(9); doc.setTextColor(40,40,40);
  const ctrlRows = [
    ['Controller/Processor:', `${data.controllerName} (${data.controllerType})`],
    ['Total Receiving Cards:', `${data.totalCabinets}`],
    ['Controller Ports (post buffer):', `${data.requiredPortsBuffered}`],
    ['Long Ethernet Ports/Runs:', `${data.requiredLongEthRuns} (Controller → Wall)`],
    ['Short Ethernet Cables:', `${data.requiredShortEthernet} (Between Cabinets)`]
  ];
  ctrlRows.forEach(r=>{
    doc.text(r[0], margin, y); doc.setTextColor(183,28,28); doc.text(r[1], pageW - margin, y, {align:'right'}); doc.setTextColor(40,40,40); y+=6;
  });

  y += 6;
  // BOQ table - using jsPDF autotable with fixed columnWidths
  doc.setFontSize(11); doc.setTextColor(13,71,161); doc.text('5. Bill of Quantities (BOQ)', margin, y);
  y += 6;

  const boqList = generateBOQList(data);
  const head = [['S.No','Item','Partcode','Description','Qty','Unit','Unit Price','Line Total']];
  const body = boqList.map((r,i)=>[String(i+1), r.item, r.partcode, r.desc, String(r.qty), r.unit, '', '']);
  // subtotal/ gst rows as last entries (rendered visually)
  body.push(['', 'Subtotal','','','','','','']);
  body.push(['', 'GST (18%)','','','','','','']);
  body.push(['', 'Grand Total','','','','','','']);

  doc.autoTable({
    startY: y,
    head: head,
    body: body,
    theme: 'grid',
    styles: { fontSize:9, cellPadding:3 },
    headStyles: { fillColor:[13,71,161], textColor:255 },
    columnStyles: {
      0:{cellWidth:10}, 1:{cellWidth:40}, 2:{cellWidth:30}, 3:{cellWidth:60}, 4:{cellWidth:12}, 5:{cellWidth:14}, 6:{cellWidth:24}, 7:{cellWidth:24}
    }
  });

  // Terms & conditions
  let after = doc.lastAutoTable.finalY + 8;
  if(after > doc.internal.pageSize.getHeight() - 80) { doc.addPage(); after = 14; }
  doc.setFontSize(11); doc.setTextColor(13,71,161); doc.text('6. Standard Terms & Conditions', margin, after); after += 6;
  doc.setFontSize(9); doc.setTextColor(50,50,50);
  const terms = [
    "1. Price Validity: Quotation valid for 30 days.",
    "2. Payment Terms: 50% advance, 40% on delivery, 10% on commissioning.",
    "3. Civil Work: Structural supports & civil works by client unless included.",
    "4. Power & Data: Dedicated power & LAN drops must be provided by client.",
    "5. Warranty: 1 year standard warranty on panels & accessories (terms apply)."
  ];
  terms.forEach(t=>{
    const spl = doc.splitTextToSize(t, pageW - margin*2);
    doc.text(spl, margin, after);
    after += spl.length*4.8;
  });

  const fname = `PeopleLink_Quotation_${data.finalResW}x${data.finalResH}.pdf`;
  doc.save(fname);
}

/* XLSX download (SheetJS) - create workbook with BOQ and formulas */
function downloadXLSX(){
  const d = finalCalculationData;
  if(!d || !d.totalPixels){ alert('Calculate first.'); return; }
  const list = generateBOQList(d);
  // build rows: header + line items + price rows + totals with formulas
  const ws_data = [];
  ws_data.push(['S.No','Item','Partcode','Description','Qty','Unit','Unit Price','Line Total']);
  list.forEach((r,i)=>{
    ws_data.push([i+1, r.item, r.partcode, r.desc, r.qty, r.unit, '', `=G${i+2}*E${i+2}`]);
  });
  const subtotalRow = ws_data.length + 1;
  ws_data.push(['','Subtotal','','','','','', `=SUM(H2:H${subtotalRow-1})`]);
  ws_data.push(['','GST (18%)','','','','','', `=H${subtotalRow}*0.18`]);
  ws_data.push(['','Grand Total','','','','','', `=H${subtotalRow}+H${subtotalRow+1}`]);

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  // set column widths for readability
  ws['!cols'] = [{wpx:36},{wpx:180},{wpx:110},{wpx:260},{wpx:50},{wpx:70},{wpx:100},{wpx:110}];
  XLSX.utils.book_append_sheet(wb, ws, 'BOQ');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout],{type:'application/octet-stream'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `PeopleLink_BOQ_${d.finalResW}x${d.finalResH}.xlsx`; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* helpers: open/close modals for contact */
document.getElementById('controllerModal').addEventListener('click', e=>{ if(e.target === document.getElementById('controllerModal')) closeControllerModal(); });
document.getElementById('contactModal').addEventListener('click', e=>{ if(e.target === document.getElementById('contactModal')) closeContactModal(); });

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  populateModal(); toggleMeasurementFields();
});
</script>
</body>
</html>
