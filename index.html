<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* PAGE */
    :root{--brand:#0D47A1;--accent:#B71C1C;--muted:#6b7280}
    /* MODIFIED: Decreased overall body font size from 14px to 13px */
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 28px; background: #eef6fb; color: #1c2738; font-size: 13px; -webkit-font-smoothing:antialiased; }
    .main-wrapper { max-width: 1200px; margin: auto; }

    /* HEADER */
    h2 { text-align: center; color: var(--brand); margin-top: 0; margin-bottom: 18px; font-weight:700; font-size:1.6rem; }

    /* LAYOUT */
    .grid-3 { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(6,25,57,0.08); }
    .input-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 600; color: #374151; font-size: 0.85rem; }
    input[type="number"], select { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; font-size: 0.85rem; }
    button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
    .btn-primary { background: var(--brand); color: #fff; }
    .btn-primary:hover { background: #0b3b84; }
    .btn-secondary { background: #e5e7eb; color: #374151; margin-left: 10px; }
    .btn-secondary:hover { background: #d1d5db; }

    /* RESULTS */
    .specs-grid, .ctrl-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
    /* MODIFIED: Increased font size from 8pt to 9pt */
    .spec-item, .ctrl-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #e5e7eb; font-size: 9pt; }
    .spec-item span:first-child, .ctrl-item span:first-child { font-weight: 600; color: #1f2937; }
    .spec-item span:last-child, .ctrl-item span:last-child { color: var(--brand); font-weight: 600; }
    .details-panel { padding: 15px; border: 1px solid #d1d5db; border-radius: 4px; margin-top: 15px; background: #f9fafb; font-size: 8pt;}

    /* VISUALIZATION */
    .vis-container { margin-top: 15px; text-align: center; }
    /* The LED wall is capped at max-width: 70% as requested */
    .led-wall { border: 2px solid #ccc; display: inline-grid; width: 100%; max-width: 70%; max-height: 400px; aspect-ratio: 16/9; overflow: hidden; position: relative; margin: auto;
    }
    #cabinetOverlay { width: 100%; height: 100%; display: grid; }
    #cabinetOverlay > div { border: 1px solid rgba(255, 255, 255, 0.4); background: rgba(13, 71, 161, 0.5); display: flex; align-items: center;
    justify-content: center; position: relative; }
    .cab-label { background: rgba(0, 0, 0, 0.7); color: #fff; padding: 2px 4px; border-radius: 2px; font-size: 8px; pointer-events: none; }
    #visDimensions { font-size: 0.9rem; font-weight: 600; margin-top: 5px; }

    /* BOQ TABLE STYLES */
    #boqPreviewTable { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 7pt; }
    #boqPreviewTable th, #boqPreviewTable td { border: 1px solid #e5e7eb; padding: 4px 6px; text-align: left; font-size: 7pt; }
    #boqPreviewTable th { background-color: var(--brand); color: #fff; font-weight: 700; }
    #boqPreviewTable td.right { text-align: right; }

    /* ERROR & UTILS */
    .hidden { display: none !important; }
    #errorMessage { color: var(--accent); font-weight: 600; margin-top: 10px; display: none; }

    /* MODAL */
    .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); display: none;
    align-items: center; justify-content: center; }
    .modal-content { background-color: #fefefe; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover, .close:focus { color: #000; text-decoration: none; }
    .hseries-only { display: none; }

    /* PDF DOWNLOAD BUTTON */
    .download-buttons { margin-top: 20px; border-top: 1px solid #d1d5db; padding-top: 15px; text-align: right; }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <h2>PeopleLink LED Video Wall Configuration</h2>

    <div class="grid-3">
      <div class="card config-panel">
        <div style="font-weight:700; color:var(--brand); margin-bottom:12px;">Input Parameters</div>

        <div class="input-group">
          <label for="productModel">LED Product Model</label>
          <select id="productModel" onchange="resetForm()">
            <option value="">-- Select Model --</option>
            <optgroup label="COB LED Products">
              <option value="cob_09">PeopleLink COB (0.9375mm)</option>
              <option value="cob_125">PeopleLink COB (1.25mm)</option>
              <option value="cob_15">PeopleLink COB (1.5625mm)</option>
            </optgroup>
            <optgroup label="SMD Indoor LED Products">
              <option value="indoor_186">PeopleLink SMD Indoor (1.86mm)</option>
              <option value="indoor_20">PeopleLink SMD Indoor (2.0mm)</option>
              <option value="indoor_25">PeopleLink SMD Indoor (2.5mm)</option>
            </optgroup>
            <optgroup label="SMD Outdoor LED Products">
              <option value="outdoor_40">PeopleLink SMD Outdoor (4.0mm)</option>
              <option value="outdoor_667">PeopleLink SMD Outdoor (6.67mm)</option>
              <option value="outdoor_80">PeopleLink SMD Outdoor (8.0mm)</option>
              <option value="outdoor_100">PeopleLink SMD Outdoor (10.0mm)</option>
            </optgroup>
          </select>
        </div>
        <div class="input-group">
          <label for="unit">Measurement Unit</label>
          <select id="unit" onchange="toggleMeasurementFields()">
            <option value="">-- Select Unit --</option>
            <option value="meters">Meters (m)</option>
            <option value="feet">Feet (ft)</option>
            <option value="inches">Diagonal Inches (in)</option>
          </select>
        </div>
        <div id="widthGroup" class="input-group hidden">
          <label id="widthLabel" for="width">Desired Width (m)</label>
          <input type="number" id="width" min="0" step="0.01">
        </div>

        <div id="heightGroup" class="input-group hidden">
          <label id="heightLabel" for="height">Desired Height (m)</label>
          <input type="number" id="height" min="0" step="0.01">
        </div>
        <div id="diagonalGroup" class="input-group hidden">
          <label for="diagonal">Desired Diagonal (inches)</label>
          <input type="number" id="diagonal" min="0" step="1">
        </div>

        <div class="input-group">
          <label for="aspectRatio">Aspect Ratio (Optional)</label>
          <select id="aspectRatio">
            <option value="auto_major" selected>Auto with Major (Fit Cabinet)</option>
            <option value="16:9">16:9</option>
            <option value="16:10">16:10</option>
            <option value="4:3">4:3</option>
            <option value="2:1">2:1</option>
            <option value="3:2">3:2</option>
            <option value="21:9">21:9</option>
          </select>
        </div>

        <button class="btn-primary" onclick="showVisualization()">Calculate Configuration</button>
        <button class="btn-secondary" onclick="fullReset()">Reset</button>

        <div id="errorMessage"></div>

      </div>

      <div class="card results-panel">
        <div style="font-weight:700; color:var(--brand); margin-bottom:12px;">Calculated Results</div>

        <div class="details-panel">
          <div style="font-weight:700;color:var(--brand);margin-bottom:8px">Detailed Wall Specification</div>
          <div class="specs-grid">
            <div class="spec-item"><span>Model:</span><span id="spec_model">--</span></div>
            <div class="spec-item"><span>Pixel Pitch:</span><span id="spec_pitch">--</span></div>
            <div class="spec-item"><span>Actual Dimensions (WxH):</span><span id="spec_dims">--</span></div>
            <div class="spec-item"><span>Actual Resolution (WxH):</span><span id="spec_res">--</span></div>
            <div class="spec-item"><span>Final Diagonal:</span><span id="spec_diag">--</span></div>
            <div class="spec-item"><span>Aspect Ratio:</span><span id="aspectRatioText">--</span></div>
            <div class="spec-item"><span>Pixel Density:</span><span id="spec_density">--</span></div>
            <div class="spec-item"><span>Final Area (m²/sq.ft):</span><span id="spec_area">--</span></div>
            <div class="spec-item"><span>Total Pixels:</span><span id="spec_total_pixels">--</span></div>
            <div class="spec-item"><span>Cabinets (WxH):</span><span id="spec_cabs">--</span></div>
            <div class="spec-item"><span>Total Modules:</span><span id="spec_modules">--</span></div>
            <div class="spec-item"><span>Cabinet Size (mm):</span><span id="spec_cabsize">--</span></div>
            <div class="spec-item"><span>Cabinet Pixels (WxH):</span><span id="spec_cabpix">--</span></div>
            <div class="spec-item"><span>Design Power (Est.):</span><span id="spec_power">--</span></div>
            <div class="spec-item"><span>Design Weight (Est.):</span><span id="spec_weight">--</span></div>
          </div>
        </div>

        <div class="details-panel" style="margin-top:12px">
          <div style="font-weight:700;color:var(--brand);margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
            <span>Controller & Connectivity</span>
            <button class="btn-secondary" style="font-size:7pt; padding:4px 8px;" onclick="openControllerModal()">Edit Controller</button>
          </div>
          <div class="ctrl-grid">
            <div class="ctrl-item"><span>Controller Model:</span><span id="ctrl_name">--</span></div>
            <div class="ctrl-item"><span>Ports Required (Long Ethernet):</span><span id="ctrl_longeth_combined">--</span></div>
            <div class="ctrl-item hseries-only"><span>Modular Sending Cards:</span><span id="ctrl_sending">--</span></div>
            <div class="ctrl-item"><span>Short Ethernet (Between Cabinets):</span><span id="ctrl_shorteth">--</span></div>
          </div>
        </div>
        <div class="download-buttons">
          <button class="btn-primary" onclick="openContactModal()">Download PDF Proposal</button>
          <button class="btn-secondary" onclick="downloadBOQCSV()">Download BOQ (CSV)</button>
        </div>

      </div>
    </div>

    <div class="card vis-panel" style="margin-top: 20px;">
      <div style="font-weight:700; color:var(--brand); margin-bottom:12px;">Wall Visualization</div>
      <div class="vis-container">
        <div class="led-wall">
          <div id="cabinetOverlay">
            <div style="grid-column: 1 / -1; grid-row: 1 / -1; background: #f0f0f0; color: #333; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 600;">
              Calculate to see visualization
            </div>
          </div>
        </div>
        <div id="visDimensions">-- m × -- m</div>
      </div>
    </div>
    <div id="boqPreviewContainer" style="margin-top: 20px;">
    </div>

  </div>
  <div id="controllerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin:0; font-size:1.2rem;">Override Controller Configuration</h3>
        <span class="close" onclick="closeControllerModal()">&times;</span>
      </div>
      <p style="font-size:12px; margin-top:-10px;">Select a controller and configure modular cards (for H-Series).</p>

      <div class="input-group">
        <label for="modalControllerModel">Controller Model (Override)</label>
        <select id="modalControllerModel" onchange="onModalControllerChange()">
        </select>
      </div>
      <div class="hseries-fields">
        <div class="input-group">
          <label for="modalOutputCardModel">Output/Sending Card Type</label>
          <select id="modalOutputCardModel" onchange="updatePortsFromOutputCard()">
          </select>
          <input type="hidden" id="modalMaxPortsPerCard">
        </div>

        <div class="input-group">
          <label for="modalInputCardModel">Input Card Type</label>
          <select id="modalInputCardModel">
          </select>
        </div>

        <div class="input-group" style="display:flex; gap:20px;">
          <div style="flex:1;">
            <label for="modalInputCardQty">Input Card Quantity</label>
            <input type="number" id="modalInputCardQty" min="1" value="2">
          </div>
          <div style="flex:1;">
            <label for="modalSplicerSolution">Splicer/Frame Solution</label>
            <input type="text" id="modalSplicerSolution">
          </div>
        </div>
      </div>

      <div style="text-align:right; margin-top:20px;">
        <button class="btn-secondary" onclick="closeControllerModal()">Cancel</button>
        <button class="btn-primary" onclick="applyModalChanges()">Apply Changes</button>
      </div>
    </div>
  </div>
  <div id="contactModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin:0; font-size:1.2rem;">Download Proposal</h3>
        <span class="close" onclick="closeContactModal()">&times;</span>
      </div>
      <p style="font-size:12px; margin-top:-10px;">Enter your contact details (optional) to include in the proposal document.</p>

      <div class="input-group">
        <label for="downloadEmail">Email Address</label>
        <input type="text" id="downloadEmail" placeholder="email@example.com">
      </div>
      <div class="input-group">
        <label for="downloadPhone">Phone Number</label>
        <input type="text" id="downloadPhone" placeholder="+91-XXXXXXXXXX">
      </div>

      <div id="contactError" style="color:var(--accent); margin-bottom:10px;"></div>

      <div style="text-align:right; margin-top:20px;">
        <button class="btn-secondary" onclick="closeContactModal()">Cancel</button>
        <button class="btn-primary" onclick="handleDownloadRequest()">Generate & Download PDF</button>
      </div>
    </div>
  </div>
  <script>
    /************************************************************************
     * Data: LED products, controllers, parts catalog
     ************************************************************************/
    const MM_PER_METER = 1000;
    const MM_PER_FOOT = 304.8;
    const MM_PER_INCH = 25.4;
    const PIXELS_PER_PORT_DEFAULT = 650000;
    const GLOBAL_PORT_BUFFER_PCT = 0.05;
    const POWER_BUFFER = 1.15;
    const WEIGHT_BUFFER = 1.15;
    const MARGIN_PERCENT_TEXT = "15%";

    const LED_PRODUCTS = {
      'cob_09': { name:"PeopleLink COB (0.9375mm)", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, nits_range:"600-1000", maxPower_W_m2:300 },
      'cob_125': { name:"PeopleLink COB (1.25mm)", pitch_mm:1.25, cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
      'cob_15': { name:"PeopleLink COB (1.5625mm)", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
      'indoor_186': { name:"PeopleLink SMD Indoor (1.86mm)", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      'indoor_20': { name:"PeopleLink SMD Indoor (2.0mm)", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      'indoor_25': { name:"PeopleLink SMD Indoor (2.5mm)", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      'outdoor_40': { name:"PeopleLink SMD Outdoor (4.0mm)", pitch_mm:4.0, cabW_mm:960, cabH_mm:960, cabPixW:240, cabPixH:240, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
      'outdoor_667': { name:"PeopleLink SMD Outdoor (6.67mm)", pitch_mm:6.67, cabW_mm:960, cabH_mm:960, cabPixW:144, cabPixH:144, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
      'outdoor_80': { name:"PeopleLink SMD Outdoor (8.0mm)", pitch_mm:8.0, cabW_mm:960, cabH_mm:960, cabPixW:120, cabPixH:120, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
      'outdoor_100': { name:"PeopleLink SMD Outdoor (10.0mm)", pitch_mm:10.0, cabW_mm:960, cabH_mm:960, cabPixW:96, cabPixH:96, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 }
    };

    const CONTROLLER_MODELS = [
      { name: 'VX400 Pro', type: 'All-in-One', max_ports: 4, is_default: true },
      { name: 'VX600 Pro', type: 'All-in-One', max_ports: 6, is_default: false },
      { name: 'VX1000 Pro', type: 'All-in-One', max_ports: 10, is_default: false },
      { name: '4K Prime', type: 'All-in-One', max_ports: 16, is_default: false },
      { name: 'H2 (Modular)', type: 'Modular', max_ports: 40, max_card_ports: 20, is_default: false },
      { name: 'H5 (Modular)', type: 'Modular', max_ports: 100, max_card_ports: 20, is_default: false },
      { name: 'H9 (Modular)', type: 'Modular', max_ports: 180, max_card_ports: 20, is_default: false },
      { name: 'H15 (Modular)', type: 'Modular', max_ports: 300, max_card_ports: 20, is_default: false },
      { name: 'H15 Enhanced (Modular)', type: 'Modular', max_ports: 300, max_card_ports: 20, is_default: false },
      // MODIFIED: H20 controller added based on user confirmation from file content
      { name: 'H20 (Modular)', type: 'Modular', max_ports: 400, max_card_ports: 20, is_default: false }, 
    ];
    const CABINETS_PER_LONG_ETH_MAX = 60; // Max cabinets (typical)

    let finalCalculationData = {};
    let contactInfo = { email:'', phone:'' };

    const PARTS_CATALOG = {
      // LED Cabinet Parts - COB 1.5 partcode confirmed as PPL-COB-MDL-CU-15
      'PPL-COB-09': { part:'PPL-COB-MDL-CU-09', desc:'PeopleLink COB 0.9375mm Cabinet' },
      'PPL-COB-125': { part:'PPL-COB-MDL-CU-12', desc:'PeopleLink COB 1.25mm Cabinet' },
      'PPL-COB-15': { part:'PPL-COB-MDL-CU-15', desc:'PeopleLink COB 1.5625mm Cabinet' },
      'PPL-SMD-18': { part:'PPL-SMD-MDL-CU-18', desc:'PeopleLink SMD Indoor 1.86/2.0/2.5 Cabinet' },
      'PPL-ALD-CU': { part:'PPL-ALD-MDL-CU-40', desc:'PeopleLink SMD Outdoor Cabinet' },

      // Accessories
      'CAB-PWR-CBL': { part:'PPL-ACC-PWR-CBL-60', desc:'AC Power Cable (Cabinet to Cabinet, 0.6m)' },
      'CAB-LAN-CBL': { part:'PPL-ACC-LAN-CBL-60', desc:'Data Cable (Cabinet to Cabinet, 0.6m)' },
      'LONG-LAN-CAT6': { part:'PPL-ACC-LAN-CBL-CAT6', desc:'Long Distance Data Cable (CAT6)' },
      'MOUNTING': { part:'PPL-ACC-MNT-FLAT', desc:'Standard Flat Wall Mounting Brackets (per cabinet)' },
      'SPARE-PSU': { part:'PPL-ACC-SPARE-PSU', desc:'Spare Power Supply Unit (1 per 10 cabinets est.)' },
      'SPARE-REC-CARD': { part:'PPL-ACC-SPARE-REC-CARD', desc:'Spare Receiving Card (1 per 10 cabinets est.)' },

      // Controller Parts
      'VX400': { part:'TP-VWC-NS-VX400', desc:'LED Video Wall Controller: VX400 Pro' },
      'VX600': { part:'TP-VWC-NS-VX600', desc:'LED Video Wall Controller: VX600 Pro' },
      'VX1000': { part:'TP-VWC-NS-VX1000', desc:'LED Video Wall Controller: VX1000 Pro' },
      '4K': { part:'TP-VWC-NS-4K', desc:'LED Video Wall Controller: 4K Prime' },

      // Modular (H-Series) Parts
      'H2': { part:'TP-XMF-H2', desc:'LED Video Wall Controller (H2)' },
      'H5': { part:'TP-XMF-H5', desc:'LED Video Wall Controller (H5)' },
      'H9': { part:'TP-XMF-H9', desc:'LED Video Wall Controller (H9)' },
      'H15': { part:'TP-XMF-H15', desc:'LED Video Wall Controller (H15)' },
      'H15E': { part:'TP-XMF-H15E', desc:'LED Video Wall Controller (H15 Enhanced)' },
      // MODIFIED: H20 part code placeholder added
      'H20': { part:'TP-XMF-H20', desc:'LED Video Wall Controller (H20)' }, 
      'H_20_RJ45': { part:'TP-XOC-RJ45-20', desc:'H_20 x RJ45 Sending Card' },
      'H_16_RJ45': { part:'TP-XOC-RJ45-16-OF2', desc:'H_16 x RJ45 + 2x Fiber Sending Card' },
      'H_4_HDMI_Out': { part:'TP-XOC-HDMI4', desc:'H_4 x HDMI Output Card' },
      'H_1xHDMI': { part:'TP-XIC-HDMI', desc:'H_1 x HDMI 2.0 Input Card' },
      'H_2xHDMI': { part:'TP-XIC-HDMI2', desc:'H_2 x HDMI 1.3 Input Card' },
      'H_4xHDMI': { part:'TP-XIC-HDMI4', desc:'H_4 x HDMI 1.3 Input Card' },
      'H_PSU': { part:'PPL-ACC-HPSU', desc:'Modular Controller Power Supply Unit' }
    };

    /************************************************************************
     * Utility functions
     ************************************************************************/
    function gcd(a, b) { return b == 0 ? a : gcd(b, a % b); }
    function formatLarge(n) { if (n < 10000) return n.toString(); return (n / 1000).toFixed(n % 1000 === 0 ? 0 : 1) + 'K'; }
    function m2ToSqFt(m2) { return m2 * 10.764; }
    function fmt(n, p=2) { return n.toFixed(p).replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function escapeHtml(text) { return text.replace(/[&<>"'`=\/]/g, function(c) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[c]; }); }

    /************************************************************************
     * Populate modal selects + initialization
     ************************************************************************/
    function populateModalControllers(){
      const sel = document.getElementById('modalControllerModel');
      sel.innerHTML = '';
      CONTROLLER_MODELS.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = `${c.name} (${c.type})`;
        sel.appendChild(opt);
      });
      const defaultCtrl = CONTROLLER_MODELS.find(c => c.is_default);
      if(defaultCtrl) sel.value = defaultCtrl.name;
    }
    function populateModalOutputCards(){
      const sel = document.getElementById('modalOutputCardModel');
      sel.innerHTML = '';
      const cards = [
        { model:'H_20_RJ45', ports:20 },
        { model:'H_16_RJ45', ports:16 },
        { model:'H_4_HDMI_Out', ports:4 }
      ];
      cards.forEach(c=>{
        const o = document.createElement('option');
        o.value = `${c.model}|${c.ports}`;
        o.textContent = `${PARTS_CATALOG[c.model].desc} (${c.ports} ports)`;
        sel.appendChild(o);
      });
      sel.value = cards[0] ? `${cards[0].model}|${cards[0].ports}` : '';
      updatePortsFromOutputCard();
    }
    function populateModalInputCards(){
      const sel = document.getElementById('modalInputCardModel');
      sel.innerHTML = '';
      const items = ['H_1xHDMI','H_2xHDMI','H_4xHDMI'];
      items.forEach(m=>{
        const o = document.createElement('option');
        o.value = m;
        o.textContent = PARTS_CATALOG[m] ? PARTS_CATALOG[m].desc : m;
        sel.appendChild(o);
      });
    }
    function updatePortsFromOutputCard(){
      const val = document.getElementById('modalOutputCardModel').value;
      if(!val) return;
      const parts = val.split('|');
      document.getElementById('modalMaxPortsPerCard').value = parts[1] || '';
    }

    /************************************************************************
     * Measurement Unit Toggle (DEBUG ALERT REMOVED)
     ************************************************************************/
    function toggleMeasurementFields(){
      // alert("Function is running"); // <-- Diagnostic Alert removed as requested
      const unit = document.getElementById('unit').value;

      const widthGroup = document.getElementById('widthGroup');
      const heightGroup = document.getElementById('heightGroup');
      const diagonalGroup = document.getElementById('diagonalGroup');

      // 1. Hide all input groups first
      widthGroup.classList.add('hidden');
      heightGroup.classList.add('hidden');
      diagonalGroup.classList.add('hidden');

      // 2. Show only the relevant group(s)
      if (unit === 'meters' || unit === 'feet') {
        widthGroup.classList.remove('hidden');
        heightGroup.classList.remove('hidden');
        document.getElementById('widthLabel').textContent = `Desired Width (${unit === 'meters' ? 'm' : 'ft'})`;
        document.getElementById('heightLabel').textContent = `Desired Height (${unit === 'meters' ? 'm' : 'ft'})`;
      } else if (unit === 'inches') {
        diagonalGroup.classList.remove('hidden');
      }
    }

    /************************************************************************
     * Calculation (REFINED Aspect Ratio Logic)
     ************************************************************************/
    function calculateLEDWall(){
      document.getElementById('errorMessage').style.display = 'none';
      const productKey = document.getElementById('productModel').value;
      const unit = document.getElementById('unit').value;
      const aspectRatio = document.getElementById('aspectRatio').value;

      if (!productKey || !unit) {
        document.getElementById('errorMessage').textContent='Please select a Product Model and Unit.';
        document.getElementById('errorMessage').style.display='block';
        return null;
      }

      const details = LED_PRODUCTS[productKey];
      let unitFactor = (unit === 'meters') ? MM_PER_METER : (unit === 'feet') ? MM_PER_FOOT : MM_PER_INCH;
      const widthInput = parseFloat(document.getElementById('width').value);
      const heightInput = parseFloat(document.getElementById('height').value);
      const diagonalInput = parseFloat(document.getElementById('diagonal').value);

      let desiredW_mm = 0;
      let desiredH_mm = 0;

      // 1. Determine Target Ratio (rW:rH)
      let rW, rH;
      if(aspectRatio === 'auto_major' || aspectRatio === '') {
          // Use cabinet ratio for 'Auto with Major'
          rW = details.cabW_mm; 
          rH = details.cabH_mm;
      } else {
          [rW, rH] = aspectRatio.split(':').map(Number);
      }
      const ratio = rW / rH;


      // 2. Convert Input to Target W/H (mm)
      if (unit === 'inches' && diagonalInput) {
        if (!diagonalInput > 0) {
           document.getElementById('errorMessage').textContent='Please enter a valid diagonal value.';
           document.getElementById('errorMessage').style.display='block';
           return null;
        }

        const d_mm = diagonalInput * MM_PER_INCH;
        const factor = d_mm / Math.sqrt(rW * rW + rH * rH);
        desiredW_mm = factor * rW;
        desiredH_mm = factor * rH;
      
      } else { // Calculations based on Width/Height input

        if (!widthInput && !heightInput) {
          document.getElementById('errorMessage').textContent='Please enter a width, height, or switch to diagonal input.';
          document.getElementById('errorMessage').style.display='block';
          return null;
        }
        
        if (widthInput && heightInput) { 
          // Both inputs provided: prioritize the closest fit by rounding cab numbers
          desiredW_mm = widthInput * unitFactor;
          desiredH_mm = heightInput * unitFactor;
          
        } else if (widthInput) { // Only width provided
          desiredW_mm = widthInput * unitFactor;
          desiredH_mm = desiredW_mm / ratio;
          
        } else if (heightInput) { // Only height provided
          desiredH_mm = heightInput * unitFactor;
          desiredW_mm = desiredH_mm * ratio;
        }
      }

      const numCabW = Math.max(1, Math.round(desiredW_mm / details.cabW_mm));
      const numCabH = Math.max(1, Math.round(desiredH_mm / details.cabH_mm));
      const totalCabinets = numCabW * numCabH;
      const totalModules = totalCabinets * details.modulesPerCab;

      const finalW_mm = numCabW * details.cabW_mm;
      const finalH_mm = numCabH * details.cabH_mm;
      const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);

      const finalResW = numCabW * details.cabPixW;
      const finalResH = numCabH * details.cabPixH;
      const totalPixels = finalResW * finalResH;
      const ratioG = gcd(finalResW, finalResH);
      const aspectRatioText = `${finalResW/ratioG}:${finalResH/ratioG}`;
      const finalDiagonal_in = Math.sqrt(finalW_mm*finalW_mm + finalH_mm*finalH_mm) / MM_PER_INCH;
      const pixelDensity = Math.round((totalPixels) / finalArea_m2);

      // power & weight
      const actualPowerW = finalArea_m2 * details.maxPower_W_m2;
      const designPowerW = actualPowerW * POWER_BUFFER;
      const actualWeight = details.weight_kg * totalCabinets;
      const designWeight = actualWeight * WEIGHT_BUFFER;

      // Power Runs Calculation
      const powerWPerRun = 1000;
      const requiredPowerRuns = Math.max(1, Math.ceil(designPowerW / powerWPerRun));

      // port rules
      const ports_by_pixels = Math.max(1, Math.ceil(totalPixels / PIXELS_PER_PORT_DEFAULT));
      const cabinetsRule = CABINETS_PER_LONG_ETH_MAX;
      const ports_by_cabinet = Math.max(1, Math.ceil(totalCabinets / cabinetsRule));
      const requiredPorts = Math.max(ports_by_pixels, ports_by_cabinet);

      // default controller selection
      let finalControllerObj = CONTROLLER_MODELS.find(c => c.is_default);
      let outputCardPorts_default = finalControllerObj.max_card_ports || finalControllerObj.max_ports;

      // Overrides
      const modalControllerModel = document.getElementById('modalControllerModel').value;
      const modalOutputCardModel = document.getElementById('modalOutputCardModel').value;
      const modalInputCardModel = document.getElementById('modalInputCardModel').value;
      const modalInputCardQty = parseInt(document.getElementById('modalInputCardQty').value) || 0;
      const modalSplicerSolution = document.getElementById('modalSplicerSolution').value;
      let requiredSendCards = 0;
      let finalRequiredPorts = requiredPorts;
      let finalControllerType = finalControllerObj.type;

      if(modalControllerModel){
        const customController = CONTROLLER_MODELS.find(c => c.name === modalControllerModel);
        if(customController) finalControllerObj = customController;
        finalControllerType = finalControllerObj.type;
        if(finalControllerType === 'Modular'){
          const maxPortsPerCard = parseInt(modalOutputCardModel.split('|')[1]) || finalControllerObj.max_card_ports;
          requiredSendCards = Math.max(1, Math.ceil(requiredPorts / maxPortsPerCard));
          finalRequiredPorts = requiredSendCards * maxPortsPerCard;
          if (finalRequiredPorts > finalControllerObj.max_ports) {
             document.getElementById('errorMessage').textContent = `Controller ${finalControllerObj.name} max ports (${finalControllerObj.max_ports}) exceeded by calculation (${finalRequiredPorts}). Please select a larger controller or reduce resolution.`;
             document.getElementById('errorMessage').style.display='block';
             return null;
          }
        } else { // All-in-One
          if (requiredPorts > finalControllerObj.max_ports) {
            document.getElementById('errorMessage').textContent = `Controller ${finalControllerObj.name} max ports (${finalControllerObj.max_ports}) exceeded by calculation (${requiredPorts}). Please select a larger controller.`;
            document.getElementById('errorMessage').style.display='block';
            return null;
          }
        }
      }

      const requiredPortsBuffered = Math.ceil(finalRequiredPorts * (1 + GLOBAL_PORT_BUFFER_PCT));
      const requiredShortEthernet = totalCabinets * 2; // In/Out for all
      const requiredLongEthRuns = Math.max(1, finalRequiredPorts);

      // store
      finalCalculationData = {
        productKey,
        productName: details.name,
        pixelPitch_mm: details.pitch_mm,
        cabinetW_mm: details.cabW_mm,
        cabinetH_mm: details.cabH_mm,
        cabPixW: details.cabPixW,
        cabPixH: details.cabPixH,
        modulesPerCab: details.modulesPerCab,
        numCabW,
        numCabH,
        totalCabinets,
        totalModules,
        finalW_mm,
        finalH_mm,
        finalArea_m2,
        finalResW,
        finalResH,
        totalPixels,
        aspectRatioText,
        finalDiagonal_in,
        pixelDensity,
        actualPowerW,
        designPowerW,
        requiredPowerRuns,
        actualWeight,
        designWeight,
        requiredPortsBuffered,
        requiredShortEthernet,
        requiredLongEthRuns,
        requiredSendCards: requiredSendCards || 1,
        controllerName: finalControllerObj.name,
        controllerType: finalControllerType,
        suggestedControllerObj: finalControllerObj,
        outputCardPorts: outputCardPorts_default,
        outputCardModel: modalOutputCardModel.split('|')[0] || 'H_20_RJ45',
        inputCardModel: modalInputCardModel || 'H_1xHDMI',
        inputCardQty: modalInputCardQty || 2,
        splicerSolution: modalSplicerSolution || (finalControllerType==='Modular' ? `${finalControllerObj.name} Splicer` : 'N/A')
      };
      return finalCalculationData;
    }

    /************************************************************************
     * Visualization & UI update
     ************************************************************************/
    function showVisualization(){
      const d = calculateLEDWall();
      if(!d) return;

      const finalAreaSqFt = m2ToSqFt(d.finalArea_m2);
      // specs panel
      document.getElementById('spec_model').textContent = d.productName;
      document.getElementById('spec_pitch').textContent = d.pixelPitch_mm + ' mm';
      document.getElementById('spec_dims').textContent = `${(d.finalW_mm/MM_PER_METER).toFixed(2)} m x ${(d.finalH_mm/MM_PER_METER).toFixed(2)} m`;
      document.getElementById('spec_res').textContent = `${formatLarge(d.finalResW)} × ${formatLarge(d.finalResH)}`;
      document.getElementById('spec_diag').textContent = `${d.finalDiagonal_in.toFixed(1)} in`;
      document.getElementById('aspectRatioText').textContent = d.aspectRatioText;
      document.getElementById('spec_density').textContent = `${formatLarge(d.pixelDensity)} px/m²`;
      document.getElementById('spec_area').textContent = `${d.finalArea_m2.toFixed(2)} m² / ${finalAreaSqFt.toFixed(2)} sq.ft`;
      document.getElementById('spec_total_pixels').textContent = formatLarge(d.totalPixels);
      document.getElementById('spec_cabs').textContent = `${d.numCabW} × ${d.numCabH} (${d.totalCabinets})`;
      document.getElementById('spec_modules').textContent = `${d.totalModules}`;
      document.getElementById('spec_cabsize').textContent = `${d.cabinetW_mm} mm × ${d.cabinetH_mm} mm`;
      document.getElementById('spec_cabpix').textContent = `${d.cabPixW} × ${d.cabPixH}`;
      document.getElementById('spec_power').textContent = `${fmt(d.designPowerW,0)} W (${MARGIN_PERCENT_TEXT} buffer)`;
      document.getElementById('spec_weight').textContent = `${fmt(d.designWeight,1)} kg (${MARGIN_PERCENT_TEXT} buffer)`;

      // controller panel
      document.getElementById('ctrl_name').textContent = `${d.controllerName} (${d.controllerType})`;
      document.getElementById('ctrl_longeth_combined').textContent = `${d.requiredLongEthRuns} runs`;
      document.getElementById('ctrl_shorteth').textContent = `${d.requiredShortEthernet} pcs`;

      if(d.controllerType === 'Modular'){
        document.querySelectorAll('.hseries-only').forEach(el=>el.style.display='flex');
        document.getElementById('ctrl_sending').textContent = `${d.requiredSendCards} cards (${PARTS_CATALOG[d.outputCardModel].desc.split(' (')[0]})`;
      } else {
        document.querySelectorAll('.hseries-only').forEach(el=>el.style.display='none');
      }

      // visualization
      const overlay = document.getElementById('cabinetOverlay');
      overlay.innerHTML = '';
      overlay.style.gridTemplateColumns = `repeat(${d.numCabW}, 1fr)`;
      overlay.style.gridTemplateRows = `repeat(${d.numCabH}, 1fr)`;
      for (let r = 0; r < d.numCabH; r++) {
        for (let c = 0; c < d.numCabW; c++) {
          const cabDiv = document.createElement('div');
          cabDiv.innerHTML = `<div class="cab-label">${c+1},${r+1}</div>`;
          overlay.appendChild(cabDiv);
        }
      }
      document.getElementById('visDimensions').textContent = `${(d.finalW_mm/MM_PER_METER).toFixed(2)} m × ${(d.finalH_mm/MM_PER_METER).toFixed(2)} m`;

      // BOQ preview
      generateBOQPreview(generateBOQList(d));
    }


    /************************************************************************
     * BOQ generation & preview
     ************************************************************************/
    function generateBOQList(data){
      const list = [];
      const isModular = data.controllerType && data.controllerType.includes('Modular');

      // --- 1. LED Cabinets/Modules ---
      let ledKey;
      if (data.productKey === 'cob_09') ledKey = 'PPL-COB-09';
      else if (data.productKey === 'cob_125') ledKey = 'PPL-COB-125';
      // CONFIRMED: Correct part code is PPL-COB-MDL-CU-15
      else if (data.productKey === 'cob_15') ledKey = 'PPL-COB-15';
      else if (data.cabinetW_mm === 640) ledKey = 'PPL-SMD-18';
      else ledKey = 'PPL-ALD-CU';

      const ledPart = PARTS_CATALOG[ledKey] ? PARTS_CATALOG[ledKey].part : 'TBD';
      list.push({ item:'LED Cabinets (Including Modules)', partcode:ledPart, desc:data.productName, qty:data.totalCabinets, unit:'PCS' });

      // --- 2. Controller/Processor ---
      let ctrlKey;
      if (data.controllerName.includes('VX400')) ctrlKey = 'VX400';
      else if (data.controllerName.includes('VX600')) ctrlKey = 'VX600';
      else if (data.controllerName.includes('VX1000')) ctrlKey = 'VX1000';
      else if (data.controllerName.includes('4K Prime')) ctrlKey = '4K';
      else if (data.controllerName.includes('H20')) ctrlKey = 'H20'; // MODIFIED: Added H20 logic
      else if (data.controllerName.includes('H15 Enhanced')) ctrlKey = 'H15E';
      else if (data.controllerName.includes('H15')) ctrlKey = 'H15';
      else if (data.controllerName.includes('H9')) ctrlKey = 'H9';
      else if (data.controllerName.includes('H5')) ctrlKey = 'H5';
      else if (data.controllerName.includes('H2')) ctrlKey = 'H2';
      else ctrlKey = data.controllerName.split(' ')[0]; // Fallback

      if(PARTS_CATALOG[ctrlKey]) list.push({ item:'Controller/Processor', partcode:PARTS_CATALOG[ctrlKey].part, desc:PARTS_CATALOG[ctrlKey].desc, qty:1, unit:'PCS' });
      else list.push({ item:'Controller/Processor', partcode:'TBD', desc:data.controllerName, qty:1, unit:'PCS' });

      // --- 3. Modular Parts (if applicable) ---
      if(isModular){
        const outModel = data.outputCardModel || 'H_20_RJ45';
        const outPart = PARTS_CATALOG[outModel] ? PARTS_CATALOG[outModel].part : 'TBD';
        list.push({ item:'Modular Sending/Output Card', partcode:outPart, desc:PARTS_CATALOG[outModel] ? PARTS_CATALOG[outModel].desc : outModel, qty:data.requiredSendCards, unit:'PCS' });

        const inModel = data.inputCardModel || 'H_1xHDMI';
        const inPart = PARTS_CATALOG[inModel] ? PARTS_CATALOG[inModel].part : 'TBD';
        list.push({ item:'Input Card (Source)', partcode:inPart, desc:PARTS_CATALOG[inModel] ? PARTS_CATALOG[inModel].desc : inModel, qty:data.inputCardQty, unit:'PCS' });

        list.push({ item:'Splicer/Video Frame Solution', partcode:'TBD', desc:data.splicerSolution, qty:1, unit:'PCS' });
        list.push({ item:'Modular Power Supply Unit', partcode:PARTS_CATALOG['H_PSU'].part, desc:PARTS_CATALOG['H_PSU'].desc, qty:1, unit:'PCS' });
      }

      // --- 4. Short Cables (Cabinet to Cabinet) ---
      list.push({ item:'Cabinet to Cabinet Data Cable', partcode:PARTS_CATALOG['CAB-LAN-CBL'].part, desc:PARTS_CATALOG['CAB-LAN-CBL'].desc, qty:data.requiredShortEthernet, unit:'PCS' });
      list.push({ item:'Cabinet to Cabinet Power Cable', partcode:PARTS_CATALOG['CAB-PWR-CBL'].part, desc:PARTS_CATALOG['CAB-PWR-CBL'].desc, qty:data.requiredShortEthernet, unit:'PCS' });

      // --- 5. Long Cables (Controller to Wall) ---
      list.push({ item:'Long Distance Data Cable (CAT6)', partcode:PARTS_CATALOG['LONG-LAN-CAT6'].part, desc:PARTS_CATALOG['LONG-LAN-CAT6'].desc, qty:data.requiredLongEthRuns, unit:'PCS' });
      list.push({ item:'Power Runs (Wall to Power Source)', partcode:'TBD', desc:'Power Runs (as per Design Power)', qty:data.requiredPowerRuns, unit:'NOS' });

      // --- 6. Mounting & Spares ---
      list.push({ item:'Standard Mounting Brackets', partcode:PARTS_CATALOG['MOUNTING'].part, desc:PARTS_CATALOG['MOUNTING'].desc, qty:data.totalCabinets, unit:'SET' });

      const sparePct = (data.productName.toLowerCase().includes('cob')) ? 0.05 : 0.10;
      const spareQty = Math.max(1, Math.round(data.totalModules * sparePct));
      list.push({ item:`Spare Modules (${Math.round(sparePct*100)}%)`, partcode:'TBD', desc:'Spare modules (site spares)', qty:spareQty, unit:'PCS' });

      const sparePsuQty = Math.max(1, Math.ceil(data.totalCabinets / 10));
      list.push({ item:`Spare Power Supply Unit`, partcode:PARTS_CATALOG['SPARE-PSU'].part, desc:PARTS_CATALOG['SPARE-PSU'].desc, qty:sparePsuQty, unit:'PCS' });

      const spareRecCardQty = Math.max(1, Math.ceil(data.totalCabinets / 10));
      list.push({ item:`Spare Receiving Card`, partcode:PARTS_CATALOG['SPARE-REC-CARD'].part, desc:PARTS_CATALOG['SPARE-REC-CARD'].desc, qty:spareRecCardQty, unit:'PCS' });

      // --- 7. Installation/Commissioning (QTY AS PER CABINET COUNT - CONFIRMED) ---
      list.push({
        item:'Installation / Configuration',
        partcode:'TBD',
        desc:'Wall Installation, Configuration, & Commissioning',
        qty: data.totalCabinets, // QTY confirmed to be totalCabinets
        unit:'PCS'
      });

      return list;
    }

    function generateBOQPreview(list){
      let html = `<div style="font-weight:700; color:var(--brand); margin-bottom:12px;">Bill of Quantities (BOQ) Preview</div>`;
      html += `<table id="boqPreviewTable"><thead><tr> <th style="width:3%">S.No</th> <th style="width:20%">Item</th> <th style="width:30%">Description</th> <th style="width:15%">Partcode</th> <th style="width:5%; text-align:right">Qty</th> <th style="width:10%">Unit</th> <th style="width:8%; text-align:right">Unit Price (INR)</th> <th style="width:9%; text-align:right">Total Price (INR)</th> </tr></thead><tbody>`;
      list.forEach((row, i)=>{
        html += `<tr><td>${i+1}</td><td>${escapeHtml(row.item)}</td><td>${escapeHtml(row.desc)}</td><td>${escapeHtml(row.partcode)}</td><td class="right">${row.qty}</td><td>${row.unit}</td><td></td><td></td></tr>`;
      });
      const spanCols = 6;
      html += `<tr><td colspan="${spanCols}" style="font-weight:700;text-align:right;background:#f3f6fb">Sub Total Amount (INR)</td><td colspan="2" style="font-weight:700;text-align:right;background:#f3f6fb"></td></tr>`;
      html += `<tr><td colspan="${spanCols}" style="font-weight:700;text-align:right;background:#f3f6fb">GST</td><td colspan="2" style="font-weight:700;text-align:right;background:#f3f6fb"></td></tr>`;
      html += `<tr><td colspan="${spanCols}" style="font-weight:700;text-align:right;background:#e5f2ff">Grand Total (INR)</td><td colspan="2" style="font-weight:700;text-align:right;background:#e5f2ff"></td></tr>`;
      html += `</tbody></table></div>`;
      document.getElementById('boqPreviewContainer').innerHTML = html;
    }

    /************************************************************************
     * Modal handlers (controller edit)
     ************************************************************************/
    function openControllerModal(){
      if(!finalCalculationData || !finalCalculationData.totalPixels){
        document.getElementById('errorMessage').textContent='Please calculate first.';
        document.getElementById('errorMessage').style.display='block';
        return;
      }
      const ctrl = CONTROLLER_MODELS.find(c => c.name === finalCalculationData.controllerName);
      document.getElementById('modalControllerModel').value = finalCalculationData.controllerName;
      if(ctrl && ctrl.type === 'Modular'){
        document.querySelectorAll('.hseries-fields').forEach(el=>el.style.display='block');
        document.getElementById('modalOutputCardModel').value = `${finalCalculationData.outputCardModel}|${finalCalculationData.outputCardPorts}`;
        document.getElementById('modalInputCardModel').value = finalCalculationData.inputCardModel;
        document.getElementById('modalInputCardQty').value = finalCalculationData.inputCardQty;
        document.getElementById('modalSplicerSolution').value = finalCalculationData.splicerSolution;
      } else {
        document.querySelectorAll('.hseries-fields').forEach(el=>el.style.display='none');
      }

      document.getElementById('controllerModal').style.display='flex';
    }
    function closeControllerModal(){
      document.getElementById('controllerModal').style.display='none';
    }
    function onModalControllerChange(){
      const val = document.getElementById('modalControllerModel').value;
      const ctrl = CONTROLLER_MODELS.find(c => c.name === val);
      if(ctrl && ctrl.type === 'Modular'){
        document.querySelectorAll('.hseries-fields').forEach(el=>el.style.display='block');
      } else {
        document.querySelectorAll('.hseries-fields').forEach(el=>el.style.display='none');
      }
    }
    function applyModalChanges(){
      const d = calculateLEDWall();
      if(d){
        closeControllerModal();
        showVisualization();
      }
    }

    /************************************************************************
     * Download & PDF generation (MODIFIED FOR FONT/TABLE FIT)
     ************************************************************************/
    function openContactModal(){
      if(!finalCalculationData || !finalCalculationData.totalPixels){
        document.getElementById('errorMessage').textContent='Please calculate first.';
        document.getElementById('errorMessage').style.display='block';
        return;
      }
      document.getElementById('downloadEmail').value = contactInfo.email || '';
      document.getElementById('downloadPhone').value = contactInfo.phone || '';
      document.getElementById('contactError').style.display='none';
      document.getElementById('contactModal').style.display='flex';
    }
    function closeContactModal(){
      document.getElementById('contactModal').style.display='none';
    }
    function handleDownloadRequest(){
      const e = document.getElementById('downloadEmail').value.trim();
      const p = document.getElementById('downloadPhone').value.trim();
      if(e){
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if(!re.test(e)){
          document.getElementById('contactError').textContent='Invalid email';
          document.getElementById('contactError').style.display='block';
          return;
        }
      }
      contactInfo.email = e;
      contactInfo.phone = p;
      closeContactModal();
      proceedToDownloadPdf();
    }

    function addFooter(doc) {
        const pageCount = doc.internal.getNumberOfPages();
        const pageW = doc.internal.pageSize.getWidth();
        const bodyFontSize = 8; // Match updated PDF body font size
        // CONFIRMED: Footer text
        const footerText = '© 2025 PeopleLink Unified Communications Pvt. Ltd. | All rights reserved';
        doc.setFont('Helvetica', 'normal');
        doc.setFontSize(bodyFontSize);
        doc.setTextColor(150, 150, 150);

        for(let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            const textWidth = doc.getStringUnitWidth(footerText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
            const xPos = pageW - 14 - textWidth;
            doc.text(footerText, xPos, doc.internal.pageSize.getHeight() - 8);
        }
    }

    function proceedToDownloadPdf(){
      const data = finalCalculationData;
      const list = generateBOQList(data);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p','mm','a4');
      const pageW = doc.internal.pageSize.getWidth();
      let y = 18;
      const margin = 14;
      const primary = [13,71,161];
      const grey = [60, 60, 60];
      const finalAreaSqFt = m2ToSqFt(data.finalArea_m2);

      doc.setFont('Helvetica');
      // MODIFIED: Increased general body font size from 7pt to 8pt for better readability
      const bodyFontSize = 8;
      const lineHeight = 4.2; // Adjusted for new font size
      doc.setFontSize(bodyFontSize);

      doc.setTextColor(...primary);
      doc.setFontSize(14);
      doc.setFont('Helvetica','bold');
      doc.text('PeopleLink LED Video Wall - Project Proposal', margin, y);
      y += 10;

      doc.setFontSize(8);
      doc.setFont('Helvetica','normal');
      doc.setTextColor(100,100,100);
      if(contactInfo.email) doc.text(`Email: ${contactInfo.email}`, margin, y);
      if(contactInfo.phone) doc.text(`Phone: ${contactInfo.phone}`, pageW - margin, y, {align: 'right'});
      y += 4;
      doc.setDrawColor(200, 200, 200);
      doc.line(margin, y, pageW - margin, y);
      y += 6;


      doc.setTextColor(...primary);
      doc.setFontSize(10);
      doc.setFont('Helvetica','bold');
      doc.text('1. Detailed Wall Specification', margin, y);
      y += 6;

      const specs = [
        ['Product Model:', data.productName],
        ['Pixel Pitch:', `${data.pixelPitch_mm} mm`],
        ['Actual Dimensions (WxH):', `${(data.finalW_mm/MM_PER_METER).toFixed(2)} m × ${(data.finalH_mm/MM_PER_METER).toFixed(2)} m`],
        ['Final Diagonal:', `${data.finalDiagonal_in.toFixed(1)} in`],
        ['Final Area (m²/sq.ft):', `${data.finalArea_m2.toFixed(2)} m² / ${finalAreaSqFt.toFixed(2)} sq.ft`],

        ['Actual Resolution (WxH):', `${formatLarge(data.finalResW)} × ${formatLarge(data.finalResH)}`],
        ['Aspect Ratio:', data.aspectRatioText],
        ['Pixel Density:', `${formatLarge(data.pixelDensity)} px/m²`],
        ['Total Pixels:', `${formatLarge(data.totalPixels)}`],
        ['Cabinets (WxH):', `${data.numCabW} × ${data.numCabH} (${data.totalCabinets})`],
        ['Total Modules Required:', `${data.totalModules} (${data.modulesPerCab} per cabinet)`],
        ['Cabinet Size (WxH):', `${data.cabinetW_mm} mm × ${data.cabinetH_mm} mm`],
        ['Cabinet Pixels (WxH):', `${formatLarge(data.cabPixW)} × ${formatLarge(data.cabPixH)}`],
        ['Design Power (Est.):', `${fmt(data.designPowerW,0)} W (${MARGIN_PERCENT_TEXT} buffer)`],
        ['Design Weight (Est.):', `${fmt(data.designWeight,1)} kg (${MARGIN_PERCENT_TEXT} buffer)`]
      ];
      const col1Items = specs.slice(0, 5);
      const col2Items = specs.slice(5);
      const col1KeyX = margin;
      const col1ValueX = col1KeyX + 45;
      const col2KeyX = pageW / 2 + 5;
      const col2ValueX = col2KeyX + 45;

      doc.setFontSize(bodyFontSize);
      let colY = y;
      col1Items.forEach(s => {
        doc.setFont('Helvetica', 'bold');
        doc.text(s[0], col1KeyX, colY);
        doc.setFont('Helvetica', 'normal');
        doc.text(s[1], col1ValueX, colY);
        colY += lineHeight;
      });

      let col2Y = y;
      col2Items.forEach(s => {
        doc.setFont('Helvetica', 'bold');
        doc.text(s[0], col2KeyX, col2Y);
        doc.setFont('Helvetica', 'normal');
        doc.text(s[1], col2ValueX, col2Y);
        col2Y += lineHeight;
      });
      y = Math.max(colY, col2Y) + 4;

      if(y > doc.internal.pageSize.getHeight() - 40){ doc.addPage(); y = margin; }
      doc.setTextColor(...primary);
      doc.setFontSize(10);
      doc.setFont('Helvetica','bold');
      doc.text('2. Controller & Connectivity', margin, y);
      y += 6;

      const ctrlSpecs = [
        ['Controller Model:', `${data.controllerName} (${data.controllerType})`],
        ['Total Ports Required:', `${data.requiredPortsBuffered} (Calculated)`],
        ['Ports for Long Ethernet:', `${data.requiredLongEthRuns} runs`],
        ['Short Ethernet (C-to-C):', `${data.requiredShortEthernet} pcs`],
      ];
      if (data.controllerType === 'Modular') {
        ctrlSpecs.push(['Modular Sending Cards:', `${data.requiredSendCards} cards (${PARTS_CATALOG[data.outputCardModel].desc.split(' (')[0]})`]);
        ctrlSpecs.push(['Input Card(s):', `${data.inputCardQty} × ${PARTS_CATALOG[data.inputCardModel].desc.split(' (')[0]}`]);
        ctrlSpecs.push(['Splicer/Video Frame:', data.splicerSolution]);
      }

      doc.setFontSize(bodyFontSize);
      let ctrlY = y;
      ctrlSpecs.forEach(s => {
        if(ctrlY > doc.internal.pageSize.getHeight() - 20) { doc.addPage(); ctrlY = margin; }
        doc.setFont('Helvetica', 'bold');
        doc.text(s[0], col1KeyX, ctrlY);
        doc.setFont('Helvetica', 'normal');
        doc.text(s[1], col1KeyX + 45, ctrlY);
        ctrlY += lineHeight;
      });
      y = ctrlY + 4;


      if(y > doc.internal.pageSize.getHeight() - 40){ doc.addPage(); y = margin; }
      doc.setTextColor(...primary);
      doc.setFontSize(10);
      doc.setFont('Helvetica','bold');
      doc.text('3. Bill of Quantities (BOQ)', margin, y);
      y += 4;
      
      const boqFontSize = 8; // MODIFIED: BOQ Table Font Size
      doc.setFontSize(boqFontSize);

      const boqHeaders = [['S.No', 'Item', 'Description', 'Partcode', 'Qty', 'Unit', 'Unit Price (INR)', 'Total Price (INR)']];
      const boqData = list.map((r, i) => [
        i + 1,
        r.item,
        r.desc,
        r.partcode,
        r.qty,
        r.unit,
        '',
        ''
      ]);

      doc.autoTable(boqHeaders, boqData, {
        startY: y,
        theme: 'striped',
        // MODIFIED: BOQ Head/Body Font Size to 8 and padding to 1.5
        headStyles: { fillColor: primary, fontSize: boqFontSize, fontStyle: 'bold', minCellHeight: 6 },
        bodyStyles: { fontSize: boqFontSize, textColor: grey },
        styles: { cellPadding: 1.5, overflow: 'linebreak' },
        columnStyles: {
            // MODIFIED: Adjusted column widths for better fit
            0: { cellWidth: 10 },    // S.No
            1: { cellWidth: 35 },    // Item
            2: { cellWidth: 'auto' },// Description
            3: { cellWidth: 30 },    // Partcode
            4: { cellWidth: 10, halign: 'right' }, // Qty
            5: { cellWidth: 10 },    // Unit
            6: { cellWidth: 20, halign: 'right' }, // Unit Price
            7: { cellWidth: 20, halign: 'right' }  // Total Price
        },
        didDrawPage: function(data) {
            if (data.pageNumber === data.pageCount) {
                const subTotalY = doc.internal.pageSize.getHeight() - 32;
                doc.setFontSize(8);
                doc.setFont('Helvetica', 'bold');
                doc.setFillColor(243, 246, 251);
                doc.rect(data.settings.margin.left, subTotalY, pageW - 2 * data.settings.margin.left, 5, 'F');
                doc.setTextColor(30);
                doc.text('Sub Total Amount (INR)', data.settings.margin.left + 90, subTotalY + 3.5, { align: 'right' });
                doc.rect(data.settings.margin.left, subTotalY + 5, pageW - 2 * data.settings.margin.left, 5, 'F');
                doc.text('GST', data.settings.margin.left + 90, subTotalY + 8.5, { align: 'right' });
                doc.setFillColor(229, 242, 255);
                doc.rect(data.settings.margin.left, subTotalY + 10, pageW - 2 * data.settings.margin.left, 5, 'F');
                doc.text('Grand Total (INR)', data.settings.margin.left + 90, subTotalY + 13.5, { align: 'right' });
            }
        }
      });
      y = doc.lastAutoTable.finalY + 6;

      if(y > doc.internal.pageSize.getHeight() - 40){ doc.addPage(); y = margin; }
      doc.setTextColor(...primary);
      doc.setFontSize(10);
      doc.setFont('Helvetica','bold');
      doc.text('4. Disclaimer', margin, y);
      y += 6;
      doc.setFontSize(bodyFontSize);
      doc.setTextColor(170, 0, 0);
      doc.setFont('Helvetica','italic');
      // CONFIRMED: Disclaimer text
      const disclaimer = 'Disclaimer: This document is system-generated. All specifications and calculations must be validated with the regional Pre-Sales team prior to finalization or execution.';
      const splitDisclaimer = doc.splitTextToSize(disclaimer, pageW - (2 * margin));
      doc.text(splitDisclaimer, margin, y);
      y += splitDisclaimer.length * lineHeight + 4;


      if(y > doc.internal.pageSize.getHeight() - 70){ doc.addPage(); y = margin; }
      doc.setTextColor(...primary);
      doc.setFontSize(10);
      doc.setFont('Helvetica','bold');
      doc.text('5. Standard Terms & Conditions', margin, y);
      y += 6;
      doc.setFontSize(bodyFontSize);
      doc.setTextColor(50,50,50);
      doc.setFont('Helvetica','normal');
      const terms = [
        "1) Price Validity: This quotation is valid for 30 days from the date of issue.",
        "2) Payment Terms: Standard terms are 50% advance, 40% upon delivery, and 10% upon successful commissioning.",
        "3) Civil & Structural Work: All civil works, primary mounting/hanging structure, and necessary site preparation are the sole responsibility of the Client/Partner, unless explicitly included in the BOQ.",
        "4) Power & Data Requirements: Stable, dedicated power sources (UPS/circuit) must be provided. Long-distance LAN and Power cable laying from Controller to Wall location (Long Length) is the Client/Partner scope. Short Lan/Power cables between Cabinets are included.",
        "5) Warranty: Standard manufacturer's warranty is 1 year on LED panels, modules, and accessories. Excludes misuse, electrical surges, unauthorized repairs, and physical damage.",
        "6) Site Access: Unrestricted site access, safe working environment, and suitable lifting equipment (if required) must be available during installation & commissioning.",
        "7) Transportation & Installation Damage: Up to 3% of the total quantity of LED Modules is included as site spares to cover any unforeseen transport or installation damage. Additional spares can be quoted separately."
      ];
      terms.forEach(term => {
        const splitText = doc.splitTextToSize(term, pageW - (2 * margin));
        doc.text(splitText, margin, y);
        y += splitText.length * lineHeight;
      });

      addFooter(doc);

      const fileName = `PeopleLink_LED_Proposal_${data.numCabW}x${data.numCabH}_${data.pixelPitch_mm}mm.pdf`;
      doc.save(fileName);
    }

    function downloadBOQCSV(){
      if(!finalCalculationData || !finalCalculationData.totalPixels){
        document.getElementById('errorMessage').textContent='Please calculate first.';
        document.getElementById('errorMessage').style.display='block';
        return;
      }
      const d = finalCalculationData;
      const list = generateBOQList(d);
      let csv = 'PeopleLink LED Video Wall Configuration\n';
      csv += 'Key: Actual Size (m), Diagonal (in), Resolution (WxH)\n';
      csv += `Summary Data,"${(d.finalW_mm/MM_PER_METER).toFixed(2)}x${(d.finalH_mm/MM_PER_METER).toFixed(2)}",${d.finalDiagonal_in.toFixed(0)},"${formatLarge(d.finalResW)}x${formatLarge(d.finalResH)}"\n\n`;

      csv += 'Bill of Quantities\n';
      csv += 'S.No,Item,Description,Partcode,Qty,Unit,"Unit Price (INR)","Total Price (INR)"\n';
      list.forEach((r,i)=>{
        csv += `${i+1},"${r.item}","${r.desc}","${r.partcode}",${r.qty},${r.unit},"",""\n`;
      });
      csv += '\nSub Total Amount (INR),,,,,,,\n';
      csv += 'GST (INR),,,,,,,\n';
      csv += 'Grand Total (INR),,,,,,,\n';
      // CONFIRMED: Disclaimer text
      csv += '\n\nDisclaimer: This document is system-generated. All specifications and calculations must be validated with the regional Pre-Sales team prior to finalization or execution.\n';

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `PeopleLink_BOQ_${d.numCabW}x${d.numCabH}_${d.pixelPitch_mm}mm.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    /************************************************************************
     * Reset
     ************************************************************************/
    function resetForm(){
      document.getElementById('width').value='';
      document.getElementById('height').value='';
      document.getElementById('diagonal').value='';
      document.getElementById('errorMessage').style.display='none';
      document.getElementById('cabinetOverlay').innerHTML='<div style="grid-column: 1 / -1; grid-row: 1 / -1; background: #f0f0f0; color: #333; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 600;">Calculate to see visualization</div>';
      document.getElementById('boqPreviewContainer').innerHTML='';
      document.getElementById('visDimensions').textContent = '-- m × -- m';

      ['spec_model','spec_pitch','spec_dims','spec_res','spec_diag','spec_density','spec_area','spec_total_pixels','spec_cabs','spec_modules','spec_cabsize','spec_cabpix','ctrl_name','ctrl_longeth_combined','ctrl_sending','ctrl_shorteth','spec_power','spec_weight','aspectRatioText'].forEach(id=>{
        const el = document.getElementById(id); if(el) el.textContent = '--';
      });
      document.querySelectorAll('.hseries-only').forEach(el=>el.style.display='none');
      finalCalculationData = {};
    }

    function fullReset(){
      document.getElementById('productModel').value = '';
      document.getElementById('unit').value = '';
      document.getElementById('width').value='';
      document.getElementById('height').value='';
      document.getElementById('diagonal').value='';
      // Set Aspect Ratio back to default (Auto with Major)
      document.getElementById('aspectRatio').value='auto_major';
      document.getElementById('errorMessage').style.display='none';
      document.getElementById('cabinetOverlay').innerHTML='<div style="grid-column: 1 / -1; grid-row: 1 / -1; background: #f0f0f0; color: #333; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 600;">Calculate to see visualization</div>';
      document.getElementById('boqPreviewContainer').innerHTML='';
      document.getElementById('visDimensions').textContent = '-- m × -- m';

      ['spec_model','spec_pitch','spec_dims','spec_res','spec_diag','spec_density','spec_area','spec_total_pixels','spec_cabs','spec_modules','spec_cabsize','spec_cabpix','ctrl_name','ctrl_longeth_combined','ctrl_sending','ctrl_shorteth','spec_power','spec_weight','aspectRatioText'].forEach(id=>{
        const el = document.getElementById(id); if(el) el.textContent = '--';
      });
      document.querySelectorAll('.hseries-only').forEach(el=>el.style.display='none');
      finalCalculationData = {};
      
      toggleMeasurementFields();
    }

    /************************************************************************
     * Init
     ************************************************************************/
    document.addEventListener('DOMContentLoaded', ()=>{\n
      populateModalControllers();
      populateModalOutputCards();
      populateModalInputCards();
      // Ensure the initial state is correct (all input fields are hidden as unit is not selected)
      toggleMeasurementFields(); 

      // close modals on background click
      window.addEventListener('click', (e)=>{
        if(e.target === document.getElementById('controllerModal')) closeControllerModal();
        if(e.target === document.getElementById('contactModal')) closeContactModal();
      });
    });
  </script>
</body>
</html>
