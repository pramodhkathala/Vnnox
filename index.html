<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* PAGE */
    :root{--brand:#0D47A1;--accent:#B71C1C;--muted:#6b7280}
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 28px; background: #eef6fb; color: #1c2738; font-size: 14px; -webkit-font-smoothing:antialiased; }
    .main-wrapper { max-width: 1200px; margin: auto; }

    /* HEADER */
    h2 { text-align: center; color: var(--brand); margin-top: 0; margin-bottom: 18px; font-weight:700; font-size:1.6rem; }

    /* PANELS */
    .panel-grid { display:grid; grid-template-columns:1fr 1fr; gap:22px; align-items:start; }
    .input-panel, .details-panel { background:#fff; padding:20px;border-radius:10px; box-shadow:0 4px 18px rgba(8,20,40,0.06); }

    /* FORM */
    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    label.form-label { font-weight:600; color:var(--brand); display:block; margin-bottom:6px; }
    input[type="number"], input[type="text"], select, input[type="email"], input[type="tel"] { width:100%; padding:9px 10px; border-radius:6px; border:1px solid #e6eef6; box-sizing:border-box; font-size:14px; }
    .controls { display:flex; gap:12px; align-items:center; margin-top:12px; }
    button.primary { background:var(--brand); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; }
    button.secondary { background:#f3f6fb; color:var(--brand); border:1px solid #e6eef6; padding:9px 12px; border-radius:8px; cursor:pointer; font-weight:600; }

    /* SPEC & CONTROL PANELS - layout like your 2nd format */
    .specs, .control-summary { padding:18px; border-radius:8px; background:#f6fbff; border:1px solid rgba(13,71,161,0.06); }
    .panel-title { color:var(--brand); font-weight:700; font-size:1.05rem; margin-bottom:10px; }
    .spec-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dotted rgba(0,0,0,0.06); }
    .spec-row .label { color:var(--brand); font-weight:700; min-width:250px; }
    .spec-row .value { color:var(--accent); font-weight:700; text-align:right; }

    /* Visualization */
    .viz-wrap { margin-top:16px; }
    .viz-box { border-radius:8px; background:#fff; padding:12px; border:1px solid #e6eef6; }
    .vis-grid { position:relative; width:100%; height:280px; border:3px solid rgba(13,71,161,0.12); background:linear-gradient(180deg,#eaf4ff,#e5f2ff); display:flex; align-items:center; justify-content:center; overflow:hidden; box-sizing:border-box; }
    #cabinetOverlay { position:absolute; inset:0; display:grid; box-sizing:border-box; grid-gap:0; padding:4px; }
    #cabinetOverlay > div { box-sizing:border-box; border:2px solid rgba(13,71,161,0.18); display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02)); transition:transform .08s ease, background .12s; }
    #cabinetOverlay > div:hover { transform:translateY(-3px); background:rgba(13,71,161,0.03); }
    .cab-label { font-size:12px; background:rgba(255,255,255,0.92); padding:2px 6px; border-radius:4px; color:var(--brand); font-weight:700; }

    /* BOQ preview */
    #boqPreviewTable { width:100%; border-collapse:collapse; margin-top:14px; font-size:13px; }
    #boqPreviewTable th, #boqPreviewTable td { border:1px solid #e6eef6; padding:8px 10px; text-align:left; }
    #boqPreviewTable th { background:linear-gradient(90deg, rgba(13,71,161,0.06), rgba(27,94,32,0.02)); color:var(--brand); font-weight:700; }

    /* small helpers */
    .muted { color:#6b7280; font-size:0.92rem; }
    .right { text-align:right; }
    .hidden { display:none !important; }
    footer.page-footer { text-align:center; margin-top:18px; color:#8fa6c8; font-size:13px; }

    /* modal */
    .modal { position:fixed; inset:0; display:none; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center; }
    .modal .modal-card { width:92%; max-width:720px; background:#fff; padding:18px; border-radius:10px; box-shadow:0 10px 40px rgba(6,25,57,0.12); }
    .modal .modal-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:10px; }
    .modal .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }

    /* responsive */
    @media (max-width:980px){ .panel-grid{grid-template-columns:1fr} .form-grid{grid-template-columns:1fr} .vis-grid{height:220px} }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <h2>PeopleLink LED Video Wall Configuration Calculator</h2>

    <div class="panel-grid">
      <div class="input-panel">
        <div style="font-weight:700;color:var(--brand);margin-bottom:10px">Configure Wall</div>

        <div class="form-grid">
          <div>
            <label class="form-label">LED Model / Pixel Pitch</label>
            <select id="productModel">
              <option value="">Select LED Model</option>
              <optgroup label="COB (600x337.5mm)">
                <option value="cob_09">0.9375 mm</option>
                <option value="cob_125">1.25 mm</option>
                <option value="cob_15">1.5625 mm</option>
              </optgroup>
              <optgroup label="SMD Indoor (640x480mm)">
                <option value="indoor_186">1.86 mm</option>
                <option value="indoor_20">2.0 mm</option>
                <option value="indoor_25">2.5 mm</option>
              </optgroup>
              <optgroup label="SMD Outdoor (960x960mm)">
                <option value="outdoor_40">4.0 mm</option>
                <option value="outdoor_667">6.67 mm</option>
                <option value="outdoor_80">8.0 mm</option>
              </optgroup>
            </select>
          </div>

          <div>
            <label class="form-label">Unit</label>
            <select id="unit" onchange="toggleMeasurementFields()">
              <option value="">Select unit</option>
              <option value="meters">Meters (m)</option>
              <option value="feet">Feet (ft)</option>
              <option value="inches">Inches - Diagonal</option>
            </select>
          </div>

          <div id="widthGroup">
            <label class="form-label" id="widthLabel">Desired Width (m)</label>
            <input type="number" id="width" placeholder="Enter width" min="0.1" step="0.01" />
          </div>

          <div id="heightGroup">
            <label class="form-label" id="heightLabel">Desired Height (m)</label>
            <input type="number" id="height" placeholder="Enter height" min="0.1" step="0.01" />
          </div>

          <div id="diagonalGroup" class="hidden">
            <label class="form-label" id="diagonalLabel">Diagonal (inches)</label>
            <input type="number" id="diagonal" placeholder="Diagonal inches" min="10" step="1" />
          </div>

          <div>
            <label class="form-label">Target Aspect Ratio (optional)</label>
            <select id="aspectRatio">
              <option value="">Auto</option>
              <option value="16:9">16:9</option>
              <option value="16:10">16:10</option>
              <option value="4:3">4:3</option>
              <option value="21:9">21:9</option>
              <option value="1:1">1:1</option>
            </select>
          </div>

          <div style="align-self:end;">
            <div class="controls">
              <button class="primary" id="calcBtn" onclick="showVisualization()">Calculate & Visualize</button>
              <button class="secondary" id="resetBtn" onclick="resetForm()">Reset</button>
            </div>
          </div>
        </div>

        <div id="errorMessage" class="muted" style="margin-top:10px; color: #b71c1c; display:none;"></div>

        <div class="viz-wrap">
          <div class="viz-box">
            <div style="font-weight:700;color:var(--brand);margin-bottom:8px">Physical Wall Visualization</div>
            <div class="vis-grid" id="visGrid">
              <div id="cabinetOverlay" aria-hidden="true"></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:10px">
              <div class="muted">Hover a cabinet to view its label</div>
              <div class="muted" id="visDimensions"></div>
            </div>
          </div>
        </div>

      </div>

      <div style="display:flex;flex-direction:column;gap:18px">
        <div class="details-panel specs">
          <div class="panel-title">LED Wall Specifications</div>

          <div id="specRows">
            <div class="spec-row"><div class="label">Model:</div><div class="value" id="spec_model">--</div></div>
            <div class="spec-row"><div class="label">Pixel Pitch:</div><div class="value" id="spec_pitch">--</div></div>
            <div class="spec-row"><div class="label">Actual Final Dimensions (WxH):</div><div class="value" id="spec_dims">--</div></div>
            <div class="spec-row"><div class="label">Actual Final Resolution (WxH):</div><div class="value" id="spec_res">--</div></div>
            <div class="spec-row"><div class="label">Final Diagonal:</div><div class="value" id="spec_diag">--</div></div>
            <div class="spec-row"><div class="label">Pixel Density:</div><div class="value" id="spec_density">--</div></div>
            <div class="spec-row"><div class="label">Final Area:</div><div class="value" id="spec_area">--</div></div>
            <div class="spec-row"><div class="label">Total Cabinets:</div><div class="value" id="spec_cabs">--</div></div>
            <div class="spec-row"><div class="label">Total Modules Required:</div><div class="value" id="spec_modules">--</div></div>
            <div class="spec-row"><div class="label">Cabinet Size (WxH):</div><div class="value" id="spec_cabsize">--</div></div>
            <div class="spec-row"><div class="label">Cabinet Pixels (WxH):</div><div class="value" id="spec_cabpix">--</div></div>
          </div>
        </div>

        <div class="details-panel control-summary">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="panel-title">Control & Connection Summary</div>
            <button class="secondary" style="font-size:13px" onclick="openControllerModal()">Edit</button>
          </div>

          <div style="margin-top:10px" id="controlRows">
            <div class="spec-row"><div class="label">Suggested Controller:</div><div class="value" id="ctrl_name">--</div></div>
            <div class="spec-row"><div class="label">Controller Ports (post buffer):</div><div class="value" id="ctrl_ports">--</div></div>
            <div class="spec-row hseries-only"><div class="label">Sending Cards needed:</div><div class="value" id="ctrl_sending">--</div></div>
            <div class="spec-row"><div class="label">Inter-cabinet Short Ethernet:</div><div class="value" id="ctrl_shorteth">--</div></div>
            <div class="spec-row"><div class="label">Max Power (Est.):</div><div class="value" id="spec_power">--</div></div>
            <div class="spec-row"><div class="label">Total Weight (Est.):</div><div class="value" id="spec_weight">--</div></div>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <button class="primary" id="downloadPdfBtn" onclick="openContactModal()">Download PDF</button>
            <button class="secondary" onclick="downloadBOQCSV()">Download Excel (CSV)</button>
          </div>
        </div>
      </div>
    </div>

    <div id="boqPreviewContainer" style="margin-top:18px"></div>

    <footer class="page-footer">© 2025 PeopleLink Unified Communications Pvt. Ltd.</footer>
  </div>

  <div class="modal" id="controllerModal">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700;color:var(--brand)">Edit Control System Components</div>
        <button onclick="closeControllerModal()" class="secondary">Close</button>
      </div>

      <div class="modal-row">
        <div>
          <label class="form-label">Controller/Processor Model</label>
          <select id="modalControllerModel" onchange="onModalControllerChange()"></select>
        </div>
        <div>
          <label class="form-label">Splicer Frame / Solution</label>
          <input type="text" id="modalSplicerSolution" />
        </div>
      </div>

      <div class="modal-row">
        <div>
          <label class="form-label">Output (Sending) Card Model</label>
          <select id="modalOutputCardModel" onchange="updatePortsFromOutputCard()"></select>
        </div>
        <div>
          <label class="form-label">Max Ports per Output Card</label>
          <input id="modalMaxPortsPerCard" readonly />
        </div>
      </div>

      <div class="modal-row">
        <div>
          <label class="form-label">Input Card Model</label>
          <select id="modalInputCardModel"></select>
        </div>
        <div>
          <label class="form-label">Input Card Quantity</label>
          <input type="number" id="modalInputCardQty" min="1" value="2" />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:10px;">
        <button class="secondary" onclick="closeControllerModal()">Cancel</button>
        <button class="primary" style="margin-left:8px" onclick="applyModalChanges()">Apply</button>
      </div>
    </div>
  </div>

  <div class="modal" id="contactModal">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700;color:var(--brand)">Contact (optional) — added to PDF metadata</div>
        <button onclick="closeContactModal()" class="secondary">Close</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label class="form-label">Email</label>
          <input type="email" id="downloadEmail" placeholder="you@company.com" />
        </div>
        <div>
          <label class="form-label">Phone</label>
          <input type="tel" id="downloadPhone" placeholder="+91..." />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="secondary" onclick="closeContactModal()">Cancel</button>
        <button class="primary" onclick="handleDownloadRequest()">Download PDF</button>
      </div>
      <div id="contactError" style="color:#b71c1c;margin-top:8px;display:none"></div>
    </div>
  </div>

  <script>
    /************************************************************************
     * Data: LED products, controllers, parts catalog
     ************************************************************************/
    const MM_PER_METER = 1000;
    const MM_PER_INCH = 25.4;
    const MM_PER_FOOT = MM_PER_INCH * 12;
    const PIXELS_PER_PORT_DEFAULT = 650000;
    const GLOBAL_PORT_BUFFER_PCT = 0.05;
    const POWER_BUFFER = 1.15;
    const WEIGHT_BUFFER = 1.15;
    const MARGIN_PERCENT_TEXT = "15%";

    const LED_PRODUCTS = {
      'cob_09': { name:"PeopleLink COB (0.9375mm)", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, nits_range:"600-1000", maxPower_W_m2:300 },
      'cob_125': { name:"PeopleLink COB (1.25mm)", pitch_mm:1.25, cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
      'cob_15': { name:"PeopleLink COB (1.5625mm)", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
      'indoor_186': { name:"PeopleLink SMD Indoor (1.86mm)", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      'indoor_20': { name:"PeopleLink SMD Indoor (2.0mm)", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      'indoor_25': { name:"PeopleLink SMD Indoor (2.5mm)", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      'outdoor_40': { name:"PeopleLink SMD Outdoor (4.0mm)", pitch_mm:4.0, cabW_mm:960, cabH_mm:960, cabPixW:240, cabPixH:240, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
      'outdoor_667': { name:"PeopleLink SMD Outdoor (6.67mm)", pitch_mm:6.67, cabW_mm:960, cabH_mm:960, cabPixW:144, cabPixH:144, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
      'outdoor_80': { name:"PeopleLink SMD Outdoor (8.0mm)", pitch_mm:8.0, cabW_mm:960, cabH_mm:960, cabPixW:120, cabPixH:120, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 }
    };

    const CONTROLLER_MODELS = [
      { name:"TB40", type:"Multimedia", ports:2, maxPixels:1300000, priority:1 },
      { name:"TB60", type:"Multimedia", ports:4, maxPixels:2300000, priority:2 },
      { name:"VX400 Pro / DSP400 Pro", type:"All-in-One", ports:4, maxPixels:2600000, priority:3 },
      { name:"VX600 Pro / DSP600 Pro", type:"All-in-One", ports:6, maxPixels:3900000, priority:4 },
      { name:"VX1000 Pro / DSP1000 Pro", type:"All-in-One", ports:10, maxPixels:6500000, priority:5 },
      { name:"4K Prime", type:"All-in-One", ports:16, maxPixels:10400000, priority:6 },
      { name:"H2", type:"Modular", ports:20, maxPixels:26000000, maxSendCards:2, priority:7 },
      { name:"H5", type:"Modular", ports:20, maxPixels:39000000, maxSendCards:3, priority:8 },
      { name:"H9", type:"Modular", ports:20, maxPixels:65000000, maxSendCards:6, priority:9 },
      { name:"H15", type:"Modular", ports:20, maxPixels:130000000, maxSendCards:12, priority:10 },
      { name:"H20", type:"Modular", ports:20, maxPixels:260000000, maxSend...
// ... (rest of CONTROLLER_MODELS array)
    ];
    
    // ... (PARTS_CATALOG, CABINETS_PER_LONG_LAN, etc.)

    /************************************************************************
     * Calculation Core
     ************************************************************************/
    function calculateLEDWall(){
      const productKey = document.getElementById('productModel').value;
      const unit = document.getElementById('unit').value;
      const widthInput = parseFloat(document.getElementById('width').value);
      const heightInput = parseFloat(document.getElementById('height').value);
      const diagonalInput = parseFloat(document.getElementById('diagonal').value);
      const aspectRatioKey = document.getElementById('aspectRatio').value;

      const err = document.getElementById('errorMessage');
      err.style.display='none';
      if(!productKey || !unit || ((unit!=='inches' && !(widthInput||heightInput)) || (unit==='inches' && !diagonalInput))){
        err.textContent = 'ERROR: Select model, unit and enter valid dimensions.';
        err.style.display='block';
        return null;
      }
      
      // ... (dimension and cabinet calculation logic)

      // Control Calculations
      const pixelsPerPort = suggested.type === 'Modular' ? 1300000 : PIXELS_PER_PORT_DEFAULT;
      const requiredPortsRaw = totalPixels / pixelsPerPort;
      const requiredPortsBuffered = requiredPortsRaw * (1 + GLOBAL_PORT_BUFFER_PCT);
      const requiredPortsCeiling = Math.ceil(requiredPortsBuffered); // <-- ADDED: Logic to round up for physical ports

      // find suggested controller
      let suggested = CONTROLLER_MODELS.find(c => {
          // Modular controllers are selected primarily by max pixels, then refined below for send cards
          if(c.type === 'Modular'){
              // modular handles many ports - but we still try to match by pixels
              return c.maxPixels >= totalPixels;
          } else {
              // CORRECTED: Compare controller ports (c.ports) against the required integer port count (requiredPortsCeiling)
              return c.maxPixels >= totalPixels && c.ports >= requiredPortsCeiling;
          }
      }) || CONTROLLER_MODELS[CONTROLLER_MODELS.length-1];

      // if modular candidate requiredSendCards calc
      const outputCardPorts_default = 20;
      // Use requiredPortsCeiling for Send Card calculation
      let requiredSendCards = Math.max(1, Math.ceil(requiredPortsCeiling / outputCardPorts_default)); 

      // If modular and selected H model can't support requiredSendCards, pick next H that can
      // ... (Modular controller refinement logic)

      // store
      finalCalculationData = {
        // ... (other data fields)
        totalPixels,
        aspectRatioText,
        finalDiagonal_in,
        pixelDensity,
        actualPowerW,
        designPowerW,
        actualWeight,
        designWeight,
        requiredPortsBuffered,
        requiredPortsCeiling, // <-- ADDED to store the integer value
        requiredShortEthernet,
        requiredLongEthRuns,
        requiredSendCards,
        controllerName: finalCalculationData.controllerOverrideName || suggested.name,
        // ... (rest of finalCalculationData)
      };
      return finalCalculationData;
    }

    /************************************************************************
     * Visualization & UI update
     ************************************************************************/
    function updateSpecPanel(data){
      // ... (other update logic)

      // Control Summary
      document.getElementById('ctrl_name').textContent = data.controllerName;
      // UPDATED: Display the ceiling value, with the buffered float in parenthesis
      document.getElementById('ctrl_ports').textContent = `${data.requiredPortsCeiling} Ports (${data.requiredPortsBuffered.toFixed(2)} buffered)`; 
      
      // ... (rest of updateSpecPanel logic)
    }
    
    // ... (rest of the script)

  </script>
</body>
</html>
