<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PeopleLink LED Video Wall Configuration Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* PAGE */
    :root{--brand:#0D47A1;--accent:#B71C1C;--muted:#6b7280}
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 28px; background: #eef6fb; color: #1c2738; font-size: 14px; -webkit-font-smoothing:antialiased; }
    .main-wrapper { max-width: 1200px; margin: auto; position: relative; } /* MODIFIED: Added position: relative for logo */

    /* HEADER */
    h2 { text-align: center; color: var(--brand); margin-top: 0; margin-bottom: 18px; font-weight:700; font-size:1.6rem; }
    
    /* Logo Styling */
    #brandLogo { 
        position: absolute; 
        top: 28px; 
        left: 28px; 
        height: 32px; 
        width: auto; 
        max-width: 180px; 
    }

    /* PANELS */
    .panel-grid { display:grid; grid-template-columns:1fr 1fr; gap:22px; align-items:start; }
    .input-panel, .details-panel { background:#fff; padding:20px;border-radius:10px; box-shadow:0 4px 18px rgba(8,20,40,0.06); }

    /* FORM */
    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    label.form-label { font-weight:600; color:var(--brand); display:block; margin-bottom:6px; }
    input[type="number"], input[type="text"], select, input[type="email"], input[type="tel"] { width:100%; padding:9px 10px; border-radius:6px; border:1px solid #e6eef6; box-sizing:border-box; font-size:14px; }
    .controls { display:flex; gap:12px; align-items:center; margin-top:12px; }
    button.primary { background:var(--brand); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:700; }
    button.secondary { background:#f3f6fb; color:var(--brand); border:1px solid #e6eef6; padding:9px 12px; border-radius:8px; cursor:pointer; font-weight:600; }

    /* SPEC & CONTROL PANELS - layout like your 2nd format */
    .specs, .control-summary { padding:18px; border-radius:8px; background:#f6fbff; border:1px solid rgba(13,71,161,0.06); }
    .panel-title { color:var(--brand); font-weight:700; font-size:1.05rem; margin-bottom:10px; }
    .spec-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px dotted rgba(0,0,0,0.06); }
    .spec-row .label { color:var(--brand); font-weight:700; min-width:250px; }
    .spec-row .value { color:var(--accent); font-weight:700; text-align:right; }

    /* Visualization */
    .viz-wrap { margin-top:16px; }
    .viz-box { border-radius:8px; background:#fff; padding:12px; border:1px solid #e6eef6; }
    .vis-grid { 
      position:relative; 
      width:100%; 
      max-width: 70%; /* MODIFIED: Max 70% width */
      height:280px; 
      border:3px solid rgba(13,71,161,0.12); 
      background:linear-gradient(180deg,#eaf4ff,#e5f2ff); 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      overflow:hidden; 
      box-sizing:border-box; 
      margin: 0 auto; /* MODIFIED: Center the grid */
    }
    #cabinetOverlay { position:absolute; inset:0; display:grid; box-sizing:border-box; grid-gap:0; padding:4px; }
    #cabinetOverlay > div { box-sizing:border-box; border:2px solid rgba(13,71,161,0.18); display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02)); transition:transform .08s ease, background .12s; }
    #cabinetOverlay > div:hover { transform:translateY(-3px); background:rgba(13,71,161,0.03); }
    .cab-label { font-size:12px; background:rgba(255,255,255,0.92); padding:2px 6px; border-radius:4px; color:var(--brand); font-weight:700; }

    /* BOQ preview */
    #boqPreviewTable { width:100%; border-collapse:collapse; margin-top:14px; font-size:13px; }
    #boqPreviewTable th, #boqPreviewTable td { border:1px solid #e6eef6; padding:8px 6px; text-align:left; }
    #boqPreviewTable th { background:linear-gradient(90deg, rgba(13,71,161,0.06), rgba(27,94,32,0.02)); color:var(--brand); font-weight:700; }

    /* small helpers */
    .muted { color:#6b7280; font-size:0.92rem; }
    .right { text-align:right; }
    .hidden { display:none !important; }
    footer.page-footer { text-align:center; margin-top:18px; color:#8fa6c8; font-size:13px; }

    /* modal */
    .modal { position:fixed; inset:0; display:none; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center; }
    .modal .modal-card { width:92%; max-width:720px; background:#fff; padding:18px; border-radius:10px; box-shadow:0 10px 40px rgba(6,25,57,0.12); }
    .modal .modal-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:10px; }
    .modal .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }

    /* responsive */
    @media (max-width:980px){ .panel-grid{grid-template-columns:1fr} .form-grid{grid-template-columns:1fr} .vis-grid{height:220px} }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <img id="brandLogo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0EQVQYVwXAAgAAAoABg9/yDQQAAAASUVORK5CYII=" alt="PeopleLink Logo Placeholder" />
    
    <h2>PeopleLink LED Video Wall Configuration Calculator</h2>

    <div class="panel-grid">
      <div class="input-panel">
        <div style="font-weight:700;color:var(--brand);margin-bottom:10px">Configure Wall</div>

        <div class="form-grid">
          <div>
            <label class="form-label">LED Model / Pixel Pitch</label>
            <select id="productModel">
              <option value="">Select LED Model</option>
              <optgroup label="COB (600x337.5mm)">
                <option value="cob_09">0.9375 mm</option>
                <option value="cob_125">1.25 mm</option>
                <option value="cob_15">1.5625 mm</option>
              </optgroup>
              <optgroup label="SMD Indoor (640x480mm)">
                <option value="indoor_186">1.86 mm</option>
                <option value="indoor_20">2.0 mm</option>
                <option value="indoor_25">2.5 mm</option>
              </optgroup>
              <optgroup label="SMD Outdoor (960x960mm)">
                <option value="outdoor_40">4.0 mm</option>
                <option value="outdoor_667">6.67 mm</option>
                <option value="outdoor_80">8.0 mm</option>
              </optgroup>
            </select>
          </div>

          <div>
            <label class="form-label">Unit</label>
            <select id="unit" onchange="toggleMeasurementFields()">
              <option value="">Select unit</option>
              <option value="meters">Meters (m)</option>
              <option value="feet">Feet (ft)</option>
              <option value="inches">Inches - Diagonal</option>
            </select>
          </div>

          <div id="widthGroup">
            <label class="form-label" id="widthLabel">Desired Width (m)</label>
            <input type="number" id="width" placeholder="Enter width" min="0.1" step="0.01" />
          </div>

          <div id="heightGroup">
            <label class="form-label" id="heightLabel">Desired Height (m)</label>
            <input type="number" id="height" placeholder="Enter height" min="0.1" step="0.01" />
          </div>

          <div id="diagonalGroup" class="hidden">
            <label class="form-label" id="diagonalLabel">Diagonal (inches)</label>
            <input type="number" id="diagonal" placeholder="Diagonal inches" min="10" step="1" />
          </div>

          <div>
            <label class="form-label">Target Aspect Ratio (optional)</label>
            <select id="aspectRatio">
              <option value="">Auto with major</option> <option value="16:9">16:9</option>
              <option value="16:10">16:10</option>
              <option value="4:3">4:3</option>
              <option value="2:1">2:1</option>   <option value="3:2">3:2</option>   <option value="21:9">21:9</option>
              <option value="1:1">1:1</option>
            </select>
          </div>

          <div style="align-self:end;">
            <div class="controls">
              <button class="primary" id="calcBtn" onclick="showVisualization()">Calculate & Visualize</button>
              <button class="secondary" id="resetBtn" onclick="resetForm()">Reset</button>
            </div>
          </div>
        </div>

        <div id="errorMessage" class="muted" style="margin-top:10px; color: #b71c1c; display:none;"></div>

        <div class="viz-wrap">
          <div class="viz-box">
            <div style="font-weight:700;color:var(--brand);margin-bottom:8px">Physical Wall Visualization</div>
            <div class="vis-grid" id="visGrid">
              <div id="cabinetOverlay" aria-hidden="true"></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:10px">
              <div class="muted">Hover a cabinet to view its label</div>
              <div class="muted" id="visDimensions"></div>
            </div>
          </div>
        </div>

      </div>

      <div style="display:flex;flex-direction:column;gap:18px">
        <div class="details-panel specs">
          <div class="panel-title">LED Wall Specifications</div>

          <div id="specRows">
            <div class="spec-row"><div class="label">Model:</div><div class="value" id="spec_model">--</div></div>
            <div class="spec-row"><div class="label">Pixel Pitch:</div><div class="value" id="spec_pitch">--</div></div>
            <div class="spec-row"><div class="label">Actual Final Dimensions (WxH):</div><div class="value" id="spec_dims">--</div></div>
            <div class="spec-row"><div class="label">Actual Final Resolution (WxH):</div><div class="value" id="spec_res">--</div></div>
            <div class="spec-row"><div class="label">Final Diagonal:</div><div class="value" id="spec_diag">--</div></div>
            <div class="spec-row"><div class="label">Pixel Density:</div><div class="value" id="spec_density">--</div></div>
            <div class="spec-row"><div class="label">Final Area:</div><div class="value" id="spec_area">--</div></div>
            <div class="spec-row"><div class="label">Total Pixels:</div><div class="value" id="spec_total_pixels">--</div></div>
            <div class="spec-row"><div class="label">Total Cabinets:</div><div class="value" id="spec_cabs">--</div></div>
            <div class="spec-row"><div class="label">Total Modules Required:</div><div class="value" id="spec_modules">--</div></div>
            <div class="spec-row"><div class="label">Cabinet Size (WxH):</div><div class="value" id="spec_cabsize">--</div></div>
            <div class="spec-row"><div class="label">Cabinet Pixels (WxH):</div><div class="value" id="spec_cabpix">--</div></div>
          </div>
        </div>

        <div class="details-panel control-summary">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="panel-title">Control & Connection Summary</div>
            <button class="secondary" style="font-size:13px" onclick="openControllerModal()">Edit</button>
          </div>

          <div style="margin-top:10px" id="controlRows">
            <div class="spec-row"><div class="label">Suggested Controller:</div><div class="value" id="ctrl_name">--</div></div>
            <div class="spec-row hseries-only"><div class="label">Sending Cards needed:</div><div class="value" id="ctrl_sending">--</div></div>
            <div class="spec-row"><div class="label">Long Ethernet Cables (Input) / Ports:</div><div class="value" id="ctrl_longeth_combined">--</div></div>
            <div class="spec-row"><div class="label">Inter-cabinet Short Ethernet:</div><div class="value" id="ctrl_shorteth">--</div></div>
            <div class="spec-row"><div class="label">Max Power (Est.):</div><div class="value" id="spec_power">--</div></div>
            <div class="spec-row"><div class="label">Total Weight (Est.):</div><div class="value" id="spec_weight">--</div></div>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <button class="primary" id="downloadPdfBtn" onclick="openContactModal()">Download PDF</button>
            <button class="secondary" onclick="downloadBOQCSV()">Download Excel (CSV)</button>
          </div>
        </div>
      </div>
    </div>

    <div id="boqPreviewContainer" style="margin-top:18px"></div>

    <footer class="page-footer">© 2025 PeopleLink Unified Communications Pvt. Ltd.</footer>
  </div>

  <div class="modal" id="controllerModal">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700;color:var(--brand)">Edit Control System Components</div>
        <button onclick="closeControllerModal()" class="secondary">Close</button>
      </div>

      <div class="modal-row">
        <div>
          <label class="form-label">Controller/Processor Model</label>
          <select id="modalControllerModel" onchange="onModalControllerChange()"></select>
        </div>
        <div>
          <label class="form-label">Splicer Frame / Solution</label>
          <input type="text" id="modalSplicerSolution" />
        </div>
      </div>

      <div class="modal-row">
        <div>
          <label class="form-label">Output (Sending) Card Model</label>
          <select id="modalOutputCardModel" onchange="updatePortsFromOutputCard()"></select>
        </div>
        <div>
          <label class="form-label">Max Ports per Output Card</label>
          <input id="modalMaxPortsPerCard" readonly />
        </div>
      </div>

      <div class="modal-row">
        <div>
          <label class="form-label">Input Card Model</label>
          <select id="modalInputCardModel"></select>
        </div>
        <div>
          <label class="form-label">Input Card Quantity</label>
          <input type="number" id="modalInputCardQty" min="1" value="2" />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:10px;">
        <button class="secondary" onclick="closeControllerModal()">Cancel</button>
        <button class="primary" style="margin-left:8px" onclick="applyModalChanges()">Apply</button>
      </div>
    </div>
  </div>

  <div class="modal" id="contactModal">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700;color:var(--brand)">Contact (optional) — added to PDF metadata</div>
        <button onclick="closeContactModal()" class="secondary">Close</button>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label class="form-label">Email</label>
          <input type="email" id="downloadEmail" placeholder="you@company.com" />
        </div>
        <div>
          <label class="form-label">Phone</label>
          <input type="tel" id="downloadPhone" placeholder="+91..." />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="secondary" onclick="closeContactModal()">Cancel</button>
        <button class="primary" onclick="handleDownloadRequest()">Download PDF</button>
      </div>
      <div id="contactError" style="color:#b71c1c;margin-top:8px;display:none"></div>
    </div>
  </div>

  <script>
    /************************************************************************
     * Data: LED products, controllers, parts catalog
     ************************************************************************/
    const MM_PER_METER = 1000;
    const MM_PER_FOOT = 304.8;
    const MM_PER_INCH = 25.4;
    const PIXELS_PER_PORT_DEFAULT = 650000;
    const GLOBAL_PORT_BUFFER_PCT = 0.05;
    const POWER_BUFFER = 1.15;
    const WEIGHT_BUFFER = 1.15;
    const MARGIN_PERCENT_TEXT = "15%";
    
    // START OF LOGO ADDITION - REPLACE '' WITH YOUR BASE64 DATA STRING
    const LOGO_DATA_URL = ''; 
    // END OF LOGO ADDITION

    const LED_PRODUCTS = {
      'cob_09': { name:"PeopleLink COB (0.9375mm)", pitch_mm:0.9375, cabW_mm:600, cabH_mm:337.5, cabPixW:640, cabPixH:360, modulesPerCab:8, weight_kg:4.6, nits_range:"600-1000", maxPower_W_m2:300 },
      'cob_125': { name:"PeopleLink COB (1.25mm)", pitch_mm:1.25, cabW_mm:600, cabH_mm:337.5, cabPixW:480, cabPixH:270, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
      'cob_15': { name:"PeopleLink COB (1.5625mm)", pitch_mm:1.5625, cabW_mm:600, cabH_mm:337.5, cabPixW:384, cabPixH:216, modulesPerCab:8, weight_kg:4.6, nits_range:"600-800", maxPower_W_m2:300 },
      'indoor_186': { name:"PeopleLink SMD Indoor (1.86mm)", pitch_mm:1.86, cabW_mm:640, cabH_mm:480, cabPixW:344, cabPixH:258, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      'indoor_20': { name:"PeopleLink SMD Indoor (2.0mm)", pitch_mm:2.0, cabW_mm:640, cabH_mm:480, cabPixW:320, cabPixH:240, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      'indoor_25': { name:"PeopleLink SMD Indoor (2.5mm)", pitch_mm:2.5, cabW_mm:640, cabH_mm:480, cabPixW:256, cabPixH:192, modulesPerCab:6, weight_kg:6.24, nits_range:"450-600", maxPower_W_m2:560 },
      'outdoor_40': { name:"PeopleLink SMD Outdoor (4.0mm)", pitch_mm:4.0, cabW_mm:960, cabH_mm:960, cabPixW:240, cabPixH:240, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
      'outdoor_667': { name:"PeopleLink SMD Outdoor (6.67mm)", pitch_mm:6.67, cabW_mm:960, cabH_mm:960, cabPixW:144, cabPixH:144, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 },
      'outdoor_80': { name:"PeopleLink SMD Outdoor (8.0mm)", pitch_mm:8.0, cabW_mm:960, cabH_mm:960, cabPixW:120, cabPixH:120, modulesPerCab:18, weight_kg:8.28, nits_range:"4500-5000", maxPower_W_m2:937.5 }
    };

    const CONTROLLER_MODELS = [
      { name:"TB40", type:"Multimedia", ports:2, maxPixels:1300000, priority:1 },
      { name:"TB60", type:"Multimedia", ports:4, maxPixels:2300000, priority:2 },
      { name:"VX400 Pro / DSP400 Pro", type:"All-in-One", ports:4, maxPixels:2600000, priority:3 },
      { name:"VX600 Pro / DSP600 Pro", type:"All-in-One", ports:6, maxPixels:3900000, priority:4 },
      { name:"VX1000 Pro / DSP1000 Pro", type:"All-in-One", ports:10, maxPixels:6500000, priority:5 },
      { name:"4K Prime", type:"All-in-One", ports:16, maxPixels:10400000, priority:6 },
      { name:"H2", type:"Modular", ports:20, maxPixels:26000000, maxSendCards:2, priority:7 },
      { name:"H5", type:"Modular", ports:20, maxPixels:39000000, maxSendCards:3, priority:8 },
      { name:"H9", type:"Modular", ports:20, maxPixels:65000000, maxSendCards:6, priority:9 },
      { name:"H15", type:"Modular", ports:20, maxPixels:130000000, maxSendCards:12, priority:10 },
      { name:"H20", type:"Modular", ports:20, maxPixels:260000000, maxSendCards:20, priority:11 }
    ];

    // basic parts catalogue from spreadsheet image
    const PARTS_CATALOG = {
      'TB40': { part:'TP-VWC-NS-TB40', desc:'LED Video Wall Controller: TB40' },
      'TB60': { part:'TP-VWC-NS-TB60', desc:'LED Video Wall Controller: TB60' },
      'VX400': { part:'TP-VWC-NS-VX400', desc:'LED Video Wall Controller: VX400 Pro' },
      'VX600': { part:'TP-VWC-NS-VX600', desc:'LED Video Wall Controller: VX600 Pro' },
      'H2': { part:'TP-XMF-H2', desc:'LED Video Wall Controller (H2)' },
      'H5': { part:'TP-XMF-H5', desc:'LED Video Wall Controller (H5)' },
      'H9': { part:'TP-XMF-H9', desc:'LED Video Wall Controller (H9)' },
      'H15': { part:'TP-XMF-H15', desc:'LED Video Wall Controller (H15)' },
      'H15E': { part:'TP-XMF-H15E', desc:'LED Video Wall Controller (H15 Enhanced)' },
      'H20': { part:'TBD', desc:'LED Video Wall Controller (H20)' },

      'H_20_RJ45': { part:'TP-XOC-RJ45-20', desc:'H_20 x RJ45 Sending Card' },
      'H_16_RJ45': { part:'TP-XOC-RJ45-16-OF2', desc:'H_16 x RJ45 + 2x Fiber Sending Card' },
      'H_4_HDMI_Out': { part:'TP-XOC-HDMI4', desc:'H_4 x HDMI Output Card' },

      'H_1xHDMI': { part:'TP-XIC-HDMI', desc:'H_1 x HDMI 2.0 Input Card' },
      'H_2xHDMI': { part:'TP-XIC-HDMI2', desc:'H_2 x HDMI 2.0 Input Card' },
      'H_4xHDMI': { part:'TP-XIC-HDMI4', desc:'H_4 x HDMI Input Card' },

      'H_800W_PSU': { part:'TP-XPS-H800W', desc:'H_800W Power Supply' },

      'PPL-COB-09': { part:'PPL-COB-MDL-CU-09', desc:'PeopleLink Active LED | 0.9PP COB (Including Modules)' },
      'PPL-COB-125': { part:'PPL-COB-MDL-CU-12', desc:'PeopleLink Active LED | 1.25PP COB (Including Modules)' },
      'PPL-COB-156': { part:'PPL-COB-MDL-CU-15', desc:'PeopleLink Active LED | 1.56PP COB (Including Modules)' }, // MODIFIED: Corrected part from CU-12 to CU-15

      'PPL-SMD-18': { part:'PPL-SMD-MDL-CU-18', desc:'PeopleLink ActiveLED | 1.8PP Video LED Cabinets (Including Modules)' },
      'PPL-ALD-CU': { part:'PPL-ALD-CU', desc:'PeopleLink ActiveLED | Video Wall Cabinet Unit (640x480mm)' },

      'ALED-INST-IN': { part:'ALED-INST-IN', desc:'Installation & Configuration - Indoor' },
      'ALED-TRS-IN-REG': { part:'ALED-TRS-IN-REG', desc:'Transportation (No. of Cabinets) - Indoor' }
    };

    // Cabinets-per-long-LAN mapping (cob_15 is 7 as requested)
    const CABINETS_PER_LONG_LAN = {
      'cob_09': 2,
      'cob_125': 5,
      'cob_15': 7
    };

    /************************************************************************
     * Globals
     ************************************************************************/
    let finalCalculationData = {};
    let contactInfo = { email:'', phone:'' };

    /************************************************************************
     * Utils
     ************************************************************************/
    function gcd(a,b){ return b===0 ? a : gcd(b, a%b); }
    function fmt(n, d=0){ return Number(n).toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d}); }
    
    // Custom formatLarge to handle total pixels and density without K/M suffix, using commas.
    function formatLarge(n){
      return n.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }
    
    // Convert m² to sq.ft
    function m2ToSqFt(m2) {
      return m2 * 10.7639;
    }

    /************************************************************************
     * Populate modal selects + initialization
     ************************************************************************/
    function populateModalControllers(){
      const sel = document.getElementById('modalControllerModel');
      sel.innerHTML = '';
      CONTROLLER_MODELS.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = `${c.name} (${c.type})`;
        sel.appendChild(opt);
      });
    }
    function populateModalOutputCards(){
      const sel = document.getElementById('modalOutputCardModel');
      sel.innerHTML = '';
      const cards = [
        { model:'H_20_RJ45', ports:20 },
        { model:'H_16_RJ45', ports:16 },
        { model:'H_4_HDMI_Out', ports:4 }
      ];
      cards.forEach(c=>{
        const o = document.createElement('option');
        o.value = `${c.model}|${c.ports}`;
        o.textContent = `${c.model} (${c.ports} ports)`;
        sel.appendChild(o);
      });
    }
    function populateModalInputCards(){
      const sel = document.getElementById('modalInputCardModel');
      sel.innerHTML = '';
      const items = ['H_1xHDMI','H_2xHDMI','H_4xHDMI'];
      items.forEach(m=>{
        const o = document.createElement('option');
        o.value = m;
        o.textContent = PARTS_CATALOG[m] ? PARTS_CATALOG[m].desc : m;
        sel.appendChild(o);
      });
    }

    function updatePortsFromOutputCard(){
      const val = document.getElementById('modalOutputCardModel').value;
      if(!val) return;
      const parts = val.split('|');
      document.getElementById('modalMaxPortsPerCard').value = parts[1] || '';
    }

    /************************************************************************
     * Calculation
     ************************************************************************/
    function toggleMeasurementFields(){
      const unit = document.getElementById('unit').value;
      const diag = unit === 'inches';
      document.getElementById('widthGroup').classList.toggle('hidden', diag);
      document.getElementById('heightGroup').classList.toggle('hidden', diag);
      document.getElementById('diagonalGroup').classList.toggle('hidden', !diag);
      const unitText = unit === 'feet' ? ' (ft)' : unit === 'inches' ? ' (in)' : ' (m)';
      document.getElementById('widthLabel').textContent = 'Desired Width' + unitText;
      document.getElementById('heightLabel').textContent = 'Desired Height' + unitText;
    }

    function calculateLEDWall(){
      const productKey = document.getElementById('productModel').value;
      const unit = document.getElementById('unit').value;
      const widthInput = parseFloat(document.getElementById('width').value || 0);
      const heightInput = parseFloat(document.getElementById('height').value || 0);
      const diagonalInput = parseFloat(document.getElementById('diagonal').value || 0);
      const aspectRatioKey = document.getElementById('aspectRatio').value;
      
      const err = document.getElementById('errorMessage');
      err.style.display='none';

      if(!productKey || !unit || ((unit!=='inches' && !(widthInput||heightInput)) || (unit==='inches' && !diagonalInput))){
        err.textContent = 'ERROR: Select model, unit and enter valid dimensions.';
        err.style.display='block';
        return null;
      }

      const details = LED_PRODUCTS[productKey];
      let desiredW_mm=0, desiredH_mm=0;

      if(unit === 'inches'){
        const ratio = aspectRatioKey || '16:9';
        const [rw,rh] = ratio.split(':').map(Number);
        const diagRatio = Math.sqrt(rw*rw + rh*rh);
        const factor = diagonalInput / diagRatio;
        desiredW_mm = rw * factor * MM_PER_INCH;
        desiredH_mm = rh * factor * MM_PER_INCH;
      } else {
        const unitFactor = unit === 'meters' ? MM_PER_METER : MM_PER_FOOT;
        if(aspectRatioKey){
          const [rw,rh] = aspectRatioKey.split(':').map(Number);
          if(widthInput){
            desiredW_mm = widthInput * unitFactor;
            desiredH_mm = (widthInput / rw) * rh * unitFactor;
          } else if(heightInput){
            desiredH_mm = heightInput * unitFactor;
            desiredW_mm = (heightInput / rh) * rw * unitFactor;
          } else {
            desiredW_mm = widthInput * unitFactor;
            desiredH_mm = heightInput * unitFactor;
          }
        } else {
          // Auto sizing based on cabinet ratio if only one dimension is entered
          desiredW_mm = widthInput * unitFactor || (heightInput * (details.cabW_mm/details.cabH_mm) * unitFactor);
          desiredH_mm = heightInput * unitFactor || (widthInput * (details.cabH_mm/details.cabW_mm) * unitFactor);
        }
      }
      
      const numCabW = Math.max(1, Math.round(desiredW_mm / details.cabW_mm));
      const numCabH = Math.max(1, Math.round(desiredH_mm / details.cabH_mm));
      const totalCabinets = numCabW * numCabH;
      const totalModules = totalCabinets * details.modulesPerCab;

      const finalW_mm = numCabW * details.cabW_mm;
      const finalH_mm = numCabH * details.cabH_mm;
      const finalArea_m2 = (finalW_mm / MM_PER_METER) * (finalH_mm / MM_PER_METER);

      const finalResW = numCabW * details.cabPixW;
      const finalResH = numCabH * details.cabPixH;
      const totalPixels = finalResW * finalResH;
      
      const ratioG = gcd(finalResW, finalResH);
      const aspectRatioText = `${finalResW/ratioG}:${finalResH/ratioG}`;

      const finalDiagonal_in = Math.sqrt(finalW_mm*finalW_mm + finalH_mm*finalH_mm) / MM_PER_INCH;
      const pixelDensity = Math.round((totalPixels) / finalArea_m2); // px per m2

      // power & weight
      const actualPowerW = finalArea_m2 * details.maxPower_W_m2;
      const designPowerW = actualPowerW * POWER_BUFFER;
      const actualWeight = details.weight_kg * totalCabinets;
      const designWeight = actualWeight * WEIGHT_BUFFER;

      // Power Runs Calculation
      const powerWPerRun = 1000;
      const requiredPowerRuns = Math.max(1, Math.ceil(designPowerW / powerWPerRun));

      // port rules
      const pixelsPerPort = PIXELS_PER_PORT_DEFAULT;
      const ports_by_pixels = Math.max(1, Math.ceil(totalPixels / pixelsPerPort));
      
      const cabinetsRule = CABINETS_PER_LONG_LAN[productKey];
      let requiredLongEthRuns = 0;
      if(cabinetsRule){
        requiredLongEthRuns = Math.max(1, Math.ceil(totalCabinets / cabinetsRule));
      } else {
        requiredLongEthRuns = Math.max(1, ports_by_pixels);
      }
      
      let requiredPorts = Math.max(ports_by_pixels, requiredLongEthRuns);
      const requiredPortsBuffered = Math.max(1, Math.ceil(requiredPorts * (1 + GLOBAL_PORT_BUFFER_PCT)));
      const requiredShortEthernet = Math.max(0, totalCabinets - requiredPortsBuffered);

      // pick suggested controller: smallest that satisfies ports & pixels
      let suggested = CONTROLLER_MODELS.find(c => {
        if(c.type === 'Modular') { 
          // modular handles many ports - but we still try to match by pixels
          return c.maxPixels >= totalPixels;
        } else {
          return c.maxPixels >= totalPixels && c.ports >= requiredPortsBuffered;
        }
      });
      if(!suggested) suggested = CONTROLLER_MODELS.slice(-1)[0]; // Fallback to largest

      // Sending Cards logic for Modular controllers
      let requiredSendingCards = 0;
      if(suggested.type === 'Modular') {
        // Calculate required number of sending cards based on buffered ports and max card capacity (20 ports/card)
        const PORTS_PER_SENDING_CARD = 20; 
        requiredSendingCards = Math.min(suggested.maxSendCards, Math.max(1, Math.ceil(requiredPortsBuffered / PORTS_PER_SENDING_CARD)));
      }


      const calculatedData = {
        productKey,
        details,
        numCabW,
        numCabH,
        totalCabinets,
        totalModules,
        finalW_m: finalW_mm / MM_PER_METER,
        finalH_m: finalH_mm / MM_PER_METER,
        finalArea_m2,
        finalResW,
        finalResH,
        totalPixels,
        aspectRatioText,
        finalDiagonal_in,
        pixelDensity,
        actualPowerW,
        designPowerW,
        actualWeight,
        designWeight,
        requiredPowerRuns,
        requiredLongEthRuns,
        requiredShortEthernet,
        requiredPortsBuffered,
        suggestedController: suggested,
        requiredSendingCards
      };

      finalCalculationData = calculatedData;
      updateUI(calculatedData);
      return calculatedData;
    }

    /************************************************************************
     * UI Functions
     ************************************************************************/
    function updateUI(data){
      // Update Specs
      document.getElementById('spec_model').textContent = data.details.name;
      document.getElementById('spec_pitch').textContent = `${data.details.pitch_mm} mm`;
      document.getElementById('spec_dims').textContent = `${fmt(data.finalW_m, 3)} m x ${fmt(data.finalH_m, 3)} m`;
      document.getElementById('spec_res').textContent = `${formatLarge(data.finalResW)} x ${formatLarge(data.finalResH)}`;
      document.getElementById('spec_diag').textContent = `${fmt(data.finalDiagonal_in, 1)} inches`;
      document.getElementById('spec_density').textContent = `${formatLarge(data.pixelDensity)} px/m²`;
      document.getElementById('spec_area').textContent = `${fmt(data.finalArea_m2, 2)} m² / ${fmt(m2ToSqFt(data.finalArea_m2), 2)} sq.ft`;
      document.getElementById('spec_total_pixels').textContent = formatLarge(data.totalPixels);
      document.getElementById('spec_cabs').textContent = `${data.numCabW} x ${data.numCabH} = ${data.totalCabinets} pcs`;
      document.getElementById('spec_modules').textContent = formatLarge(data.totalModules);
      document.getElementById('spec_cabsize').textContent = `${data.details.cabW_mm} x ${data.details.cabH_mm} mm`;
      document.getElementById('spec_cabpix').textContent = `${data.details.cabPixW} x ${data.details.cabPixH} px`;
      document.getElementById('spec_power').textContent = `${fmt(data.actualPowerW, 0)}W (Actual) / ${fmt(data.designPowerW, 0)}W (Design)`;
      document.getElementById('spec_weight').textContent = `${fmt(data.actualWeight, 1)}kg (Actual) / ${fmt(data.designWeight, 1)}kg (Design)`;

      // Update Control
      const ctrl = data.suggestedController;
      document.getElementById('ctrl_name').textContent = `${ctrl.name} (${ctrl.type}, ${formatLarge(ctrl.maxPixels)} max pixels)`;
      document.getElementById('ctrl_sending').textContent = ctrl.type === 'Modular' ? `${data.requiredSendingCards} cards` : '--';
      
      // Update long eth: show runs (or ports needed) and the controller's capacity
      const longEthText = `${data.requiredLongEthRuns} Runs (min) / ${data.requiredPortsBuffered} Ports (Req) - ${ctrl.ports} Ports (Controller)`;
      document.getElementById('ctrl_longeth_combined').textContent = longEthText;
      document.getElementById('ctrl_shorteth').textContent = `${data.requiredShortEthernet} Short Cables`;

      // Toggle H-series specific row
      document.querySelectorAll('.hseries-only').forEach(el=>{
        el.style.display = ctrl.type === 'Modular' ? 'flex' : 'none';
      });

      // Update visualization dimensions
      document.getElementById('visDimensions').textContent = `${data.totalCabinets} Cabinets | ${fmt(data.finalW_m, 2)}m x ${fmt(data.finalH_m, 2)}m`;
      
      // Update BOQ preview
      generateBOQPreview(data);
    }

    function showVisualization(){
      const data = calculateLEDWall();
      if(!data) return;

      const overlay = document.getElementById('cabinetOverlay');
      overlay.innerHTML = '';
      overlay.style.gridTemplateColumns = `repeat(${data.numCabW}, 1fr)`;
      overlay.style.gridTemplateRows = `repeat(${data.numCabH}, 1fr)`;

      for (let r = 0; r < data.numCabH; r++) {
        for (let c = 0; c < data.numCabW; c++) {
          const cabIndex = r * data.numCabW + c + 1;
          const div = document.createElement('div');
          
          const label = document.createElement('span');
          label.className = 'cab-label';
          label.textContent = `Cab ${cabIndex}`;
          
          div.appendChild(label);
          overlay.appendChild(div);
        }
      }
    }

    function generateBOQPreview(data) {
      const container = document.getElementById('boqPreviewContainer');
      container.innerHTML = '<div style="font-weight:700;color:var(--brand);margin-bottom:8px">Bill of Quantities (BOQ) Preview</div>';

      const table = document.createElement('table');
      table.id = 'boqPreviewTable';
      table.innerHTML = `
        <thead>
          <tr>
            <th>Part Code</th>
            <th>Description</th>
            <th>Qty (pcs)</th>
            <th>Unit Price (INR)</th>
            <th>Total Price (INR)</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      `;
      container.appendChild(table);
      const tbody = table.querySelector('tbody');
      
      const isCob = data.productKey.startsWith('cob');
      let cabPartKey, cabDescKey;

      if(isCob) {
        if(data.productKey === 'cob_09') { cabPartKey = 'PPL-COB-09'; }
        else if(data.productKey === 'cob_125') { cabPartKey = 'PPL-COB-125'; }
        else if(data.productKey === 'cob_15') { cabPartKey = 'PPL-COB-156'; } // Uses PPL-COB-156 key
        cabDescKey = cabPartKey;
      } else {
        cabPartKey = 'PPL-ALD-CU'; // For SMD
        cabDescKey = data.productKey === 'indoor_186' ? 'PPL-SMD-18' : 'PPL-ALD-CU';
      }

      // Base items for the BOQ
      const boqItems = [];

      // 1. Cabinet Item (Primary Item)
      boqItems.push({
          part: PARTS_CATALOG[cabPartKey].part,
          desc: PARTS_CATALOG[cabDescKey].desc,
          qty: data.totalCabinets,
          unitPrice: '-', total: '-'
      });

      // 2. Controller
      const ctrl = data.suggestedController;
      let ctrlKey = ctrl.name.split(' ')[0]; // E.g., 'VX600' or 'H5'
      boqItems.push({
          part: PARTS_CATALOG[ctrlKey] ? PARTS_CATALOG[ctrlKey].part : ctrl.name,
          desc: PARTS_CATALOG[ctrlKey] ? PARTS_CATALOG[ctrlKey].desc : ctrl.name,
          qty: 1,
          unitPrice: '-', total: '-'
      });

      // 3. Sending Card (For Modular Systems)
      if(ctrl.type === 'Modular') {
        // Assume default H_20_RJ45 card for BOQ preview if not edited
        const cardModel = PARTS_CATALOG['H_20_RJ45'];
        boqItems.push({
          part: cardModel.part,
          desc: cardModel.desc,
          qty: data.requiredSendingCards,
          unitPrice: '-', total: '-'
        });
      }

      // 4. Spare Modules (assuming 1 per 10 cabinets, min 1)
      const spareModules = Math.max(1, Math.ceil(data.totalCabinets / 10)) * (data.details.modulesPerCab/data.numCabH); // crude estimation based on modules/row
      boqItems.push({
        part: `Module - ${data.details.pitch_mm}mm`,
        desc: `Spare LED Modules - ${data.details.pitch_mm}mm`,
        qty: Math.ceil(spareModules),
        unitPrice: '-', total: '-'
      });

      // 5. Installation & Configuration
      boqItems.push({
          part: PARTS_CATALOG['ALED-INST-IN'].part,
          desc: PARTS_CATALOG['ALED-INST-IN'].desc,
          qty: data.totalCabinets, // MODIFIED: Quantity is now total Cabinets
          unitPrice: '-', total: '-'
      });

      // 6. Transportation
      boqItems.push({
          part: PARTS_CATALOG['ALED-TRS-IN-REG'].part,
          desc: PARTS_CATALOG['ALED-TRS-IN-REG'].desc,
          qty: data.totalCabinets,
          unitPrice: '-', total: '-'
      });

      // 7. Cables (Power, Ethernet)
      boqItems.push({
          part: 'ALED-CBL-P',
          desc: 'Power Cables (Cabinet)',
          qty: data.totalCabinets,
          unitPrice: '-', total: '-'
      });
      boqItems.push({
          part: 'ALED-CBL-S-NET',
          desc: 'Short Ethernet Cables (Inter-cabinet)',
          qty: data.requiredShortEthernet,
          unitPrice: '-', total: '-'
      });
      boqItems.push({
          part: 'ALED-CBL-L-NET',
          desc: 'Long Ethernet Cables (Controller to Wall)',
          qty: data.requiredLongEthRuns,
          unitPrice: '-', total: '-'
      });

      boqItems.forEach(item => {
        const row = tbody.insertRow();
        row.insertCell().textContent = item.part;
        row.insertCell().textContent = item.desc;
        row.insertCell().textContent = item.qty;
        row.insertCell().textContent = item.unitPrice;
        row.insertCell().textContent = item.total;
      });
    }

    function createPdf(data) {
      if(!data || !data.totalCabinets) {
        alert('Please run the calculation first.');
        return;
      }
      
      const doc = new window.jspdf.jsPDF();

      // LOGO PLACEMENT FOR PDF
      const LOGO_PDF_WIDTH = 40; // mm
      const LOGO_PDF_HEIGHT = 10; // mm
      const LOGO_PDF_X = 14;
      const LOGO_PDF_Y = 10;

      if(LOGO_DATA_URL) {
          doc.addImage(
              LOGO_DATA_URL,
              'PNG',
              LOGO_PDF_X,
              LOGO_PDF_Y,
              LOGO_PDF_WIDTH,
              LOGO_PDF_HEIGHT
          );
      }
      // END LOGO PLACEMENT

      // Set Metadata
      doc.setProperties({
        title: 'PeopleLink LED Video Wall Configuration',
        subject: `Configuration for ${data.details.name}`,
        author: 'PeopleLink Calculator',
        keywords: 'LED, Video Wall, Configuration, BOQ',
        creator: 'PeopleLink Calculator',
        producer: 'PeopleLink Calculator',
      });
      
      // Header
      doc.setFontSize(16);
      doc.setTextColor(13, 71, 161); // brand color
      doc.text("PeopleLink LED Video Wall Configuration Calculator", 105, 22, { align: "center" }); // MODIFIED: Moved title down to 22
      doc.setFontSize(10);
      doc.text(`Generated: ${new Date().toLocaleDateString()} | Email: ${contactInfo.email || '-'} | Phone: ${contactInfo.phone || '-'}`, 105, 27, { align: "center" });

      let yPos = 35;
      
      // Wall Specifications Table
      doc.setFontSize(12);
      doc.setTextColor(13, 71, 161);
      doc.text("LED Wall Specifications", 14, yPos);
      yPos += 2;

      const specTableData = [
          ['Model:', data.details.name],
          ['Pixel Pitch:', `${data.details.pitch_mm} mm`],
          ['Actual Final Dimensions (WxH):', `${fmt(data.finalW_m, 3)} m x ${fmt(data.finalH_m, 3)} m`],
          ['Actual Final Resolution (WxH):', `${formatLarge(data.finalResW)} x ${formatLarge(data.finalResH)}`],
          ['Final Diagonal:', `${fmt(data.finalDiagonal_in, 1)} inches`],
          ['Pixel Density (px/m²):', formatLarge(data.pixelDensity)],
          ['Final Area:', `${fmt(data.finalArea_m2, 2)} m² / ${fmt(m2ToSqFt(data.finalArea_m2), 2)} sq.ft`],
          ['Total Pixels:', formatLarge(data.totalPixels)],
          ['Total Cabinets:', `${data.numCabW} x ${data.numCabH} = ${data.totalCabinets} pcs`],
          ['Cabinet Size (WxH):', `${data.details.cabW_mm} x ${data.details.cabH_mm} mm`],
          ['Cabinet Pixels (WxH):', `${data.details.cabPixW} x ${data.details.cabPixH} px`]
      ];

      doc.autoTable({
          startY: yPos,
          head: [['Specification', 'Value']],
          body: specTableData,
          theme: 'grid',
          styles: { fontSize: 10, cellPadding: 2, lineWidth: 0.1, lineColor: '#e6eef6' },
          headStyles: { fillColor: [243, 246, 251], textColor: [13, 71, 161], fontStyle: 'bold' },
          bodyStyles: { textColor: [0, 0, 0] },
          columnStyles: { 0: { fontStyle: 'bold', textColor: [13, 71, 161] }, 1: { halign: 'right' } },
          margin: { left: 14, right: 14 }
      });

      yPos = doc.autoTable.previous.finalY + 8;
      
      // Control & Connection Summary Table
      doc.setFontSize(12);
      doc.setTextColor(13, 71, 161);
      doc.text("Control & Connection Summary", 14, yPos);
      yPos += 2;

      const ctrl = data.suggestedController;
      const ctrlTableData = [
        ['Suggested Controller:', `${ctrl.name} (${ctrl.type})`],
        ['Total Ports Required (Buffered):', `${data.requiredPortsBuffered}`],
        ['Controller Ports (Max):', `${ctrl.ports}`],
        ['Long Ethernet Cables (Input Runs):', `${data.requiredLongEthRuns}`],
        ['Inter-cabinet Short Ethernet:', `${data.requiredShortEthernet}`],
        ['Max Power (Design):', `${fmt(data.designPowerW, 0)}W`],
        ['Total Weight (Design):', `${fmt(data.designWeight, 1)}kg`]
      ];
      if (ctrl.type === 'Modular') {
          ctrlTableData.splice(1, 0, ['Sending Cards needed:', `${data.requiredSendingCards} cards`]);
      }

      doc.autoTable({
          startY: yPos,
          head: [['Summary', 'Value']],
          body: ctrlTableData,
          theme: 'grid',
          styles: { fontSize: 10, cellPadding: 2, lineWidth: 0.1, lineColor: '#e6eef6' },
          headStyles: { fillColor: [243, 246, 251], textColor: [13, 71, 161], fontStyle: 'bold' },
          bodyStyles: { textColor: [0, 0, 0] },
          columnStyles: { 0: { fontStyle: 'bold', textColor: [13, 71, 161] }, 1: { halign: 'right' } },
          margin: { left: 14, right: 14 }
      });

      yPos = doc.autoTable.previous.finalY + 8;

      // Bill of Quantities (BOQ)
      doc.setFontSize(12);
      doc.setTextColor(13, 71, 161);
      doc.text("Bill of Quantities (BOQ)", 14, yPos);
      yPos += 2;
      
      const boqData = generateBOQDataForPdf(data);

      doc.autoTable({
          startY: yPos,
          head: [['Part Code', 'Description', 'Qty (pcs)', 'Unit Price (INR)', 'Total Price (INR)']],
          body: boqData.map(item => [item.part, item.desc, item.qty, item.unitPrice, item.total]),
          theme: 'grid',
          styles: { fontSize: 10, cellPadding: 2, lineWidth: 0.1, lineColor: '#e6eef6' },
          headStyles: { fillColor: [243, 246, 251], textColor: [13, 71, 161], fontStyle: 'bold' },
          bodyStyles: { textColor: [0, 0, 0] },
          columnStyles: { 2: { halign: 'center' }, 3: { halign: 'right' }, 4: { halign: 'right' } },
          margin: { left: 14, right: 14 }
      });


      doc.save(`PeopleLink_LED_Configuration_${data.productKey}.pdf`);
    }

    // New helper function to keep PDF logic clean and handle the BOQ Qty change.
    function generateBOQDataForPdf(data) {
      const isCob = data.productKey.startsWith('cob');
      let cabPartKey, cabDescKey;

      if(isCob) {
        if(data.productKey === 'cob_09') { cabPartKey = 'PPL-COB-09'; }
        else if(data.productKey === 'cob_125') { cabPartKey = 'PPL-COB-125'; }
        else if(data.productKey === 'cob_15') { cabPartKey = 'PPL-COB-156'; } // Uses PPL-COB-156 key
        cabDescKey = cabPartKey;
      } else {
        cabPartKey = 'PPL-ALD-CU'; // For SMD
        cabDescKey = data.productKey === 'indoor_186' ? 'PPL-SMD-18' : 'PPL-ALD-CU';
      }

      const boqItems = [];

      // 1. Cabinet Item (Primary Item)
      boqItems.push({
          part: PARTS_CATALOG[cabPartKey].part,
          desc: PARTS_CATALOG[cabDescKey].desc,
          qty: data.totalCabinets, unitPrice: '-', total: '-'
      });

      // 2. Controller
      const ctrl = data.suggestedController;
      let ctrlKey = ctrl.name.split(' ')[0]; 
      boqItems.push({
          part: PARTS_CATALOG[ctrlKey] ? PARTS_CATALOG[ctrlKey].part : ctrl.name,
          desc: PARTS_CATALOG[ctrlKey] ? PARTS_CATALOG[ctrlKey].desc : ctrl.name,
          qty: 1, unitPrice: '-', total: '-'
      });

      // 3. Sending Card (For Modular Systems)
      if(ctrl.type === 'Modular') {
        const cardModel = PARTS_CATALOG['H_20_RJ45'];
        boqItems.push({
          part: cardModel.part,
          desc: cardModel.desc,
          qty: data.requiredSendingCards, unitPrice: '-', total: '-'
        });
      }

      // 4. Spare Modules
      const spareModules = Math.max(1, Math.ceil(data.totalCabinets / 10)) * (data.details.modulesPerCab/data.numCabH);
      boqItems.push({
        part: `Module - ${data.details.pitch_mm}mm`,
        desc: `Spare LED Modules - ${data.details.pitch_mm}mm`,
        qty: Math.ceil(spareModules), unitPrice: '-', total: '-'
      });

      // 5. Installation & Configuration
      boqItems.push({
          part: PARTS_CATALOG['ALED-INST-IN'].part,
          desc: PARTS_CATALOG['ALED-INST-IN'].desc,
          qty: data.totalCabinets, // **MODIFIED: Qty set to totalCabinets**
          unitPrice: '-', total: '-'
      });

      // 6. Transportation
      boqItems.push({
          part: PARTS_CATALOG['ALED-TRS-IN-REG'].part,
          desc: PARTS_CATALOG['ALED-TRS-IN-REG'].desc,
          qty: data.totalCabinets, unitPrice: '-', total: '-'
      });

      // 7. Cables (Power, Ethernet)
      boqItems.push({
          part: 'ALED-CBL-P',
          desc: 'Power Cables (Cabinet)',
          qty: data.totalCabinets, unitPrice: '-', total: '-'
      });
      boqItems.push({
          part: 'ALED-CBL-S-NET',
          desc: 'Short Ethernet Cables (Inter-cabinet)',
          qty: data.requiredShortEthernet, unitPrice: '-', total: '-'
      });
      boqItems.push({
          part: 'ALED-CBL-L-NET',
          desc: 'Long Ethernet Cables (Controller to Wall)',
          qty: data.requiredLongEthRuns, unitPrice: '-', total: '-'
      });
      
      return boqItems;
    }

    function downloadBOQCSV(){
        if(!finalCalculationData || !finalCalculationData.totalCabinets) {
            alert('Please run the calculation first.');
            return;
        }

        const data = generateBOQDataForPdf(finalCalculationData); // Re-use the data generation logic
        
        let csv = "Part Code,Description,Qty (pcs),Unit Price (INR),Total Price (INR)\n";
        data.forEach(item => {
            csv += `${item.part},"${item.desc}",${item.qty},${item.unitPrice},${item.total}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `PeopleLink_BOQ_${finalCalculationData.productKey}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function resetForm(){
      // Reset input fields
      document.getElementById('productModel').value='';
      document.getElementById('unit').value='';
      document.getElementById('width').value='';
      document.getElementById('height').value='';
      document.getElementById('diagonal').value='';
      document.getElementById('aspectRatio').value='';
      document.getElementById('errorMessage').style.display='none';
      document.getElementById('cabinetOverlay').innerHTML='';
      document.getElementById('boqPreviewContainer').innerHTML='';
      document.getElementById('visDimensions').textContent = '';
      
      // clear specs
      ['spec_model','spec_pitch','spec_dims','spec_res','spec_diag','spec_density','spec_area','spec_total_pixels','spec_cabs','spec_modules','spec_cabsize','spec_cabpix','ctrl_name','ctrl_longeth_combined','ctrl_sending','ctrl_shorteth','spec_power','spec_weight'].forEach(id=>{
        const el = document.getElementById(id); if(el) el.textContent = '--';
      });
      
      // Re-initialize for visual cleanup
      toggleMeasurementFields();
      finalCalculationData = {};
    }

    // Modal control functions
    function openControllerModal(){
      document.getElementById('controllerModal').style.display = 'flex';
      // Populate modal with current/default values if needed
    }
    function closeControllerModal(){
      document.getElementById('controllerModal').style.display = 'none';
    }
    function applyModalChanges(){
      // In a real application, logic to override suggested controller goes here.
      // For this script, we just close the modal.
      closeControllerModal();
    }
    function openContactModal(){
      document.getElementById('contactModal').style.display = 'flex';
      document.getElementById('contactError').style.display = 'none';
    }
    function closeContactModal(){
      document.getElementById('contactModal').style.display = 'none';
    }
    function handleDownloadRequest(){
      contactInfo.email = document.getElementById('downloadEmail').value.trim();
      contactInfo.phone = document.getElementById('downloadPhone').value.trim();
      
      // Basic validation (optional but good practice)
      if(!contactInfo.email && !contactInfo.phone) {
        document.getElementById('contactError').textContent = 'Please enter either an email or phone number for the PDF metadata, or click cancel.';
        document.getElementById('contactError').style.display = 'block';
        return;
      }

      closeContactModal();
      createPdf(finalCalculationData);
    }

    /************************************************************************
     * Init
     ************************************************************************
     *//*
    document.addEventListener('DOMContentLoaded', ()=>{
      toggleMeasurementFields();
      populateModalControllers();
      populateModalOutputCards();
      populateModalInputCards();

      // close modals on background click
      window.addEventListener('click', (e)=>{
        if(e.target === document.getElementById('controllerModal')) closeControllerModal();
        if(e.target === document.getElementById('contactModal')) closeContactModal();
      });
    });*/

  </script>
</body>
</html>
